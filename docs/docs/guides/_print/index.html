<!doctype html>
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.95.0" /><link rel="canonical" type="text/html" href="https://vine-io.github.io/vine/docs/guides/">
<link rel="alternate" type="application/rss&#43;xml" href="https://vine-io.github.io/vine/docs/guides/index.xml">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="shortcut icon" href="/vine/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/vine/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/vine/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/vine/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/vine/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/vine/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/vine/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/vine/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/vine/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/vine/favicons/android-192x192.png" sizes="192x192">

<title>用户指南 | Vine</title><meta property="og:title" content="用户指南" />
<meta property="og:description" content="Vine 文档" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://vine-io.github.io/vine/docs/guides/" /><meta property="og:site_name" content="Vine" />

<meta itemprop="name" content="用户指南">
<meta itemprop="description" content="Vine 文档"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="用户指南"/>
<meta name="twitter:description" content="Vine 文档"/>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






<link rel="preload" href="/vine/scss/main.min.bd19fcdf38c012b14ad8d3c8432efd8cf1740a17234311f030bcb495e955a2cf.css" as="style">
<link href="/vine/scss/main.min.bd19fcdf38c012b14ad8d3c8432efd8cf1740a17234311f030bcb495e955a2cf.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>




  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/vine/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">Vine</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a  class="nav-link active" href="/vine/docs/" ><span class="active">文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a  class="nav-link" href="https://github.com/vine-io/examples" target="_blank" ><span>实例</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a  class="nav-link" href="https://github.com/vine-io/vine" target="_blank" ><span>GitHub</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
<input type="search" class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label="站内搜索…" autocomplete="off">

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/vine/docs/guides/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">用户指南</h1>






<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-22e05ce140284b8cc925e8080f773895">1 - Protobuf 规范</h1>
    
	<p>我们提供一套 <code>Protobuf</code> 文件格式和神生成代码的规范，帮助用户写出更标准的接口。</p>
<p><strong>Vine</strong> 项目的推崇以 <strong>资源</strong> 为核心。接口的设计和代码的规范都按照 <strong>资源</strong> 展开。每个接口的设计遵循以下的规则:</p>
<ol>
<li>根据需求确定资源 (领域模型)。</li>
<li>每个接口实际为资源的方法或者是针对资源的操作。</li>
<li>每个 service 为资源操作的集合。</li>
<li>前端请求时提交的数据可直接转化为资源的内部属性。</li>
<li>提供的 API 接口格式统一为针对资源的曹组。</li>
</ol>
<h2 id="目录结构">目录结构</h2>
<p>API 接口统一存放在 api 目录下，proto 文件同时转化为 gRPC 和 HTTP 两种接口。</p>
<p>项目中定义 Proto，以 api 为根目录。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>├── service    
</span></span><span style="display:flex;"><span>│   └── helloworld
</span></span><span style="display:flex;"><span>│       └── v1
</span></span><span style="display:flex;"><span>│           ├── helloworld.pb.go
</span></span><span style="display:flex;"><span>│           ├── helloworld.pb.validator.go
</span></span><span style="display:flex;"><span>│           ├── helloworld.pb.vine.go
</span></span><span style="display:flex;"><span>│           └── helloworld.proto
</span></span><span style="display:flex;"><span>└── types
</span></span><span style="display:flex;"><span>    └── core
</span></span><span style="display:flex;"><span>        └── v1
</span></span><span style="display:flex;"><span>            ├── core.pb.dao.go
</span></span><span style="display:flex;"><span>            ├── core.pb.deepcopy.go
</span></span><span style="display:flex;"><span>            ├── core.pb.go
</span></span><span style="display:flex;"><span>            ├── core.pb.validator.go
</span></span><span style="display:flex;"><span>            └── core.proto
</span></span></code></pre></div><p>api 下有两个子目录，分别对应</p>
<ul>
<li>types (领域模型或者资源)，格式为 <code>group/version/name.proto</code></li>
<li>services (gRPC、http 接口)，格式为 <code>service/version/name.proto</code></li>
</ul>
<h2 id="包名">包名</h2>
<p>包名为应用的标识，用户生成 gRPC 请求路径，或者 proto 文件之间引用。</p>
<blockquote>
<p>建议在 $GOPATH/src 生成代码 proto 代码。</p>
</blockquote>
<h3 id="go_package">go_package</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#ff79c6">option</span> go_package <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;github.com/lack-io/foo/api/types/&lt;group&gt;/&lt;version&gt;;&lt;group&gt;&lt;version&gt;&#34;</span>;
</span></span></code></pre></div><h3 id="java_package">java_package</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#ff79c6">option</span> java_multiple_files <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">option</span> java_package <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;io.vine.services.&lt;group&gt;.&lt;version&gt;&#34;</span>;
</span></span></code></pre></div><h2 id="import">import</h2>
<p>service proto 依赖 types protobuf，以 $GOPATH/src 为更目录引入对应 proto。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/foo/api/types/core/v1/core.proto&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Request</span> {
</span></span><span style="display:flex;"><span>    corev1.Request req <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="storage">storage</h2>
<p>当需要数据持久化时，有 types proto 生成对应的数据库交互代码。详细的说明可以参考 <a href="https://vine-io.github.io/vine/docs/guides/dao/">proto-gen-dao</a>。</p>
<p>代码的存放规则为，<em>谁实现，谁存放</em>。生成的代码存放在对应服务更目录的 <code>infra/storage</code> 下，需要在 proto 文件的头部指定生成路径:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#6272a4">// +dao:output=github.com/vine-io/foo/pkg/helloworld/infra/storage;storage
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;protoc&#34;</span>
</span></span></code></pre></div><h2 id="命令规范">命令规范</h2>
<h3 id="目录结构-1">目录结构</h3>
<p>包名为小写，且同与目录一致: 如 <code>hellowrold/v1/helloworld.proto</code> 的包名为 <code>helloworldv1</code>。</p>
<h3 id="文件结构">文件结构</h3>
<p>文件应该命名为：lower_snake_case.proto 所有Proto应按下列方式排列:</p>
<ul>
<li>License header (if applicable)</li>
<li>File overview</li>
<li>Syntax</li>
<li>Package</li>
<li>Imports (sorted)</li>
<li>File options</li>
<li>Service</li>
<li>Message</li>
</ul>
<h3 id="service-和-message">Service 和 Message</h3>
<p>使用驼峰命名法命名 service, method 和 message。Service 的名称格式为 <code>&lt;PackageName&gt;Service</code> 以 <code>Service</code> 为后缀。</p>
<p>Method 的格式为:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">service</span> EchoService {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">rpc</span> EmptyMethod(Empty) <span style="color:#ff79c6">returns</span> (Empty);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">rpc</span> Echo(EchoReq) <span style="color:#ff79c6">returns</span> (EchoRsp);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Empty</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">EchoReq</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">EchoRsp</span> {}
</span></span></code></pre></div><p>Method 的输入输出 Message 没有其他字段时，使用 <code>Empty</code>。Method 的输入 message 以 <code>Req</code> 结尾。输出 message 以 <code>Rsp</code> 结尾。</p>
<h3 id="字段">字段</h3>
<p>字段使用驼峰命名法(首字母小写)，<code>repeated</code> 数组类型是结尾加小写:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">User</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">repeated</span> <span style="color:#8be9fd">string</span> tags <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="枚举-enums">枚举 Enums</h3>
<p>使用驼峰命名法（首字母大写）命名枚举类型，使用 “大写下划线大写” 的方式命名枚举值：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">enum</span> Color {
</span></span><span style="display:flex;"><span>  RED <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>  BLACK <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>每一个枚举值以分号结尾，而非逗号。</p>
<h3 id="注释-comment">注释 Comment</h3>
<ul>
<li>Service，描述清楚服务的作用</li>
<li>Method，描述清楚接口的功能特性</li>
<li>Field，描述清楚字段准确的信息</li>
</ul>
<h2 id="完整实例">完整实例</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span>syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;proto3&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">package</span> gpmv1;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">option</span> go_package <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/gpm/api/service/gpm/v1;gpmv1&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">option</span> java_multiple_files <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">option</span> java_package <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;io.vine.services.gpm.v1&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/gpm/api/types/gpm/v1/gpm.proto&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:openapi
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">service</span> GpmService {
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:summary=查询单个服务
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:get=/api/v1/Service/{name}
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> GetService(GetServiceReq) <span style="color:#ff79c6">returns</span> (GetServiceRsp);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Empty</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// GetService 请求参数
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">GetServiceReq</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// 服务名称
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:required
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// GetService 返回结果
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">GetServiceRsp</span> {
</span></span><span style="display:flex;"><span>  gpmv1.Service <span style="color:#8be9fd;font-style:italic">service</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d821b90f925c23ea34f7869438d8aa2a">2 - Vine 工具</h1>
    <div class="lead">在 <strong>vine</strong> 框架下我们提供一套命令行管理工具，用来管理项目和实现与 <strong>vine</strong> 服务的交互</div>
	<h2 id="安装-vine-工具">安装 vine 工具</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get github.com/vine-io/vine/cmd/vine
</span></span></code></pre></div><p>验证安装结果</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ vine --help
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   vine - A vine service runtime
</span></span><span style="display:flex;"><span>        _
</span></span><span style="display:flex;"><span> _   __<span style="color:#ff79c6">(</span>_<span style="color:#ff79c6">)</span>___  ___
</span></span><span style="display:flex;"><span>| | / / / __ <span style="color:#f1fa8c">\/</span> _ <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>| |/ / / / / /  __/
</span></span><span style="display:flex;"><span>|___/_/_/ /_/<span style="color:#f1fa8c">\_</span>__/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   vine <span style="color:#ff79c6">[</span>global options<span style="color:#ff79c6">]</span> <span style="color:#8be9fd;font-style:italic">command</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">command</span> options<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>arguments...<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERSION:
</span></span><span style="display:flex;"><span>   ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>   api      Run the api gateway
</span></span><span style="display:flex;"><span>   new      Create vine resource template
</span></span><span style="display:flex;"><span>   init     Initialize a vine project
</span></span><span style="display:flex;"><span>   build    Build vine project or resource
</span></span><span style="display:flex;"><span>   run      Start a vine project
</span></span><span style="display:flex;"><span>   help, h  Shows a list of commands or <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">for</span> one <span style="color:#8be9fd;font-style:italic">command</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>GLOBAL OPTIONS:
</span></span><span style="display:flex;"><span>   --help, -h     show <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   --version, -v  print the version <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>vine 命令行工具支持多个子命令，包含以下功能:</p>
<ul>
<li>启动网关</li>
<li>项目管理 (创建，编译，运行)</li>
</ul>
<h2 id="vine-项目管理">vine 项目管理</h2>
<p><code>new</code>, <code>init</code>, <code>build</code>, <code>run</code> 可能帮助开发人员很好的管理 vine 实现的项目。接下来我们使用该工具一步步实现单服务的管理</p>
<h3 id="初始化项目">初始化项目</h3>
<p>新建目录 <code>$GOPATH/src/example</code> (建议将项目目录保存在 GOPATH 下。)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ mkdir <span style="color:#8be9fd;font-style:italic">$GOAPTH</span>/src/example
</span></span><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">cd</span> <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/example
</span></span></code></pre></div><p>在项目目录下执行初始化操作:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ vine init 
</span></span><span style="display:flex;"><span>Creating resource  in <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── vine.toml
</span></span><span style="display:flex;"><span>├── README.md
</span></span><span style="display:flex;"><span>├── .gitignore
</span></span><span style="display:flex;"><span>└── go.mod
</span></span></code></pre></div><p>初始化话生成以上文件，<code>vine.toml</code> 中包含项目相关的信息，包含该文件的目录就会被识别为 <code>vine</code> 项目。</p>
<h3 id="新建服务">新建服务</h3>
<p>执行以下命令创建一个服务:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ vine new service 
</span></span><span style="display:flex;"><span>Creating resource example in <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── cmd
</span></span><span style="display:flex;"><span>│   └── main.go
</span></span><span style="display:flex;"><span>├── pkg
</span></span><span style="display:flex;"><span>│   ├── runtime
</span></span><span style="display:flex;"><span>│   │   └── doc.go
</span></span><span style="display:flex;"><span>│   ├── plugin.go
</span></span><span style="display:flex;"><span>│   ├── app.go
</span></span><span style="display:flex;"><span>│   ├── server
</span></span><span style="display:flex;"><span>│   │   └── example.go
</span></span><span style="display:flex;"><span>│   ├── service
</span></span><span style="display:flex;"><span>│   │   ├── example.go
</span></span><span style="display:flex;"><span>│   │   └── wire.go
</span></span><span style="display:flex;"><span>│   └── dao
</span></span><span style="display:flex;"><span>│       └── example.go
</span></span><span style="display:flex;"><span>├── deploy
</span></span><span style="display:flex;"><span>│   ├── Dockerfile
</span></span><span style="display:flex;"><span>│   ├── example.ini
</span></span><span style="display:flex;"><span>│   └── example.service
</span></span><span style="display:flex;"><span>├── proto
</span></span><span style="display:flex;"><span>│   └── service
</span></span><span style="display:flex;"><span>│       └── example
</span></span><span style="display:flex;"><span>│           └── v1
</span></span><span style="display:flex;"><span>│               └── example.proto
</span></span><span style="display:flex;"><span>└── vine.toml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>download protoc zip packages <span style="color:#ff79c6">(</span>protoc-<span style="color:#8be9fd;font-style:italic">$VERSION</span>-<span style="color:#8be9fd;font-style:italic">$PLATFORM</span>.zip<span style="color:#ff79c6">)</span> and install:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>visit https://github.com/protocolbuffers/protobuf/releases
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>download protobuf <span style="color:#ff79c6">for</span> vine:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">cd</span> example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>install dependencies:
</span></span><span style="display:flex;"><span>   go get github.com/google/wire/cmd/wire
</span></span><span style="display:flex;"><span>	go get github.com/gogo/protobuf
</span></span><span style="display:flex;"><span>	go get github.com/vine-io/vine/cmd/protoc-gen-gogo
</span></span><span style="display:flex;"><span>	go get github.com/vine-io/vine/cmd/protoc-gen-vine
</span></span><span style="display:flex;"><span>	go get github.com/vine-io/vine/cmd/protoc-gen-validator
</span></span><span style="display:flex;"><span>	go get github.com/vine-io/vine/cmd/protoc-gen-deepcopy
</span></span><span style="display:flex;"><span>	go get github.com/vine-io/vine/cmd/protoc-gen-dao
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">cd</span> example
</span></span><span style="display:flex;"><span>	vine build example
</span></span></code></pre></div><h3 id="安装依赖包">安装依赖包</h3>
<p>根据提示，安装依赖</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ go get github.com/google/wire/cmd/wire
</span></span><span style="display:flex;"><span>$ go get github.com/gogo/protobuf
</span></span><span style="display:flex;"><span>$ go get github.com/vine-io/vine/cmd/protoc-gen-gogo
</span></span><span style="display:flex;"><span>$ go get github.com/vine-io/vine/cmd/protoc-gen-vine
</span></span><span style="display:flex;"><span>$ go get github.com/vine-io/vine/cmd/protoc-gen-validator
</span></span><span style="display:flex;"><span>$ go get github.com/vine-io/vine/cmd/protoc-gen-deepcopy
</span></span><span style="display:flex;"><span>$ go get github.com/vine-io/vine/cmd/protoc-gen-dao
</span></span></code></pre></div><h3 id="编译项目">编译项目</h3>
<p>生成 <code>*.pb.go</code> 代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ vine build proto --type<span style="color:#ff79c6">=</span>service  --group<span style="color:#ff79c6">=</span>example example
</span></span><span style="display:flex;"><span>change directory <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src:
</span></span><span style="display:flex;"><span>protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src --gogo_out<span style="color:#ff79c6">=</span>:. --vine_out<span style="color:#ff79c6">=</span>:. --validator_out<span style="color:#ff79c6">=</span>:. example/proto/service/example/v1/example.proto
</span></span></code></pre></div><p>编译成二进制文件:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ go mod vendor
</span></span><span style="display:flex;"><span>go: finding module <span style="color:#ff79c6">for</span> package github.com/google/wire
</span></span><span style="display:flex;"><span>go: found github.com/google/wire in github.com/google/wire v0.5.0
</span></span><span style="display:flex;"><span>$ vine build service example
</span></span><span style="display:flex;"><span>vine build service example
</span></span><span style="display:flex;"><span>go build -a -installsuffix cgo -ldflags <span style="color:#f1fa8c">&#34;-s -w&#34;</span> cmd/main.go
</span></span><span style="display:flex;"><span>speed: 17.907776483s
</span></span></code></pre></div><h3 id="运行服务">运行服务</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./main
</span></span><span style="display:flex;"><span>2021-06-05 08:47:29  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>vine/service.go:199 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Starting <span style="color:#ff79c6">[</span>service<span style="color:#ff79c6">]</span> go.vine.service.example
</span></span><span style="display:flex;"><span>2021-06-05 08:47:29  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>vine/service.go:200 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info service <span style="color:#ff79c6">[</span>version<span style="color:#ff79c6">]</span> latest
</span></span><span style="display:flex;"><span>2021-06-05 08:47:29  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>grpc/grpc.go:878 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Server <span style="color:#ff79c6">[</span>grpc<span style="color:#ff79c6">]</span> Listening on <span style="color:#ff79c6">[</span>::<span style="color:#ff79c6">]</span>:51530
</span></span><span style="display:flex;"><span>2021-06-05 08:47:29  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>grpc/grpc.go:719 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Registry <span style="color:#ff79c6">[</span>mdns<span style="color:#ff79c6">]</span> Registering node: go.vine.service.example-81ec2a02-c402-42d7-88c8-3de75a68a49b
</span></span><span style="display:flex;"><span>2021-06-05 08:47:29  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>mdns/mdns_registry.go:266 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info <span style="color:#ff79c6">[</span>mdns<span style="color:#ff79c6">]</span> registry create new service with ip: 192.168.11.167 <span style="color:#ff79c6">for</span>: 192.168.11.167
</span></span></code></pre></div><h2 id="vine-项目结构">vine 项目结构</h2>
<p>vine 项目采用合理的结构，使代码结构变得清晰易理解。项目分成两种类型，<code>cluster</code> 分布式和 <code>single</code> 单服务。两种类型的目录结构上有一些区别</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># 单服务项目</span>
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── cmd  <span style="color:#6272a4"># 服务入口目录, single类型时目录下只有 main.go 文件，cluster 下包含多个服务同名的目录，内部有 main.go 文件</span>
</span></span><span style="display:flex;"><span>│   └── main.go
</span></span><span style="display:flex;"><span>├── pkg  <span style="color:#6272a4"># pkg 每个服务核心代码存放下该目录下，single类型时，目录下直接存放服务代码，cluster类型时，目录还有一层服务同名的子目录。</span>
</span></span><span style="display:flex;"><span>│   ├── runtime  <span style="color:#6272a4"># 各服务公用的工具包和 client 等</span>
</span></span><span style="display:flex;"><span>│   │   └── doc.go
</span></span><span style="display:flex;"><span>│   ├── plugin.go <span style="color:#6272a4"># vine 服务的插件信息</span>
</span></span><span style="display:flex;"><span>│   ├── app.go    <span style="color:#6272a4"># 服务入口，初始化的一些代码</span>
</span></span><span style="display:flex;"><span>│   ├── server    <span style="color:#6272a4"># 提供 rpc 服务，只进行一些数据的验证，具体工具调用 service</span>
</span></span><span style="display:flex;"><span>│   │   └── example.go
</span></span><span style="display:flex;"><span>│   ├── service   <span style="color:#6272a4"># 服务业务逻辑代码</span>
</span></span><span style="display:flex;"><span>│   │   ├── example.go
</span></span><span style="display:flex;"><span>│   │   └── wire.go <span style="color:#6272a4"># 使用 github.com/google/wire 实现 DI</span>
</span></span><span style="display:flex;"><span>│   └── dao       <span style="color:#6272a4"># 数据库交互代码，有 protoc 工具自动生成</span>
</span></span><span style="display:flex;"><span>│       └── example.go
</span></span><span style="display:flex;"><span>├── deploy    <span style="color:#6272a4"># 项目代码部署时需要的文件，single 和 cluster 结构上不同</span>
</span></span><span style="display:flex;"><span>│   ├── Dockerfile <span style="color:#6272a4"># 服务 Dockerfile</span>
</span></span><span style="display:flex;"><span>│   ├── example.ini <span style="color:#6272a4"># 服务的启动参数配置文件</span>
</span></span><span style="display:flex;"><span>│   └── example.service <span style="color:#6272a4"># CentOS 上的服务脚本</span>
</span></span><span style="display:flex;"><span>├── proto    <span style="color:#6272a4"># 存放 *.proto 文件及其生成的 *.go 代码，分成 apis 和 service 类型</span>
</span></span><span style="display:flex;"><span>│   └── service <span style="color:#6272a4"># 提供 gRPC 服务，引用 proto/apis 下的 message  </span>
</span></span><span style="display:flex;"><span>│       └── example <span style="color:#6272a4"># 和服务同名的目录</span>
</span></span><span style="display:flex;"><span>│           └── v1  <span style="color:#6272a4"># 服务接口版本，默认为 v1</span>
</span></span><span style="display:flex;"><span>│               └── example.proto
</span></span><span style="display:flex;"><span>└── vine.toml <span style="color:#6272a4"># vine 项目的描述文件，有该文件则被认定为 vine 项目。</span>
</span></span></code></pre></div><p><code>vine.toml</code> 文件内容说明</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff79c6">[</span>package<span style="color:#ff79c6">]</span>   
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">kind</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;single&#34;</span> <span style="color:#6272a4"># 项目类型</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">namespace</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;go.vine&#34;</span> <span style="color:#6272a4"># 项目的命令空间</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>pkg<span style="color:#ff79c6">]</span>  <span style="color:#6272a4"># kind = &#34;single&#34; 该配置存在，描述服务信息。</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">name</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;example&#34;</span> <span style="color:#6272a4"># 服务命令</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">alias</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;go.vine.service.example&#34;</span> <span style="color:#6272a4"># 别名</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">type</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;service&#34;</span>  <span style="color:#6272a4"># 服务类型,提供 gRPC 接口，service, web, gateway</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;latest&#34;</span> <span style="color:#6272a4"># 服务版本</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">main</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;cmd/main.go&#34;</span> <span style="color:#6272a4"># main 函数路径</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">dir</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;example&#34;</span> <span style="color:#6272a4"># 项目目录路径，$GOPATH/src 下</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">output</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span> <span style="color:#6272a4"># 服务编译时，输入路径 go build -o $output main.go</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">flags</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">[</span>   <span style="color:#6272a4"># 服务编译时的额外参数，支持多个格式，&#34;KEY=value&#34;, &#34;-key&#34;, &#34;key=${shell command}&#34;  </span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;-a&#34;</span>, <span style="color:#f1fa8c">&#34;-installsuffix&#34;</span>, <span style="color:#f1fa8c">&#34;cgo&#34;</span>, <span style="color:#f1fa8c">&#34;-ldflags \&#34;-s -w\&#34;&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[[</span>mod<span style="color:#ff79c6">]]</span>  <span style="color:#6272a4"># kind = &#34;cluster&#34; 该配置存在，描述服务信息。每个 mod 表示一个服务</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">name</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;apiserver&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">alias</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;com.howlink.service.apiserver&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">type</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;service&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;latest&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">main</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;cmd/apiserver/main.go&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">dir</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;dr/apiserver&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">output</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;_output/apiserver&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">flags</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">[</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;GOOS=linux&#34;</span>, <span style="color:#f1fa8c">&#34;GOARCH=amd64&#34;</span>, <span style="color:#f1fa8c">&#34;-a&#34;</span>, <span style="color:#f1fa8c">&#34;-installsuffix&#34;</span>, <span style="color:#f1fa8c">&#34;cgo&#34;</span>, <span style="color:#f1fa8c">&#34;-ldflags \&#34;-s -w\&#34;&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[[</span>proto<span style="color:#ff79c6">]]</span> <span style="color:#6272a4"># .proto 文件描述信息</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">name</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;example&#34;</span> <span style="color:#6272a4"># 文件名</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">pb</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;example/proto/service/example/v1/example.proto&#34;</span> <span style="color:#6272a4"># 路径</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">type</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;service&#34;</span> <span style="color:#6272a4"># 类型，service 和 api</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">group</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;example&#34;</span> <span style="color:#6272a4"># 组，同个 group 下不同有同名的 proto 文件</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;v1&#34;</span> <span style="color:#6272a4"># 版本，默认为 v1</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">plugins</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#34;gogo&#34;</span>, <span style="color:#f1fa8c">&#34;vine&#34;</span>, <span style="color:#f1fa8c">&#34;validator&#34;</span><span style="color:#ff79c6">]</span> <span style="color:#6272a4"># 生成 .go 代码时启用的 protoc 插件</span>
</span></span></code></pre></div><h2 id="vine-命令解析">vine 命令解析</h2>
<p><code>vine</code> 工具支持以下子命令:</p>
<ul>
<li>api      启动网关服务</li>
<li>new      创建服务或者proto文件</li>
<li>init     初始化项目，将一个目录转化为项目目录</li>
<li>build    编译服务、生成 .go 文件</li>
<li>run      运行服务</li>
</ul>
<h3 id="init-子命令">init 子命令</h3>
<p><code>vine init</code> 支持以下参数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ vine init --help    
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   vine init - Initialize a vine project
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   vine init <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">command</span> options<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>arguments...<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>   --namespace string  Namespace <span style="color:#ff79c6">for</span> the project e.g com.example <span style="color:#ff79c6">(</span>default: <span style="color:#f1fa8c">&#34;go.vine&#34;</span><span style="color:#ff79c6">)</span> <span style="color:#6272a4"># 指定项目的命令空间</span>
</span></span><span style="display:flex;"><span>   --cluster           create cluster package. <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span> <span style="color:#6272a4"># 确认项目类型，默认为单服务</span>
</span></span><span style="display:flex;"><span>   --help, -h          show <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>vine 项目支持 cluster (多服务分布式)、single (单服务，默认) 两种类型。</p>
<h3 id="new-子命令">new 子命令</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ NAME:
</span></span><span style="display:flex;"><span>   vine new - Create vine resource template
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   vine new <span style="color:#8be9fd;font-style:italic">command</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">command</span> options<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>arguments...<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>   service  Create a service template  <span style="color:#6272a4"># 创建一个 gRPC 服务</span>
</span></span><span style="display:flex;"><span>   gateway  Create a gateway template  <span style="color:#6272a4"># 创建一个网关服务</span>
</span></span><span style="display:flex;"><span>   web      Create a web template      <span style="color:#6272a4"># 创建一个 web 服务</span>
</span></span><span style="display:flex;"><span>   proto    Create a proto file        <span style="color:#6272a4"># 创建 proto 文件</span>
</span></span><span style="display:flex;"><span>   help, h  Shows a list of commands or <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">for</span> one <span style="color:#8be9fd;font-style:italic">command</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>   --help, -h     show <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   --version, -v  print the version <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   
</span></span></code></pre></div><h3 id="build-子命令">build 子命令</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ vine build --help
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   vine build - Build vine project or resource
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   vine build <span style="color:#8be9fd;font-style:italic">command</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">command</span> options<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>arguments...<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>   proto    Generate protobuf file  <span style="color:#6272a4"># 生成 proto 对应的go代码</span>
</span></span><span style="display:flex;"><span>   service  Build vine project      <span style="color:#6272a4"># 编译服务</span>
</span></span><span style="display:flex;"><span>   help, h  Shows a list of commands or <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">for</span> one <span style="color:#8be9fd;font-style:italic">command</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>   --help, -h     show <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   --version, -v  print the version <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
</span></span></code></pre></div><h3 id="run-子命令">run 子命令</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ vine run --help          
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   vine run - Start a vine project
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   vine run <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">command</span> options<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>arguments...<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>   --auto-restart   <span style="color:#6272a4"># 是否在监听到文件变动时自动重启，默认为 true</span>
</span></span><span style="display:flex;"><span>   --watch strings  <span style="color:#6272a4"># 监听指定目录的文件内容变化</span>
</span></span><span style="display:flex;"><span>   --help, -h       show <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>// TODO</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-826345e38af594c61cf85a8e0dd09f73">3 - protoc-gen-vine</h1>
    <div class="lead"><em>OpenAPI</em> 通过 <code>protoc-gen-vine</code> 集成 openapi3.0。</div>
	<h2 id="概述">概述</h2>
<p><em>Vine</em> 内部集成 openapi3.0，<code>protoc-gen-vine</code> 通过识别 protobuf 文件的注释生成 Openapi3.0 文档。类似 <a href="https://vine-io.github.io/vine/docs/tools/validate/">Validator</a>。</p>
<h2 id="使用">使用</h2>
<h3 id="1先编写-helloworldproto-文件">1.先编写 helloworld.proto 文件</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span>syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;proto3&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">package</span> testdata;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">option</span> go_package <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/testdata/proto;testdata&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/proto/api/api.proto&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:openapi
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:term_name=vine
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:term_email=598223084@qq.com
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:contact_name=vine
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:contact_email=598223084@qq.com
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:license_name=Apache2.0
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:license_url=https://www.apache.org/licenses/LICENSE-2.0
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:external_doc_desc=123
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:external_doc_url=http://www.baidu.com
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">service</span> Helloworld {
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:get=/api/v1/call
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:body=*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:summary=callllllllll
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:security=bearer, apiKeys, basic
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:result=[200]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Call(HelloWorldRequest) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {};
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:post=/api/v1/event
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:body=*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Mul(api.Event) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {};
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">HelloWorldRequest</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:required
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int32</span> age <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">HelloWorldResponse</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int32</span> code <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">string</span> reply <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="2安装-protoc-gen-vine">2.安装 protoc-gen-vine</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get github.com/vine-io/vine/cmd/protoc-gen-vine
</span></span></code></pre></div><h3 id="3生成-swagger-文档">3.生成 swagger 文档</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/github.com/gogo/googleapis --gogofaster_out<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">plugins</span><span style="color:#ff79c6">=</span>grpc:. --vine_out<span style="color:#ff79c6">=</span>:. proto/helloworld.proto
</span></span></code></pre></div><p>执行完成后生成以下代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#6272a4">// Swagger OpenAPI 3.0 for Helloworld service
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">NewHelloworldOpenAPI</span>() <span style="color:#ff79c6">*</span>openapipb.OpenAPI {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><h3 id="4验证">4.验证</h3>
<p>生成的 Openapi3.0 文档会自动注册到 <code>Registry</code> 组件，当启动 <code>vine api</code> 时添加 <code>--enable-openapi</code> 参数可以启动 OpenAPI3.0 功能:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>vine api <span style="color:#ff79c6">--</span>handler=rpc <span style="color:#ff79c6">--</span>enable<span style="color:#ff79c6">-</span>openapi
</span></span></code></pre></div><p>启动用访问 url <code>http://127.0.0.1:8080/openapi-ui/</code> 效果如下:</p>
<p><img src="2021-01-25-18-58-50.png" alt="swagger-openapi"></p>
<p><em>Vine</em> 的 OpenAPI 支持 swagger 风格和 redoc 风格，切换到 redoc 则使用路径 <code>http://127.0.0.1:8080/openapi-ui/redoc</code>，效果如下：</p>
<p><img src="2021-01-25-19-04-57.png" alt="redoc-openapi"></p>
<h2 id="语法解析">语法解析</h2>
<p><code>protoc-gen-vine</code> 通过解析 <code>protobuf</code> 中的注释来生成 OpenAPI3.0 文档。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#6272a4">// +gen:openapi
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:term_name=vine
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:term_email=598223084@qq.com
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:contact_name=vine
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:contact_email=598223084@qq.com
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:license_name=Apache2.0
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:license_url=https://www.apache.org/licenses/LICENSE-2.0
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:external_doc_desc=123
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:external_doc_url=http://www.baidu.com
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">service</span> Helloworld {
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:get=/api/v1/call
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:body=*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:summary=callllllllll
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:security=bearer, apiKeys, basic
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:result=[200]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Call(HelloWorldRequest) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {};
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:post=/api/v1/event
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:body=*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Mul(api.Event) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {};
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>注: <code>protoc-gen-vine</code> 和 <code>protoc-gen-validator</code> 中存在大量重复注释，这样设计的原因是通过一套的注释规则直接生成更多的代码，较少非业务代码的编写。</p>
</blockquote>
<h3 id="语法规则">语法规则</h3>
<p>有效的注释有以下的规则:</p>
<ul>
<li>注释必须以 <code>+gen</code> 作为开头</li>
<li>注释的内容必须紧贴对应的字段，中间不能有空行</li>
<li>支持多行注释，也可以将多行合并成一行，并用 <code>;</code> 作为分隔符</li>
</ul>
<blockquote>
<p>注：// 风格的注释会被识别为 openapi3.0 中的 Description 信息。</p>
</blockquote>
<h3 id="类型支持">类型支持</h3>
<p><code>service</code> 类型规则:</p>
<ul>
<li>openapi（必填）: 生成 openapi 的标识，具有此标识的 Service 才会生成文档</li>
<li>term_url: 项目团队的 url</li>
<li>contact_name: 项目作者名称，和 contact_email 配合使用</li>
<li>contact_email: 项目作者邮箱，和 contact_name 配合使用</li>
<li>license_name: 项目遵循的许可类型，和 license_url 配合使用</li>
<li>license_url: 项目遵循的许可 url，和 license_name配合使用</li>
<li>external_doc_desc: 扩展文档描述，和 external_doc_url 配合使用</li>
<li>external_doc_url: 扩展文档 url，和 external_doc_url 配合使用</li>
<li>version: 文档版本，如 1.0.0</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#6272a4">// +gen:ignore
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">P</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:openapi
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:term_name=vine
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:term_email=598223084@qq.com
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:contact_name=vine
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:contact_email=598223084@qq.com
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:license_name=Apache2.0
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:license_url=https://www.apache.org/licenses/LICENSE-2.0
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:external_doc_desc=123
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:external_doc_url=http://www.example.com
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd;font-style:italic">service</span> HelloWorld {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>rpc</code> 支持的规则:</p>
<ul>
<li>get | post | put | patch | delete（必填）: 生成对应的 http method，后面紧接路由信息，如 // +gen:get=/api/v1/call</li>
<li>body: 指定 Request message 的名称，可以直接使用 <code>*</code></li>
<li>summary: 接口的摘要信息</li>
<li>security: 路由支持的 Authorization。支持 beaer, apiKeys 和 basic</li>
<li>result: http response code。支持 200，400，401，403，404，405，408，409，500，502，503，504</li>
</ul>
<blockquote>
<p>注: 使用 +gen:security 时，result 会直接添加 401，403 的内容</p>
</blockquote>
<p><code>message</code> 作为内嵌字段时支持的规则:</p>
<ul>
<li>required: 判断该字段是否为 nil。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">service</span> Helloworld {
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:get=/api/v1/call
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:body=*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:summary=callllllllll
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:security=bearer, apiKeys, basic
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:result=[200]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Call(HelloWorldRequest) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {};
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:post=/api/v1/{name}/{id}
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:body=*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Mul(api.Event) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {};
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>message</code> 字段通用的规则：</p>
<ul>
<li>required: 指定字段为必填</li>
<li>default: 指定字段的默认值</li>
<li>example: 给定字段的实例</li>
<li>in: 字段只能在几个值中选择</li>
<li>enum: 同 in</li>
<li>ro: 字段为只读</li>
<li>wo: 字段为只写，和 password 配合使用</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">HelloWorldRequest</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:required
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:default=&#34;hello&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:example=&#34;hello&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:ro
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:rw
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:enum=[1,2,3]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">int32</span> age <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>string</code> 类型支持的规则</p>
<ul>
<li>min_len: 指定字段的最小长度</li>
<li>max_len: 指定字段的最大长度</li>
<li>email: 邮箱地址格式</li>
<li>date: 日期格式<a href="https://tools.ietf.org/html/rfc3339#section-5.6">RFC 3339, section 5.6</a>，如 2017-07-21</li>
<li>date-time: 日期加时间格式<a href="https://tools.ietf.org/html/rfc3339#section-5.6">RFC 3339, section 5.6</a>，如 2017-07-21T17:32:28Z</li>
<li>password: 密码格式</li>
<li>byte: 字节格式</li>
<li>binary: 二进制格式，上传文件使用</li>
<li>ip: ip 地址格式</li>
<li>ipv4: ipv4 格式</li>
<li>ipv6: ipv6 格式</li>
<li>uuid: uuid v4 格式</li>
<li>uri: uri 格式</li>
<li>hostname: 主机名</li>
<li>pattern: 正则表达式</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">S</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// +gen:required
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:default=&#34;hello&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:in=[&#34;1&#34;, &#34;2&#34;, &#34;3&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:enum=[&#34;a&#34;, &#34;b&#34;, &#34;c&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_len=3
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_max=4
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:pattern=`\d+(\w+){3,5}`
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:password
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:email
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:ip
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:ipv4
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:ipv6
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:date
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:date-time
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:bytes
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:binary
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:hostname
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:uuid
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:uri
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">string</span> m <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>注: string pattern 最好单独一行，以免和其他规则冲突</p>
</blockquote>
<p>数字类型的支持，包含 int32, int64, fixed32, fix64, float, double</p>
<ul>
<li>lt: 指定字段小于指定值</li>
<li>lte: 指定字段的小于等于指定值</li>
<li>gt: 指定字段大于指定值</li>
<li>gte: 指定字段大于等于指定值</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">S</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// +gen:required
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">float</span> a <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// +gen:default=3.14
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">double</span> pi <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// +gen:in=[1,2,3]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:enum=[2,3]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:not_in=[4,5]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int32</span> b <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// +gen:ge=3
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +ggen:gte=4
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:lte=9
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:lt=10
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int64</span> c <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0f3139f04142acc9dea586846b8c4063">4 - protoc-gen-validator</h1>
    <div class="lead"><em>Validate</em> 通过 <code>protoc-gen-validator</code> 生成 <code>Validate()</code> 接口，减少非业务代码的编写。</div>
	<h2 id="概述">概述</h2>
<p>服务运行中，经常需要和其他客户端进行数据交互，验证来自客户端的数据的合法性。但是这些代码编写起来枯燥且易错，<strong>vine</strong> 提供 <code>protoc-gen-validator</code> 工具来自动生成结构体 <code>Validate()</code> 方法，减少一部分代码的手动编写。</p>
<h2 id="使用">使用</h2>
<h3 id="1先编写-validatorproto-文件">1.先编写 validator.proto 文件</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Person</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:min_len=4
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:max_len=10
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:required;gt=10;lt=100
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">int32</span> age <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:required;min_bytes=3;max_bytes=4;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">bytes</span> any <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:email
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> email <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="2安装-protoc-gen-validator">2.安装 protoc-gen-validator</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get github.com/vine-io/vine/cmd/protoc-gen-validator
</span></span></code></pre></div><h3 id="3生成-validate-方法">3.生成 Validate() 方法</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src --gogo_out<span style="color:#ff79c6">=</span>:.  --validator_out<span style="color:#ff79c6">=</span>:. proto/validator.proto
</span></span></code></pre></div><p>执行完成后生成以下代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">Valdiate</span>() <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> m.<span style="color:#50fa7b">ValidateE</span>(<span style="color:#f1fa8c">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">ValidateE</span>() <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>	errs <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>([]<span style="color:#8be9fd">error</span>, <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(m.Name) <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !(<span style="color:#8be9fd;font-style:italic">len</span>(m.Name) <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">4</span>) {
</span></span><span style="display:flex;"><span>			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;name&#39; length must less than &#39;4&#39;&#34;</span>))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !(<span style="color:#8be9fd;font-style:italic">len</span>(m.Name) <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">10</span>) {
</span></span><span style="display:flex;"><span>			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;name&#39; length must great than &#39;10&#39;&#34;</span>))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">int64</span>(m.Age) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
</span></span><span style="display:flex;"><span>		errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;age&#39; is required&#34;</span>))
</span></span><span style="display:flex;"><span>	} <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !(m.Age &lt; <span style="color:#bd93f9">100</span>) {
</span></span><span style="display:flex;"><span>			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;age&#39; must less than &#39;100&#39;&#34;</span>))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !(m.Age &gt; <span style="color:#bd93f9">10</span>) {
</span></span><span style="display:flex;"><span>			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;age&#39; must great than &#39;10&#39;&#34;</span>))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(m.Any) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
</span></span><span style="display:flex;"><span>		errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;any&#39; is required&#34;</span>))
</span></span><span style="display:flex;"><span>	} <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !(<span style="color:#8be9fd;font-style:italic">len</span>(m.Any) <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">3</span>) {
</span></span><span style="display:flex;"><span>			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;any&#39; length must less than &#39;3&#39;&#34;</span>))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !(<span style="color:#8be9fd;font-style:italic">len</span>(m.Any) <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">4</span>) {
</span></span><span style="display:flex;"><span>			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;any&#39; length must great than &#39;4&#39;&#34;</span>))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(m.Email) <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !is.<span style="color:#50fa7b">Email</span>(m.Email) {
</span></span><span style="display:flex;"><span>			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;email&#39; is not a valid email&#34;</span>))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> is.<span style="color:#50fa7b">MargeErr</span>(errs<span style="color:#ff79c6">...</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="4验证">4.验证</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span> 	p <span style="color:#ff79c6">:=</span> pb.Person{}
</span></span><span style="display:flex;"><span>	p.Age = <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>	p.Email = <span style="color:#f1fa8c">&#34;11&#34;</span>
</span></span><span style="display:flex;"><span> 	err <span style="color:#ff79c6">:=</span> p.<span style="color:#50fa7b">Validate</span>()
</span></span><span style="display:flex;"><span> 	log.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;%v\n&#34;</span>, err)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// output:  field &#39;age&#39; must great than &#39;10&#39;;field &#39;any&#39; is required;field &#39;email&#39; is not a valid email
</span></span></span></code></pre></div><p>多个错误时，使用 <code>;</code> 隔开</p>
<h2 id="语法解析">语法解析</h2>
<p><code>protoc-gen-validator</code> 通过解析 <code>protobuf</code> 中的注释来生成 <code>Validate()</code> 规则。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#6272a4">// +gen:ignore
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// +gen:required
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">string</span> field1 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// +gen:required;email
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_len=3
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">string</span> field2 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="语法规则">语法规则</h3>
<p>有效的注释有以下的规则:</p>
<ul>
<li>注释必须以 <code>+gen</code> 作为开头</li>
<li>注释的内容必须紧贴对应的字段，中间不能有空行</li>
<li>支持多行注释，也可以将多行合并成一行，并用 <code>;</code> 作为分隔符</li>
</ul>
<h3 id="类型支持">类型支持</h3>
<p><code>message</code> 类型规则:</p>
<ul>
<li>ignore: 忽略该 message ，不生成 <code>Validate()</code> 方法</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#6272a4">// +gen:ignore
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">P</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>message</code> 作为内嵌字段时支持的规则:</p>
<ul>
<li>required: 判断该字段是否为 nil。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">P</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// +gen:required
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    Sub sub <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Sub</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>注: 在引用外部的 message 时，请确认 message 存在 Validate() 方法</p>
</blockquote>
<p><code>string</code> 类型支持的规则</p>
<ul>
<li>required: 判断是否为空</li>
<li>default: 字段为空时指定的默认值，(不可用 required 同时使用)</li>
<li>in, enum: 判断字段的值是否存在于指定的列表中</li>
<li>not_in: 判断字段的值是否在指定的列表之外</li>
<li>min_len: 指定字段的最小长度</li>
<li>max_len: 指定字段的最大长度</li>
<li>prefix: 判断字段是否以给定的值为开头</li>
<li>suffix: 判断字段是否以给定的值为结尾</li>
<li>contains: 判断字段是否包含给定的值</li>
<li>pattern: 判断该字段是否为有效的正则表达式</li>
<li>number: 判断该字段是否为有效数字</li>
<li>email: 判断该字段是否为有效的邮箱地址</li>
<li>ip: 判断该字段是否为有效的 ip 地址</li>
<li>ipv4: 判断该字段是否为有效的 ipv4</li>
<li>ipv6: 判断该字段是否为有效的 ipv6</li>
<li>crontab: 判断该字段是否为有效的 crontab 表达式</li>
<li>uuid: 判断该字段是否为有效的 uuid v4</li>
<li>uri: 判断该字段是否为有效的 uri</li>
<li>domain: 判断该字段是否为有效的域名</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">S</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// +gen:required
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:default=&#34;hello&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:in=[&#34;1&#34;, &#34;2&#34;, &#34;3&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:enum=[&#34;a&#34;, &#34;b&#34;, &#34;c&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:not_in=[&#34;d&#34;, &#34;s&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_len=3
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_max=4
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:prefix=&#34;http&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:suffix=&#34;.com&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:contains=&#34;www&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:pattern=`\d+(\w+){3,5}`
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:number
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:ip
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:ipv4
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:ipv6
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:crontab
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:uuid
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:uri
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:domain
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">string</span> m <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>注: string pattern 最好单独一行，以免和其他规则冲突</p>
</blockquote>
<p>数字类型的支持，包含 int32, int64, fixed32, fix64, float, double</p>
<ul>
<li>required: 判断是否为 0</li>
<li>default: 字段为空时指定的默认值，(不可用 required 同时使用)</li>
<li>in, enum: 判断字段的值是否存在于指定的列表中</li>
<li>not_in: 判断字段的值是否在指定的列表之外</li>
<li>lt: 指定字段小于指定值</li>
<li>lte: 指定字段的小于等于指定值</li>
<li>gt: 指定字段大于指定值</li>
<li>gte: 指定字段大于等于指定值</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">S</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// +gen:required
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">float</span> a <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// +gen:default=3.14
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">double</span> pi <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// +gen:in=[1,2,3]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:enum=[2,3]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:not_in=[4,5]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int32</span> b <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// +gen:ge=3
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +ggen:gte=4
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:lte=9
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:lt=10
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int64</span> c <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>bytes</code> 类型的支持:</p>
<ul>
<li>required: 判断字段的长度是否为0</li>
<li>min_bytes: 判断字段的最小字节数是否大于给定值</li>
<li>max_bytes: 判断字段的最大字节数是否小于给定值</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">S</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// +gen:required
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_bytes=10
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_bytes=1024
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">bytes</span> any <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>repeated 类型的支持：repeated 类型的字段在 golang 中会被解析成切片。</p>
<ul>
<li>required: 判断切片的长度是否为0</li>
<li>min_len: 判断切片的最小长度是否大于给定值</li>
<li>max_len: 判断切片的最大长度是否小于给定值</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">S</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// +gen:required
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_len=3
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:max_len=5
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">repeated</span> <span style="color:#8be9fd">string</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="内嵌-message">内嵌 message</h3>
<p><code>protoc-gen-validator</code> 支持解析内嵌 message, 使用 <code>+gen:inline</code> 可以将子 message 中的字段嵌入该 message。实例如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Meta</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:required
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:required
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">int64</span> id <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Request</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:inline
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:required
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  Meta meta <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">string</span> data <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>解析出来的内容如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func (m *Meta) Validate() error {
</span></span><span style="display:flex;"><span>	return m.ValidateE(<span style="color:#f1fa8c">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func (m *Meta) ValidateE(prefix <span style="color:#8be9fd">string</span>) error {
</span></span><span style="display:flex;"><span>	errs <span style="color:#ff79c6">:=</span> make([]error, <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>	if len(m.Name) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
</span></span><span style="display:flex;"><span>		errs <span style="color:#ff79c6">=</span> append(errs, fmt.Errorf(<span style="color:#f1fa8c">&#34;field &#39;%sname&#39; is required&#34;</span>, prefix))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	if <span style="color:#8be9fd">int64</span>(m.Id) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
</span></span><span style="display:flex;"><span>		errs <span style="color:#ff79c6">=</span> append(errs, fmt.Errorf(<span style="color:#f1fa8c">&#34;field &#39;%sid&#39; is required&#34;</span>, prefix))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	return is.MargeErr(errs...)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func (m *Request) Validate() error {
</span></span><span style="display:flex;"><span>	return m.ValidateE(<span style="color:#f1fa8c">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func (m *Request) ValidateE(prefix <span style="color:#8be9fd">string</span>) error {
</span></span><span style="display:flex;"><span>	errs <span style="color:#ff79c6">:=</span> make([]error, <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>	if len(m.Name) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
</span></span><span style="display:flex;"><span>		errs <span style="color:#ff79c6">=</span> append(errs, fmt.Errorf(<span style="color:#f1fa8c">&#34;field &#39;%sname&#39; is required&#34;</span>, prefix))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	if <span style="color:#8be9fd">int64</span>(m.Id) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
</span></span><span style="display:flex;"><span>		errs <span style="color:#ff79c6">=</span> append(errs, fmt.Errorf(<span style="color:#f1fa8c">&#34;field &#39;%sid&#39; is required&#34;</span>, prefix))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	return is.MargeErr(errs...)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func (m *Response) Validate() error {
</span></span><span style="display:flex;"><span>	return m.ValidateE(<span style="color:#f1fa8c">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func (m *Response) ValidateE(prefix <span style="color:#8be9fd">string</span>) error {
</span></span><span style="display:flex;"><span>	errs <span style="color:#ff79c6">:=</span> make([]error, <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>	return is.MargeErr(errs...)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1cef3190b3d455150f6a09aa20c5c878">5 - protoc-gen-deepcopy</h1>
    <div class="lead">使用 protoc-gen-deepcopy 生成资源的 deepcopy 接口。</div>
	<h2 id="概述">概述</h2>
<p>protoc-gen-deepcopy 帮助用户生成资源的深拷贝接口，减少用户编写代码。</p>
<h2 id="使用">使用</h2>
<h3 id="1先编写-deepcopyproto-文件">1.先编写 deepcopy.proto 文件</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#6272a4">// +gen:deepcopy
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Person</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">bytes</span> any <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">string</span> email <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="2安装-protoc-gen-deepcopy">2.安装 protoc-gen-deepcopy</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get github.com/vine-io/vine/cmd/protoc-gen-deepcopy
</span></span></code></pre></div><h3 id="3生成-validate-方法">3.生成 Validate() 方法</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src --gogo_out<span style="color:#ff79c6">=</span>:.  --deepcopy_out<span style="color:#ff79c6">=</span>:. proto/deepcopy.proto
</span></span></code></pre></div><p>执行完成后生成以下代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#6272a4">// DeepCopyInto is an auto-generated deepcopy function, coping the receiver, writing into out. in must be no-nil.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (in <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">DeepCopyInto</span>(out <span style="color:#ff79c6">*</span>Person) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">*</span>out = <span style="color:#ff79c6">*</span>in
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// DeepCopy is an auto-generated deepcopy function, copying the receiver, creating a new Person.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (in <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">DeepCopy</span>() <span style="color:#ff79c6">*</span>Person {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> in <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	out <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">new</span>(Person)
</span></span><span style="display:flex;"><span>	in.<span style="color:#50fa7b">DeepCopyInto</span>(out)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> out
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="4验证">4.验证</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	p <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>helloworld.Person{
</span></span><span style="display:flex;"><span>		Name:  <span style="color:#f1fa8c">&#34;Vine&#34;</span>,
</span></span><span style="display:flex;"><span>		Any:   []<span style="color:#8be9fd;font-style:italic">byte</span>(<span style="color:#f1fa8c">&#34;Hello&#34;</span>),
</span></span><span style="display:flex;"><span>		Email: <span style="color:#f1fa8c">&#34;aa@gmail.com&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;%p %v\n&#34;</span>, p, p)
</span></span><span style="display:flex;"><span>	pc <span style="color:#ff79c6">:=</span> p.<span style="color:#50fa7b">DeepCopy</span>()
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;%p %v\n&#34;</span>, pc, pc)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// output:  
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//  0xc0002ea280 name:&#34;Vine&#34; any:&#34;Hello&#34; email:&#34;aa@gmail.com&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//  0xc0002ea2c0 name:&#34;Vine&#34; any:&#34;Hello&#34; email:&#34;aa@gmail.com&#34;
</span></span></span></code></pre></div><h2 id="语法解析">语法解析</h2>
<p><code>protoc-gen-deepcopy</code> 通过解析 <code>protobuf</code> 中的注释来生成 <code>deepcopy</code> 接口。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#6272a4">// +gen:deepcopy
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">string</span> field1 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">string</span> field2 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="语法规则">语法规则</h3>
<p>有效的注释有以下的规则:</p>
<ul>
<li>注释必须以 <code>+gen</code> 作为开头</li>
<li>注释的内容必须紧贴对应的字段，中间不能有空行</li>
</ul>
<h3 id="类型支持">类型支持</h3>
<p><code>message</code> 类型规则:</p>
<ul>
<li>deepcopy: 生成 DeepCopy 方法</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#6272a4">// +gen:deepcopy
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">P</span> {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-148255df01058e3f71315560bc42a419">6 - protoc-gen-dao</h1>
    <div class="lead"><em>Dao</em> 通过 <code>protoc-gen-dao</code> 生成数据库CURD代码。</div>
	<h2 id="概述">概述</h2>
<p><code>Dao</code> 是 <strong>Vine</strong> 框架的数据库交互模块，而<code>protoc-gen-dao</code>工具则可以通过识别<code>*.proto</code>来生成对应的数据库交互代码。减少大量重复代码的编写，提高用户效率。</p>
<h2 id="使用">使用</h2>
<h3 id="1先编写-userproto-文件">1.先编写 user.proto 文件</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span>syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;proto3&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">package</span> v1;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:dao
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">User</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// +gen:pk
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> id <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">repeated</span> <span style="color:#8be9fd">string</span> following <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  map&lt;<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd">string</span>&gt; tags <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Other other <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">5</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Other</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">string</span> k <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">string</span> v <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="2安装-protoc-gen-dao">2.安装 protoc-gen-dao</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get github.com/vine-io/vine/cmd/protoc-gen-dao
</span></span></code></pre></div><h3 id="3生成curd代码">3.生成CURD代码</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src --gogofaster_out<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">plugins</span><span style="color:#ff79c6">=</span>grpc:.  --dao_out<span style="color:#ff79c6">=</span>:. proto/dao.proto
</span></span></code></pre></div><p>执行完成后生成以下文件:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>-rw-r--r--  <span style="color:#bd93f9">1</span> lack  staff   7.8K Mar <span style="color:#bd93f9">19</span> 22:26 user.pb.dao.go
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#bd93f9">1</span> lack  staff    20K Mar <span style="color:#bd93f9">19</span> 22:26 user.pb.go
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#bd93f9">1</span> lack  staff   255B Mar <span style="color:#bd93f9">18</span> 23:00 user.proto
</span></span></code></pre></div><p><code>*.pb.dao.go</code> 中保存着CURD代码。</p>
<h3 id="4curd-实例">4.CURD 实例</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	dao.DefaultDialect = sqlite.<span style="color:#50fa7b">NewDialect</span>(dao.<span style="color:#50fa7b">DSN</span>(<span style="color:#f1fa8c">&#34;user.db&#34;</span>), dao.<span style="color:#50fa7b">Logger</span>(logger.Default.<span style="color:#50fa7b">LogMode</span>(logger.Info)))
</span></span><span style="display:flex;"><span>	dao.DefaultDialect.<span style="color:#50fa7b">Init</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// 注册 Schema, 会在数据库中创建对应的表
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	v1.<span style="color:#50fa7b">RegistryUser</span>(<span style="color:#ff79c6">&amp;</span>v1.User{})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ctx <span style="color:#ff79c6">:=</span> context.<span style="color:#50fa7b">TODO</span>()
</span></span><span style="display:flex;"><span>	u <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>v1.User{
</span></span><span style="display:flex;"><span>		Id: <span style="color:#f1fa8c">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>		Name: <span style="color:#f1fa8c">&#34;Lack&#34;</span>,
</span></span><span style="display:flex;"><span>		Following: []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;JJ&#34;</span>, <span style="color:#f1fa8c">&#34;OO&#34;</span>},
</span></span><span style="display:flex;"><span>		Tags: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;label&#34;</span>: <span style="color:#f1fa8c">&#34;vv&#34;</span>},
</span></span><span style="display:flex;"><span>		Other:     <span style="color:#ff79c6">&amp;</span>v1.Other{
</span></span><span style="display:flex;"><span>			K: <span style="color:#f1fa8c">&#34;k1&#34;</span>,
</span></span><span style="display:flex;"><span>			V: <span style="color:#f1fa8c">&#34;v1&#34;</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Create ==============&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>	out, err <span style="color:#ff79c6">:=</span> v1.<span style="color:#50fa7b">FromUser</span>(u).<span style="color:#50fa7b">Create</span>(ctx)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Fatal</span>(err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#50fa7b">Println</span>(out)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Updates ==============&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>	out, err = v1.<span style="color:#50fa7b">FromUser</span>(<span style="color:#ff79c6">&amp;</span>v1.User{Id: <span style="color:#f1fa8c">&#34;1&#34;</span>, Tags: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;aa&#34;</span>: <span style="color:#f1fa8c">&#34;vv&#34;</span>}}).<span style="color:#50fa7b">Updates</span>(ctx)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Fatal</span>(err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#50fa7b">Println</span>(out)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;FindAll ==============&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>	outs, err <span style="color:#ff79c6">:=</span> v1.<span style="color:#50fa7b">FromUser</span>(<span style="color:#ff79c6">&amp;</span>v1.User{Tags: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;aa&#34;</span>: <span style="color:#f1fa8c">&#34;vv&#34;</span>}}).<span style="color:#50fa7b">FindAll</span>(ctx)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Fatal</span>(err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#50fa7b">Println</span>(outs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;FindOne ==============&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>	out, err = v1.<span style="color:#50fa7b">FromUser</span>(<span style="color:#ff79c6">&amp;</span>v1.User{Id: <span style="color:#f1fa8c">&#34;1&#34;</span>}).<span style="color:#50fa7b">FindOne</span>(ctx)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Fatal</span>(err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#50fa7b">Println</span>(outs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;SoftDelete ==============&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>	err = v1.<span style="color:#50fa7b">FromUser</span>(<span style="color:#ff79c6">&amp;</span>v1.User{Id: <span style="color:#f1fa8c">&#34;1&#34;</span>}).<span style="color:#50fa7b">SoftDelete</span>(ctx)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Fatal</span>(err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Delete ==============&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>	err = v1.<span style="color:#50fa7b">FromUser</span>(<span style="color:#ff79c6">&amp;</span>v1.User{Id: <span style="color:#f1fa8c">&#34;1&#34;</span>}).<span style="color:#50fa7b">Delete</span>(ctx)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#6272a4">//log.Fatal(err)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>事务支持</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">getDB</span>() (dao.Dialect, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	dsn <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">`your dns`</span>
</span></span><span style="display:flex;"><span>	dialect <span style="color:#ff79c6">:=</span> mysql.<span style="color:#50fa7b">NewDialect</span>(dao.<span style="color:#50fa7b">DSN</span>(dsn))
</span></span><span style="display:flex;"><span>	err <span style="color:#ff79c6">:=</span> dialect.<span style="color:#50fa7b">Init</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	dao.DefaultDialect = dialect
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> dialect, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">TestRegisterCore</span>(t <span style="color:#ff79c6">*</span>testing.T) {
</span></span><span style="display:flex;"><span>	db, err <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">getDB</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		t.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;get db: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> err = <span style="color:#50fa7b">RegisterCore</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		t.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;registry core: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> err = <span style="color:#50fa7b">RegisterUser</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		t.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;registry user: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ctx <span style="color:#ff79c6">:=</span> context.<span style="color:#50fa7b">TODO</span>()
</span></span><span style="display:flex;"><span>	tx <span style="color:#ff79c6">:=</span> db.<span style="color:#50fa7b">NewTx</span>().<span style="color:#50fa7b">Begin</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> _, err = <span style="color:#50fa7b">CoreStorageBuilder</span>().
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">SetUid</span>(<span style="color:#f1fa8c">&#34;2&#34;</span>).<span style="color:#50fa7b">Create</span>(ctx); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		tx.<span style="color:#50fa7b">Rollback</span>()
</span></span><span style="display:flex;"><span>		t.<span style="color:#50fa7b">Errorf</span>(<span style="color:#f1fa8c">&#34;create core: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> _, err = <span style="color:#50fa7b">UserStorageBuilder</span>().<span style="color:#50fa7b">WithTx</span>(tx).
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">SetUid</span>(<span style="color:#f1fa8c">&#34;1&#34;</span>).
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">SetName</span>(<span style="color:#f1fa8c">&#34;user1&#34;</span>).
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">Create</span>(ctx); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		tx.<span style="color:#50fa7b">Rollback</span>()
</span></span><span style="display:flex;"><span>		t.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;create core: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> err = tx.<span style="color:#50fa7b">Commit</span>().Error; err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		t.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;commit %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="语法解析">语法解析</h2>
<p><code>protoc-gen-dao</code> 通过解析 <code>protobuf</code> 中的注释来生成代码。repeated, map, message 字段会生成新的结构体，在数据库中存储格式为 json。
每个带<code>+gen:dao</code>注释的 message 会生成 *Schema 结构体，并生成对应的 CURD 方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#6272a4">// 注册 User 相应的数据库表
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">RegistryUser</span>(in <span style="color:#ff79c6">*</span>User) <span style="color:#8be9fd">error</span> 
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// User =&gt; UserSchema, 忽略空值字段
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">FromUser</span>(in <span style="color:#ff79c6">*</span>User) <span style="color:#ff79c6">*</span>UserSchema 
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// UserSchema =&gt; User
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">ToUser</span>() <span style="color:#ff79c6">*</span>User
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// User 结构体在数据库中的表名
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (UserSchema) <span style="color:#50fa7b">TableName</span>() <span style="color:#8be9fd">string</span> 
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 主键信息，返回主键名称、值、是否为零值
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m UserSchema) <span style="color:#50fa7b">PrimaryKey</span>() (<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd;font-style:italic">interface</span>{}, <span style="color:#8be9fd">bool</span>)
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 分页查询，等同 FindAll 和 Count
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">FindPage</span>(ctx context.Context, page, size <span style="color:#8be9fd">int</span>, exprs <span style="color:#ff79c6">...</span>clause.Expression) ([]<span style="color:#ff79c6">*</span>User, <span style="color:#8be9fd">int64</span>, <span style="color:#8be9fd">error</span>) 
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 查询所有符合的记录
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">FindAll</span>(ctx context.Context, exprs <span style="color:#ff79c6">...</span>clause.Expression) ([]<span style="color:#ff79c6">*</span>User, <span style="color:#8be9fd">error</span>) 
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 查询符合的记录总量
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">Count</span>(ctx context.Context, exprs <span style="color:#ff79c6">...</span>clause.Expression) (<span style="color:#8be9fd">int64</span>, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 查询首条符合的记录
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">FindOne</span>(ctx context.Context, exprs <span style="color:#ff79c6">...</span>clause.Expression) (<span style="color:#ff79c6">*</span>User, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 插入一条记录
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">Create</span>(ctx context.Context) (<span style="color:#ff79c6">*</span>User, <span style="color:#8be9fd">error</span>) 
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 更新记录
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">Updates</span>(ctx context.Context) (<span style="color:#ff79c6">*</span>User, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 软删除
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">Delete</span>(ctx context.Context, soft) <span style="color:#8be9fd">error</span> 
</span></span></code></pre></div><h3 id="类型转化">类型转化</h3>
<p>slice、map、message 自动生成实现 driver.Valuer 接口的类型</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#ff79c6">repeated</span> <span style="color:#8be9fd">string</span> following <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;
</span></span></code></pre></div><p>生成</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">type</span> UserFollowing []<span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Value return json value, implement driver.Valuer interface
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m UserFollowing) <span style="color:#50fa7b">Value</span>() (driver.Value, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(m) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	b, err <span style="color:#ff79c6">:=</span> _go.<span style="color:#50fa7b">Marshal</span>(m)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">string</span>(b), err
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Scan scan value into Jsonb, implements sql.Scanner interface
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserFollowing) <span style="color:#50fa7b">Scan</span>(value <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd;font-style:italic">var</span> bytes []<span style="color:#8be9fd">byte</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">switch</span> v <span style="color:#ff79c6">:=</span> value.(<span style="color:#8be9fd;font-style:italic">type</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">case</span> []<span style="color:#8be9fd">byte</span>:
</span></span><span style="display:flex;"><span>		bytes = v
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">case</span> <span style="color:#8be9fd">string</span>:
</span></span><span style="display:flex;"><span>		bytes = []<span style="color:#8be9fd;font-style:italic">byte</span>(v)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">default</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(fmt.<span style="color:#50fa7b">Sprint</span>(<span style="color:#f1fa8c">&#34;Failed to unmarshal JSONB value:&#34;</span>, value))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> _go.<span style="color:#50fa7b">Unmarshal</span>(bytes, <span style="color:#ff79c6">&amp;</span>m)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserFollowing) <span style="color:#50fa7b">DaoDataType</span>() <span style="color:#8be9fd">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;json&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span>map&lt;<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd">string</span>&gt; tags <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;
</span></span></code></pre></div><p>生成</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">type</span> UserTags <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Value return json value, implement driver.Valuer interface
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m UserTags) <span style="color:#50fa7b">Value</span>() (driver.Value, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(m) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	b, err <span style="color:#ff79c6">:=</span> _go.<span style="color:#50fa7b">Marshal</span>(m)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">string</span>(b), err
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Scan scan value into Jsonb, implements sql.Scanner interface
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserTags) <span style="color:#50fa7b">Scan</span>(value <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd;font-style:italic">var</span> bytes []<span style="color:#8be9fd">byte</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">switch</span> v <span style="color:#ff79c6">:=</span> value.(<span style="color:#8be9fd;font-style:italic">type</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">case</span> []<span style="color:#8be9fd">byte</span>:
</span></span><span style="display:flex;"><span>		bytes = v
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">case</span> <span style="color:#8be9fd">string</span>:
</span></span><span style="display:flex;"><span>		bytes = []<span style="color:#8be9fd;font-style:italic">byte</span>(v)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">default</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(fmt.<span style="color:#50fa7b">Sprint</span>(<span style="color:#f1fa8c">&#34;Failed to unmarshal JSONB value:&#34;</span>, value))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> _go.<span style="color:#50fa7b">Unmarshal</span>(bytes, <span style="color:#ff79c6">&amp;</span>m)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserTags) <span style="color:#50fa7b">DaoDataType</span>() <span style="color:#8be9fd">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;json&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span>Other other <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">5</span>;
</span></span></code></pre></div><p>生成</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">type</span> UserOther Other
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Value return json value, implement driver.Valuer interface
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserOther) <span style="color:#50fa7b">Value</span>() (driver.Value, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> m <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	b, err <span style="color:#ff79c6">:=</span> _go.<span style="color:#50fa7b">Marshal</span>(m)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">string</span>(b), err
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Scan scan value into Jsonb, implements sql.Scanner interface
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserOther) <span style="color:#50fa7b">Scan</span>(value <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd;font-style:italic">var</span> bytes []<span style="color:#8be9fd">byte</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">switch</span> v <span style="color:#ff79c6">:=</span> value.(<span style="color:#8be9fd;font-style:italic">type</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">case</span> []<span style="color:#8be9fd">byte</span>:
</span></span><span style="display:flex;"><span>		bytes = v
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">case</span> <span style="color:#8be9fd">string</span>:
</span></span><span style="display:flex;"><span>		bytes = []<span style="color:#8be9fd;font-style:italic">byte</span>(v)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">default</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(fmt.<span style="color:#50fa7b">Sprint</span>(<span style="color:#f1fa8c">&#34;Failed to unmarshal JSONB value:&#34;</span>, value))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> _go.<span style="color:#50fa7b">Unmarshal</span>(bytes, <span style="color:#ff79c6">&amp;</span>m)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserOther) <span style="color:#50fa7b">DaoDataType</span>() <span style="color:#8be9fd">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;json&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="json-支持">JSON 支持</h3>
<p><code>protoc-gen-dao</code> 将 slice、map 和 message 类型的字段转化为JSON格式并存储到数据库中，同时 Dao 支持通过 JSON 来作为查询条件。以下是JSON格式查询的条件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span>    <span style="color:#6272a4">// slice 格式，查询slice包含指定项的记录
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(m.Following) <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">for</span> _, item <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> m.Following {
</span></span><span style="display:flex;"><span>			exprs = <span style="color:#8be9fd;font-style:italic">append</span>(exprs, dao.DefaultDialect.<span style="color:#50fa7b">JSONBuild</span>(<span style="color:#f1fa8c">&#34;following&#34;</span>).<span style="color:#50fa7b">Tx</span>(tx).<span style="color:#50fa7b">Contains</span>(item))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// map 格式，查询kv符合条件的记录，key 类型必须为 string
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> m.Tags <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">for</span> k, v <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> m.Tags {
</span></span><span style="display:flex;"><span>			exprs = <span style="color:#8be9fd;font-style:italic">append</span>(exprs, dao.DefaultDialect.<span style="color:#50fa7b">JSONBuild</span>(<span style="color:#f1fa8c">&#34;tags&#34;</span>).<span style="color:#50fa7b">Tx</span>(tx).<span style="color:#50fa7b">Equals</span>(v, k))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// struct 格式，精确查询 JSON 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// 支持两种方式:
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">//  * 当传入 key 的值为空，查询对应 JSON key 是否存在
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">//  * 当传入 key 为确定值时，查询对应 JSON key 是否等于对应的值
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> m.Other <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">for</span> k, v <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> dao.<span style="color:#50fa7b">FieldPatch</span>(m.Other) {
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">if</span> v <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>				exprs = <span style="color:#8be9fd;font-style:italic">append</span>(exprs, dao.DefaultDialect.<span style="color:#50fa7b">JSONBuild</span>(<span style="color:#f1fa8c">&#34;other&#34;</span>).<span style="color:#50fa7b">Tx</span>(tx).<span style="color:#50fa7b">HasKeys</span>(strings.<span style="color:#50fa7b">Split</span>(k, <span style="color:#f1fa8c">&#34;,&#34;</span>)<span style="color:#ff79c6">...</span>))
</span></span><span style="display:flex;"><span>			} <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>				exprs = <span style="color:#8be9fd;font-style:italic">append</span>(exprs, dao.DefaultDialect.<span style="color:#50fa7b">JSONBuild</span>(<span style="color:#f1fa8c">&#34;other&#34;</span>).<span style="color:#50fa7b">Tx</span>(tx).<span style="color:#50fa7b">Equals</span>(v, strings.<span style="color:#50fa7b">Split</span>(k, <span style="color:#f1fa8c">&#34;,&#34;</span>)<span style="color:#ff79c6">...</span>))
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><blockquote>
<p>注: 如果默认数据库选择 Sqlite3 时，默认不支持 json_each, json_extract 方法，需要添加 -tags 选项。 <code>go build -tags JSON1 main.go</code></p>
</blockquote>
<h3 id="语法规则">语法规则</h3>
<p>有效的注释有以下的规则:</p>
<ul>
<li>注释必须以 <code>+gen</code> 作为开头</li>
<li>注释的内容必须紧贴对应的字段，中间不能有空行</li>
<li>支持多行注释，也可以将多行合并成一行，并用 <code>;</code> 作为分隔符</li>
<li>只有带 <code>+gen:dao</code> 注释的 message 才会生成 CURD 代码</li>
</ul>
<h3 id="语法支持">语法支持</h3>
<h4 id="代码输出路径">代码输出路径</h4>
<p><code>protoc-gen-dao</code> 支持将CURD代码输出到指定路径</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#6272a4">// +dao:output=github.com/vine-io/vine/testdata/db/dao;dao
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;protoc&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">...</span>
</span></span></code></pre></div><p>使用 <code>+dao:output=</code>为开头，写在 protobuf 文件头部，指定生成的路径(对应$GOPATH)和生成 package 名称。</p>
<h4 id="message-支持">message 支持</h4>
<p>message 支持以下注释:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#6272a4">// +gen:dao  =&gt; 只有标识该注释的 message 才会生成 CURD 代码
</span></span></span></code></pre></div><h4 id="field-支持">field 支持</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#6272a4">// +gen:pk   =&gt; 指定字段为主键(必须), 可以是 string 和 数字, 当 int 类型时自增 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//              当多个 PK 字段存在时，默认选择第一个。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:inline =&gt; 只能用在 message field 中，将 message 的字段直接解析为父 message 的字段
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// +gen:daoInject =&gt; 注入额外的数据库约束，详细请看 https://gorm.io/zh_CN/docs/models.html
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">...</span>
</span></span></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="" aria-label="">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="">
      <i class=""></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 The Docsy Authors All Rights Reserved</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank">隐私政策</a></small>
	
		<p class="mt-2"><a href="/vine/about/">关于</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>


<script src="https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js" integrity="sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj" crossorigin="anonymous"></script>










<script src="/vine/js/main.min.163d123d0686e32440643e7e6a262d74812afcf72ef040b4512877d807100e4e.js" integrity="sha256-Fj0SPQaG4yRAZD5&#43;aiYtdIEq/Pcu8EC0USh32AcQDk4=" crossorigin="anonymous"></script>




  </body>
</html>
