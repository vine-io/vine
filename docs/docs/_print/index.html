<!doctype html>
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.87.0" /><link rel="canonical" type="text/html" href="https://vine-io.github.io/vine/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="https://vine-io.github.io/vine/docs/index.xml">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="shortcut icon" href="/vine/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/vine/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/vine/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/vine/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/vine/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/vine/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/vine/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/vine/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/vine/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/vine/favicons/android-192x192.png" sizes="192x192">

<title>æ¬¢è¿æ¥åˆ° Vine æ–‡æ¡£ | Vine</title><meta property="og:title" content="æ¬¢è¿æ¥åˆ° Vine æ–‡æ¡£" />
<meta property="og:description" content="Vine æ–‡æ¡£" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://vine-io.github.io/vine/docs/" /><meta property="og:site_name" content="Vine" />

<meta itemprop="name" content="æ¬¢è¿æ¥åˆ° Vine æ–‡æ¡£">
<meta itemprop="description" content="Vine æ–‡æ¡£"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="æ¬¢è¿æ¥åˆ° Vine æ–‡æ¡£"/>
<meta name="twitter:description" content="Vine æ–‡æ¡£"/>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






<link rel="preload" href="/vine/scss/main.min.bd19fcdf38c012b14ad8d3c8432efd8cf1740a17234311f030bcb495e955a2cf.css" as="style">
<link href="/vine/scss/main.min.bd19fcdf38c012b14ad8d3c8432efd8cf1740a17234311f030bcb495e955a2cf.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>




  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/vine/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">Vine</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a  class="nav-link active" href="/vine/docs/" ><span class="active">æ–‡æ¡£</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a  class="nav-link" href="https://github.com/vine-io/vine-example" target="_blank" ><span>å®ä¾‹</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a  class="nav-link" href="https://github.com/vine-io/vine" target="_blank" ><span>GitHub</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
<input type="search" class="form-control td-search-input" placeholder="&#xf002 ç«™å†…æœç´¢â€¦" aria-label="ç«™å†…æœç´¢â€¦" autocomplete="off">

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/vine/docs/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">æ¬¢è¿æ¥åˆ° Vine æ–‡æ¡£</h1>






<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-08b1b69f6319108b0455d24614fdd660">1 - å¿«é€Ÿå¼€å§‹</h1>
    
	<p>è¿™é‡Œæä¾›ä¸€ä¸ªç®€å•çš„å®ä¾‹ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿäº†è§£ <strong>Vine</strong> æ¡†æ¶ã€‚</p>
<h2 id="å®šä¹‰æ¥å£">å®šä¹‰æ¥å£</h2>
<h3 id="æ–°å»ºé¡¹ç›®">æ–°å»ºé¡¹ç›®</h3>
<p>æ–°å»ºç›®å½•ä¿å­˜ç›¸å…³ä»£ç :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/greet
</code></pre></div><blockquote>
<p>å»ºè®®é¡¹ç›®ä¿å­˜åœ¨ $GOPATH ä¸‹</p>
</blockquote>
<h3 id="æ–°å»º-proto-æ–‡ä»¶">æ–°å»º *.proto æ–‡ä»¶</h3>
<p><strong>Vine</strong> å†…éƒ¨ä½¿ç”¨ <code>gRPC</code> ä½œä¸ºæœåŠ¡ç«¯ï¼Œ<code>*.proto</code> æ˜¯ google å…¬å¸å¼€æºçš„ä¸€ç§æ•°æ®äº¤æ¢åè®®ï¼Œç±»ä¼¼ <code>json</code>ã€‚å…³äº <code>protobuf</code> æ›´è¯¦ç»†çš„è¯­æ³•å¯ä»¥å‚è€ƒ<a href="https://developers.google.com/protocol-buffers/docs/gotutorial">protobuf</a>ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬æ–°å»º <code>greet.proto</code> æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// mysite/proto/greet.proto
</span><span style="color:#6272a4"></span>syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;proto3&#34;</span>;

<span style="color:#ff79c6">package</span> greet;

<span style="color:#8be9fd;font-style:italic">service</span> Greeter {
  <span style="color:#ff79c6">rpc</span> Echo(EchoReq) <span style="color:#ff79c6">returns</span> (EchoRsp) {}
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">EchoReq</span> {
  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">EchoRsp</span> {
  <span style="color:#8be9fd">string</span> greeting <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div><blockquote>
<p>æ›´å¤šçš„å…³äº <strong>Vine</strong> çš„è¯­æ³•è§„åˆ™å¯ä»¥å‚è€ƒ <a href="/vine/docs/guides/openapi/">protoc-gen-vine</a></p>
</blockquote>
<h3 id="ç”Ÿæˆ-api-æ¥å£">ç”Ÿæˆ API æ¥å£</h3>
<p>ä½ éœ€è¦ä»¥ä¸‹çš„å·¥å…·æ¥ç”Ÿæˆ proto ä»£ç </p>
<ul>
<li><a href="https://github.com/protocolbuffers/protobuf">protoc</a></li>
<li><a href="https://github.com/vine-io/vine/tree/master/cmd/protoc-gen-gogo">protoc-gen-gogo</a></li>
<li><a href="https://github.com/vine-io/vine/tree/master/cmd/protoc-gen-vine">protoc-gen-vine</a></li>
</ul>
<p>ä½¿ç”¨ protocã€protoc-gen-gogoã€protoc-gen-vine æ¥ç”Ÿæˆ protobuf code</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/gogo/protobuf
go get github.com/vine-io/vine/cmd/protoc-gen-gogo
go get github.com/vine-io/vine/cmd/protoc-gen-vine
</code></pre></div><p>ä½¿ç”¨å‘½ä»¤ç”Ÿæˆ <code>greet.pb.go</code> å’Œ <code>greet.vine.go</code> æ–‡ä»¶:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8be9fd;font-style:italic">cd</span> <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src
protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src --gogo_out<span style="color:#ff79c6">=</span>:. --vine_out<span style="color:#ff79c6">=</span>:. mysite/proto/greet.proto
</code></pre></div><p>æ‰§è¡ŒæˆåŠŸåä¼šç”Ÿæˆæ–°çš„æ–‡ä»¶:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mysite
â””â”€â”€ proto
    â”œâ”€â”€ greet.pb.go       <span style="color:#6272a4"># é€šè¿‡ protoc-gen-gogo æ’ä»¶ç”Ÿæˆï¼ŒåŒ…å«ç»“æ„ä½“å’Œ gRPC çš„æ¥å£</span>
    â”œâ”€â”€ greet.pb.vine.go  <span style="color:#6272a4"># é€šè¿‡ protoc-gen-vine æ’ä»¶ç”Ÿæˆï¼ŒåŒ…å« Vine æ¡†æ¶æ¥å£</span>
    â””â”€â”€ greet.proto

</code></pre></div><h2 id="å®šä¹‰æœåŠ¡">å®šä¹‰æœåŠ¡</h2>
<h3 id="å®ç°-vine-æœåŠ¡">å®ç° Vine æœåŠ¡</h3>
<p>æœ‰äº† proto æ–‡ä»¶åï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç¼–å†™æœåŠ¡ç«¯ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">mkdir -p server
touch mysite/server/main.go
</code></pre></div><p>æœåŠ¡ç«¯ä»£ç :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>
	<span style="color:#f1fa8c">&#34;log&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
	pb <span style="color:#f1fa8c">&#34;mysite/proto&#34;</span>
)

<span style="color:#6272a4">// greet éœ€è¦å®ç° pb.Greet çš„æ¥å£
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> greet <span style="color:#8be9fd;font-style:italic">struct</span> {}

<span style="color:#8be9fd;font-style:italic">func</span> (g <span style="color:#ff79c6">*</span>greet) <span style="color:#50fa7b">Echo</span>(ctx context.Context, req <span style="color:#ff79c6">*</span>pb.EchoReq, rsp <span style="color:#ff79c6">*</span>pb.EchoRsp) <span style="color:#8be9fd">error</span> {
	rsp.Greeting = <span style="color:#f1fa8c">&#34;hello: &#34;</span> <span style="color:#ff79c6">+</span> req.Name
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// æ„å»ºæ–°çš„æœåŠ¡
</span><span style="color:#6272a4"></span>	app <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
		vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;greet&#34;</span>),
	)

	<span style="color:#6272a4">// æœåŠ¡åˆå§‹åŒ–
</span><span style="color:#6272a4"></span>	app.<span style="color:#50fa7b">Init</span>()

	<span style="color:#6272a4">// æ³¨å†ŒæœåŠ¡
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">RegisterGreeterHandler</span>(app.<span style="color:#50fa7b">Server</span>(), <span style="color:#ff79c6">&amp;</span>greet{}); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;register greet hander: %v&#34;</span>, err)
	}

	<span style="color:#6272a4">// æœåŠ¡å¯åŠ¨
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> app.<span style="color:#50fa7b">Run</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;start greet server: %v&#34;</span>, err)
	}
}
</code></pre></div><p>è¿™æ ·ä¸€ä¸ªç®€æ˜“çš„ <strong>Vine</strong> æœåŠ¡å°±å®Œæˆäº†ã€‚</p>
<blockquote>
<p>æ›´å¤šæœåŠ¡ç«¯çš„å†…å®¹è¯·å‚è€ƒ <a href="/vine/docs/component/server/">å†…éƒ¨æœåŠ¡</a></p>
</blockquote>
<h3 id="å¯åŠ¨æœåŠ¡">å¯åŠ¨æœåŠ¡</h3>
<p>å¯åŠ¨æœåŠ¡å¹¶ç»‘å®šç«¯å£:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go run server/main.go
2021-08-27 13:24:18  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>vine/service.go:171 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Starting <span style="color:#ff79c6">[</span>service<span style="color:#ff79c6">]</span> greet
2021-08-27 13:24:18  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>vine/service.go:172 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info service <span style="color:#ff79c6">[</span>version<span style="color:#ff79c6">]</span> latest
2021-08-27 13:24:18  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>grpc/grpc.go:920 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Server <span style="color:#ff79c6">[</span>grpc<span style="color:#ff79c6">]</span> Listening on <span style="color:#ff79c6">[</span>::<span style="color:#ff79c6">]</span>:65235
2021-08-27 13:24:18  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>grpc/grpc.go:761 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Registry <span style="color:#ff79c6">[</span>mdns<span style="color:#ff79c6">]</span> Registering node: greet-d4d5e1a8-1bc0-4387-8fb2-1b5eda59055e
2021-08-27 13:24:18  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>mdns/mdns_registry.go:266 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info <span style="color:#ff79c6">[</span>mdns<span style="color:#ff79c6">]</span> registry create new service with ip: 192.168.11.167 <span style="color:#ff79c6">for</span>: 192.168.11.167
</code></pre></div><p>å¦‚æœç”¨æˆ·æ²¡æœ‰æŒ‡å®š ip å’Œç«¯å£ï¼Œåˆ™é»˜è®¤ ip ä¸º 0.0.0.0ï¼Œç«¯å£éšæœºç”Ÿæˆã€‚</p>
<blockquote>
<p>å…³äº <strong>Vine</strong> æœåŠ¡çš„å‘½ä»¤è¡Œå‚æ•°å¯ä»¥å‚è€ƒ <a href="/vine/docs/component/cmd/">å‘½ä»¤è¡Œå‚æ•°</a></p>
</blockquote>
<h2 id="å®¢æˆ·ç«¯">å®¢æˆ·ç«¯</h2>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ç¼–å†™å®¢æˆ·ç«¯çš„ä»£ç æ¥è¯·æ±‚æœåŠ¡ç«¯:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p client
touch client/main.go
</code></pre></div><p>å®¢æˆ·ç«¯ä»£ç :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/client/grpc&#34;</span>
	log <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/logger&#34;</span>
	pb <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/testdata/mysite/proto&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// é€‰æ‹© gRPC å®¢æˆ·ç«¯
</span><span style="color:#6272a4"></span>	cc <span style="color:#ff79c6">:=</span> grpc.<span style="color:#50fa7b">NewClient</span>()
	<span style="color:#6272a4">// æŒ‡å®šæœåŠ¡åç§°
</span><span style="color:#6272a4"></span>	client <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">NewGreeterService</span>(<span style="color:#f1fa8c">&#34;greet&#34;</span>, cc)

	<span style="color:#6272a4">// è¯·æ±‚ Greet.Echo æ¥å£
</span><span style="color:#6272a4"></span>	rsp, err <span style="color:#ff79c6">:=</span> client.<span style="color:#50fa7b">Echo</span>(context.<span style="color:#50fa7b">TODO</span>(), <span style="color:#ff79c6">&amp;</span>pb.EchoReq{Name: <span style="color:#f1fa8c">&#34;lack&#34;</span>})
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	log.<span style="color:#50fa7b">Infof</span>(<span style="color:#f1fa8c">&#34;greet result: %v&#34;</span>, rsp.Greeting)
}
</code></pre></div><p>æ‰§è¡Œå‘½ä»¤è¾“å‡ºå¦‚ä¸‹:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go run client/main.go
2021-08-27 13:24:41  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>client/main.go:20 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info greet result: hello: lack
</code></pre></div><blockquote>
<p>æ›´å¤šå…³äºå®¢æˆ·ç«¯çš„å†…å®¹å¯ä»¥å‚è€ƒ <a href="/vine/docs/component/client/">å†…éƒ¨è¯·æ±‚</a></p>
</blockquote>
<h2 id="api-æ¥å£">API æ¥å£</h2>
<p><strong>Vine</strong> æœåŠ¡å¯ä»¥åŒæ—¶æ”¯æŒ <code>gRPC</code> å’Œ <code>Restful</code> æ¥å£ã€‚</p>
<h3 id="ä¿®æ”¹-greetproto-æ–‡ä»¶">ä¿®æ”¹ greet.proto æ–‡ä»¶</h3>
<p>å…ˆä¿®æ”¹ greet.proto æ–‡ä»¶:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;proto3&#34;</span>;

<span style="color:#ff79c6">package</span> greet;

<span style="color:#6272a4">// +gen:openapi
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">service</span> Greeter {
  <span style="color:#6272a4">// +gen:get=/api/v1/echo
</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Echo(EchoReq) <span style="color:#ff79c6">returns</span> (EchoRsp) {}
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">EchoReq</span> {
  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">EchoRsp</span> {
  <span style="color:#8be9fd">string</span> greeting <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div><p>é‡æ–°ç”Ÿæˆ <code>greet.pb.vine.go</code> æ–‡ä»¶:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src --vine_out<span style="color:#ff79c6">=</span>:.  github.com/vine-io/vine/testdata/mysite/proto/greet.proto
</code></pre></div><h3 id="å®‰è£…-vine">å®‰è£… <code>vine</code>:</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/vine-io/vine/cmd/vine
</code></pre></div><h3 id="å¯åŠ¨ç½‘å…³">å¯åŠ¨ç½‘å…³</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine api --handler<span style="color:#ff79c6">=</span>rpc --enable-openapi  
2021-08-27 13:38:54  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>openapi/openapi.go:56 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Starting OpenAPI at /openapi-ui/
2021-08-27 13:38:54  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>api/api.go:179 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Registering API RPC Handler at /
2021-08-27 13:38:54  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>http/http.go:116 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info HTTP API Listening on <span style="color:#ff79c6">[</span>::<span style="color:#ff79c6">]</span>:8080
2021-08-27 13:38:54  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>vine/service.go:171 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Starting <span style="color:#ff79c6">[</span>service<span style="color:#ff79c6">]</span> go.vine.api
2021-08-27 13:38:54  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>vine/service.go:172 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info service <span style="color:#ff79c6">[</span>version<span style="color:#ff79c6">]</span> latest
2021-08-27 13:38:54  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>grpc/grpc.go:920 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Server <span style="color:#ff79c6">[</span>grpc<span style="color:#ff79c6">]</span> Listening on <span style="color:#ff79c6">[</span>::<span style="color:#ff79c6">]</span>:50405
2021-08-27 13:38:54  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>grpc/grpc.go:761 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Registry <span style="color:#ff79c6">[</span>mdns<span style="color:#ff79c6">]</span> Registering node: go.vine.api-b405ca1d-ba24-4470-a18e-b1feeb22c5f6
2021-08-27 13:38:54  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>mdns/mdns_registry.go:266 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info <span style="color:#ff79c6">[</span>mdns<span style="color:#ff79c6">]</span> registry create new service with ip: 192.168.11.167 <span style="color:#ff79c6">for</span>: 192.168.11.167
</code></pre></div><p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl http://127.0.0.1:8080/api/v1/echo<span style="color:#f1fa8c">\?</span>name<span style="color:#f1fa8c">\=</span>lack
<span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;greeting&#34;</span>:<span style="color:#f1fa8c">&#34;hello: lack&#34;</span><span style="color:#ff79c6">}</span>%
</code></pre></div><p>å®Œæˆçš„ç›®å½•ç»“æ„å¦‚ä¸‹:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mysite
â”œâ”€â”€ client
â”‚Â Â  â””â”€â”€ main.go
â”œâ”€â”€ proto
â”‚Â Â  â”œâ”€â”€ greet.pb.go
â”‚Â Â  â”œâ”€â”€ greet.pb.vine.go
â”‚Â Â  â””â”€â”€ greet.proto
â””â”€â”€ server
    â””â”€â”€ main.go
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2ca5b21c2e8606490b4d2c267c683e14">1.1 - æ¡†æ¶ç®€ä»‹</h1>
    
	<p><a href="https://opensource.org/licenses/Apache-2.0"><img src="https://img.shields.io/:license-apache-blue.svg" alt="License"></a> <a href="https://pkg.go.dev/github.com/vine-io/vine?tab=doc"><img src="https://img.shields.io/badge/go.dev-reference-007d9c?logo=go&amp;logoColor=white&amp;style=flat-square" alt="Go.Dev reference"></a> <a href="https://travis-ci.org/vine-io/vine"><img src="https://api.travis-ci.org/vine-io/vine.svg?branch=master" alt="Travis CI"></a> <a href="https://goreportcard.com/report/github.com/vine-io/vine"><img src="https://goreportcard.com/badge/vine-io/vine" alt="Go Report Card"></a></p>
<p>Vine (<em>/vaÉªn/</em>) ä¸€å¥—ç®€å•ã€é«˜æ•ˆã€å¯æ’æ‹”çš„åˆ†å¸ƒå¼ RPC æ¡†æ¶ã€‚</p>
<blockquote>
<p>Vine (è‘¡è„æ ‘ ğŸ‡) : æˆ‘ä»¬å¸Œæœ›å®ƒèƒ½åƒçš„å®ƒåå­—ä¸€æ ·ï¼Œå¤šèŠ‚æœå­ã€‚</p>
</blockquote>
<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p><strong>Vine</strong> åŸºäº <a href="https://github.com/asim/go-micro">go-micro</a> æ¡†æ¶ï¼Œå› æ­¤ç»§æ‰¿äº†å®ƒçš„ä¼˜ç‚¹ã€‚å¹¶åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œè£å‰ªå’Œæ”¹è¿›ï¼Œå¢åŠ æ€§èƒ½å’Œå¯ç”¨æ€§ã€‚</p>
<h2 id="æ¶æ„å›¾">æ¶æ„å›¾</h2>
<p><img src="vine%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="vineæ¶æ„å›¾"></p>
<h2 id="åŠŸèƒ½">åŠŸèƒ½</h2>
<p><strong>Vine</strong> æŠ½è±¡åŒ–åˆ†å¸ƒå¼ç³»ç»Ÿçš„å†…éƒ¨ç»†èŠ‚. ä»¥ä¸‹æ˜¯ä¸»è¦åŠŸèƒ½.</p>
<ul>
<li>
<p><strong>åŠ¨æ€é…ç½® (Dynamic Config)</strong> - ä»ä»»æ„åœ°æ–¹åŠ è½½å’Œçƒ­åŠ è½½åŠ¨æ€é…ç½®ã€‚é…ç½®æ¥å£æä¾›äº†ä¸€ç§æ–¹æ³•ï¼Œå¯ä»¥ä»ä»»ä½•æºï¼ˆå¦‚ç¯å¢ƒå˜é‡ï¼Œæ–‡ä»¶ï¼Œetcdï¼‰åŠ è½½åº”ç”¨çº§åˆ«é…ç½®ã€‚åŒæ—¶æ”¯æŒåˆå¹¶æºã€ç”šè‡³å®šä¹‰å›é€€ã€‚</p>
</li>
<li>
<p><strong>æ•°æ®å­˜å‚¨ (Dao)</strong> - ä¸€ä¸ªç®€å•çš„æ•°æ®å­˜å‚¨æ¥å£ï¼Œç”¨äºæŸ¥è¯¢ï¼Œåˆ›å»ºï¼Œåˆ é™¤æ•°æ®è®°å½•ã€‚å†…ç½® memoryï¼Œfileï¼ŒpostgresSQL ç­‰</p>
</li>
<li>
<p><strong>ç¼“å­˜æ¥å£ (Cache)</strong> - æ”¯æŒå†…éƒ¨æ•°æ®ç¼“å­˜ï¼Œä¿å­˜ä¸´æ—¶æ•°æ®ã€‚</p>
</li>
<li>
<p><strong>æœåŠ¡å‘ç° (Service discovery)</strong> - è‡ªåŠ¨æœåŠ¡æ³¨å†Œå’Œåç§°è§£æã€‚æœåŠ¡å‘ç°æ˜¯å¾®æœåŠ¡å¼€å‘çš„æ ¸å¿ƒåŠŸèƒ½ã€‚å½“æœåŠ¡Aä¸æœåŠ¡Bé€šè®¯æ—¶ï¼Œéœ€è¦çŸ¥é“æœåŠ¡Bçš„IPåœ°å€ç­‰ä¿¡æ¯ã€‚<strong>Vine</strong> å†…ç½®(mdns)ä½œä¸ºæœåŠ¡å‘ç°ç»„ä»¶ï¼Œå®ƒæ˜¯é›¶é…ç½®ç³»ç»Ÿã€‚</p>
</li>
<li>
<p><strong>è´Ÿè½½å‡è¡¡ (Load Balancing)</strong> - åŸºäºæœåŠ¡å‘ç°çš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ã€‚å½“å†…éƒ¨å­˜åœ¨å¤šä¸ªæœåŠ¡å®ä¾‹çš„åœ°å€æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹å¼ç¡®å®šè·¯ç”±åˆ°å“ªä¸ªèŠ‚ç‚¹ï¼Œé»˜è®¤ä½¿ç”¨éšæœºæŒ‡å®šå…¶ä¸­ä¸€ä¸ªåœ°å€ã€‚åŒæ—¶åœ¨è¯·æ±‚é”™è¯¯æ—¶é‡è¯•ä¸åŒçš„èŠ‚ç‚¹ã€‚</p>
</li>
<li>
<p><strong>æ¶ˆæ¯ç¼–ç  (Message Encoding)</strong> - åŸºäº<code>Content-Type</code>çš„åŠ¨æ€æ¶ˆæ¯ç¼–ç ã€‚Codec ä¸ºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æä¾› Go ç±»å‹çš„ç¼–ç å’Œè§£ç ï¼Œæ”¯æŒå„ç§ä¸åŒçš„ç±»å‹ã€‚é»˜è®¤ä½¿ç”¨ protobuf å’Œ jsonã€‚</p>
</li>
<li>
<p><strong>gRPC ä¼ è¾“ (gRPC transport)</strong> - åŸºäº gRPC çš„è¯·æ±‚å“åº”ï¼ŒåŒæ—¶æ”¯æŒåŒå‘æµã€‚<strong>Vine</strong> ä¸ºåŒæ­¥é€šè®¯æä¾›ä¸€ä¸ªæŠ½è±¡ï¼Œä½¿å‘å‘æœåŠ¡çš„è¯·æ±‚è¢«è‡ªåŠ¨è§£æã€è´Ÿè½½å‡è¡¡ã€æ‹¨å·å’ŒæµåŒ–ã€‚</p>
</li>
<li>
<p><strong>å¼‚æ­¥æ¶ˆæ¯ (Async Messaging)</strong> - å†…ç½®è®¢é˜…å‘å¸ƒæ¨¡å‹ï¼Œä½œä¸ºå¼‚æ­¥é€šè®¯å’Œäº‹ä»¶é©±åŠ¨æ¶æ„ã€‚äº‹ä»¶é€šçŸ¥å±äºå¾®æœåŠ¡å¼€å‘ä¸­çš„æ ¸å¿ƒæ¨¡å¼ã€‚é»˜è®¤çš„æ¶ˆæ¯ç³»ç»Ÿä¸º HTTP äº‹ä»¶ä»£ç†ã€‚</p>
</li>
<li>
<p><strong>åŒæ­¥ (Synchronization)</strong> - åˆ†å¸ƒå¼ç³»ç»Ÿé€šå¸¸ä»¥æœ€ç»ˆä¸€è‡´æ€§çš„æ–¹å¼æ„å»ºã€‚å†…ç½®çš„ <strong>Sync</strong> æ¥å£å®ç°åˆ†å¸ƒå¼é”å’Œé¢†å¯¼é€‰ä¸¾ã€‚</p>
</li>
<li>
<p><strong>å¯æ’æ‹”æ¥å£ (Pluggable Interfaces)</strong> - å¾—ç›Šäº Go è¯­è¨€çš„æŠ½è±¡ç‰¹æ€§ã€‚ <strong>Vine</strong> ä¸ºæ¯ä¸ªæ¨¡å—æä¾›æŠ½è±¡æ¥å£ï¼Œæ­£å› ä¸ºå¦‚æ­¤ï¼Œè¿™äº›æ¥å£éƒ½æ˜¯å¯æ’æ‹”çš„ã€‚å¯ä»¥åœ¨ <a href="https://github.com/vine-io/plugins">github.com/vine-io/plugins</a> æŸ¥è¯¢ä½ éœ€è¦çš„æ’ä»¶ã€‚</p>
</li>
</ul>
<h2 id="è®¸å¯">è®¸å¯</h2>
<p>Vine éµå®ˆ MIT License å¼€æºè®¸å¯.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-83087925151d27e6b8d84f40aff9cdee">1.2 - æ–°å»ºé¡¹ç›®</h1>
    
	<h2 id="ä¾èµ–">ä¾èµ–</h2>
<p>æ–°å»º <strong>Vine</strong> é¡¹ç›®éœ€è¦å®‰è£…ä¾èµ–ç¯å¢ƒå’Œå·¥å…·:</p>
<ul>
<li><a href="https://golang.org/dl/">go</a></li>
<li><a href="https://github.com/protocolbuffers/protobuf">protoc</a></li>
</ul>
<p>å»ºè®®å¼€å¯GO111MODULE</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go env -w <span style="color:#8be9fd;font-style:italic">GO111MODULE</span><span style="color:#ff79c6">=</span>on
</code></pre></div><h2 id="å®‰è£…">å®‰è£…</h2>
<p>å®‰è£… <strong>Vine</strong> å·¥å…·</p>
<p>go get å®‰è£…</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get -u github.com/vine-io/vine/cmd/vine@latest
go get -u github.com/vine-io/vine/cmd/protoc-gen-gogo@latest
go get -u github.com/vine-io/vine/cmd/protoc-gen-vine@latest
</code></pre></div><p>go install å®‰è£…</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go install github.com/vine-io/vine/cmd/vine@latest
go install github.com/vine-io/vine/cmd/protoc-gen-gogo@latest
go install github.com/vine-io/vine/cmd/protoc-gen-vine@latest
</code></pre></div><p>æºç ç¼–è¯‘å®‰è£…</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git clone https://github.com/vine-io/vine
<span style="color:#8be9fd;font-style:italic">cd</span> vine
make build <span style="color:#ff79c6">&amp;&amp;</span> mv vine <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/bin/vine 
</code></pre></div><h2 id="åˆ›å»ºé¡¹ç›®">åˆ›å»ºé¡¹ç›®</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4"># æ–°å»ºé¡¹ç›®æ ¹ç›®å½•</span>
mkdir -p <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/helloworld
<span style="color:#8be9fd;font-style:italic">cd</span> <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/helloworld

<span style="color:#6272a4"># åˆå§‹åŒ–ç›®å½•</span>
vine init
<span style="color:#6272a4"># æ–°å»ºæœåŠ¡</span>
vine new service helloworld
<span style="color:#6272a4"># ç”Ÿæˆä»£ç </span>
vine build proto
<span style="color:#6272a4"># å®‰è£…ä¾èµ–</span>
go mod vendor
<span style="color:#6272a4"># å¯åŠ¨æœåŠ¡</span>
vine run helloworld
</code></pre></div><h2 id="å¯åŠ¨æœåŠ¡">å¯åŠ¨æœåŠ¡</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine run helloworld
</code></pre></div><h2 id="å¯åŠ¨ç½‘å…³">å¯åŠ¨ç½‘å…³</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine api --handler<span style="color:#ff79c6">=</span>rpc --enable-openapi
</code></pre></div><h2 id="æµ‹è¯•">æµ‹è¯•</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -X POST http://127.0.0.1:8080/foo/v1/foo/Call -H <span style="color:#f1fa8c">&#34;Content-Type: application/json&#34;</span>  -d <span style="color:#f1fa8c">&#34;{\&#34;name\&#34;:\&#34;World\&#34;}&#34;</span>
<span style="color:#6272a4"># {&#34;msg&#34;:&#34;reply: World&#34;}</span>
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-67790003301156bb2bbfd3d432c5d2f6">1.3 - é¡¹ç›®ç»“æ„</h1>
    
	<p><strong>Vine</strong> æä¾›å‘½ä»¤è¡Œå·¥å…·åˆ›å»ºé¡¹ç›®ï¼Œå…¶ä¸­åŒ…æ‹¬äº†å¼€å‘è¿‡ç¨‹ä¸­éœ€è¦çš„å·¥å…·é“¾å’Œéƒ¨ç½²å†…å®¹ã€‚ç¬¦åˆ DDD è®¾è®¡è§„èŒƒã€‚</p>
<h2 id="å•æœåŠ¡">å•æœåŠ¡</h2>
<p>å•æœåŠ¡ç›®å½•ç»“æ„ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»º:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir <span style="color:#8be9fd;font-style:italic">$PATH</span>/src/foo
vine init
vine new service foo
</code></pre></div><p>ç”Ÿæˆç›®å½•ç»“æ„:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">â”œâ”€â”€ Makefile
â”œâ”€â”€ README.md
â”œâ”€â”€ api  // ------ ç»´æŠ¤ grpc æ¥å£ï¼Œå’Œ domain å±‚ä¸­é¢†åŸŸæ¨¡å‹
â”‚Â Â  â””â”€â”€ service
â”‚Â Â      â””â”€â”€ foo
â”‚Â Â          â””â”€â”€ v1
â”‚Â Â              â”œâ”€â”€ foo.pb.go
â”‚Â Â              â”œâ”€â”€ foo.pb.validator.go
â”‚Â Â              â”œâ”€â”€ foo.pb.vine.go
â”‚Â Â              â””â”€â”€ foo.proto
â”œâ”€â”€ cmd         // ------ é¡¹ç›®å…¥å£
â”‚Â Â  â””â”€â”€ main.go
â”œâ”€â”€ deploy    // ------- éƒ¨ç½²ç›¸å…³å·¥å…·
â”‚Â Â  â”œâ”€â”€ Dockerfile
â”‚Â Â  â”œâ”€â”€ foo.ini
â”‚Â Â  â””â”€â”€ foo.service
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ pkg  // æœåŠ¡å†…éƒ¨ä»£ç 
â”‚Â Â  â”œâ”€â”€ app.go  // -------- æ„é€ å’Œç»„åˆå„å±‚ä»£ç ï¼Œæä¾›ç»™ cmd/main.go
â”‚Â Â  â”œâ”€â”€ biz  // ---------- DDD çš„ domain å±‚ï¼Œç»´æŠ¤ä¸šåŠ¡ä»£ç 
â”‚Â Â  â”‚Â Â  â””â”€â”€ foo.go
â”‚Â Â  â”œâ”€â”€ infra  // --------- DDD çš„ infrastructure å±‚ï¼Œåº•å±‚é€šç”¨ä»£ç 
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ cache  // -------- ç¼“å­˜ç›¸å…³
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ cache.go
â”‚Â Â  â”‚Â Â  â””â”€â”€ repo  // ------- æ•°æ®åº“ repositoryï¼Œæ•°æ®äº¤äº’
â”‚Â Â  â”‚Â Â      â””â”€â”€ repo.go
â”‚Â Â  â”œâ”€â”€ service   // ---------- DDD çš„ interfaces å±‚ï¼Œæä¾›å¯¹å¤–çš„ gRPC æ¥å£ 
â”‚Â Â  â”‚Â Â  â””â”€â”€ foo.go
â”‚Â Â  â””â”€â”€ runtime
â”‚Â Â      â”œâ”€â”€ doc.go  // ç»´æŠ¤æœåŠ¡ç‰ˆæœ¬ä¿¡æ¯
â”‚Â Â      â””â”€â”€ inject  // ------ ç»´æŠ¤ä¾èµ–æ³¨å…¥ä»£ç 
â”‚Â Â          â””â”€â”€ inject.go
â””â”€â”€ vine.toml   // -------- vine é¡¹ç›®çš„æè¿°æ–‡ä»¶
</code></pre></div><h2 id="å¤šæœåŠ¡">å¤šæœåŠ¡</h2>
<p>å½“ä¸€ä¸ªé¡¹ç›®ä¸­æœ‰å¤šä¸ªå¾®æœåŠ¡æ—¶ï¼Œæˆ‘ä»¬æ¨èä»£ç åœ¨ä¸€ä¸ªç›®å½•ä¸­ç»´æŠ¤ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»º</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/cluster
<span style="color:#8be9fd;font-style:italic">cd</span> <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/cluster

vine init --cluster
vine new service helloworld
</code></pre></div><p>ç”Ÿæˆä»¥ä¸‹ç›®å½•ç»“æ„:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">â”œâ”€â”€ Makefile
â”œâ”€â”€ README.md
â”œâ”€â”€ api
â”‚Â Â  â””â”€â”€ service
â”‚Â Â      â””â”€â”€ helloworld
â”‚Â Â          â””â”€â”€ v1
â”‚Â Â              â””â”€â”€ helloworld.proto
â”œâ”€â”€ cmd
â”‚Â Â  â””â”€â”€ helloworld
â”‚Â Â      â””â”€â”€ main.go
â”œâ”€â”€ deploy
â”‚Â Â  â”œâ”€â”€ config
â”‚Â Â  â”‚Â Â  â””â”€â”€ helloworld.ini
â”‚Â Â  â”œâ”€â”€ docker
â”‚Â Â  â”‚Â Â  â””â”€â”€ helloworld
â”‚Â Â  â”‚Â Â      â””â”€â”€ Dockerfile
â”‚Â Â  â””â”€â”€ systemd
â”‚Â Â      â””â”€â”€ helloworld.service
â”œâ”€â”€ go.mod
â”œâ”€â”€ pkg   
â”‚Â Â  â”œâ”€â”€ helloworld // -------- å¤šæœåŠ¡æ˜¯ï¼Œpkg æ¯ä¸ªç›®å½•ä»£ç ä¸€ä¸ªæœåŠ¡
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ app.go
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ biz
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ helloworld.go
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ infra
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ cache
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ cache.go
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ repo
â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ repo.go
â”‚Â Â  â”‚Â Â  â””â”€â”€ service
â”‚Â Â  â”‚Â Â      â””â”€â”€ helloworld.go
â”‚Â Â  â””â”€â”€ runtime  // ------ å¤šä¸ªæœåŠ¡é—´çš„é€šç”¨ä»£ç 
â”‚Â Â      â”œâ”€â”€ doc.go
â”‚Â Â      â””â”€â”€ inject
â”‚Â Â          â””â”€â”€ inject.go
â””â”€â”€ vine.toml
</code></pre></div><h2 id="vinetoml">vine.toml</h2>
<p><code>vine.toml</code> æ˜¯ <strong>Vine</strong> é¡¹ç›®çš„æè¿°æ–‡ä»¶ï¼Œå½“ä¸€ä¸ªç›®å½•åº•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè¢«è¯†åˆ«ä¸º <strong>Vine</strong> é¡¹ç›®ã€‚</p>
<p><code>vine.toml</code> å­˜åœ¨ä¸¤ç§æ ¼å¼ï¼Œsingle å’Œ clusterã€‚</p>
<h3 id="single">single</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#ff79c6">[</span>package<span style="color:#ff79c6">]</span>               <span style="color:#6272a4"># [package] æè¿°é¡¹ç›®çš„å…¬å…±ä¿¡æ¯ </span>
<span style="color:#8be9fd;font-style:italic">kind</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;single&#34;</span>         <span style="color:#6272a4"># é¡¹ç›®ç±»å‹ single å’Œ cluster</span>
<span style="color:#8be9fd;font-style:italic">namespace</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;go.vine&#34;</span>   <span style="color:#6272a4"># ç»Ÿä¸€çš„å‘½åç©ºé—´</span>

<span style="color:#ff79c6">[</span>pkg<span style="color:#ff79c6">]</span>      <span style="color:#6272a4"># single é¡¹ç›®è¯¦ç»†ä¿¡æ¯</span>
<span style="color:#8be9fd;font-style:italic">name</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;foo&#34;</span>  <span style="color:#6272a4"># é¡¹ç›®åç§°</span>
<span style="color:#8be9fd;font-style:italic">alias</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;go.vine.service.foo&#34;</span> <span style="color:#6272a4"># æœåŠ¡åç§°</span>
<span style="color:#8be9fd;font-style:italic">type</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;service&#34;</span>    <span style="color:#6272a4"># æœåŠ¡ç±»å‹ service, gateway</span>
<span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;latest&#34;</span>  <span style="color:#6272a4"># æœåŠ¡ç‰ˆæœ¬</span>
<span style="color:#8be9fd;font-style:italic">main</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;cmd/main.go&#34;</span> <span style="color:#6272a4"># æœåŠ¡å…¥å£æ–‡ä»¶</span>
<span style="color:#8be9fd;font-style:italic">dir</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;github.com/lack-io/foo&#34;</span>  <span style="color:#6272a4"># æœåŠ¡æ ¸å¿ƒä»£ç ç›®å½•</span>
<span style="color:#8be9fd;font-style:italic">output</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>  <span style="color:#6272a4"># ç¼–è¯‘æˆäºŒè¿›åˆ¶æ–‡ä»¶çš„å­˜æ”¾ç›®å½•</span>
<span style="color:#8be9fd;font-style:italic">flags</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">[</span>
	<span style="color:#f1fa8c">&#34;-a&#34;</span>, <span style="color:#f1fa8c">&#34;-installsuffix&#34;</span>, <span style="color:#f1fa8c">&#34;cgo&#34;</span>, <span style="color:#f1fa8c">&#34;-ldflags \&#34;-s -w\&#34;&#34;</span>,  <span style="color:#6272a4"># ç¼–è¯‘å‚æ•°, æ”¯æŒshellå‘½ä»¤ä½œä¸ºå€¼ &#34;name=$(echo hello)&#34;</span>
<span style="color:#ff79c6">]</span>

<span style="color:#ff79c6">[[</span>proto<span style="color:#ff79c6">]]</span>    <span style="color:#6272a4"># *.proto æ–‡ä»¶ä¿¡æ¯</span>
<span style="color:#8be9fd;font-style:italic">name</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;foo&#34;</span> <span style="color:#6272a4"># proto æ–‡ä»¶åç§°</span>
<span style="color:#8be9fd;font-style:italic">pb</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;github.com/lack-io/foo/api/service/foo/v1/foo.proto&#34;</span> <span style="color:#6272a4"># proto æ–‡ä»¶è·¯å¾„</span>
<span style="color:#8be9fd;font-style:italic">type</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;service&#34;</span> <span style="color:#6272a4"># proto ç±»å‹ service å’Œ apiï¼› service è¡¨ç¤º gRPC æœåŠ¡ï¼Œapi è¡¨ç¤ºé¢†åŸŸæ¨¡å‹</span>
<span style="color:#8be9fd;font-style:italic">group</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;foo&#34;</span> <span style="color:#6272a4"># proto åˆ†ç»„</span>
<span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;v1&#34;</span> <span style="color:#6272a4"># proto ç‰ˆæœ¬</span>
<span style="color:#8be9fd;font-style:italic">plugins</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#34;gogo&#34;</span>, <span style="color:#f1fa8c">&#34;vine&#34;</span>, <span style="color:#f1fa8c">&#34;validator&#34;</span><span style="color:#ff79c6">]</span> <span style="color:#6272a4"># æ‰§è¡Œ protoc å‘½ä»¤æ—¶æºå¸¦çš„æ’ä»¶ï¼Œå¯é€‰ gogoã€vineã€validatorã€deepcopyã€dao</span>
</code></pre></div><h3 id="cluster">cluster</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#ff79c6">[</span>package<span style="color:#ff79c6">]</span>
<span style="color:#8be9fd;font-style:italic">kind</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;cluster&#34;</span>
<span style="color:#8be9fd;font-style:italic">namespace</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;go.vine&#34;</span>

<span style="color:#ff79c6">[[</span>mod<span style="color:#ff79c6">]]</span>  <span style="color:#6272a4"># æ¯ä¸ª mod è¡¨ç¤ºä¸€ä¸ªæœåŠ¡</span>
<span style="color:#8be9fd;font-style:italic">name</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;helloworld&#34;</span>
<span style="color:#8be9fd;font-style:italic">alias</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;go.vine.service.helloworld&#34;</span>
<span style="color:#8be9fd;font-style:italic">type</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;service&#34;</span>
<span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;latest&#34;</span>
<span style="color:#8be9fd;font-style:italic">main</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;cmd/helloworld/main.go&#34;</span>
<span style="color:#8be9fd;font-style:italic">dir</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;github.com/lack-io/foo/helloworld&#34;</span>
<span style="color:#8be9fd;font-style:italic">output</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>
<span style="color:#8be9fd;font-style:italic">flags</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">[</span>
	<span style="color:#f1fa8c">&#34;-a&#34;</span>, <span style="color:#f1fa8c">&#34;-installsuffix&#34;</span>, <span style="color:#f1fa8c">&#34;cgo&#34;</span>, <span style="color:#f1fa8c">&#34;-ldflags \&#34;-s -w\&#34;&#34;</span>, 
<span style="color:#ff79c6">]</span>

<span style="color:#ff79c6">[[</span>proto<span style="color:#ff79c6">]]</span>
<span style="color:#8be9fd;font-style:italic">name</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;helloworld&#34;</span>
<span style="color:#8be9fd;font-style:italic">pb</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;github.com/lack-io/foo/api/service/helloworld/v1/helloworld.proto&#34;</span>
<span style="color:#8be9fd;font-style:italic">type</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;service&#34;</span>
<span style="color:#8be9fd;font-style:italic">group</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;helloworld&#34;</span>
<span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;v1&#34;</span>
<span style="color:#8be9fd;font-style:italic">plugins</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#34;gogo&#34;</span>, <span style="color:#f1fa8c">&#34;vine&#34;</span>, <span style="color:#f1fa8c">&#34;validator&#34;</span><span style="color:#ff79c6">]</span>
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-79e475706ae8025baf8c0f923eec34bd">1.4 - æ„å»ºå·¥å…·</h1>
    
	<p>æˆ‘ä»¬æä¾›ä¸€å¥—å·¥å…·å¸®åŠ©å¼€å‘è€…å¿«é€Ÿæ„å»ºå¾®æœåŠ¡ã€‚</p>
<h2 id="å®‰è£…">å®‰è£…</h2>
<p>ä½¿ç”¨ go get å®‰è£…</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get -u github.com/vine-io/vine/cmd/vine@latest
</code></pre></div><p>ç¼–è¯‘åŒ…å®‰è£… (æ¨è)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget https://github.com/vine-io/vine/releases/download/v0.23.0/vine-darwin-amd64-v0.23.0.tar.gz
tar -xvf vine-darwin-amd64-v0.23.0.tar.gz
cp -r darwin-amd64/* <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/bin/
</code></pre></div><p>å·¥å…·ä½¿ç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine --version
&gt; v0.23.0-8b25f36c-1630374346
</code></pre></div><h2 id="æ–°å»ºé¡¹ç›®">æ–°å»ºé¡¹ç›®</h2>
<p>åˆ›å»ºç›®å½•ä½œä¸ºé¡¹ç›®æ ¹ç›®å½•</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/foo
</code></pre></div><p>åˆå§‹åŒ–ç›®å½•</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8be9fd;font-style:italic">cd</span> <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/foo
vine init
</code></pre></div><p><code>vine init [--cluster]</code> ä¼šåˆå§‹åŒ– <strong>Vine</strong> é¡¹ç›®ï¼Œç”Ÿæˆä»¥ä¸‹æ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">.
â”œâ”€â”€ vine.toml  <span style="color:#6272a4"># vine é¡¹ç›®çš„æè¿°æ–‡ä»¶ï¼ŒåŒ…æ‹¬é¡¹ç›®åç§°ï¼ŒæœåŠ¡æ¥å£å’Œprotoç­‰ä¿¡æ¯ã€‚</span>
â”œâ”€â”€ README.md
â”œâ”€â”€ .gitignore
â””â”€â”€ go.mod
</code></pre></div><h2 id="æ–°å»ºæœåŠ¡">æ–°å»ºæœåŠ¡</h2>
<p>åœ¨åˆå§‹åŒ–çš„ç›®å½•æ–°å»ºå¾®æœåŠ¡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine new service foo
</code></pre></div><blockquote>
<p>vine é¡¹ç›®ç±»å‹ä¸º single æ—¶ï¼Œ<code>vine new service</code> æŒ‡å®šæœåŠ¡åç§°æ˜¯æ— æ•ˆçš„ï¼Œå®ƒçš„åç§°ç­‰äºç›®å½•åã€‚</p>
</blockquote>
<p>æ‰§è¡Œç»“æœï¼Œç”Ÿæˆä»¥ä¸‹æ–‡æ¡£:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">.
â”œâ”€â”€ cmd
â”‚Â Â  â””â”€â”€ main.go
â”œâ”€â”€ pkg
â”‚Â Â  â”œâ”€â”€ runtime
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ doc.go
â”‚Â Â  â”‚Â Â  â””â”€â”€ inject
â”‚Â Â  â”‚Â Â      â””â”€â”€ inject.go
â”‚Â Â  â”œâ”€â”€ app.go
â”‚Â Â  â”œâ”€â”€ interfaces
â”‚Â Â  â”‚Â Â  â””â”€â”€ foo.go
â”‚Â Â  â”œâ”€â”€ app
â”‚Â Â  â”‚Â Â  â””â”€â”€ foo.go
â”‚Â Â  â”œâ”€â”€ biz
â”‚Â Â  â”‚Â Â  â””â”€â”€ foo.go
â”‚Â Â  â””â”€â”€ infra
â”‚Â Â      â”œâ”€â”€ repo
â”‚Â Â      â”‚Â Â  â””â”€â”€ repo.go
â”‚Â Â      â””â”€â”€ cache
â”‚Â Â          â””â”€â”€ cache.go
â”œâ”€â”€ deploy
â”‚Â Â  â”œâ”€â”€ Dockerfile
â”‚Â Â  â”œâ”€â”€ foo.ini
â”‚Â Â  â””â”€â”€ foo.service
â”œâ”€â”€ api
â”‚Â Â  â””â”€â”€ service
â”‚Â Â      â””â”€â”€ foo
â”‚Â Â          â””â”€â”€ v1
â”‚Â Â              â””â”€â”€ foo.proto
â”œâ”€â”€ Makefile
â””â”€â”€ vine.toml


download protoc zip packages <span style="color:#ff79c6">(</span>protoc-<span style="color:#8be9fd;font-style:italic">$VERSION</span>-<span style="color:#8be9fd;font-style:italic">$PLATFORM</span>.zip<span style="color:#ff79c6">)</span> and install:

visit https://github.com/protocolbuffers/protobuf/releases

download protobuf <span style="color:#ff79c6">for</span> vine:

<span style="color:#8be9fd;font-style:italic">cd</span> github.com/lack-io/foo

install dependencies:
        go get github.com/gogo/protobuf
        go get github.com/vine-io/vine/cmd/protoc-gen-gogo
        go get github.com/vine-io/vine/cmd/protoc-gen-vine
        go get github.com/vine-io/vine/cmd/protoc-gen-validator
        go get github.com/vine-io/vine/cmd/protoc-gen-deepcopy
        go get github.com/vine-io/vine/cmd/protoc-gen-dao

<span style="color:#8be9fd;font-style:italic">cd</span> github.com/lack-io/foo
        vine build foo
</code></pre></div><h2 id="å®‰è£…ä¾èµ–">å®‰è£…ä¾èµ–</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/gogo/protobuf
go get github.com/vine-io/vine/cmd/protoc-gen-gogo
go get github.com/vine-io/vine/cmd/protoc-gen-vine
go get github.com/vine-io/vine/cmd/protoc-gen-validator
go get github.com/vine-io/vine/cmd/protoc-gen-deepcopy
go get github.com/vine-io/vine/cmd/protoc-gen-dao
</code></pre></div><h2 id="æ›´åŠ -proto-æ–‡ä»¶ç”Ÿæˆ-go-ä»£ç ">æ›´åŠ  proto æ–‡ä»¶ç”Ÿæˆ go ä»£ç </h2>
<p>ä½¿ç”¨å‘½ä»¤æ ¼å¼ä¸º: <code>vine build proto [command options] [proto_name]</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4"># ç”Ÿæˆ vine.toml ä¸­æ‰€æœ‰ proto æ–‡ä»¶å¯¹åº”çš„ä»£ç ã€‚</span>
vine new proto
</code></pre></div><p>æ”¯æŒå¦‚ä¸‹å‚æ•°:</p>
<ul>
<li>&ndash;type string                      æŒ‡å®š proto æ–‡ä»¶çš„ç±»å‹ï¼Œæ”¯æŒ api å’Œ serviceï¼Œé»˜è®¤ api</li>
<li>&ndash;proto-version string, -v string  æŒ‡å®š proto æ–‡ä»¶ç‰ˆæœ¬ï¼Œé»˜è®¤ v1</li>
<li>&ndash;group string                     æŒ‡å®š proto æ–‡ä»¶åˆ†ç»„ï¼Œé»˜è®¤ core</li>
<li>&ndash;dir string                       æ‰§è¡Œ protoc å‘½ä»¤æ˜¯æ‰€åœ¨çš„ç›®å½•ï¼Œchroot</li>
<li>&ndash;path strings, -I strings         protoc -I è·¯å¾„</li>
<li>&ndash;plugins strings, -P strings      ç”Ÿæˆ proto æ—¶è£…è½½çš„æ’ä»¶</li>
</ul>
<h2 id="è¿è¡ŒæœåŠ¡">è¿è¡ŒæœåŠ¡</h2>
<p>å‘½ä»¤æ ¼å¼: <code>vine new [command options] [name]</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine run foo
</code></pre></div><p>æ”¯æŒå¦‚ä¸‹å‚æ•°:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">- --auto-restart                    ç›‘å¬æ–‡ä»¶å˜åŒ–æ—¶é‡å¯æœåŠ¡
- --watch strings                   è¿½åŠ ç›‘å¬çš„è·¯å¾„
- --watch-interval int64, -I int64  ç›‘å¬äº‹ä»¶è§¦å‘é—´éš”ï¼Œé»˜è®¤3s
</code></pre></div><h2 id="å¯åŠ¨-api-ç½‘å…³">å¯åŠ¨ api ç½‘å…³</h2>
<p>å‘½ä»¤æ ¼å¼: <code>vine api [command options]</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine api --handler<span style="color:#ff79c6">=</span>rpc --enable-openapi
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1adf2527acb4bd9f3ca351337ddc8408">1.5 - å¯é€‰å‚æ•°</h1>
    
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p>åˆ›å»ºæ–°æœåŠ¡æ—¶ï¼Œä½ å¯ä»¥é€‰æ‹©ä¼ é€’å…¶ä»–å‚æ•°ï¼Œä¾‹å¦‚è®¾ç½®åç§°ï¼Œç‰ˆæœ¬ï¼ŒBrokerï¼ŒRegistry æˆ–è€…å­˜å‚¨ï¼Œä»¥ä¾¿ä¸æ‰€æœ‰å…¶ä»–å†…éƒ¨å®ç°ä¸€èµ·ä½¿ç”¨ã€‚
é€‰é¡¹é€šå¸¸å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Options <span style="color:#8be9fd;font-style:italic">struct</span> {
    Name        <span style="color:#8be9fd">string</span>
    Version     <span style="color:#8be9fd">string</span>
    Broker      broker.Broker
    Registry    registry.Registry
}


<span style="color:#8be9fd;font-style:italic">type</span> Option <span style="color:#8be9fd;font-style:italic">func</span>(<span style="color:#ff79c6">*</span>Options)

<span style="color:#6272a4">// set the name
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Name</span>(n <span style="color:#8be9fd">string</span>) Option {
    <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(o <span style="color:#ff79c6">*</span>Options) {
        o.Name = n
    }
}

<span style="color:#6272a4">// set the broker
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Broker</span>(b broker.Broker) Option {
    <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(o <span style="color:#ff79c6">*</span>Options) {
        o.Broker = b
    }
}
</code></pre></div><p>ç„¶åè¿™å®‰è£…å¦‚ä¸‹æ–¹å¼è®¾ç½®è¿™äº›é€‰é¡¹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">service <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
    vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;foobar&#34;</span>),
    vine.<span style="color:#50fa7b">Broker</span>(broker),
)
</code></pre></div><h2 id="æœåŠ¡-options">æœåŠ¡ options</h2>
<p>åœ¨ <strong>Vine</strong> ä¸­ï¼Œæˆ‘ä»¬æœ‰å¯ä»¥è®¾ç½®å¤šç§é€‰é¡¹ï¼ŒåŒ…æ‹¬ç”¨äºèº«ä»½éªŒè¯ï¼Œé…ç½®å’Œå­˜å‚¨ç­‰å†…å®¹çš„åŸºç¡€åŒ…ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>service.Options()</code> æ¥è®¿é—®è¿™äº›ã€‚</p>
<p>authã€configã€registryã€cache ç­‰åŒ…å°†é»˜è®¤ä¸ºæˆ‘ä»¬çš„é›¶ä¾èµ–æ’ä»¶ã€‚å¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡æˆ–è€…å‘½ä»¤è¡Œå‚æ•°æ¥é…ç½®å®ƒä»¬ï¼Œåœ¨æ‰§è¡Œ <code>service.Init()</code> åç”Ÿæ•ˆã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4">## as an env vars</span>
<span style="color:#8be9fd;font-style:italic">VINE_CACHE</span><span style="color:#ff79c6">=</span>file go run main.go

<span style="color:#6272a4">## or as a flag</span>
go run main.go --cache<span style="color:#ff79c6">=</span>file
</code></pre></div><h2 id="ä½¿ç”¨-options">ä½¿ç”¨ options</h2>
<p>åœ¨å†…éƒ¨ï¼Œå¯ä»¥é€šè¿‡é€‰é¡¹è®¿é—®å­˜å‚¨ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">service <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
    vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;foobar&#34;</span>),
)

service.<span style="color:#50fa7b">Init</span>()

store <span style="color:#ff79c6">:=</span> service.<span style="color:#50fa7b">Options</span>().Store
</code></pre></div><blockquote>
<p><strong>Vine</strong> æ¯ä¸ªå†…éƒ¨æ¥å£ä¸€èˆ¬éƒ½æœ‰å¯¹åº”çš„é€‰é¡¹ï¼Œåœ¨æ’ä»¶ä¸­ï¼Œé¢å¤–çš„é€‰é¡¹é€šå¸¸è¢«ä¿å­˜åœ¨ <code>context.Context</code> ä¸­ã€‚</p>
</blockquote>
<h2 id="è‡ªå®šä¹‰-options">è‡ªå®šä¹‰ options</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">custom <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(s <span style="color:#8be9fd">string</span>) vine.Option {
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(o <span style="color:#ff79c6">*</span>vine.Options) {
		o.Context = context.<span style="color:#50fa7b">WithValue</span>(o.Context, s, s)
	}
}
	
vine.<span style="color:#50fa7b">NewService</span>(<span style="color:#50fa7b">custom</span>(<span style="color:#f1fa8c">&#34;value&#34;</span>))
</code></pre></div><h2 id="æ‰€æœ‰-options">æ‰€æœ‰ options</h2>
<p>vine æœåŠ¡åˆå§‹åŒ–æ˜¯ï¼Œæ”¯æŒä»¥ä¸‹ options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">vine.<span style="color:#50fa7b">Name</span>(),            <span style="color:#6272a4">// å¾®æœåŠ¡åç§°
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Id</span>(),              <span style="color:#6272a4">// å¾®æœåŠ¡ uuid
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Version</span>(),         <span style="color:#6272a4">// å¾®æœåŠ¡ç‰ˆæœ¬
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Address</span>(),         <span style="color:#6272a4">// å¾®æœåŠ¡ç»‘å®šåœ°å€
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Metadata</span>(),        <span style="color:#6272a4">// å¾®æœåŠ¡ metadata
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Server</span>(),          <span style="color:#6272a4">// è®¾ç½®å†…éƒ¨ Server æ¨¡å—
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Client</span>(),          <span style="color:#6272a4">// è®¾ç½®å†…éƒ¨ Client æ¨¡å—
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Selector</span>(),        <span style="color:#6272a4">// è®¾ç½® client selector 
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">HandleSignal</span>(),    <span style="color:#6272a4">// æ˜¯å¦å¤„ç†ç³»ç»Ÿä¿¡å·
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Context</span>(),         <span style="color:#6272a4">// è®¾ç½® Context 
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Broker</span>(),          <span style="color:#6272a4">// è®¾ç½®å†…éƒ¨ broker æ¨¡å—
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Registry</span>(),        <span style="color:#6272a4">// è®¾ç½®å†…éƒ¨ Registry æ¨¡å—
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">RegisterTTL</span>(),     <span style="color:#6272a4">// æœåŠ¡æ³¨å†Œæœ‰æ•ˆæ—¶é—´
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">RegisterInterval</span>(), <span style="color:#6272a4">// æœåŠ¡æ³¨å†Œé—´éš”ï¼Œå¿…é¡»å°äº ttl
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Tracer</span>(),          <span style="color:#6272a4">// è®¾ç½® Trace æ¨¡å—
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Dialect</span>(),         <span style="color:#6272a4">// è®¾ç½® Dialect æ¨¡å—
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Cmd</span>(),             <span style="color:#6272a4">// è®¾ç½® Cmd æ¨¡å—
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Action</span>(),          <span style="color:#6272a4">// è®¾ç½® Cmd Action å›è°ƒå‡½æ•°
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Flags</span>(),           <span style="color:#6272a4">// æ·»åŠ  Cmd Flags 
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">WrapHandler</span>(),     <span style="color:#6272a4">// æ·»åŠ  Server è¯·æ±‚æ‹¦æˆªå™¨
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">WrapClient</span>(),      <span style="color:#6272a4">// æ·»åŠ  Client è¯·æ±‚æ‹¦æˆªå™¨
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">WrapCall</span>(),        <span style="color:#6272a4">// æ·»åŠ  Client Call è¯·æ±‚æ‹¦æˆªå™¨
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">WrapSubscriber</span>(),  <span style="color:#6272a4">// æ·»åŠ  Broker æ‹¦æˆªå™¨
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">BeforeStart</span>(),     <span style="color:#6272a4">// è¿½åŠ æœåŠ¡ Start æ–¹æ³•å‰çš„å›è°ƒ
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">BeforeStop</span>(),      <span style="color:#6272a4">// è¿½åŠ æœåŠ¡ Stop æ–¹æ³•å‰çš„å›è°ƒ
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">AfterStart</span>(),      <span style="color:#6272a4">// è¿½åŠ æœåŠ¡ Start æ–¹æ³•åçš„å›è°ƒ
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">AfterStop</span>(),       <span style="color:#6272a4">// è¿½åŠ æœåŠ¡ Stop æ–¹æ³•åçš„å›è°ƒ
</span></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6315071e53a7aa2cbc40cd1587b5d32b">1.6 - æ’ä»¶ä¸­å¿ƒ</h1>
    
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p><strong>Vine</strong> æ„å»ºåœ¨ Go æ¥å£ä¹‹ä¸Šã€‚å› æ­¤è¿™äº›æ¥å£çš„å®ç°æ˜¯å¯æ’æ‹”çš„ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<strong>Vine</strong> åªæä¾›æ ¸å¿ƒä¸Šæ¯ä¸ªæ¥å£çš„å‡ ä¸ªå®ç°ï¼Œä½†å®ƒå®Œå…¨æ˜¯å¯æ’æ‹”çš„ã€‚è€Œé¢å¤–çš„å®ç°ä¿å­˜åœ¨ <a href="https://github.com/vine-io/plugins">plugins</a>ã€‚</p>
<h2 id="æ·»åŠ æ’ä»¶">æ·»åŠ æ’ä»¶</h2>
<p>å¦‚æœè¦é›†æˆæ’ä»¶ï¼Œåªéœ€å°†å®ƒä»¬é“¾æ¥åˆ°å•ç‹¬çš„æ–‡ä»¶ä¸­å¹¶é‡æ–°ç”Ÿæˆã€‚
åˆ›å»º plugins.go æ–‡ä»¶å¹¶å¯¼å…¥æ‰€éœ€çš„æ’ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
    <span style="color:#6272a4">// etcd registry
</span><span style="color:#6272a4"></span>    _ <span style="color:#f1fa8c">&#34;github.com/vine-io/plugins/registry/etcd&#34;</span>
    <span style="color:#6272a4">// nats broker
</span><span style="color:#6272a4"></span>    _ <span style="color:#f1fa8c">&#34;github.com/vine-io/plugins/broker/nats&#34;</span>
)
</code></pre></div><p>é€šè¿‡åŒ…å«æ’ä»¶æ–‡ä»¶æ¥æ„å»ºåº”ç”¨ç¨‹åºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go build -o service main.go plugins.go
</code></pre></div><p>ä½¿ç”¨æ’ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">service --registry<span style="color:#ff79c6">=</span>etcd --broker<span style="color:#ff79c6">=</span>nats
</code></pre></div><p>æˆ–è€…ä½¿ç”¨ç¯å¢ƒå˜é‡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8be9fd;font-style:italic">VINE_REGISTRY</span><span style="color:#ff79c6">=</span>etcd <span style="color:#8be9fd;font-style:italic">VINE_BROKER</span><span style="color:#ff79c6">=</span>nats service
</code></pre></div><h2 id="æ’ä»¶é€‰é¡¹">æ’ä»¶é€‰é¡¹</h2>
<p>æˆ–è€…ä½ å¯ä»¥å°†æ’ä»¶è®¾ç½®åœ¨é€‰é¡¹ä¸­</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
    <span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>

    <span style="color:#6272a4">// etcd registry
</span><span style="color:#6272a4"></span>    <span style="color:#f1fa8c">&#34;github.com/vine-io/plugins/registry/etcd&#34;</span>
    <span style="color:#6272a4">// nats broker
</span><span style="color:#6272a4"></span>    <span style="color:#f1fa8c">&#34;github.com/vine-io/plugins/broker/nats&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    registry <span style="color:#ff79c6">:=</span> etcd.<span style="color:#50fa7b">NewRegistry</span>()
    broker <span style="color:#ff79c6">:=</span> nats.<span style="color:#50fa7b">NewBroker</span>()

    service <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
        vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;greeter&#34;</span>),
        vine.<span style="color:#50fa7b">Registry</span>(registry),
        vine.<span style="color:#50fa7b">Broker</span>(broker),
    )

    service.<span style="color:#50fa7b">Init</span>()

    service.<span style="color:#50fa7b">Run</span>()
}
</code></pre></div><h2 id="ç¼–å†™æ’ä»¶">ç¼–å†™æ’ä»¶</h2>
<p>æ’ä»¶æ˜¯ä¸€ä¸ªå»ºç«‹åœ¨ Go æ¥å£ä¸Šçš„æ¦‚å¿µã€‚æ¯ä¸ªåŒ…éƒ½ç»´æŠ¤ä¸€ä¸ªé«˜çº§æ¥å£æŠ½è±¡ã€‚åªéœ€å®ç°æ¥å£å¹¶å°†å…¶ä½œä¸ºæœåŠ¡é€‰é¡¹ä¼ é€’ç»™å®ƒå³å¯.</p>
<p>æœåŠ¡å‘ç°æ¥å£ç§°ä¸º <a href="https://pkg.go.dev/github.com/vine-io/vine/core/registry#Registry">Registry</a>. å®ç°æ­¤æ¥å£çš„ä»»ä½•å†…å®¹éƒ½å¯ä»¥ç”¨ä½œ <strong>Registry</strong>ã€‚è¿™åŒæ ·é€‚ç”¨äºå…¶ä»–åŒ….</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Registry <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#50fa7b">Register</span>(<span style="color:#ff79c6">*</span>Service, <span style="color:#ff79c6">...</span>RegisterOption) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Deregister</span>(<span style="color:#ff79c6">*</span>Service, <span style="color:#ff79c6">...</span>DeregisterOption) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">GetService</span>(<span style="color:#8be9fd">string</span>, <span style="color:#ff79c6">...</span>GetOption) ([]<span style="color:#ff79c6">*</span>Service, <span style="color:#8be9fd">error</span>)
	<span style="color:#50fa7b">ListServices</span>(<span style="color:#ff79c6">...</span>ListOption) ([]<span style="color:#ff79c6">*</span>Service, <span style="color:#8be9fd">error</span>)
	<span style="color:#50fa7b">Watch</span>(<span style="color:#ff79c6">...</span>WatchOption) (Watcher, <span style="color:#8be9fd">error</span>)
	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><p>æŸ¥é˜… <a href="https://github.com/vine-io/plugins">plugins</a> å¯ä»¥æ›´å¥½åœ°äº†è§£å®ç°ç»†èŠ‚ã€‚</p>
<h2 id="æ’ä»¶åˆ—è¡¨">æ’ä»¶åˆ—è¡¨</h2>
<p>Registry æ’ä»¶:</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/registry/etcd">etcd</a></li>
</ul>
<p>Broker æ’ä»¶:</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/broker/nats">nats</a></li>
<li><a href="https://github.com/vine-io/plugins/tree/main/broker/redis">redis</a></li>
</ul>
<p>Dao æ’ä»¶:</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/dao/mysql">mysql</a></li>
<li><a href="https://github.com/vine-io/plugins/tree/main/dao/postgres">postgresql</a></li>
<li><a href="https://github.com/vine-io/plugins/tree/main/dao/sqlite">sqlite</a></li>
</ul>
<p>Cache æ’ä»¶:</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/cache/redis">redis</a></li>
</ul>
<p>Sync æ’ä»¶ï¼š</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/sync/etcd">etcd</a></li>
<li><a href="https://github.com/vine-io/plugins/tree/main/sync/memory">memory</a></li>
</ul>
<p>Logger æ’ä»¶:</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/logger/zap">zap</a></li>
</ul>
<p>Config Source æ’ä»¶ï¼š</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/config/source/configmap">configmap</a></li>
<li><a href="https://github.com/vine-io/plugins/tree/main/config/source/etcd">etcd</a></li>
</ul>
<p>Wrapper ç±»</p>
<p>ç†”æ–­å™¨:</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/wrapper/breaker/gobreaker">gobreaker</a></li>
<li><a href="https://github.com/vine-io/plugins/tree/main/wrapper/breaker/hystrix">hystrix</a></li>
</ul>
<p>é™æµå™¨:</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/wrapper/ratelimiter/ratelimiter">ratelimiter</a></li>
<li><a href="https://github.com/vine-io/plugins/tree/main/wrapper/ratelimiter/uber">uber</a></li>
</ul>
<p>é“¾è·¯è¿½è¸ª:</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/wrapper/trace/opentracing">opentracing</a></li>
</ul>
<p>æ•°æ®æ ¡éªŒ:</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/wrapper/validator">validator</a></li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ceffc22118740feeb3d7861a1db173aa">2 - æ¡†æ¶ç»„ä»¶</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-4bf4097c812f2b345e3a8236e52dae1a">2.1 - æœåŠ¡æ³¨å†Œå‘ç°</h1>
    
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p><code>æœåŠ¡æ³¨å†Œå‘ç°</code>æ¨¡å—æ˜¯å¾®æœåŠ¡çš„æ ¸å¿ƒã€‚æœåŠ¡ç«¯éœ€è¦å®ƒæ¥æä¾›æ³¨å†ŒæœåŠ¡ï¼Œç™»å½•æœåŠ¡è‡ªèº«ä¿¡æ¯ã€‚å®¢æˆ·ç«¯éœ€è¦å®ƒæ¥æ ¹æ®åç§°æŸ¥æ‰¾æœåŠ¡åœ°å€ã€‚</p>
<p><strong>Vine</strong> æä¾›ä¸€ä¸ªé€šç”¨çš„ <code>Registry</code> æ¥å£ï¼Œæè¿° <code>æœåŠ¡æ³¨å†Œå‘ç°</code> æ¨¡å—çš„è¡Œä¸ºã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Registry <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span> <span style="color:#6272a4">// ------------------------------- æ¨¡å—åˆå§‹åŒ–
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options <span style="color:#6272a4">// ----------------------------------- æ¨¡å—çš„é…ç½®ä¿¡æ¯
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Register</span>(<span style="color:#ff79c6">*</span>Service, <span style="color:#ff79c6">...</span>RegisterOption) <span style="color:#8be9fd">error</span> <span style="color:#6272a4">// --------- æ³¨å†ŒæœåŠ¡
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Deregister</span>(<span style="color:#ff79c6">*</span>Service, <span style="color:#ff79c6">...</span>DeregisterOption) <span style="color:#8be9fd">error</span> <span style="color:#6272a4">// ----- æ³¨é”€æœåŠ¡
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">GetService</span>(<span style="color:#8be9fd">string</span>, <span style="color:#ff79c6">...</span>GetOption) ([]<span style="color:#ff79c6">*</span>Service, <span style="color:#8be9fd">error</span>) <span style="color:#6272a4">//- æ ¹æ®åç§°æŸ¥æ‰¾æœåŠ¡
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">ListServices</span>(<span style="color:#ff79c6">...</span>ListOption) ([]<span style="color:#ff79c6">*</span>Service, <span style="color:#8be9fd">error</span>) <span style="color:#6272a4">// ----- æŸ¥è¯¢æ‰€æœ‰æœåŠ¡
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Watch</span>(<span style="color:#ff79c6">...</span>WatchOption) (Watcher, <span style="color:#8be9fd">error</span>) <span style="color:#6272a4">// -------------- ç›‘å¬æœåŠ¡å˜åŒ–
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span> <span style="color:#6272a4">// ------------------------------------- æŸ¥è¯¢å®ç° Registry æ¥å£çš„å…·ä½“ç±»å‹
</span><span style="color:#6272a4"></span>}
</code></pre></div><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<p>åœ¨æ­¤æˆ‘ä»¬æä¾›ä¸€ä¸ªå®Œæ•´çš„ä»£ç æ¥ä»‹ç» <code>Registry</code> çš„å…·ä½“ä½¿ç”¨æ–¹å¼:</p>
<h3 id="åˆå§‹åŒ–">åˆå§‹åŒ–</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry/mdns&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// åˆ›å»ºæ–°çš„ Registry
</span><span style="color:#6272a4"></span>	r <span style="color:#ff79c6">:=</span> mdns.<span style="color:#50fa7b">NewRegistry</span>()
	<span style="color:#6272a4">// åˆå§‹åŒ–
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> r.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
}
</code></pre></div><h3 id="æ³¨å†Œå’Œæ³¨é”€æœåŠ¡">æ³¨å†Œå’Œæ³¨é”€æœåŠ¡</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// åˆ›å»ºæ–°çš„æœåŠ¡
</span><span style="color:#6272a4"></span>	svc <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>registry.Service{
		Name:     <span style="color:#f1fa8c">&#34;go.vine.test&#34;</span>,   <span style="color:#6272a4">// æœåŠ¡åç§°ï¼Œå”¯ä¸€å€¼
</span><span style="color:#6272a4"></span>		Version:  <span style="color:#f1fa8c">&#34;v1.0.0&#34;</span>,         <span style="color:#6272a4">// æœåŠ¡ç‰ˆæœ¬
</span><span style="color:#6272a4"></span>		Metadata: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;Content-Type&#34;</span>: <span style="color:#f1fa8c">&#34;application/json&#34;</span>},  <span style="color:#6272a4">// å…ƒæ•°æ®
</span><span style="color:#6272a4"></span>		Endpoints: []<span style="color:#ff79c6">*</span>registry.Endpoint{        <span style="color:#6272a4">// æœåŠ¡æ¥å£
</span><span style="color:#6272a4"></span>			{
				Name:     <span style="color:#f1fa8c">&#34;&#34;</span>,
				Request:  <span style="color:#ff79c6">nil</span>,
				Response: <span style="color:#ff79c6">nil</span>,
				Metadata: <span style="color:#ff79c6">nil</span>,
			},
		},
		Nodes: []<span style="color:#ff79c6">*</span>registry.Node{     <span style="color:#6272a4">// è¯¥æœåŠ¡ä¸‹çš„èŠ‚ç‚¹ä¿¡æ¯, èŠ‚ç‚¹çš„ ID å¿…é¡»æ˜¯ä¸åŒçš„ï¼Œå½“ä¸€ä¸ª `Registry` ä¸­å¤šæ¬¡æ³¨å†Œç›¸åŒæœåŠ¡æ—¶ï¼ŒæœåŠ¡çš„è¯¥å­—æ®µå°±ä¼šåˆå¹¶
</span><span style="color:#6272a4"></span>			{
				Id:       uuid.<span style="color:#50fa7b">New</span>().<span style="color:#50fa7b">String</span>(),
				Address:  <span style="color:#f1fa8c">&#34;127.0.0.1:11500&#34;</span>,
				<span style="color:#6272a4">//Port:     11500,
</span><span style="color:#6272a4"></span>				Metadata: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;os&#34;</span>: <span style="color:#f1fa8c">&#34;linux&#34;</span>},
			},
		},
		TTL:  <span style="color:#bd93f9">30</span>,  <span style="color:#6272a4">// æœåŠ¡è¿‡æœŸæ—¶é—´ï¼Œå•ä½ç§’
</span><span style="color:#6272a4"></span>		Apis: <span style="color:#ff79c6">nil</span>, <span style="color:#6272a4">// swagger ä¿¡æ¯
</span><span style="color:#6272a4"></span>	}

	<span style="color:#6272a4">// æ³¨å†ŒæœåŠ¡
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> r.<span style="color:#50fa7b">Register</span>(svc); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	<span style="color:#6272a4">// æ³¨é”€æœåŠ¡
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> r.<span style="color:#50fa7b">Deregister</span>(svc); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
}
</code></pre></div><h3 id="æŸ¥è¯¢æœåŠ¡">æŸ¥è¯¢æœåŠ¡</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// æŸ¥è¯¢æ‰€æœ‰æœåŠ¡
</span><span style="color:#6272a4"></span>	list, err <span style="color:#ff79c6">:=</span> r.<span style="color:#50fa7b">ListServices</span>()
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	<span style="color:#ff79c6">for</span> _, item <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> list {
		fmt.<span style="color:#50fa7b">Println</span>(item.Name)
	}

	<span style="color:#6272a4">// æŸ¥è¯¢å•ä¸ªæœåŠ¡
</span><span style="color:#6272a4"></span>	list, err = r.<span style="color:#50fa7b">GetService</span>(<span style="color:#f1fa8c">&#34;go.vine.test&#34;</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	<span style="color:#ff79c6">for</span> _, item <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> list {
		fmt.<span style="color:#50fa7b">Println</span>(item.Name, <span style="color:#8be9fd;font-style:italic">len</span>(item.Nodes))
	}
}
</code></pre></div><blockquote>
<p>ListService() æ–¹æ³•è·å–çš„ç»“æœï¼Œæ•°æ®æ˜¯ä¸å®Œæ•´çš„ï¼Œåªå«æœ‰åŒ…æ‹¬æœåŠ¡åç§°åœ¨å†…çš„å°‘é‡ä¿¡æ¯ã€‚</p>
</blockquote>
<h3 id="ç›‘å¬æœåŠ¡">ç›‘å¬æœåŠ¡</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// å¯åŠ¨ä¸€ä¸ªç›‘å¬å™¨
</span><span style="color:#6272a4"></span>	watcher, err <span style="color:#ff79c6">:=</span> r.<span style="color:#50fa7b">Watch</span>(registry.<span style="color:#50fa7b">WatchService</span>(<span style="color:#f1fa8c">&#34;go.vine.test&#34;</span>))
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	<span style="color:#6272a4">// åœæ­¢ç›‘å¬å™¨
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">defer</span> watcher.<span style="color:#50fa7b">Stop</span>()
	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		<span style="color:#ff79c6">for</span> {
			e, err <span style="color:#ff79c6">:=</span> watcher.<span style="color:#50fa7b">Next</span>() <span style="color:#6272a4">// è¿™é‡Œä¼šé˜»å¡ï¼Œç›´åˆ°è¿”å›äº‹å‡
</span><span style="color:#6272a4"></span>			<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
				<span style="color:#ff79c6">return</span>
			}
			fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;%d: %s, %s\n&#34;</span>,  e.Timestamp, e.Action, e.Service.Name)
		}
	}()
}
</code></pre></div><h3 id="æ›¿æ¢æœåŠ¡çš„-registry">æ›¿æ¢æœåŠ¡çš„ <code>Registry</code></h3>
<p><strong>Vine</strong> æœåŠ¡é»˜è®¤ <code>Registry</code> ä¸º <code>mdns</code>ã€‚å°è¯•å»æ›¿æ¢æˆ <code>memory</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry/memory&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	mr <span style="color:#ff79c6">:=</span> memory.<span style="color:#50fa7b">NewRegistry</span>()
	vine.<span style="color:#50fa7b">NewService</span>(vine.<span style="color:#50fa7b">Registry</span>(mr))
}
</code></pre></div><h2 id="options">options</h2>
<p><code>Registry</code> æ¥å£çš„å‡ ä¸ªæ–¹æ³•éƒ½æ”¯æŒ Optionsã€‚</p>
<p>åˆ›å»º <code>NewRegistry(opts...)</code> å’Œ åˆå§‹åŒ– <code>Init(opts...)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memory.<span style="color:#50fa7b">NewRegistry</span>(
	<span style="color:#6272a4">// Registry çš„ ip åœ°å€
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">Addrs</span>(addrs <span style="color:#ff79c6">...</span><span style="color:#8be9fd">string</span>),
	<span style="color:#6272a4">// è¿æ¥è¶…æ—¶æ—¶é—´
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">Timeout</span>(t time.Duration),
	<span style="color:#6272a4">// å®‰å…¨é€šè®¯
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">Secure</span>(b <span style="color:#8be9fd">bool</span>),
	<span style="color:#6272a4">// å®‰å…¨é€šè®¯æ‰€éœ€è¯ä¹¦ä¿¡æ¯
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">TLSConfig</span>(t <span style="color:#ff79c6">*</span>tls.Config),
)
</code></pre></div><p>æ³¨å†ŒæœåŠ¡ <code>Register(svc, opts...)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memory.<span style="color:#50fa7b">Register</span>(svc,
	<span style="color:#6272a4">// æœåŠ¡è¿‡æœŸæ—¶é—´
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">RegisterTTL</span>(ttl <span style="color:#8be9fd">int64</span>), 
	<span style="color:#6272a4">// ä¸Šä¸‹æ–‡ä¿¡æ¯
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">RegisterContext</span>(ctx context.Context),
)
</code></pre></div><p>æ³¨é”€æœåŠ¡ <code>Deregister(svc, opts...)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memory.<span style="color:#50fa7b">Deregister</span>(svc,
	registry.<span style="color:#50fa7b">DeregisterContext</span>(ctx context.Context),
)
</code></pre></div><p>æŸ¥è¯¢æ‰€æœ‰æœåŠ¡ <code>ListServices(opts...)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memory.<span style="color:#50fa7b">ListServices</span>(svc,
	registry.<span style="color:#50fa7b">ListServicesContext</span>(ctx context.Context),
)
</code></pre></div><p>æ ¹æ®åç§°è·å–æœåŠ¡ <code>GetService(name, opts...)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memory.<span style="color:#50fa7b">GetService</span>(svc,
	registry.<span style="color:#50fa7b">GetServiceContext</span>(ctx context.Context),
)
</code></pre></div><p>ç›‘å¬æœåŠ¡ <code>Watch(opts...)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memory.<span style="color:#50fa7b">Watch</span>(svc,
    <span style="color:#6272a4">// ç›‘å¬å•ä¸ªæœåŠ¡
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">WatchService</span>(name <span style="color:#8be9fd">string</span>),
	registry.<span style="color:#50fa7b">WatchServiceContext</span>(ctx context.Context),
)
</code></pre></div><h2 id="æ’ä»¶">æ’ä»¶</h2>
<p><strong>Vine</strong> ç›®å‰è‡ªå¸¦çš„ <code>Registry</code> å®ç°æœ‰:</p>
<ul>
<li>memory</li>
<li>mdns</li>
</ul>
<p>ç¬¬ä¸‰æ–¹çš„å®ç°è¯·å‚è€ƒ <a href="https://github.com/vine-io/plugins/tree/main/registry">registry</a></p>
<h3 id="etcd">etcd</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/cmd&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/plugins/registry/etcd&#34;</span>
)
	
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	er <span style="color:#ff79c6">:=</span> etcd.<span style="color:#50fa7b">NewRegistry</span>()
	vine.<span style="color:#50fa7b">NewService</span>(vine.<span style="color:#50fa7b">Registry</span>(er))
}
</code></pre></div><h2 id="æœåŠ¡å¯åŠ¨">æœåŠ¡å¯åŠ¨</h2>
<p><strong>Vine</strong> æœåŠ¡ä»¥æ’ä»¶çš„æ–¹å¼ï¼Œæ³¨å†Œå¤šç§å®ç°ï¼Œç”¨æˆ·å¯ä»¥å†æœåŠ¡å¯åŠ¨æ—¶é€‰æ‹©å–œæ¬¢çš„ç±»å‹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./helloworld --registy<span style="color:#ff79c6">=</span>etcd --registry-address<span style="color:#ff79c6">=</span>127.0.0.1:2379
<span style="color:#6272a4"># æˆ–è€…ä½¿ç”¨ç¯å¢ƒå˜é‡</span>
<span style="color:#8be9fd;font-style:italic">VINE_REGISTRY</span><span style="color:#ff79c6">=</span>ETCD <span style="color:#8be9fd;font-style:italic">VINE_REGISTRY_ADDRESS</span><span style="color:#ff79c6">=</span>127.0.0.1:2379 ./helloworld
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f375a1b0338deecef74fa867c6bb7ed5">2.2 - æœåŠ¡ç½‘å…³</h1>
    
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p><strong>API</strong> æ˜¯ä¸€ä¸ªå¯æ’æ‹”çš„ API æ¥å£ï¼Œç”± <strong>Registry</strong> é©±åŠ¨ï¼Œå¯å¸®åŠ©æ„å»ºå¼ºå¤§çš„å…¬å…± API ç½‘å…³.</p>
<p><strong>API</strong> åº“æä¾› api ç½‘å…³è·¯ç”±åŠŸèƒ½ã€‚å¾®æœåŠ¡ä½“ç³»ç»“æ„å°†åº”ç”¨ç¨‹åºé€»è¾‘åˆ†ç¦»åˆ°å•ç‹¬çš„æœåŠ¡ä¸­. api ç½‘å…³æä¾›å•ä¸ªå…¥å£ç‚¹ï¼Œä»¥å°†è¿™äº›æœåŠ¡åˆå¹¶åˆ°ç»Ÿä¸€ api ä¸­ã€‚ <strong>API</strong> ä½¿ç”¨åœ¨ <strong>Registry</strong> å…ƒæ•°æ®ä¸­å®šä¹‰çš„è·¯ç”±æ¥ç”Ÿæˆè·¯ç”±è§„åˆ™å¹¶æœåŠ¡ http è¯·æ±‚.</p>
<h2 id="å¯åŠ¨-api-æœåŠ¡">å¯åŠ¨ api æœåŠ¡</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4"># æä¾› http æœåŠ¡å’Œ swagger </span>
vine api --handler<span style="color:#ff79c6">=</span>rpc --enable-openapi
</code></pre></div><h2 id="åˆ›å»ºç½‘å…³">åˆ›å»ºç½‘å…³</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine new gateway api
</code></pre></div><p>å¯åŠ¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go run cmd/api/main.go --api-address<span style="color:#ff79c6">=</span>127.0.0.1:8080
</code></pre></div><blockquote>
<p>ä¸€ä¸ªæœåŠ¡åŒæ—¶æä¾› gRPC å’Œ http æ¥å£å¯ä»¥å‚è€ƒ <a href="https://github.com/vine-io/examples/tree/main/api">api</a></p>
</blockquote>
<h2 id="æµ‹è¯•">æµ‹è¯•</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -X POST <span style="color:#f1fa8c">&#34;http://127.0.0.1:8080/helloworld/v1/helloworld/Call&#34;</span> -H  <span style="color:#f1fa8c">&#34;accept: application/json&#34;</span> -H  <span style="color:#f1fa8c">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#f1fa8c">&#34;{\&#34;name\&#34;:\&#34;hello\&#34;}&#34;</span>
&gt; <span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;reply: hello&#34;</span><span style="color:#ff79c6">}</span>
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fa10acc15b4e6765d798505e47c766c2">2.3 - åºåˆ—åŒ–</h1>
    
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p>æˆ‘ä»¬æŠ½è±¡å‡º <code>Codec</code> å’Œ <code>Marshaler</code> æ¥å£æ¥ç»Ÿä¸€ç®¡ç†æ•°æ®çš„åºåˆ—åŒ–å’Œååºåˆ—åŠŸèƒ½ã€‚<code>Codec</code> è¢« <code>Server</code> å’Œ <code>Client</code> ä½¿ç”¨ä½œä¸ºæ•°æ®è§£æå·¥å…·ã€‚<code>Marshaler</code> ä¸ºç”¨æˆ·æä¾›æ•°æ®è½¬åŒ–å·¥å…·ã€‚</p>
<p>ç›®å‰ <code>Marshaler</code> æ¥å£æ”¯æŒä»¥ä¸‹æ ¼å¼ï¼š</p>
<ul>
<li>yaml</li>
<li>json</li>
<li>bytes</li>
<li>proto</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Codec <span style="color:#8be9fd;font-style:italic">interface</span> {
	Reader
	Writer
	<span style="color:#50fa7b">Close</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}

<span style="color:#8be9fd;font-style:italic">type</span> Reader <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">ReadHeader</span>(<span style="color:#ff79c6">*</span>Message, MessageType) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">ReadBody</span>(<span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
}

<span style="color:#8be9fd;font-style:italic">type</span> Writer <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Write</span>(<span style="color:#ff79c6">*</span>Message, <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
}

<span style="color:#8be9fd;font-style:italic">type</span> Marshaler <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Marshal</span>(<span style="color:#8be9fd;font-style:italic">interface</span>{}) ([]<span style="color:#8be9fd">byte</span>, <span style="color:#8be9fd">error</span>)
	<span style="color:#50fa7b">Unmarshal</span>([]<span style="color:#8be9fd">byte</span>, <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><h2 id="å…·ä½“å®ç°">å…·ä½“å®ç°</h2>
<p>åªè¦ç”¨æˆ·æä¾›äº† <code>Marshal</code>, <code>Unmarshal</code> å’Œ <code>String</code> æ–¹æ³•å³å¯å®ç° <code>Marshaler</code> æ¥å£ï¼Œä»¥ä¸‹æä¾›ä¸€ä¸ªå®Œæ•´çš„ <code>json</code> ç‰ˆæœ¬ä»£ç :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#8be9fd;font-style:italic">var</span> jsonbMarshaler = <span style="color:#ff79c6">&amp;</span>mjsonpb.Marshaler{}

<span style="color:#6272a4">// create buffer pool with 16 instances each preallocated with 256 bytes
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">var</span> bufferPool = bpool.<span style="color:#50fa7b">NewSizedBufferPool</span>(<span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">256</span>)

<span style="color:#8be9fd;font-style:italic">type</span> Marshaler <span style="color:#8be9fd;font-style:italic">struct</span>{}

<span style="color:#8be9fd;font-style:italic">func</span> (j Marshaler) <span style="color:#50fa7b">Marshal</span>(v <span style="color:#8be9fd;font-style:italic">interface</span>{}) ([]<span style="color:#8be9fd">byte</span>, <span style="color:#8be9fd">error</span>) {
	<span style="color:#ff79c6">if</span> pb, ok <span style="color:#ff79c6">:=</span> v.(proto.Message); ok {
		buf <span style="color:#ff79c6">:=</span> bufferPool.<span style="color:#50fa7b">Get</span>()
		<span style="color:#ff79c6">defer</span> bufferPool.<span style="color:#50fa7b">Put</span>(buf)
		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> jsonbMarshaler.<span style="color:#50fa7b">Marshal</span>(buf, pb); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
			<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
		}
		<span style="color:#ff79c6">return</span> buf.<span style="color:#50fa7b">Bytes</span>(), <span style="color:#ff79c6">nil</span>
	}
	<span style="color:#ff79c6">return</span> json.<span style="color:#50fa7b">Marshal</span>(v)
}

<span style="color:#8be9fd;font-style:italic">func</span> (j Marshaler) <span style="color:#50fa7b">Unmarshal</span>(d []<span style="color:#8be9fd">byte</span>, v <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span> {
	<span style="color:#ff79c6">if</span> pb, ok <span style="color:#ff79c6">:=</span> v.(proto.Message); ok {
		<span style="color:#ff79c6">return</span> mjsonpb.<span style="color:#50fa7b">Unmarshal</span>(bytes.<span style="color:#50fa7b">NewReader</span>(d), pb)
	}
	<span style="color:#ff79c6">return</span> json.<span style="color:#50fa7b">Unmarshal</span>(d, v)
}

<span style="color:#8be9fd;font-style:italic">func</span> (j Marshaler) <span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span> {
	<span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;json&#34;</span>
}
</code></pre></div><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<h3 id="æ³¨å†Œ">æ³¨å†Œ</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	encoding.<span style="color:#50fa7b">RegisterMarshaler</span>(<span style="color:#f1fa8c">&#34;json&#34;</span>, <span style="color:#ff79c6">&amp;</span>Marshaler{})
}
</code></pre></div><h3 id="è·å–">è·å–</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	m, ok <span style="color:#ff79c6">:=</span> encoding.<span style="color:#50fa7b">GetMarshaler</span>(<span style="color:#f1fa8c">&#34;json&#34;</span>)
}
</code></pre></div><h3 id="åºåˆ—åŒ–å’Œååºåˆ—åŒ–">åºåˆ—åŒ–å’Œååºåˆ—åŒ–</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/codec/encoding&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">type</span> Person <span style="color:#8be9fd;font-style:italic">struct</span> {
	Name <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;name&#34;`</span>
	Age  <span style="color:#8be9fd">int32</span>  <span style="color:#f1fa8c">`json:&#34;age&#34;`</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	m, _ <span style="color:#ff79c6">:=</span> encoding.<span style="color:#50fa7b">GetMarshaler</span>(<span style="color:#f1fa8c">&#34;json&#34;</span>)
	p <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>Person{
		Name: <span style="color:#f1fa8c">&#34;Vine&#34;</span>,
		Age:  <span style="color:#bd93f9">20</span>,
	}

	data, _ <span style="color:#ff79c6">:=</span> m.<span style="color:#50fa7b">Marshal</span>(p)
	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#8be9fd;font-style:italic">string</span>(data))

	p1 <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">new</span>(Person)
	m.<span style="color:#50fa7b">Unmarshal</span>(data, <span style="color:#ff79c6">&amp;</span>p1)
	fmt.<span style="color:#50fa7b">Println</span>(p1.Name)
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-59586a1fa5b90047cde9c17a0fe343a1">2.4 - è®¢é˜…å‘å¸ƒ</h1>
    
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p>å¾®æœåŠ¡æ˜¯ä¸€ç§äº‹ä»¶é©±åŠ¨çš„ä½“ç³»ç»“æ„æ¨¡å¼ï¼Œå› æ­¤ <strong>Vine</strong> ä½¿ç”¨æ¶ˆæ¯ä»£ç†æ¥å£æ„å»ºå¼‚æ­¥æ¶ˆæ¯çš„æ¦‚å¿µã€‚å®ƒå¯ä¸ºç”¨æˆ·æ— ç¼åœ°è¿è¡Œ protobuf ç±»å‹ï¼Œå¹¶è‡ªåŠ¨ç¼–ç å’Œè§£ç æ¶ˆæ¯ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Broker is an interface used for asynchronous messaging.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Broker <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#50fa7b">Address</span>() <span style="color:#8be9fd">string</span>
	<span style="color:#50fa7b">Connect</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Disconnect</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Publish</span>(topic <span style="color:#8be9fd">string</span>, m <span style="color:#ff79c6">*</span>Message, opts <span style="color:#ff79c6">...</span>PublishOption) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Subscribe</span>(topic <span style="color:#8be9fd">string</span>, h Handler, opts <span style="color:#ff79c6">...</span>SubscribeOption) (Subscriber, <span style="color:#8be9fd">error</span>)
	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œvine å®ç°ç‚¹å¯¹ç‚¹ http ä»£ç†ï¼Œä½†å¯ä»¥é€šè¿‡ <a href="https://github.com/vine-io/plugins/tree/main/broker">plugins</a> æ›¿æ¢å®ç°ã€‚</p>
<h2 id="å‘å¸ƒæ¶ˆæ¯">å‘å¸ƒæ¶ˆæ¯</h2>
<p>ä½¿ç”¨ topic åç§°å’ŒæœåŠ¡å®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªæ–°çš„å‘å¸ƒè€…</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">p <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewEvent</span>(<span style="color:#f1fa8c">&#34;events&#34;</span>, service.<span style="color:#50fa7b">Client</span>())
</code></pre></div><p>å‘å¸ƒ proto æ¶ˆæ¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">p.<span style="color:#50fa7b">Publish</span>(context.<span style="color:#50fa7b">TODO</span>(), <span style="color:#ff79c6">&amp;</span>proto.Event{Name: <span style="color:#f1fa8c">&#34;event&#34;</span>})
</code></pre></div><h2 id="è®¢é˜…">è®¢é˜…</h2>
<p>åˆ›å»ºæ¶ˆæ¯å¤„ç†ç¨‹åºã€‚å®ƒçš„ç­¾ååº”è¯¥æ˜¯ <code>func(context.Context, v interface{}) error</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">ProcessEvent</span>(ctx context.Context, event <span style="color:#ff79c6">*</span>proto.Event) <span style="color:#8be9fd">error</span> {
    fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;Got event %+v\n&#34;</span>, event)
    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}
</code></pre></div><p>ä½¿ç”¨ topic æ³¨å†Œæ¶ˆæ¯å¤„ç†ç¨‹åº</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">vine.<span style="color:#50fa7b">RegisterSubscriber</span>(<span style="color:#f1fa8c">&#34;events&#34;</span>, ProcessEvent)
</code></pre></div><p>å®Œæ•´å®ä¾‹å¯ä»¥çœ‹ <a href="https://github.com/vine-io/examples/tree/main/pubsub">example/pubsub</a></p>
<h2 id="å•ç‹¬ä½¿ç”¨-broker">å•ç‹¬ä½¿ç”¨ Broker</h2>
<p><code>Broker</code> ä¹Ÿå¯ä»¥å•ç‹¬ä½¿ç”¨ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/service/broker&#34;</span>
	log <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/service/logger&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	topic <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;go.vine.topic.foo&#34;</span>

	b <span style="color:#ff79c6">:=</span> broker.<span style="color:#50fa7b">NewBroker</span>()

	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> b.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;Broker Init error: %v&#34;</span>, err)
	}
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> b.<span style="color:#50fa7b">Connect</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;Broker Connect error: %v&#34;</span>, err)
	}

	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		<span style="color:#6272a4">// receive message from broker
</span><span style="color:#6272a4"></span>		b.<span style="color:#50fa7b">Subscribe</span>(topic, <span style="color:#8be9fd;font-style:italic">func</span>(p broker.Event) <span style="color:#8be9fd">error</span> {
			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;[sub] received message:&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(p.<span style="color:#50fa7b">Message</span>().Body), <span style="color:#f1fa8c">&#34;header&#34;</span>, p.<span style="color:#50fa7b">Message</span>().Header)
			<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
		})
	}()

	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		<span style="color:#ff79c6">&lt;-</span>time.<span style="color:#50fa7b">After</span>(time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">1</span>)
		<span style="color:#6272a4">// publish message to broker
</span><span style="color:#6272a4"></span>        b.<span style="color:#50fa7b">Publish</span>(topic, <span style="color:#ff79c6">&amp;</span>broker.Message{Header: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;a&#34;</span>: <span style="color:#f1fa8c">&#34;b&#34;</span>}, Body: []<span style="color:#8be9fd;font-style:italic">byte</span>(<span style="color:#f1fa8c">&#34;hello world&#34;</span>)})
	}()

    time.<span style="color:#50fa7b">Sleep</span>(time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">2</span>)
    
    b.<span style="color:#50fa7b">Disconnect</span>()
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d2d36bead0be0a3b9422b2b89dcb6a4f">2.5 - å†…éƒ¨æœåŠ¡</h1>
    
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p><code>Server</code> æ˜¯å¾®æœåŠ¡çš„æ ¸å¿ƒæ¨¡å—ï¼Œå®ƒå¯¹å¤–æä¾›æ¥å£ï¼Œæ ¹æ®ä¸åŒçš„å®ç°ï¼Œæä¾›ç›¸åº”ç±»å‹çš„æ¥å£ã€‚ç›®å‰å†…éƒ¨æ”¯æŒ:</p>
<ul>
<li>grpc</li>
<li>http</li>
</ul>
<p><code>Server</code> ä¾èµ–å›¾</p>

<figure>
    <img src=" /vine/docs/component/server/2021-09-03-11-20-03.png " width="30%" height="30%"/> 
</figure>

<p>ä»¥ä¸‹æ˜¯ <code>Server</code> æ¨¡å—çš„å†…éƒ¨æ–¹æ³•ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Server is a simple vine server abstraction
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Server <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#6272a4">// åˆå§‹åŒ–
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// è¿”å› Options
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#6272a4">// æ³¨å†Œ Handler
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Handle</span>(Handler) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// åˆ›å»ºä¸€ä¸ªæ–°çš„ Handler
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">NewHandler</span>(<span style="color:#8be9fd;font-style:italic">interface</span>{}, <span style="color:#ff79c6">...</span>HandlerOption) Handler
	<span style="color:#6272a4">// åˆ›å»ºä¸€ä¸ªæ–°çš„ Subscriber
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">NewSubscriber</span>(<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd;font-style:italic">interface</span>{}, <span style="color:#ff79c6">...</span>SubscriberOption) Subscriber
	<span style="color:#6272a4">// æ³¨å†Œ Subscriber
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Subscribe</span>(Subscriber) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// å¯åŠ¨æœåŠ¡
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Start</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// åœæ­¢æœåŠ¡
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Stop</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Server æ¥å£ç±»å‹
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><h2 id="ä½¿ç”¨æ–¹æ³•">ä½¿ç”¨æ–¹æ³•</h2>
<h3 id="å¯åŠ¨ä¸€ä¸ª-grpc-æœåŠ¡">å¯åŠ¨ä¸€ä¸ª grpc æœåŠ¡</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;log&#34;</span>
	<span style="color:#f1fa8c">&#34;os&#34;</span>
	<span style="color:#f1fa8c">&#34;os/signal&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/broker/memory&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry/mdns&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/server&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/server/grpc&#34;</span>
	usignal <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/util/signal&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// æ–°å»º gRPC æœåŠ¡
</span><span style="color:#6272a4"></span>	s <span style="color:#ff79c6">:=</span> grpc.<span style="color:#50fa7b">NewServer</span>(
		server.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;helloworld&#34;</span>),
		server.<span style="color:#50fa7b">Address</span>(<span style="color:#f1fa8c">&#34;:9000&#34;</span>),
		server.<span style="color:#50fa7b">Broker</span>(memory.<span style="color:#50fa7b">NewBroker</span>()),
		server.<span style="color:#50fa7b">Registry</span>(mdns.<span style="color:#50fa7b">NewRegistry</span>()),
	)
	<span style="color:#6272a4">// åˆå§‹åŒ–
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;grpc init: %v&#34;</span>, err)
	}
	<span style="color:#6272a4">// å¯åŠ¨æœåŠ¡, (éé˜»å¡)
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Start</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;grpc start: %v&#34;</span>, err)
	}
	<span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>	ch <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> os.Signal, <span style="color:#bd93f9">1</span>)
	signal.<span style="color:#50fa7b">Notify</span>(ch, usignal.<span style="color:#50fa7b">Shutdown</span>()<span style="color:#ff79c6">...</span>)

	<span style="color:#ff79c6">select</span> {
	<span style="color:#6272a4">// wait on kill signal
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">case</span> <span style="color:#ff79c6">&lt;-</span>ch:
	}

    <span style="color:#6272a4">// åœæ­¢æœåŠ¡
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Stop</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;grpc stop: %v&#34;</span>, err)
	}
}
</code></pre></div><h3 id="æ³¨å†Œ-handler">æ³¨å†Œ Handler</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">...</span>

<span style="color:#8be9fd;font-style:italic">type</span> HelloImpl <span style="color:#8be9fd;font-style:italic">struct</span> {

}

<span style="color:#8be9fd;font-style:italic">var</span> _ proto.Message = (<span style="color:#ff79c6">*</span>Request)(<span style="color:#ff79c6">nil</span>)
<span style="color:#8be9fd;font-style:italic">type</span> Request <span style="color:#8be9fd;font-style:italic">struct</span> {
	Name <span style="color:#8be9fd">string</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>Request) <span style="color:#50fa7b">Reset</span>() {
	r = <span style="color:#ff79c6">&amp;</span>Request{}
}

<span style="color:#8be9fd;font-style:italic">func</span> (r Request) <span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span> {
	<span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> (r Request) <span style="color:#50fa7b">ProtoMessage</span>() {

}


<span style="color:#8be9fd;font-style:italic">type</span> Response <span style="color:#8be9fd;font-style:italic">struct</span> {
	Name <span style="color:#8be9fd">string</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> (h <span style="color:#ff79c6">*</span>HelloImpl) <span style="color:#50fa7b">Get</span>(ctx context.Context, r <span style="color:#ff79c6">*</span>Request, rsp <span style="color:#ff79c6">*</span>Response) <span style="color:#8be9fd">error</span> {
	rsp.Name = r.Name
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}
<span style="color:#ff79c6">...</span>

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#ff79c6">...</span>
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;grpc init: %v&#34;</span>, err)
	}

	h <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>HelloImpl{}
	opts <span style="color:#ff79c6">:=</span> []server.HandlerOption{
		api.<span style="color:#50fa7b">WithEndpoint</span>(<span style="color:#ff79c6">&amp;</span>api.Endpoint{
			Name:        <span style="color:#f1fa8c">&#34;HelloWorld.Get&#34;</span>,
			Description: <span style="color:#f1fa8c">&#34;HelloWorld.Get&#34;</span>,
			Path:        []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;/api/v1/get&#34;</span>},
			Method:      []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;GET&#34;</span>},
			Body:        <span style="color:#f1fa8c">&#34;*&#34;</span>,
			Handler:     <span style="color:#f1fa8c">&#34;rpc&#34;</span>,
		}),
	}
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Handle</span>(s.<span style="color:#50fa7b">NewHandler</span>(h, opts<span style="color:#ff79c6">...</span>)); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;register handler: %v&#34;</span>, err)
	}
	<span style="color:#ff79c6">...</span>
}
</code></pre></div><h3 id="æ³¨å†Œ-subscriber">æ³¨å†Œ Subscriber</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Alternatively a function can be used
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">subEv</span>(ctx context.Context, event <span style="color:#ff79c6">*</span>Request) <span style="color:#8be9fd">error</span> {
	md, _ <span style="color:#ff79c6">:=</span> metadata.<span style="color:#50fa7b">FromContext</span>(ctx)
	log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;[pubsub.2] Received event %+v with metadata %+v\n&#34;</span>, event, md)
	<span style="color:#6272a4">// do something with event
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#ff79c6">...</span>
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;grpc init: %v&#34;</span>, err)
	}

	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Subscribe</span>(s.<span style="color:#50fa7b">NewSubscriber</span>(<span style="color:#f1fa8c">&#34;get.topic&#34;</span>, subEv, server.<span style="color:#50fa7b">SubscriberQueue</span>(<span style="color:#f1fa8c">&#34;sub&#34;</span>))); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;register subscribe: %v&#34;</span>, err)
	}
	<span style="color:#ff79c6">...</span>
}
</code></pre></div><h2 id="options">options</h2>
<p>ä½¿ç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	s <span style="color:#ff79c6">:=</span> grpc.<span style="color:#50fa7b">NewServer</span>(server.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;name&#34;</span>))
}
</code></pre></div><p><code>Server</code> åˆ›å»ºå’Œåˆå§‹åŒ– options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span>  <span style="color:#50fa7b">main</span>() {
	grpc.<span style="color:#50fa7b">NewServer</span>(
		<span style="color:#6272a4">// è®¾ç½®æœåŠ¡åç§°
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Name</span>(),
		<span style="color:#6272a4">// è®¾ç½®å…¬å…± IP åœ°å€
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Advertise</span>(),
		<span style="color:#6272a4">// è®¾ç½®æœåŠ¡ç»‘å®šåœ°å€ï¼Œå¦‚æœ Advertise ä¸ä¸ºç©ºï¼Œä¼˜å…ˆé€‰æ‹© Advertise
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Address</span>(),
		<span style="color:#6272a4">// è®¾ç½®æœåŠ¡ id
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Id</span>(),
		<span style="color:#6272a4">// è®¾ç½®æœåŠ¡ ç‰ˆæœ¬
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Version</span>(),
		<span style="color:#6272a4">// è®¾ç½®æœåŠ¡ context.Context, ä¿å­˜é¢å¤–çš„å€¼
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Context</span>(),
		<span style="color:#6272a4">// è®¾ç½®æœåŠ¡åºåˆ—åŒ–
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Codec</span>(),
		<span style="color:#6272a4">// è®¾ç½®æœåŠ¡ä¾èµ–çš„ Broker
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Broker</span>(memory.<span style="color:#50fa7b">NewBroker</span>()),
		<span style="color:#6272a4">// è®¾ç½®æœåŠ¡ä¾èµ–çš„ Registry
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Registry</span>(mdns.<span style="color:#50fa7b">NewRegistry</span>()),
		<span style="color:#6272a4">// æ·»åŠ  Subscriber å¤„ç†å™¨çš„è£…è½½å™¨
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">WrapSubscriber</span>(),
		<span style="color:#6272a4">// æ·»åŠ  Handler è£…è½½å™¨
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">WrapHandler</span>(),
		<span style="color:#6272a4">// è®¾ç½®æœåŠ¡æ³¨å†Œæ—¶çš„ ttl
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">RegisterTTL</span>(),
		<span style="color:#6272a4">// è®¾ç½®æœåŠ¡æ³¨å†Œé—´éš”æ—¶é—´
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">RegisterInterval</span>(),
		<span style="color:#6272a4">// è®¾ç½®å†…éƒ¨ sync.WaitGroup
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Wait</span>(),
		<span style="color:#6272a4">// è®¾ç½®æœåŠ¡å…ƒæ•°æ®
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Metadata</span>(),
		<span style="color:#6272a4">// è®¾ç½®æœåŠ¡å¯åŠ¨æ—¶æ³¨å†Œåˆ° Registry çš„æ£€æµ‹å‡½æ•°
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">RegisterCheck</span>(<span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context) <span style="color:#8be9fd">error</span> {
			<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
		}),
		<span style="color:#6272a4">// è®¾ç½®æœåŠ¡ Router
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">WithRouter</span>(),
	)
}
</code></pre></div><p>åˆ›å»º Handler çš„ options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	s.<span style="color:#50fa7b">NewHandler</span>(h,
		server.<span style="color:#50fa7b">InternalHandler</span>(), <span style="color:#6272a4">// å†…éƒ¨ handler
</span><span style="color:#6272a4"></span>		api.<span style="color:#50fa7b">WithEndpoint</span>(),   <span style="color:#6272a4">// æ·»åŠ  api ä¿¡æ¯
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">OpenAPIHandler</span>(), <span style="color:#6272a4">// æ·»åŠ  swagger ä¿¡æ¯
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p>åˆ›å»º Subscriber çš„ options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	s.<span style="color:#50fa7b">NewSubscriber</span>(<span style="color:#f1fa8c">&#34;topic&#34;</span>, subEv,
		server.<span style="color:#50fa7b">InternalSubscriber</span>(), <span style="color:#6272a4">// å†…éƒ¨ internal
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">SubscriberQueue</span>(),   <span style="color:#6272a4">// è®¾ç½® subscriber é˜Ÿåˆ—
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">SubscriberContext</span>(), <span style="color:#6272a4">// subscriber å†…éƒ¨ context.Context
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><h2 id="grpc-ç»“åˆ-http">gRPC ç»“åˆ http</h2>
<p><code>Server</code> çš„ gRPC å®ç°å¯ä»¥åŒæ—¶æä¾› gRPC å’Œ http æœåŠ¡:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	gh <span style="color:#ff79c6">:=</span> grpc.Grpc2Http{
		CertFile: <span style="color:#f1fa8c">&#34;server.pem&#34;</span>,
		KeyFile:  <span style="color:#f1fa8c">&#34;server.key&#34;</span>,
		CaFile:   <span style="color:#f1fa8c">&#34;ca.pem&#34;</span>,
	}
	grpc.<span style="color:#50fa7b">NewServer</span>(grpc.<span style="color:#50fa7b">GrpcToHttp</span>(gh))
}
</code></pre></div><blockquote>
<p>grpc å†…ç½® prometheus metrics å’Œ golang http prof æ¥å£</p>
</blockquote>
<h2 id="http-å®ç°">http å®ç°</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	reg <span style="color:#ff79c6">:=</span> memory.<span style="color:#50fa7b">NewRegistry</span>()
	bro <span style="color:#ff79c6">:=</span> membroker.<span style="color:#50fa7b">NewBroker</span>()

	<span style="color:#6272a4">// create server
</span><span style="color:#6272a4"></span>	srv <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">NewServer</span>(server.<span style="color:#50fa7b">Registry</span>(reg), server.<span style="color:#50fa7b">Broker</span>(bro))

	<span style="color:#6272a4">// create server mux
</span><span style="color:#6272a4"></span>	mux <span style="color:#ff79c6">:=</span> http.<span style="color:#50fa7b">NewServeMux</span>()
	mux.<span style="color:#50fa7b">HandleFunc</span>(<span style="color:#f1fa8c">&#34;/&#34;</span>, <span style="color:#8be9fd;font-style:italic">func</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request) {
		w.<span style="color:#50fa7b">Write</span>([]<span style="color:#8be9fd;font-style:italic">byte</span>(<span style="color:#f1fa8c">`hello world`</span>))
	})

	<span style="color:#6272a4">// create handler
</span><span style="color:#6272a4"></span>	hd <span style="color:#ff79c6">:=</span> srv.<span style="color:#50fa7b">NewHandler</span>(mux)

	<span style="color:#6272a4">// register handler
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> srv.<span style="color:#50fa7b">Handle</span>(hd); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		t.<span style="color:#50fa7b">Fatal</span>(err)
	}

	<span style="color:#6272a4">// start server
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> srv.<span style="color:#50fa7b">Start</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		t.<span style="color:#50fa7b">Fatal</span>(err)
	}

	<span style="color:#ff79c6">select</span>{}
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-890777915678ed57c745424af4cba2b8">2.6 - å†…éƒ¨è¯·æ±‚</h1>
    
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p><code>Client</code> æ˜¯å¾®æœåŠ¡çš„æ ¸å¿ƒæ¨¡å—ï¼Œæä¾›ä¸€ä¸ªè¯·æ±‚å…¶ä»–æœåŠ¡çš„å·¥å…·ï¼Œæ ¹æ®ä¸åŒçš„å®ç°ï¼Œæä¾›ç›¸åº”ç±»å‹çš„æ¥å£ã€‚ç›®å‰å†…éƒ¨æ”¯æŒ:</p>
<ul>
<li>grpc</li>
<li>http</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Client <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#50fa7b">NewMessage</span>(topic <span style="color:#8be9fd">string</span>, msg <span style="color:#8be9fd;font-style:italic">interface</span>{}, opts <span style="color:#ff79c6">...</span>MessageOption) Message
	<span style="color:#50fa7b">NewRequest</span>(service, endpoint <span style="color:#8be9fd">string</span>, req <span style="color:#8be9fd;font-style:italic">interface</span>{}, reqOpts <span style="color:#ff79c6">...</span>RequestOption) Request
	<span style="color:#50fa7b">Call</span>(ctx context.Context, req Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}, opts <span style="color:#ff79c6">...</span>CallOption) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Stream</span>(ctx context.Context, req Request, opts <span style="color:#ff79c6">...</span>CallOption) (Stream, <span style="color:#8be9fd">error</span>)
	<span style="color:#50fa7b">Publish</span>(ctx context.Context, msg Message, opts <span style="color:#ff79c6">...</span>PublishOption) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><h2 id="ä½¿ç”¨æ–¹æ³•">ä½¿ç”¨æ–¹æ³•</h2>
<h3 id="å¯åŠ¨è¯·æ±‚">å¯åŠ¨è¯·æ±‚</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;log&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/broker/memory&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/client&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/client/grpc&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry/mdns&#34;</span>
	pb <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/testdata/proto&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    <span style="color:#6272a4">// æ–°å»ºä¸€ä¸ªæ–°çš„ gRPC Client
</span><span style="color:#6272a4"></span>	cc <span style="color:#ff79c6">:=</span> grpc.<span style="color:#50fa7b">NewClient</span>(
		client.<span style="color:#50fa7b">Registry</span>(mdns.<span style="color:#50fa7b">NewRegistry</span>()),
		client.<span style="color:#50fa7b">Broker</span>(memory.<span style="color:#50fa7b">NewBroker</span>()),
	)
    <span style="color:#6272a4">// åˆå§‹åŒ–
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	in <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>pb.Request{
		Id:   <span style="color:#f1fa8c">&#34;1&#34;</span>,
		Name: <span style="color:#f1fa8c">&#34;World&#34;</span>,
		Data: <span style="color:#f1fa8c">&#34;data&#34;</span>,
	}
    <span style="color:#6272a4">// åˆ›å»ºä¸€ä¸ªæ–°çš„è¯·æ±‚
</span><span style="color:#6272a4"></span>	req <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">NewRequest</span>(
		<span style="color:#f1fa8c">&#34;go.vine.helloworld&#34;</span>,
		<span style="color:#f1fa8c">&#34;HelloWorld.Get&#34;</span>,
		in,
	)
	rsp <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>pb.Response{}
    <span style="color:#6272a4">// è°ƒç”¨è¯·æ±‚
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Call</span>(context.<span style="color:#50fa7b">TODO</span>(), req, rsp); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	fmt.<span style="color:#50fa7b">Println</span>(rsp.Reply)
}
</code></pre></div><h3 id="å‘å¸ƒæ¶ˆæ¯">å‘å¸ƒæ¶ˆæ¯</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    <span style="color:#ff79c6">...</span>
    in <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>pb.Request{
		Id:   <span style="color:#f1fa8c">&#34;1&#34;</span>,
		Name: <span style="color:#f1fa8c">&#34;World&#34;</span>,
		Data: <span style="color:#f1fa8c">&#34;data&#34;</span>,
	}
    <span style="color:#6272a4">// å‘å¸ƒä¿¡æ¯
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Publish</span>(context.<span style="color:#50fa7b">TODO</span>(), cc.<span style="color:#50fa7b">NewMessage</span>(<span style="color:#f1fa8c">&#34;go.topic&#34;</span>, in)); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
    <span style="color:#ff79c6">...</span>
}
</code></pre></div><h3 id="æ–°å»ºæµ">æ–°å»ºæµ</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    <span style="color:#ff79c6">...</span>
    stream, err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Stream</span>(context.<span style="color:#50fa7b">TODO</span>(), req)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	<span style="color:#ff79c6">defer</span> stream.<span style="color:#50fa7b">Close</span>()

	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		<span style="color:#6272a4">// å‘é€æ¶ˆæ¯
</span><span style="color:#6272a4"></span>		stream.<span style="color:#50fa7b">Send</span>(in)
	}()
	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		<span style="color:#6272a4">// æ¥æ”¶æ¶ˆæ¯
</span><span style="color:#6272a4"></span>		rsp <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>pb.Request{}
		<span style="color:#6272a4">// é˜»å¡ç›´åˆ°æ¥æ”¶åˆ°æ¶ˆæ¯
</span><span style="color:#6272a4"></span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> stream.<span style="color:#50fa7b">Recv</span>(rsp); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {

		}
	}()
    <span style="color:#ff79c6">...</span>
}
</code></pre></div><h2 id="options">options</h2>
<p>åˆå§‹åŒ– options:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    cc <span style="color:#ff79c6">:=</span> grpc.<span style="color:#50fa7b">NewClient</span>(
		client.<span style="color:#50fa7b">Codec</span>(),     <span style="color:#6272a4">// è®¾ç½® codec
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">Selector</span>(),  <span style="color:#6272a4">// è®¾ç½® selector
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">Registry</span>(mdns.<span style="color:#50fa7b">NewRegistry</span>()), <span style="color:#6272a4">// è®¾ç½® registry
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">Broker</span>(memory.<span style="color:#50fa7b">NewBroker</span>()), <span style="color:#6272a4">// è®¾ç½® broker
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithRouter</span>(),  <span style="color:#6272a4">// è®¾ç½® router
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WrapCall</span>(),    <span style="color:#6272a4">// è®¾ç½®è¯·æ±‚è£…è½½å™¨
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">Wrap</span>(),        <span style="color:#6272a4">// è®¾ç½®è£…è½½å™¨
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">DialTimeout</span>(), <span style="color:#6272a4">// è®¾ç½®è¿æ¥è¶…æ—¶æ—¶é—´
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">ContentType</span>(), <span style="color:#6272a4">// è®¾ç½® Content-Type
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">Backoff</span>(),     <span style="color:#6272a4">// è®¾ç½®é‡è¯•æœºåˆ¶
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">PoolSize</span>(),    <span style="color:#6272a4">// è®¾ç½®è¿æ¥æ± å®¹é‡
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">PoolTTL</span>(),     <span style="color:#6272a4">// è®¾ç½®è¿æ¥æ±  ttl
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">StreamTimeout</span>(),  <span style="color:#6272a4">// è®¾ç½® stream è¶…æ—¶æ—¶é—´
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">Retries</span>(),     <span style="color:#6272a4">// è®¾ç½®é”™è¯¯é‡è¯•æ¬¡æ•°
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">Retry</span>(),   <span style="color:#6272a4">// è®¾ç½®é‡è¯•å‡½æ•°
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p><code>NewRequest</code> çš„ options:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    req <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">NewRequest</span>(
		<span style="color:#f1fa8c">&#34;go.vine.helloworld&#34;</span>,
		<span style="color:#f1fa8c">&#34;HelloWorld.Get&#34;</span>,
		in,
		client.<span style="color:#50fa7b">WithContentType</span>(<span style="color:#f1fa8c">&#34;application/json&#34;</span>), <span style="color:#6272a4">//  è®¾ç½®è¯·æ±‚ä½“çš„ Content-Type
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">StreamingRequest</span>(), <span style="color:#6272a4">// æµå¼è¯·æ±‚
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p><code>NewMessage</code> çš„ options:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    cc.<span style="color:#50fa7b">NewMessage</span>(
		<span style="color:#f1fa8c">&#34;topic&#34;</span>,
		in,
		client.<span style="color:#50fa7b">WithMessageContentType</span>(<span style="color:#f1fa8c">&#34;application/json&#34;</span>), <span style="color:#6272a4">// è®¾ç½®æ¶ˆæ¯çš„ Content-Type
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p><code>Call</code> çš„ options:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    cc.<span style="color:#50fa7b">Call</span>(context.<span style="color:#50fa7b">TODO</span>(), req, rsp,
		client.<span style="color:#50fa7b">WithAddress</span>(),      <span style="color:#6272a4">// è®¾ç½®æœåŠ¡ç«¯åœ°å€ï¼Œè·³è¿‡é€šè¿‡ Registry æŸ¥è¯¢æœåŠ¡ç«¯çš„æ­¥éª¤
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithRequestTimeout</span>(), <span style="color:#6272a4">// è¯·æ±‚è¶…æ—¶æ—¶é—´
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithStreamTimeout</span>(), <span style="color:#6272a4">// stream è¶…æ—¶æ—¶é—´
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithDialTimeout</span>(),   <span style="color:#6272a4">// è¿æ¥æ—¶é—´
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithBackoff</span>(),   <span style="color:#6272a4">// é‡è¯•æœºåˆ¶
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithCache</span>(),     <span style="color:#6272a4">// è®¾ç½®ç¼“å­˜æ—¶é—´
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithCallWrapper</span>(), <span style="color:#6272a4">// è®¾ç½®è¯·æ±‚è£…è½½å™¨
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithRetries</span>(),   <span style="color:#6272a4">// è®¾ç½®é‡è¯•æ¬¡æ•°
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithRetry</span>(),  <span style="color:#6272a4">// è®¾ç½®é‡è¯•å‡½æ•°
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithSelectOption</span>(), <span style="color:#6272a4">// è®¾ç½®ç­›é€‰å™¨
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p><code>Publish</code> çš„ Option:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    cc.<span style="color:#50fa7b">Publish</span>(context.<span style="color:#50fa7b">TODO</span>(), cc.<span style="color:#50fa7b">NewMessage</span>(<span style="color:#f1fa8c">&#34;go.topic&#34;</span>, in),
		client.<span style="color:#50fa7b">WithExchange</span>(<span style="color:#f1fa8c">&#34;&#34;</span>), <span style="color:#6272a4">// è®¾ç½® exchange
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><h2 id="http-client">http client</h2>
<p>http å®ç°çš„ client å¯ä»¥å‚è€ƒ <a href="https://github.com/vine-io/vine/blob/master/core/client/http/http_test.go">http</a></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-797b02a4bf0dfe71b512bbf7a2dce8be">2.7 - é”™è¯¯å¤„ç†</h1>
    
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p>æˆ‘ä»¬å®šä¹‰ä»¥ä¸‹é”™è¯¯ç±»å‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Error <span style="color:#8be9fd;font-style:italic">struct</span> {
	Id       <span style="color:#8be9fd">string</span>     <span style="color:#f1fa8c">`json:&#34;id,omitempty&#34;`</span>
	Code     <span style="color:#8be9fd">int32</span>      <span style="color:#f1fa8c">`json:&#34;code,omitempty&#34;`</span>
	Detail   <span style="color:#8be9fd">string</span>     <span style="color:#f1fa8c">`json:&#34;detail,omitempty&#34;`</span>
	Status   <span style="color:#8be9fd">string</span>     <span style="color:#f1fa8c">`json:&#34;status,omitempty&#34;`</span>
    Position <span style="color:#8be9fd">string</span>     <span style="color:#f1fa8c">`json:&#34;position,omitempty&#34;`</span>
    Child    <span style="color:#ff79c6">*</span>Child     <span style="color:#f1fa8c">`json:&#34;child,omitempty&#34;`</span>
    Stacks   []<span style="color:#ff79c6">*</span>Stack   <span style="color:#f1fa8c">`json:&#34;stacks,omitempty&#34;`</span>
}
</code></pre></div><p>åœ¨ç³»ç»Ÿä¸­ï¼Œè¦æ±‚ç”¨æˆ·ä»å¤„ç†ç¨‹åºè¿”å›é”™è¯¯æˆ–ä»å®¢æˆ·ç«¯æ¥æ”¶é”™è¯¯çš„ä»»ä½•ä½ç½®ï¼Œéƒ½åº”è®¤ä¸ºæ˜¯ <strong>Vine</strong> é”™è¯¯ï¼Œæˆ–è€…åº”è¯¥ç”Ÿæˆé”™è¯¯ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿”å› <code>errors.InternalServerError</code>ï¼Œå¦‚æœå‡ºç°é”™è¯¯é”™è¯¯åˆ™è¿”å› <code>errors.Timeout</code>ã€‚</p>
<h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<p>è®©æˆ‘ä»¬å‡è®¾ç¨‹åºä¸­å‘ç”Ÿé”™è¯¯ï¼Œç„¶åï¼Œä½ åº”è¯¥ç¡®å®šè¿”å›å“ªç§é”™è¯¯ï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹æ“ä½œã€‚
å‡è®¾æä¾›çš„æ•°æ®æ— æ•ˆï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">badRequest</span>(<span style="color:#f1fa8c">&#34;com.example.srv.service&#34;</span>, <span style="color:#f1fa8c">&#34;invalid field&#34;</span>)
</code></pre></div><p>å¦‚æœå‘ç”Ÿå†…éƒ¨é”™è¯¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">InternalServerError</span>(<span style="color:#f1fa8c">&#34;com.example.srv.service&#34;</span>, <span style="color:#f1fa8c">&#34;failed to read db: %v&#34;</span>, err.<span style="color:#50fa7b">Error</span>())
}
</code></pre></div><p>å¦‚æœä½ ä»å®¢æˆ·ç«¯æ”¶åˆ°ä¸€äº›é”™è¯¯ï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ–¹å¼å¤„ç†:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">cc <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">NewGreeterService</span>(<span style="color:#f1fa8c">&#34;go.vine.srv.greeter&#34;</span>, service.<span style="color:#50fa7b">Client</span>())
rsp, err <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">Clinet</span>(ctx, req)
<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
    <span style="color:#6272a4">// parse out the error 
</span><span style="color:#6272a4"></span>    e <span style="color:#ff79c6">:=</span> errors.<span style="color:#50fa7b">Parse</span>(err.<span style="color:#50fa7b">Error</span>())

    <span style="color:#6272a4">// inspect the value
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> e.Code <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">401</span> {
        <span style="color:#6272a4">// unauthorized
</span><span style="color:#6272a4"></span>    }
}
</code></pre></div><h2 id="é”™è¯¯åˆ—è¡¨">é”™è¯¯åˆ—è¡¨</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BadGateway</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BadRequest</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Conflict</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Forbidden</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">GatewayTimeout</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">InternalServerError</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">MethodNotAllowed</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">NotFound</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">NotImplemented</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">ServiceUnavailable</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Timeout</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Unauthorized</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
</code></pre></div><h2 id="è‡ªå®šä¹‰é”™è¯¯">è‡ªå®šä¹‰é”™è¯¯</h2>
<p>é™¤äº†å†…ç½®çš„é”™è¯¯ç±»å‹ä¹‹å¤–ï¼Œ<strong>Vine</strong> æ”¯æŒè‡ªå®šä¹‰é”™è¯¯ç±»å‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// è‡ªå®šä¹‰é”™è¯¯ï¼Œå¹¶è®°å½•é”™è¯¯ä½ç½®
</span><span style="color:#6272a4"></span>customErr <span style="color:#ff79c6">:=</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;go.vine.srv.example&#34;</span>, <span style="color:#f1fa8c">&#34;custom error&#34;</span>, <span style="color:#bd93f9">510</span>, <span style="color:#ff79c6">true</span>)
</code></pre></div><h2 id="å…¶ä»–">å…¶ä»–</h2>
<p>åˆ¤æ–­é”™è¯¯ç±»å‹æ˜¯å¦ç›¸åŒ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">b <span style="color:#ff79c6">:=</span> errors.<span style="color:#50fa7b">Equal</span>(err1, err2)
</code></pre></div><p>é“¾å¼è°ƒç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">e <span style="color:#ff79c6">:=</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;go.vine.srv.example&#34;</span>, <span style="color:#f1fa8c">&#34;name must be set&#34;</span>, <span style="color:#bd93f9">404</span>).
        <span style="color:#50fa7b">WithChild</span>(<span style="color:#bd93f9">111</span>, <span style="color:#f1fa8c">&#34;%v&#34;</span>, <span style="color:#f1fa8c">&#34;child error&#34;</span>). <span style="color:#6272a4">// æ·»åŠ é¢å¤–é”™è¯¯
</span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">WithPos</span>(). <span style="color:#6272a4">// è®°å½•é”™è¯¯ä½ç½® 
</span><span style="color:#6272a4"></span>		<span style="color:#50fa7b">WithStack</span>(<span style="color:#bd93f9">10001</span>, <span style="color:#f1fa8c">&#34;stack context&#34;</span>) <span style="color:#6272a4">// è¿½åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯ 
</span></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a166f9ca5ae0b67e66da460ca61f73a2">2.8 - é…ç½®ä¸­å¿ƒ</h1>
    
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p>åº”ç”¨ç¨‹åºä¸­çš„å¤§å¤šæ•°é…ç½®éƒ½æ˜¯é™æ€é…ç½®æˆ–è€…ä»å¤šä¸ªæºåŠ è½½çš„å¤æ‚é€»è¾‘ã€‚<strong>Config</strong> æ˜¯å…¶å˜å¾—ç®€å•ï¼Œå¯æ’æ‹”å’Œå¯åˆå¹¶ã€‚</p>
<h2 id="ç‰¹æ€§">ç‰¹æ€§</h2>
<ul>
<li><strong>åŠ¨æ€åŠ è½½</strong> - åœ¨éœ€è¦æ—¶ä»å¤šä¸ªæºåŠ è½½é…ç½®. <strong>Config</strong> ç®¡ç†åœ¨åå°ç›‘å¬é…ç½®æºï¼Œå¹¶è‡ªåŠ¨åˆå¹¶å’Œæ›´æ–°å†…å­˜ä¸­çš„é…ç½®æ–‡ä»¶æºã€‚</li>
<li><strong>å¯æ’æ‹”çš„æº</strong> - ä»ä»»æ„æ•°é‡çš„æºä¸­è¿›è¡Œé€‰æ‹©ä»¥åŠ è½½å’Œåˆå¹¶é…ç½®ã€‚åç«¯æºè¢«æŠ½è±¡ä¸ºå†…éƒ¨ä½¿ç”¨å¹¶é€šè¿‡ç¼–ç å™¨è§£ç çš„æ ‡å‡†æ ¼å¼ã€‚æºå¯ä»¥æ˜¯ env vars, flags, etcd, k8s configmap, ç­‰ã€‚</li>
<li><strong>å¯åˆå¹¶é…ç½®</strong> - å¦‚æœæŒ‡å®šå¤šä¸ªé…ç½®æºï¼Œæ— è®ºæ ¼å¼å¦‚ä½•ï¼Œå®ƒä»¬éƒ½å°†åˆå¹¶å¹¶åœ¨å•ä¸ªè§†å›¾ä¸­æ˜¾ç¤ºã€‚è¿™æå¤§åœ°ç®€åŒ–äº†åŸºäºç¯å¢ƒçš„ä¼˜å…ˆçº§é¡ºåºåŠ è½½å’Œæ›´æ”¹ã€‚</li>
<li><strong>æ”¹åŠ¨ç›‘å¬</strong> - å¯é€‰æ‹©ç›‘å¬é…ç½®ï¼Œä»¥ç›‘æ§ç‰¹å®šå€¼çš„æ›´æ”¹ã€‚ä½¿ç”¨ <strong>Config</strong> çš„ç›‘å¬ç¨‹åºçƒ­åŠ è½½ä½ çš„åº”ç”¨ã€‚ä¸å¿…ä¸´æ—¶å…³æœºé‡æ–°åŠ è½½å…¶ä»–ä»»ä½•å†…å®¹ï¼Œåªéœ€ç»§ç»­è¯»å–é…ç½®å¹¶ç›‘å¬éœ€è¦é€šçŸ¥çš„æ›´æ”¹ã€‚</li>
<li><strong>å®‰å…¨æ¢å¤</strong> - å¦‚æœé…ç½®è´Ÿè½½ä¸¥é‡æˆ–ç”±äºæœªçŸ¥åŸå› å®Œå…¨æ“¦é™¤ï¼Œåˆ™å¯ä»¥åœ¨ç›´æ¥è®¿é—®ä»»ä½•é…ç½®å€¼æ—¶æŒ‡å®šå›é€€å€¼ã€‚è¿™å¯ç¡®ä¿åœ¨å‘ç”Ÿé—®é¢˜æ—¶å§‹ç»ˆè¯»å–æŸäº›åˆç†çš„é»˜è®¤å€¼ã€‚</li>
</ul>
<h2 id="å†…éƒ¨å®ç°">å†…éƒ¨å®ç°</h2>
<p>ä¸‹é¢ä»‹ç» <strong>Config</strong> çš„å®ç°ï¼Œ<strong>Config</strong> æœ‰ä»¥ä¸‹éƒ¨åˆ†ç»„æˆï¼š</p>
<ul>
<li>source: é…ç½®çš„æ¥æº</li>
<li>encoder: å¤„ç†ç¼–ç /è§£ç æºé…ç½®</li>
<li>reader: å°†å¤šä¸ªç¼–ç æºåˆå¹¶ä¸ºå•ä¸€æ ¼å¼</li>
<li>loaderï¼šç®¡ç†åŠ è½½æº</li>
</ul>
<h3 id="source">Source</h3>
<p><code>Source</code> ä½œä¸ºé…ç½®çš„è¯»å–æ¥æºã€‚å¯ä»¥åŒæ—¶ä½¿ç”¨å¤šä¸ªæºã€‚
æ”¯æŒä»¥ä¸‹æº:</p>
<p>cli : ä» CLI æ ‡å¿—è¯»å–</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    <span style="color:#6272a4">// New Service
</span><span style="color:#6272a4"></span>    service <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
        vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;example&#34;</span>),
        vine.<span style="color:#50fa7b">Flags</span>(
            cli.StringFlag{
                Name: <span style="color:#f1fa8c">&#34;database-address&#34;</span>,
                Value: <span style="color:#f1fa8c">&#34;127.0.0.1&#34;</span>,
                Usage: <span style="color:#f1fa8c">&#34;the db address&#34;</span>,
            },
        ),
    )

    <span style="color:#8be9fd;font-style:italic">var</span> clisrc source.Source

    service.<span style="color:#50fa7b">Init</span>(
        vine.<span style="color:#50fa7b">Action</span>(<span style="color:#8be9fd;font-style:italic">func</span>(c <span style="color:#ff79c6">*</span>cli.Context) {
            clisrc = cli.<span style="color:#50fa7b">NewSource</span>(
                cli.<span style="color:#50fa7b">Context</span>(c),
	    )
            <span style="color:#6272a4">// Alternatively, just setup your config right here
</span><span style="color:#6272a4"></span>        }),
    )
    
    <span style="color:#6272a4">// ... Load and use that source ...
</span><span style="color:#6272a4"></span>    conf <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">NewConfig</span>()
    conf.<span style="color:#50fa7b">Load</span>(clisrc)
}
</code></pre></div><p>env : ä»ç¯å¢ƒå˜é‡ä¸­è¯»å–</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">src <span style="color:#ff79c6">:=</span> env.<span style="color:#50fa7b">NewSource</span>(
	<span style="color:#6272a4">// optionally specify prefix
</span><span style="color:#6272a4"></span>	env.<span style="color:#50fa7b">WithPrefix</span>(<span style="color:#f1fa8c">&#34;VINE&#34;</span>),
)

<span style="color:#6272a4">// Create new config
</span><span style="color:#6272a4"></span>conf <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">NewConfig</span>()

<span style="color:#6272a4">// Load env source
</span><span style="color:#6272a4"></span>conf.<span style="color:#50fa7b">Load</span>(src)
</code></pre></div><p>file : ä»æ–‡ä»¶ä¸­è¯»å–</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	data <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd;font-style:italic">byte</span>(<span style="color:#f1fa8c">`{&#34;foo&#34;: &#34;bar&#34;}`</span>)
	path <span style="color:#ff79c6">:=</span> filepath.<span style="color:#50fa7b">Join</span>(os.<span style="color:#50fa7b">TempDir</span>(), fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;file.%d&#34;</span>, time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">UnixNano</span>()))
	fh, err <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Create</span>(path)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		t.<span style="color:#50fa7b">Error</span>(err)
	}
	<span style="color:#ff79c6">defer</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		fh.<span style="color:#50fa7b">Close</span>()
		os.<span style="color:#50fa7b">Remove</span>(path)
	}()

	_, err = fh.<span style="color:#50fa7b">Write</span>(data)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		t.<span style="color:#50fa7b">Error</span>(err)
	}

	f <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">NewSource</span>(<span style="color:#50fa7b">WithPath</span>(path))
	c, err <span style="color:#ff79c6">:=</span> f.<span style="color:#50fa7b">Read</span>()
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		t.<span style="color:#50fa7b">Error</span>(err)
	}
}
</code></pre></div><p>flag : ä»æ ‡å¿—ä¸­è¯»å–</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">flagSource <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">NewSource</span>(
	<span style="color:#6272a4">// optionally enable reading of unset flags and their default
</span><span style="color:#6272a4"></span>	<span style="color:#6272a4">// values into config, defaults to false
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">IncludeUnset</span>(<span style="color:#ff79c6">true</span>)
)
<span style="color:#6272a4">// Create new config
</span><span style="color:#6272a4"></span>conf <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">NewConfig</span>()

<span style="color:#6272a4">// Load flag source
</span><span style="color:#6272a4"></span>conf.<span style="color:#50fa7b">Load</span>(flagSource)
</code></pre></div><p>memory : ä»å†…å­˜ä¸­è¯»å–</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memorySource <span style="color:#ff79c6">:=</span> memory.<span style="color:#50fa7b">NewSource</span>(
	memory.<span style="color:#50fa7b">WithJSON</span>(data),
)
<span style="color:#6272a4">// Create new config
</span><span style="color:#6272a4"></span>conf <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">NewConfig</span>()
<span style="color:#6272a4">// Load memory source
</span><span style="color:#6272a4"></span>conf.<span style="color:#50fa7b">Load</span>(memorySource)
</code></pre></div><h3 id="changeset">ChangeSet</h3>
<p><strong>Source</strong> å°† <strong>Config</strong> ä½œä¸ºä¸€ä¸ª <strong>ChangeSet</strong> è¿”å›ï¼Œä½œä¸ºå¤šä¸ªæºçš„å•ä¸€å†…éƒ¨æŠ½è±¡ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// ChangeSet represents a set of changes from a source
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> ChangeSet <span style="color:#8be9fd;font-style:italic">struct</span> {
	Data      []<span style="color:#8be9fd">byte</span>
	CheckSum  <span style="color:#8be9fd">string</span>
	Format    <span style="color:#8be9fd">string</span>
	Source    <span style="color:#8be9fd">string</span>
	Timestamp time.Time
}
</code></pre></div><h3 id="encoder">encoder</h3>
<p><code>Encoder</code> å¤„ç†ç¼–ç å’Œè§£ç ã€‚åç«¯æºå¯èƒ½ä»¥è®¸å¤šä¸åœçš„æ ¼å¼å­˜å‚¨ã€‚ç¼–ç å™¨ä½¿æˆ‘ä»¬èƒ½å¤Ÿå¤„ç†ä»»ä½•æ ¼å¼ã€‚å¦‚æœæœªæŒ‡å®šç¼–ç å™¨ï¼Œåˆ™é»˜è®¤ä¸º jsonã€‚
æ”¯æŒä»¥ä¸‹ç¼–ç æ ¼å¼ï¼š</p>
<ul>
<li>json</li>
<li>yaml</li>
<li>toml</li>
<li>xml</li>
<li>hcl</li>
</ul>
<h3 id="reader">reader</h3>
<p><code>Reader</code> å°†å¤šä¸ª <strong>ChangeSet</strong> è¡¨ç¤ºä¸ºå•ä¸ªåˆå¹¶å’ŒæŸ¥è¯¢çš„é›†åˆ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Reader is an interface for merging changesets
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Reader <span style="color:#8be9fd;font-style:italic">interface</span> {
    <span style="color:#6272a4">// Merge multiple changeset into a single format
</span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">Merge</span>(<span style="color:#ff79c6">...*</span>source.ChangeSet) (<span style="color:#ff79c6">*</span>source.ChangeSet, <span style="color:#8be9fd">error</span>)
    <span style="color:#6272a4">// Return Go assertable values
</span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">Values</span>(<span style="color:#ff79c6">*</span>source.ChangeSet) (Values, <span style="color:#8be9fd">error</span>)
    <span style="color:#6272a4">// Name of the reader e.g json reader
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><p><code>Reader</code> ä½¿ç”¨ <code>Encoder</code> å°† <strong>ChangeSet</strong> è§£ç ä¸º <code>map[string]Values</code>ï¼Œç„¶åå°†å®ƒä»¬åˆå¹¶åˆ°å•ä¸ª <strong>ChangeSet</strong> ä¸­ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Values is returned by the reader
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Values <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Bytes</span>() []<span style="color:#8be9fd">byte</span>
	<span style="color:#50fa7b">Get</span>(path <span style="color:#ff79c6">...</span><span style="color:#8be9fd">string</span>) Value
	<span style="color:#50fa7b">Set</span>(val <span style="color:#8be9fd;font-style:italic">interface</span>{}, path <span style="color:#ff79c6">...</span><span style="color:#8be9fd">string</span>)
	<span style="color:#50fa7b">Del</span>(path <span style="color:#ff79c6">...</span><span style="color:#8be9fd">string</span>)
	<span style="color:#50fa7b">Map</span>() <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}
	<span style="color:#50fa7b">Scan</span>(v <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
}
</code></pre></div><p><code>Value</code> æ¥å£å…è®¸å¼ºåˆ¶è½¬æ¢ï¼Œç±»å‹æ–­è¨€ï¼Œè¿”å›é»˜è®¤å€¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Value represents a value of any type
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Value <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Bool</span>(def <span style="color:#8be9fd">bool</span>) <span style="color:#8be9fd">bool</span>
	<span style="color:#50fa7b">Int</span>(def <span style="color:#8be9fd">int64</span>) <span style="color:#8be9fd">int64</span>
	<span style="color:#50fa7b">String</span>(def <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">string</span>
	<span style="color:#50fa7b">Float64</span>(def <span style="color:#8be9fd">float64</span>) <span style="color:#8be9fd">float64</span>
	<span style="color:#50fa7b">Duration</span>(def time.Duration) time.Duration
	<span style="color:#50fa7b">StringSlice</span>(def []<span style="color:#8be9fd">string</span>) []<span style="color:#8be9fd">string</span>
	<span style="color:#50fa7b">StringMap</span>(def <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>) <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>
	<span style="color:#50fa7b">Scan</span>(val <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Bytes</span>() []<span style="color:#8be9fd">byte</span>
}
</code></pre></div><h3 id="config">Config</h3>
<p><strong>Config</strong> ç®¡ç†æ‰€æœ‰é…ç½®ï¼ŒæŠ½è±¡ sourceï¼Œencoderï¼Œreaderã€‚
å®ƒä»å¤šä¸ªæºè¯»å–ï¼ŒåŒæ­¥ï¼Œç›‘å¬ï¼Œå¹¶å°†å®ƒä»¬åˆå¹¶ä¸ºå•ä¸ªå¯æŸ¥è¯¢çš„æºã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Config is an interface abstraction for dynamic configuration
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Config <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#6272a4">// provide the reader.Values interface
</span><span style="color:#6272a4"></span>	reader.Values
	<span style="color:#6272a4">// Init the config
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Init</span>(opts <span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Options in the config
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#6272a4">// Stop the config loader/watcher
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Close</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Load config sources
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Load</span>(source <span style="color:#ff79c6">...</span>source.Source) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Force a source changeset sync
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Sync</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Watch a value for changes
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Watch</span>(path <span style="color:#ff79c6">...</span><span style="color:#8be9fd">string</span>) (Watcher, <span style="color:#8be9fd">error</span>)
}
</code></pre></div><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<h3 id="å®ä¾‹é…ç½®">å®ä¾‹é…ç½®</h3>
<p>åªè¦æˆ‘ä»¬æœ‰ä¸€ä¸ªç¼–ç å™¨æ¥æ”¯æŒå®ƒï¼Œé…ç½®æ–‡ä»¶å°±å¯ä»¥æ˜¯ä»»åŠ¡æ ¼å¼çš„ã€‚
json é…ç½®å®ä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#ff79c6">&#34;hosts&#34;</span>: {
        <span style="color:#ff79c6">&#34;database&#34;</span>: {
            <span style="color:#ff79c6">&#34;address&#34;</span>: <span style="color:#f1fa8c">&#34;10.0.0.1&#34;</span>,
            <span style="color:#ff79c6">&#34;port&#34;</span>: <span style="color:#bd93f9">3306</span>
        },
        <span style="color:#ff79c6">&#34;cache&#34;</span>: {
            <span style="color:#ff79c6">&#34;address&#34;</span>: <span style="color:#f1fa8c">&#34;10.0.0.2&#34;</span>,
            <span style="color:#ff79c6">&#34;port&#34;</span>: <span style="color:#bd93f9">6379</span>
        }
    }
}
</code></pre></div><h3 id="åˆ›å»º-config">åˆ›å»º Config</h3>
<p>åˆ›å»ºä¸€ä¸ªæ–° <strong>Config</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/services/config&#34;</span>

conf <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">NewConfig</span>()
</code></pre></div><h3 id="åŠ è½½æ–‡ä»¶">åŠ è½½æ–‡ä»¶</h3>
<p>ä»æ–‡ä»¶åŠ è½½é…ç½®ï¼Œæ ¹æ®æ–‡ä»¶æ‰©å±•åæ¥ç¡®å®šé…ç½®æ ¼å¼ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/services/config&#34;</span>

<span style="color:#6272a4">// åŠ è½½ json é…ç½®æ–‡ä»¶
</span><span style="color:#6272a4"></span>config.<span style="color:#50fa7b">LoadFile</span>(<span style="color:#f1fa8c">&#34;/tmp/config.json&#34;</span>)
</code></pre></div><p>å¦‚æœæ‰©å±•ä¸å­˜åœ¨ï¼Œå¯æŒ‡å®š <code>encoder</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/service/config&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/service/config/encoder/toml&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/service/config/source&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/service/config/source/file&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	enc <span style="color:#ff79c6">:=</span> toml.<span style="color:#50fa7b">NewEncoder</span>()
	
	<span style="color:#6272a4">// é€šè¿‡ç¼–ç å™¨åŠ è½½ toml æ–‡ä»¶
</span><span style="color:#6272a4"></span>	config.<span style="color:#50fa7b">Load</span>(
		file.<span style="color:#50fa7b">NewSource</span>(
			file.<span style="color:#50fa7b">WithPath</span>(<span style="color:#f1fa8c">&#34;/tmp/config&#34;</span>),
			source.<span style="color:#50fa7b">WithEncoder</span>(enc),
		),
	)
}
</code></pre></div><h3 id="è¯»å–é…ç½®">è¯»å–é…ç½®</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">conf <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">Map</span>()

fmt.<span style="color:#50fa7b">Println</span>(conf[<span style="color:#f1fa8c">&#34;hosts&#34;</span>])
</code></pre></div><p>æ‰«æé…ç½®åˆ°ç»“æ„ä½“</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Host <span style="color:#8be9fd;font-style:italic">struct</span> {
	Address <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;address&#34;`</span>
	Port <span style="color:#8be9fd">int</span> <span style="color:#f1fa8c">`json:&#34;port&#34;`</span>
}

<span style="color:#8be9fd;font-style:italic">type</span> Config <span style="color:#8be9fd;font-style:italic">struct</span> {
	Hosts <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]Host <span style="color:#f1fa8c">`json:&#34;hosts&#34;`</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	pwd, _ <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Getwd</span>()
	err <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">LoadFile</span>(pwd <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;/config/&#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;config.json&#34;</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	<span style="color:#8be9fd;font-style:italic">var</span> cfg Config
	config.<span style="color:#50fa7b">Scan</span>(<span style="color:#ff79c6">&amp;</span>cfg)

	fmt.<span style="color:#50fa7b">Println</span>(cfg.Hosts[<span style="color:#f1fa8c">&#34;database&#34;</span>].Address)
}
</code></pre></div><h3 id="è¯»å–å€¼">è¯»å–å€¼</h3>
<p>ä»é…ç½®æ‰«æå€¼åˆ°ç»“æ„ä½“</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Host <span style="color:#8be9fd;font-style:italic">struct</span> {
    Address <span style="color:#8be9fd">string</span>  <span style="color:#f1fa8c">`json:&#34;address&#34;`</span>
    Port    <span style="color:#8be9fd">int</span>     <span style="color:#f1fa8c">`json:&#34;port&#34;`</span>
}

<span style="color:#8be9fd;font-style:italic">var</span> host Host

config.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;hosts&#34;</span>, <span style="color:#f1fa8c">&#34;database&#34;</span>).<span style="color:#50fa7b">Scan</span>(<span style="color:#ff79c6">&amp;</span>host)

<span style="color:#6272a4">// 10.0.0.1 3306
</span><span style="color:#6272a4"></span>fmt.<span style="color:#50fa7b">Println</span>(host.Address, host.Port)
</code></pre></div><p>è¯»å–å•ä¸ªå€¼ä½œä¸º Go ç±»å‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Get address. Set default to localhost as fallback
</span><span style="color:#6272a4"></span>address <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;hosts&#34;</span>, <span style="color:#f1fa8c">&#34;database&#34;</span>, <span style="color:#f1fa8c">&#34;address&#34;</span>).<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;localhost&#34;</span>)

<span style="color:#6272a4">// Get port. Set default to 3000 as fallback
</span><span style="color:#6272a4"></span>port <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;hosts&#34;</span>, <span style="color:#f1fa8c">&#34;database&#34;</span>, <span style="color:#f1fa8c">&#34;port&#34;</span>).<span style="color:#50fa7b">Int</span>(<span style="color:#bd93f9">3000</span>)
</code></pre></div><h3 id="ç›‘å¬é…ç½®">ç›‘å¬é…ç½®</h3>
<p>ç›‘å¬é…ç½®æ–‡ä»¶ã€‚å½“æ–‡ä»¶æ›´æ”¹æ—¶ï¼Œæ›´æ–°åˆ°æ–°å€¼:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">w, err <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">Watch</span>(<span style="color:#f1fa8c">&#34;hosts&#34;</span>, <span style="color:#f1fa8c">&#34;database&#34;</span>)
<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
    <span style="color:#6272a4">// do something
</span><span style="color:#6272a4"></span>}

<span style="color:#6272a4">// wait for next value
</span><span style="color:#6272a4"></span>v, err <span style="color:#ff79c6">:=</span> w.<span style="color:#50fa7b">Next</span>()
<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
    <span style="color:#6272a4">// do something
</span><span style="color:#6272a4"></span>}

<span style="color:#8be9fd;font-style:italic">var</span> host Host

v.<span style="color:#50fa7b">Scan</span>(<span style="color:#ff79c6">&amp;</span>host)
</code></pre></div><h3 id="å¤šæº">å¤šæº</h3>
<p>å¯ä»¥åŠ è½½å’Œåˆå¹¶å¤šä¸ªæºã€‚åˆå¹¶ä¼˜å…ˆçº§é¡ºåºç›¸å:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">config.<span style="color:#50fa7b">Load</span>(
    <span style="color:#6272a4">// base config from env
</span><span style="color:#6272a4"></span>    env.<span style="color:#50fa7b">NewSource</span>()
    <span style="color:#6272a4">// override env with flags
</span><span style="color:#6272a4"></span>    flag.<span style="color:#50fa7b">NewSource</span>()
    <span style="color:#6272a4">// override flags with file
</span><span style="color:#6272a4"></span>    file.<span style="color:#50fa7b">NewSource</span>(file.<span style="color:#50fa7b">WatchPath</span>(<span style="color:#f1fa8c">&#34;/tmp/config.json&#34;</span>))
)
</code></pre></div><h3 id="è®¾ç½®æºç¼–ç å™¨">è®¾ç½®æºç¼–ç å™¨</h3>
<p>æºè¦æ±‚ç¼–ç å™¨å¯¹æ•°æ®è¿›è¡Œç¼–ç  / è§£ç å¹¶æŒ‡å®šæ›´æ”¹é›†æ ¼å¼.</p>
<p>é»˜è®¤çš„ç¼–ç å™¨æ˜¯ json. è¦æ›´æ”¹ç¼–ç å™¨å¯è°ƒæ•´å¯¹åº”çš„ç±»å‹é€‰é¡¹.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">e <span style="color:#ff79c6">:=</span> yaml.<span style="color:#50fa7b">NewEncoder</span>()

s <span style="color:#ff79c6">:=</span> consul.<span style="color:#50fa7b">NewSource</span>(
    source.<span style="color:#50fa7b">WithEncoder</span>(e),
)
</code></pre></div><h3 id="æ·»åŠ è¯»å–å™¨ç¼–ç å™¨">æ·»åŠ è¯»å–å™¨ç¼–ç å™¨</h3>
<p>è¯»å–å™¨ä½¿ç”¨ç¼–ç å™¨ä»ä¸åŒæ ¼å¼çš„æºè§£ç æ•°æ®.</p>
<p>é»˜è®¤çš„è¯»å–å™¨æ”¯æŒ json, yaml, xml, toml å’Œ hcl. å®ƒå°†åˆå¹¶çš„é…ç½®è¡¨ç¤ºä¸º json.</p>
<p>å¯ä»¥é€šè¿‡æŒ‡å®šçš„é€‰é¡¹æ¥æ·»åŠ ä¸€ä¸ªæ–°çš„ç¼–ç å™¨.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">e <span style="color:#ff79c6">:=</span> yaml.<span style="color:#50fa7b">NewEncoder</span>()

r <span style="color:#ff79c6">:=</span> json.<span style="color:#50fa7b">NewReader</span>(
    reader.<span style="color:#50fa7b">WithEncoder</span>(e),
)
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-39fecad7477de2ef09d3e2a496ab8478">2.9 - æ•°æ®ç¼“å­˜</h1>
    
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p><strong>Vine</strong> æä¾› <code>Cache</code> ä½œä¸ºåˆ†å¸ƒå¼ç¼“å­˜æ¥å£ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Cache is a data cache interface
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Cache <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#6272a4">// Init initialises the cache. It must perform any required setup on the backing storage implementation and check that it is ready for use, returning any errors.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Options allows you to view the current options.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#6272a4">// Get takes a single key name and optional GetOptions. It returns matching []*Record or an error.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Get</span>(key <span style="color:#8be9fd">string</span>, opts <span style="color:#ff79c6">...</span>GetOption) ([]<span style="color:#ff79c6">*</span>Record, <span style="color:#8be9fd">error</span>)
	<span style="color:#6272a4">// Put writes a record to the cache, and returns an error if the record was not written.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Put</span>(r <span style="color:#ff79c6">*</span>Record, opts <span style="color:#ff79c6">...</span>PutOption) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Del removes the record with the corresponding key from the cache.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Del</span>(key <span style="color:#8be9fd">string</span>, opts <span style="color:#ff79c6">...</span>DelOption) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// List returns any keys that match, or an empty list with no error if none matched.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">List</span>(opts <span style="color:#ff79c6">...</span>ListOption) ([]<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd">error</span>)
	<span style="color:#6272a4">// Close the cache
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Close</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// String returns the name of the implementation.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}

<span style="color:#6272a4">// Record is an item cached or retrieved from a Cache
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Record <span style="color:#8be9fd;font-style:italic">struct</span> {
	<span style="color:#6272a4">// The key to cache the record
</span><span style="color:#6272a4"></span>	Key <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;key&#34;`</span>
	<span style="color:#6272a4">// The value within the record
</span><span style="color:#6272a4"></span>	Value []<span style="color:#8be9fd">byte</span> <span style="color:#f1fa8c">`json:&#34;value&#34;`</span>
	<span style="color:#6272a4">// Any associated metadata for indexing
</span><span style="color:#6272a4"></span>	Metadata <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{} <span style="color:#f1fa8c">`json:&#34;metadata&#34;`</span>
	<span style="color:#6272a4">// Time to expire a record: TODO: change to timestamp
</span><span style="color:#6272a4"></span>	Expiry time.Duration <span style="color:#f1fa8c">`json:&#34;expiry,omitempty&#34;`</span>
}
</code></pre></div><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<h3 id="åˆå§‹åŒ–">åˆå§‹åŒ–</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;log&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/cache&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/cache/memory&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	cc <span style="color:#ff79c6">:=</span> memory.<span style="color:#50fa7b">NewCache</span>()
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	<span style="color:#ff79c6">defer</span> cc.<span style="color:#50fa7b">Close</span>()
}
</code></pre></div><h3 id="æ’å…¥-keyvalue">æ’å…¥ key/value</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// cache.Record
</span><span style="color:#6272a4"></span>	r <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>cache.Record{
		Key:      <span style="color:#f1fa8c">&#34;a&#34;</span>, <span style="color:#6272a4">// key å”¯ä¸€å€¼
</span><span style="color:#6272a4"></span>		Value:    []<span style="color:#8be9fd;font-style:italic">byte</span>(<span style="color:#f1fa8c">&#34;hello&#34;</span>), <span style="color:#6272a4">// value
</span><span style="color:#6272a4"></span>		Metadata: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}{}, <span style="color:#6272a4">// 
</span><span style="color:#6272a4"></span>		Expiry:   time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">3</span>, <span style="color:#6272a4">// è¿‡æœŸæ—¶é—´
</span><span style="color:#6272a4"></span>	}
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Put</span>(r); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
}
</code></pre></div><h3 id="è·å–-keyvalue">è·å– key/value</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// è·å–æ‰€æœ‰ keys
</span><span style="color:#6272a4"></span>	keys, err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">List</span>()
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	fmt.<span style="color:#50fa7b">Println</span>(keys)

	<span style="color:#6272a4">// é€šè¿‡ key è·å– value
</span><span style="color:#6272a4"></span>	rr, err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;a&#34;</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#8be9fd;font-style:italic">string</span>(rr[<span style="color:#bd93f9">0</span>].Value))
}
</code></pre></div><h3 id="åˆ é™¤-key">åˆ é™¤ key</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Del</span>(<span style="color:#f1fa8c">&#34;a&#34;</span>); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
}
</code></pre></div><h2 id="options">options</h2>
<p>åˆå§‹åŒ– options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	cc <span style="color:#ff79c6">:=</span> memory.<span style="color:#50fa7b">NewCache</span>(
		cache.<span style="color:#50fa7b">Nodes</span>(),    <span style="color:#6272a4">// æŒ‡å®šç¼“å­˜æœåŠ¡å™¨çš„èŠ‚ç‚¹ä¿¡æ¯
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">Table</span>(),    <span style="color:#6272a4">// æŒ‡å®š table
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">Database</span>(), <span style="color:#6272a4">// æŒ‡å®š database
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">WithClient</span>(), <span style="color:#6272a4">// æŒ‡å®š Client æ¥å£å®ç°
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">WithContext</span>(), <span style="color:#6272a4">// æŒ‡å®š context.Context
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p><code>Put</code> options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	cc.<span style="color:#50fa7b">Put</span>(r,
		cache.<span style="color:#50fa7b">PutExpiry</span>(), <span style="color:#6272a4">// æŒ‡å®š key è¿‡æœŸæ—¶é—´
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">PutTo</span>(),     <span style="color:#6272a4">// æŒ‡å®š database å’Œ table
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">PutTTL</span>(),    <span style="color:#6272a4">// æŒ‡å®š key ttl
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p><code>List</code> options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	keys, err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">List</span>(
		cache.<span style="color:#50fa7b">ListFrom</span>(),  <span style="color:#6272a4">// æŒ‡å®š database å’Œ table
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">ListLimit</span>(), <span style="color:#6272a4">// é™åˆ¶ key æ•°é‡
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">ListOffset</span>(), <span style="color:#6272a4">// æŸ¥è¯¢åç§»é‡
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">ListPrefix</span>(), <span style="color:#6272a4">// æŒ‡å®š key å‰ç¼€
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">ListSuffix</span>(), <span style="color:#6272a4">// æŒ‡å®š key åç¼€
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p><code>Get</code> options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	cc.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;a&#34;</span>,
		cache.<span style="color:#50fa7b">GetFrom</span>(), <span style="color:#6272a4">// æŒ‡å®š database å’Œ table
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">GetLimit</span>(), <span style="color:#6272a4">// é™åˆ¶ key æ•°é‡
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">GetOffset</span>(), <span style="color:#6272a4">// æŸ¥è¯¢åç§»é‡
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">GetPrefix</span>(), <span style="color:#6272a4">// æŒ‡å®š key å‰ç¼€
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">GetSuffix</span>(), <span style="color:#6272a4">// æŒ‡å®š key åç¼€
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p><code>Del</code> options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	cc.<span style="color:#50fa7b">Del</span>(<span style="color:#f1fa8c">&#34;a&#34;</span>,
		cache.<span style="color:#50fa7b">DelFrom</span>(), <span style="color:#6272a4">// æŒ‡å®š database å’Œ table
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-153e4a0bca2441db25452191e5399846">2.10 - å‘½ä»¤è¡Œå‚æ•°</h1>
    
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p><strong>Vine</strong> ç»“åˆ <a href="https://github.com/vine-io/cli">cli</a> æä¾› <code>Cmd</code> æ¨¡å—ï¼Œä½œä¸ºæœåŠ¡çš„å‘½ä»¤å·¥å…·ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Cmd <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#6272a4">// App The cli app within this cmd
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">App</span>() <span style="color:#ff79c6">*</span>cli.App
	<span style="color:#6272a4">// Init Adds options, parses flags and initialise
</span><span style="color:#6272a4"></span>	<span style="color:#6272a4">// exits on error
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Init</span>(opts <span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Options set within this command
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options
}
</code></pre></div><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;log&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/cmd&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	c <span style="color:#ff79c6">:=</span> cmd.<span style="color:#50fa7b">NewCmd</span>()
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> c.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	c.<span style="color:#50fa7b">App</span>().<span style="color:#50fa7b">RunAndExitOnError</span>()
}
</code></pre></div><h2 id="options">options</h2>
<p>ç½—åˆ— <code>Cmd</code> çš„ options:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    c <span style="color:#ff79c6">:=</span> cmd.<span style="color:#50fa7b">NewCmd</span>(
		cmd.<span style="color:#50fa7b">Name</span>(),   <span style="color:#6272a4">// è®¾ç½® cli å¯åŠ¨åç§°
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Server</span>(), <span style="color:#6272a4">// è®¾ç½®é»˜è®¤ Server æ¨¡å—
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Client</span>(), <span style="color:#6272a4">// è®¾ç½®é»˜è®¤ Client æ¨¡å—
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Selector</span>(), <span style="color:#6272a4">// è®¾ç½® Client Selector æ¨¡å—
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Registry</span>(), <span style="color:#6272a4">// è®¾ç½®é»˜è®¤ Registry æ¨¡å—
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Broker</span>(),  <span style="color:#6272a4">// è®¾ç½®é»˜è®¤ Broker æ¨¡å—
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Tracer</span>(),  <span style="color:#6272a4">// è®¾ç½®é»˜è®¤ Tracer æ¨¡å—
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Dialect</span>(), <span style="color:#6272a4">// è®¾ç½®é»˜è®¤ Dialect æ¨¡å—
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Config</span>(),  <span style="color:#6272a4">// è®¾ç½®é»˜è®¤ Config æ¨¡å—
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Cache</span>(),   <span style="color:#6272a4">// è®¾ç½® Cache æ¨¡å—
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">CliApp</span>(),  <span style="color:#6272a4">// è®¾ç½® *cli.App
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Description</span>(), <span style="color:#6272a4">// è®¾ç½® cli æè¿°ä¿¡æ¯
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><h2 id="æœåŠ¡-cmd">æœåŠ¡ cmd</h2>
<p><strong>Vine</strong> æœåŠ¡å¯åŠ¨æ—¶åˆå§‹åŒ– <code>Cmd</code> æ¨¡å—ï¼Œæ¯ä¸ªæœåŠ¡æ”¯æŒä»¥ä¸‹çš„å‘½ä»¤è¡Œå‚æ•°:</p>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>è¯´æ˜</th>
<th>é»˜è®¤å€¼</th>
<th>ç¯å¢ƒæ¢è„¸</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>&ndash;client string</td>
<td>Client for vine;</td>
<td>rpc</td>
<td>[$VINE_CLIENT]</td>
<td></td>
</tr>
<tr>
<td>&ndash;client-request-timeout string</td>
<td>Sets the client request timeout. e.g 500ms, 5s, 1m.</td>
<td>Default: 5s</td>
<td>[$VINE_CLIENT_REQUEST_TIMEOUT]</td>
<td></td>
</tr>
<tr>
<td>&ndash;client-retries int</td>
<td>Sets the client retries.</td>
<td>Default: 1 (default: 1)</td>
<td>[$VINE_CLIENT_RETIES]</td>
<td></td>
</tr>
<tr>
<td>&ndash;client-pool-size int</td>
<td>Sets the client connection pool size.</td>
<td>Default: 1 (default: 0)</td>
<td>[$VINE_CLIENT_POOL_SIZE]</td>
<td></td>
</tr>
<tr>
<td>&ndash;client-pool-ttl string</td>
<td>Sets the client connection pool ttl. e.g 500ms, 5s, 1m.</td>
<td>Default: 1m</td>
<td>[$VINE_CLIENT_POOL_TTL]</td>
<td></td>
</tr>
<tr>
<td>&ndash;register-ttl int</td>
<td>Register TTL in seconds</td>
<td>(default: 60)</td>
<td>[$VINE_REGISTER_TTL]</td>
<td></td>
</tr>
<tr>
<td>&ndash;register-interval int</td>
<td>Register interval in seconds</td>
<td>(default: 30)</td>
<td>[$VINE_REGISTER_INTERVAL]</td>
<td></td>
</tr>
<tr>
<td>&ndash;server string</td>
<td>Server for vine;</td>
<td>rpc</td>
<td>[$VINE_SERVER]</td>
<td></td>
</tr>
<tr>
<td>&ndash;server-name string</td>
<td>Name of the server. go.vine.svc.example</td>
<td></td>
<td>[$VINE_SERVER_NAME]</td>
<td></td>
</tr>
<tr>
<td>&ndash;server-version string</td>
<td>Version of the server. 1.1.0</td>
<td></td>
<td>[$VINE_SERVER_VERSION]</td>
<td></td>
</tr>
<tr>
<td>&ndash;server-id string</td>
<td>Id of the server. Auto-generated if not specified</td>
<td></td>
<td>[$VINE_SERVER_ID]</td>
<td></td>
</tr>
<tr>
<td>&ndash;server-address string</td>
<td>Bind address for the server. 127.0.0.1:8080</td>
<td></td>
<td>[$VINE_SERVER_ADDRESS]</td>
<td></td>
</tr>
<tr>
<td>&ndash;server-advertise string</td>
<td>Use instead of the server-address when registering with discovery. 127.0.0.1:8080</td>
<td></td>
<td>[$VINE_SERVER_ADVERTISE]</td>
<td></td>
</tr>
<tr>
<td>&ndash;server-metadata strings</td>
<td>A list of key-value pairs defining metadata. version=1.0.0</td>
<td></td>
<td>[$VINE_SERVER_METADATA]</td>
<td></td>
</tr>
<tr>
<td>&ndash;broker string</td>
<td>Broker for pub/sub. http, nats</td>
<td></td>
<td>[$VINE_BROKER]</td>
<td></td>
</tr>
<tr>
<td>&ndash;broker-address string</td>
<td>Comma-separated list of broker addresses</td>
<td></td>
<td>[$VINE_BROKER_ADDRESS]</td>
<td></td>
</tr>
<tr>
<td>&ndash;registry string</td>
<td>Registry for discovery. memory, mdns</td>
<td></td>
<td>[$VINE_REGISTRY]</td>
<td></td>
</tr>
<tr>
<td>&ndash;registry-address string</td>
<td>Comma-separated list of registry addresses</td>
<td></td>
<td>[$VINE_REGISTRY_ADDRESS]</td>
<td></td>
</tr>
<tr>
<td>&ndash;selector string</td>
<td>Selector used to pick nodes for querying</td>
<td></td>
<td>[$VINE_SELECTOR]</td>
<td></td>
</tr>
<tr>
<td>&ndash;dao-dialect string</td>
<td>Database option for the underlying dao</td>
<td></td>
<td>[$VINE_DAO_DIALECT]</td>
<td></td>
</tr>
<tr>
<td>&ndash;dao-dsn string</td>
<td>DSN database driver name for underlying dao</td>
<td></td>
<td>[$VINE_DSN]</td>
<td></td>
</tr>
<tr>
<td>&ndash;config string</td>
<td>The source of the config to be used to get configuration</td>
<td></td>
<td>[$VINE_CONFIG]</td>
<td></td>
</tr>
<tr>
<td>&ndash;cache string</td>
<td>Cache used for key-value storage</td>
<td></td>
<td>[$VINE_CACHE]</td>
<td></td>
</tr>
<tr>
<td>&ndash;cache-address string</td>
<td>Comma-separated list of cache addresses</td>
<td></td>
<td>[$VINE_CACHE_ADDRESS]</td>
<td></td>
</tr>
<tr>
<td>&ndash;tracer string</td>
<td>Tracer for distributed tracing, e.g. memory, jaeger</td>
<td></td>
<td>[$VINE_TRACER]</td>
<td></td>
</tr>
<tr>
<td>&ndash;tracer-address string</td>
<td>Comma-separated list of tracer addresses</td>
<td></td>
<td>[$VINE_TRACER_ADDRESS]</td>
<td></td>
</tr>
</tbody>
</table>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a711fd4172b59f618933a2b52fdc23a0">2.11 - æ—¥å¿—æ¥å£</h1>
    
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p><code>Logger</code> æ˜¯ <strong>Vine</strong> çš„æ—¥å¿—æ¨¡å—ï¼Œæˆ‘ä»¬æŠ½è±¡ä¸€ä¸ªä¸€ç»„é€šç”¨çš„æ¥å£ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦æ¥æ„å»ºè‡ªå·±çš„å®ç°:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Logger <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#6272a4">// Init initialises options
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Init</span>(options <span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Options the Logger options
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#6272a4">// Fields set fields to always be logged
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Fields</span>(fields <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}) Logger
	<span style="color:#6272a4">// Log writes a log entry
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Log</span>(level Level, v <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{})
	<span style="color:#6272a4">// Logf writes a formatted log entry
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Logf</span>(level Level, format <span style="color:#8be9fd">string</span>, v <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{})
	<span style="color:#6272a4">// String returns the name of logger
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<p>è¿™é‡Œä»‹ç» <code>Logger</code> çš„ç®€å•ä½¿ç”¨æ–¹å¼ï¼Œæˆ‘ä»¬åœ¨å†…éƒ¨å·²ç»æœ‰è‡ªå¸¦çš„å®ç°:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    <span style="color:#6272a4">// æ–° Logger
</span><span style="color:#6272a4"></span>    l <span style="color:#ff79c6">:=</span> logger.<span style="color:#50fa7b">NewLogger</span>(<span style="color:#50fa7b">WithLevel</span>(TraceLevel))
	h1 <span style="color:#ff79c6">:=</span> logger.<span style="color:#50fa7b">NewHelper</span>(l).<span style="color:#50fa7b">WithFields</span>(<span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}{<span style="color:#f1fa8c">&#34;key1&#34;</span>: <span style="color:#f1fa8c">&#34;val1&#34;</span>})
	h1.<span style="color:#50fa7b">Trace</span>(<span style="color:#f1fa8c">&#34;trace_msg1&#34;</span>)
	h1.<span style="color:#50fa7b">Log</span>(WarnLevel, <span style="color:#f1fa8c">&#34;warn_msg1&#34;</span>)

	h2 <span style="color:#ff79c6">:=</span> logger.<span style="color:#50fa7b">NewHelper</span>(l).<span style="color:#50fa7b">WithFields</span>(<span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}{<span style="color:#f1fa8c">&#34;key2&#34;</span>: <span style="color:#f1fa8c">&#34;val2&#34;</span>})
	h2.<span style="color:#50fa7b">Trace</span>(<span style="color:#f1fa8c">&#34;trace_msg2&#34;</span>)
	h2.<span style="color:#50fa7b">Warn</span>(<span style="color:#f1fa8c">&#34;warn_msg2&#34;</span>)

    <span style="color:#6272a4">// è®¾ç½® Fields
</span><span style="color:#6272a4"></span>	l.<span style="color:#50fa7b">Fields</span>(<span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}{<span style="color:#f1fa8c">&#34;key3&#34;</span>: <span style="color:#f1fa8c">&#34;val4&#34;</span>}).<span style="color:#50fa7b">Log</span>(InfoLevel, <span style="color:#f1fa8c">&#34;test_msg&#34;</span>)

    <span style="color:#6272a4">// ä½¿ç”¨é»˜è®¤çš„ logger
</span><span style="color:#6272a4"></span>	logger.<span style="color:#50fa7b">Fields</span>(<span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}{<span style="color:#f1fa8c">&#34;key1&#34;</span>: <span style="color:#f1fa8c">&#34;val1&#34;</span>})
	logger.<span style="color:#50fa7b">Info</span>(<span style="color:#f1fa8c">&#34;info&#34;</span>)
}
</code></pre></div><p>æŸ¥çœ‹è¾“å‡º:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">2021-09-05 16:29:32 <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>logger/logger_test.go:10 <span style="color:#8be9fd;font-style:italic">key1</span><span style="color:#ff79c6">=</span>val1 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>trace trace_msg1
2021-09-05 16:29:32 <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>logger/logger_test.go:11 <span style="color:#8be9fd;font-style:italic">key1</span><span style="color:#ff79c6">=</span>val1 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>warn warn_msg1
2021-09-05 16:29:32 <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>logger/logger_test.go:14 <span style="color:#8be9fd;font-style:italic">key2</span><span style="color:#ff79c6">=</span>val2 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>trace trace_msg2
2021-09-05 16:29:32 <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>logger/logger_test.go:15 <span style="color:#8be9fd;font-style:italic">key2</span><span style="color:#ff79c6">=</span>val2 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>warn warn_msg2
2021-09-05 16:29:32 <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>logger/logger_test.go:17 <span style="color:#8be9fd;font-style:italic">key3</span><span style="color:#ff79c6">=</span>val4 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info test_msg
2021-09-05 16:29:32 <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>logger/logger_test.go:20 <span style="color:#8be9fd;font-style:italic">key1</span><span style="color:#ff79c6">=</span>val1 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info info
</code></pre></div><p>é»˜è®¤çš„å®ç°æ”¯æŒä»¥ä¸‹å‡ ç§çº§åˆ«æ—¥å¿—ï¼š</p>
<ul>
<li>TRACE: æ—¥å¿—è¿½è¸ª</li>
<li>DEBUG: è°ƒè¯•æ—¥å¿—</li>
<li>INFO: æ™®é€šæç¤º</li>
<li>WARN: è­¦å‘Šï¼Œæœ‰é”™è¯¯ä½†ä¸å½±å“æ­£å¸¸è¿è¡Œ</li>
<li>ERROR: é”™è¯¯ï¼ŒåŠŸèƒ½æ— æ³•æ­£å¸¸æ‰§è¡Œ</li>
<li>FATAL: ä¸¥é‡é”™è¯¯ï¼Œè§¦å‘ä¼šå¯¼è‡´ç¨‹åºå´©æºƒ</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-06993b840e35b8603c1d1fa4e5390ca5">2.12 - æ•°æ®åº“æ¥å£</h1>
    
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p>æˆ‘ä»¬æ•´åˆ <a href="https://gorm.io/">gorm</a>ï¼Œå¹¶æŠ½è±¡å‡º <code>Dao</code> ä½œä¸ºæ•°æ®åº“äº¤äº’å·¥å…·ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Dialect DAO database dialect
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Dialect <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#50fa7b">NewTx</span>() <span style="color:#ff79c6">*</span>DB
	<span style="color:#50fa7b">Migrator</span>() Migrator
	<span style="color:#50fa7b">DataTypeOf</span>(<span style="color:#ff79c6">*</span>schema.Field) <span style="color:#8be9fd">string</span>
	<span style="color:#50fa7b">DefaultValueOf</span>(<span style="color:#ff79c6">*</span>schema.Field) clause.Expression
	<span style="color:#50fa7b">BindVarTo</span>(writer clause.Writer, stmt <span style="color:#ff79c6">*</span>Statement, v <span style="color:#8be9fd;font-style:italic">interface</span>{})
	<span style="color:#50fa7b">QuoteTo</span>(clause.Writer, <span style="color:#8be9fd">string</span>)
	<span style="color:#50fa7b">Explain</span>(sql <span style="color:#8be9fd">string</span>, vars <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">string</span>
	<span style="color:#50fa7b">JSONBuild</span>(column <span style="color:#8be9fd">string</span>) JSONQuery
	<span style="color:#50fa7b">JSONDataType</span>() <span style="color:#8be9fd">string</span>
	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<p><code>Dao</code> çš„æ¥å£è¯­æ³•å’Œ <a href="https://gorm.io/">gorm</a> å…¼å®¹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;log&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/plugins/dao/mysql&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/dao&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/dao/logger&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">type</span> User <span style="color:#8be9fd;font-style:italic">struct</span> {
	Id   <span style="color:#8be9fd">int32</span>  <span style="color:#f1fa8c">`dao:&#34;column:id;autoIncrement;primaryKey&#34;`</span>
	Name <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`dao:&#34;column:name&#34;`</span>
	Age  <span style="color:#8be9fd">int32</span>  <span style="color:#f1fa8c">`dao:&#34;column:age&#34;`</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	dns <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">`root:123456@tcp(192.168.3.111:3306)/vine?charset=utf8&amp;parseTime=True&amp;loc=Local`</span>
	dialect <span style="color:#ff79c6">:=</span> mysql.<span style="color:#50fa7b">NewDialect</span>(dao.<span style="color:#50fa7b">DSN</span>(dns), dao.<span style="color:#50fa7b">Logger</span>(logger.<span style="color:#50fa7b">New</span>(logger.Options{
		SlowThreshold: <span style="color:#bd93f9">200</span> <span style="color:#ff79c6">*</span> time.Millisecond,
		LogLevel:      logger.Info,
	})))
    <span style="color:#6272a4">// åˆå§‹åŒ–
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> dialect.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

    <span style="color:#6272a4">// åˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯
</span><span style="color:#6272a4"></span>	db <span style="color:#ff79c6">:=</span> dialect.<span style="color:#50fa7b">NewTx</span>()

    <span style="color:#6272a4">// æ›´æ–°è¡¨ç»“æ„
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> db.<span style="color:#50fa7b">AutoMigrate</span>(<span style="color:#ff79c6">&amp;</span>User{}); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	u <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>User{Name: <span style="color:#f1fa8c">&#34;Mimi&#34;</span>, Age: <span style="color:#bd93f9">11</span>}
    <span style="color:#6272a4">// æ’å…¥ä¸€æ¡è®°å½•
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> db.<span style="color:#50fa7b">Create</span>(u).Error; err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	u1 <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>User{}
    <span style="color:#6272a4">// æŸ¥è¯¢
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> db.<span style="color:#50fa7b">Find</span>(<span style="color:#ff79c6">&amp;</span>u1, <span style="color:#f1fa8c">&#34;name = ?&#34;</span>, <span style="color:#f1fa8c">&#34;Mimi&#34;</span>).Error; err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	fmt.<span style="color:#50fa7b">Println</span>(u1)

	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> db.<span style="color:#50fa7b">Where</span>(<span style="color:#f1fa8c">&#34;name = ?&#34;</span>, <span style="color:#f1fa8c">&#34;Mimi&#34;</span>).<span style="color:#50fa7b">First</span>(<span style="color:#ff79c6">&amp;</span>u1).Error; err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	fmt.<span style="color:#50fa7b">Println</span>(u1)

	u1.Name = <span style="color:#f1fa8c">&#34;Mimi_update&#34;</span>
    <span style="color:#6272a4">// æ›´æ–°ä¸€æ¡è®°å½•
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> db.<span style="color:#50fa7b">Updates</span>(u1).Error; err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

    <span style="color:#6272a4">// åˆ é™¤ä¸€æ¡è®°å½•
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> db.<span style="color:#50fa7b">Delete</span>(<span style="color:#ff79c6">&amp;</span>User{}, <span style="color:#f1fa8c">&#34;id = ?&#34;</span>, <span style="color:#bd93f9">1</span>).Error; err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
}
</code></pre></div><p>æ›´å¤š CURD çš„ä½¿ç”¨æ–¹å¼å¯ä»¥å‚è€ƒ<a href="https://gorm.io/docs/create.html">è¿™é‡Œ</a>ã€‚</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1716b93d0e0fcc931d997f5833d2e6f4">2.13 - é”å’Œé€‰ä¸¾</h1>
    
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Sync is an interface for distributed synchronization
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Sync <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#6272a4">// Init Initialise options
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Options Return the options
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#6272a4">// Leader Elect a leader
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Leader</span>(id <span style="color:#8be9fd">string</span>, opts <span style="color:#ff79c6">...</span>LeaderOption) (Leader, <span style="color:#8be9fd">error</span>)
	<span style="color:#6272a4">// ListMembers get all election member
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">ListMembers</span>(opts <span style="color:#ff79c6">...</span>ListMembersOption) ([]<span style="color:#ff79c6">*</span>Member, <span style="color:#8be9fd">error</span>)
	<span style="color:#6272a4">// Lock acquires a lock
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Lock</span>(id <span style="color:#8be9fd">string</span>, opts <span style="color:#ff79c6">...</span>LockOption) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Unlock releases a lock
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Unlock</span>(id <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// String Sync implementation
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<h3 id="åˆ†å¸ƒå¼é”">åˆ†å¸ƒå¼é”</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    s <span style="color:#ff79c6">:=</span> etcd.<span style="color:#50fa7b">NewSync</span>()
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

    <span style="color:#6272a4">// åˆ›å»ºé”
</span><span style="color:#6272a4"></span>	err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Lock</span>(<span style="color:#f1fa8c">&#34;lock1&#34;</span>, sync.<span style="color:#50fa7b">LockTTL</span>(time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">3</span>))
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	ch <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd;font-style:italic">struct</span>{}, <span style="color:#bd93f9">1</span>)
	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Lock</span>(<span style="color:#f1fa8c">&#34;lock1&#34;</span>, sync.<span style="color:#50fa7b">LockTTL</span>(time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">3</span>))
		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
			log.<span style="color:#50fa7b">Fatalln</span>(err)
		}
		fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Locked&#34;</span>)
		ch <span style="color:#ff79c6">&lt;-</span> <span style="color:#8be9fd;font-style:italic">struct</span>{}{}
	}()

    <span style="color:#6272a4">// é‡Šæ”¾é”
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err = s.<span style="color:#50fa7b">Unlock</span>(<span style="color:#f1fa8c">&#34;lock1&#34;</span>); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;lock1 released&#34;</span>)

	<span style="color:#ff79c6">&lt;-</span>ch
}
</code></pre></div><h3 id="åˆ†å¸ƒå¼é€‰ä¸¾">åˆ†å¸ƒå¼é€‰ä¸¾</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    s <span style="color:#ff79c6">:=</span> etcd.<span style="color:#50fa7b">NewSync</span>()
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	id <span style="color:#ff79c6">:=</span> uuid.<span style="color:#50fa7b">NewString</span>()
    <span style="color:#6272a4">// æ–° leader
</span><span style="color:#6272a4"></span>	role1, err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Leader</span>(<span style="color:#f1fa8c">&#34;leader&#34;</span>, sync.<span style="color:#50fa7b">LeaderNS</span>(<span style="color:#f1fa8c">&#34;default&#34;</span>), sync.<span style="color:#50fa7b">LeaderId</span>(id), sync.<span style="color:#50fa7b">LeaderTTL</span>(<span style="color:#bd93f9">3</span>))
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

    <span style="color:#6272a4">// æŸ¥è¯¢æ‰€æœ‰é€‰ä¸¾æˆå‘˜
</span><span style="color:#6272a4"></span>    ms, _ <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">ListMembers</span>(sync.<span style="color:#50fa7b">MemberNS</span>(<span style="color:#f1fa8c">&#34;default&#34;</span>))
	<span style="color:#ff79c6">for</span> _, m <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> ms {
		fmt.<span style="color:#50fa7b">Println</span>(m)
	}

    <span style="color:#6272a4">// æˆå‘˜è¾èŒ
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> role1.<span style="color:#50fa7b">Resign</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
}
</code></pre></div><h2 id="options">options</h2>
<p>åˆå§‹åŒ–</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	memory.<span style="color:#50fa7b">NewSync</span>(
		sync.<span style="color:#50fa7b">Prefix</span>(<span style="color:#f1fa8c">&#34;/vine/sync&#34;</span>),    <span style="color:#6272a4">// key å‰ç¼€
</span><span style="color:#6272a4"></span>		sync.<span style="color:#50fa7b">Nodes</span>(<span style="color:#f1fa8c">&#34;127.0.0.1:2379&#34;</span>), <span style="color:#6272a4">// æœåŠ¡ç«¯åœ°å€
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p>ä¸Šé”å’Œé‡Šæ”¾é”</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    s.<span style="color:#50fa7b">Lock</span>(<span style="color:#f1fa8c">&#34;lock1&#34;</span>,
		sync.<span style="color:#50fa7b">LockTTL</span>(),   <span style="color:#6272a4">// é”çš„ ttl
</span><span style="color:#6272a4"></span>		sync.<span style="color:#50fa7b">LockWait</span>(),  <span style="color:#6272a4">// è¶…æ—¶æ—¶é—´
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p>é€‰ä¸¾</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    s.<span style="color:#50fa7b">Leader</span>(<span style="color:#f1fa8c">&#34;leader&#34;</span>,
		sync.<span style="color:#50fa7b">LeaderNS</span>(), <span style="color:#6272a4">// namespace
</span><span style="color:#6272a4"></span>		sync.<span style="color:#50fa7b">LeaderTTL</span>(), <span style="color:#6272a4">// 
</span><span style="color:#6272a4"></span>		sync.<span style="color:#50fa7b">LeaderId</span>(), <span style="color:#6272a4">// æˆå‘˜ id
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><h2 id="å®ä¾‹">å®ä¾‹</h2>
<p>æ›´å¤šçš„å®ä¾‹ä»£ç å¯å‚è€ƒ <a href="https://github.com/vine-io/examples/tree/main/sync">examples</a></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-af33cab72523ccb0847ef55ee3168c8b">2.14 - è£…è½½å™¨</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-6d71662a7a073686a5f0e2c3e135bd39">2.14.1 - æ¦‚è¿°</h1>
    
	<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p><strong>Vine</strong> è£…è½½å™¨ç­‰åŒäº&quot;ä¸­é—´ä»¶&quot;ã€‚</p>
<blockquote>
<p>ä¸­é—´ä»¶ï¼ˆè‹±è¯­ï¼šMiddlewareï¼‰ï¼Œåˆè¯‘ä¸­é—´ä»¶ã€ä¸­ä»‹å±‚ï¼Œæ˜¯ä¸€ç±»æä¾›ç³»ç»Ÿè½¯ä»¶å’Œåº”ç”¨è½¯ä»¶ä¹‹é—´è¿æ¥ã€ä¾¿äºè½¯ä»¶å„éƒ¨ä»¶ä¹‹é—´çš„æ²Ÿé€šçš„è½¯ä»¶ï¼Œåº”ç”¨è½¯ä»¶å¯ä»¥å€ŸåŠ©ä¸­é—´ä»¶åœ¨ä¸åŒçš„æŠ€æœ¯æ¶æ„ä¹‹é—´å…±äº«ä¿¡æ¯ä¸èµ„æºã€‚ä¸­é—´ä»¶ä½äºå®¢æˆ·æœºæœåŠ¡å™¨çš„æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œç®¡ç†ç€è®¡ç®—èµ„æºå’Œç½‘ç»œé€šä¿¡ã€‚ &ndash; ç»´åŸºç™¾ç§‘</p>
</blockquote>
<h2 id="wrapper">wrapper</h2>
<p><strong>Vine</strong> ä¸­åŒ…å«è¾“å…¥è¾“å‡ºçš„ wrappr åˆ†åˆ«åœ¨ <code>Client</code> å’Œ <code>Server</code> ä¸­ä½¿ç”¨ï¼Œå®šä¹‰å¦‚ä¸‹:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// client
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> CallFunc <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, node <span style="color:#ff79c6">*</span>registry.Node, req Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}, opts CallOptions) <span style="color:#8be9fd">error</span>
<span style="color:#6272a4">// CallWrapper is a low level wrapper for the CallFunc
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> CallWrapper <span style="color:#8be9fd;font-style:italic">func</span>(CallFunc) CallFunc
<span style="color:#6272a4">// Wrapper wraps a client and returns a client
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Wrapper <span style="color:#8be9fd;font-style:italic">func</span>(Client) Client
<span style="color:#6272a4">// StreamWrapper wraps a Stream and returns the equivalent
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> StreamWrapper <span style="color:#8be9fd;font-style:italic">func</span>(Stream) Stream

<span style="color:#6272a4">// server
</span><span style="color:#6272a4">// HandlerFunc represents a single method of a handler. It&#39;s used primarily
</span><span style="color:#6272a4">// for the wrappers. What&#39;s handed to the actual method is the concrete
</span><span style="color:#6272a4">// request and response types.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> HandlerFunc <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, req Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
<span style="color:#6272a4">// SubscriberFunc represents a single method of a subscriber. It&#39;s used primarily
</span><span style="color:#6272a4">// for the wrappers. What&#39;s handed to the actual method is the concrete
</span><span style="color:#6272a4">// publication message.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> SubscriberFunc <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, msg Message) <span style="color:#8be9fd">error</span>
<span style="color:#6272a4">// HandlerWrapper wraps the HandlerFunc and returns the equivalent
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> HandlerWrapper <span style="color:#8be9fd;font-style:italic">func</span>(HandlerFunc) HandlerFunc
<span style="color:#6272a4">// SubscriberWrapper wraps the SubscriberFunc and returns the equivalent
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> SubscriberWrapper <span style="color:#8be9fd;font-style:italic">func</span>(SubscriberFunc) SubscriberFunc
<span style="color:#6272a4">// StreamWrapper wraps a Stream interface and returns the equivalent.
</span><span style="color:#6272a4">// Because streams exist for the lifetime of a method invocation this
</span><span style="color:#6272a4">// is a convenient way to wrap a Stream as its in use for trace, monitoring.
</span><span style="color:#6272a4">// metrics, etc.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> StreamWrapper <span style="color:#8be9fd;font-style:italic">func</span>(Stream) Stream
</code></pre></div><p><strong>Vine</strong> å†…éƒ¨é›†æˆäº”ä¸­ç±»å‹çš„ wrapper:
client wrapper:</p>
<ul>
<li>CallWrapper: æ‹¦æˆª client Call è¯·æ±‚</li>
<li>StreamWrapper: æ‹¦æˆª client Stream è¯·æ±‚</li>
</ul>
<p>server wrapper:</p>
<ul>
<li>HandlerWrapper: æ‹¦æˆª grpc simple è¯·æ±‚</li>
<li>SubscriberWrapper: è¿æ¥ broker è®¢é˜…</li>
<li>StreamWrapper:  è¿æ¥ grpc stream è¯·æ±‚</li>
</ul>
<h2 id="è‡ªå®šä¹‰-wrapper">è‡ªå®šä¹‰ wrapper</h2>
<p>æˆ‘ä»¬é€šè¿‡å®ä¾‹ä»£ç æ¥è¯´æ˜ wrapper çš„å†…éƒ¨å·¥ä½œåŸç†ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/client&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry&#34;</span>
	log <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/logger&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	vine.<span style="color:#50fa7b">NewService</span>(
        <span style="color:#6272a4">// åŠ è½½è‡ªå®šä¹‰çš„ wrapper
</span><span style="color:#6272a4"></span>		vine.<span style="color:#50fa7b">WrapCall</span>(<span style="color:#50fa7b">LoggerWrapper</span>(), <span style="color:#50fa7b">SubWrapper</span>()),
	)
}

<span style="color:#6272a4">// å®šä¹‰ä¸€ä¸ª CallWrapper, æ‹¦æˆª client Call è¯·æ±‚
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">LoggerWrapper</span>() client.CallWrapper {
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(fn client.CallFunc) client.CallFunc {
		<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, node <span style="color:#ff79c6">*</span>registry.Node, req client.Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}, opts client.CallOptions) <span style="color:#8be9fd">error</span> {

			log.<span style="color:#50fa7b">Info</span>(<span style="color:#f1fa8c">&#34;logger wrapper: before call&#34;</span>)
			err <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">fn</span>(ctx, node, req, rsp, opts)
			log.<span style="color:#50fa7b">Info</span>(<span style="color:#f1fa8c">&#34;logger wrapper: after call&#34;</span>)

			<span style="color:#ff79c6">return</span> err
		}
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">SubWrapper</span>() client.CallWrapper {
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(fn client.CallFunc) client.CallFunc {
		<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, node <span style="color:#ff79c6">*</span>registry.Node, req client.Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}, opts client.CallOptions) <span style="color:#8be9fd">error</span> {

			log.<span style="color:#50fa7b">Info</span>(<span style="color:#f1fa8c">&#34;sub wrapper: before call&#34;</span>)
			err <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">fn</span>(ctx, node, req, rsp, opts)
			log.<span style="color:#50fa7b">Info</span>(<span style="color:#f1fa8c">&#34;sub wrapper: after call&#34;</span>)

			<span style="color:#ff79c6">return</span> err
		}
	}
}
</code></pre></div><p>è¯·æ±‚è¾“å‡º:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">logger wrapper: before call
sub wrapper: before call
sub wrapper: after call
logger wrapper: after call
</code></pre></div><p>ç”±æ­¤å¯è§ wrapper é“¾è·¯æ˜¯ä¸€ä¸ª <code>&quot;æ´‹è‘±æ¨¡å‹&quot;</code>:</p>
<p><img src="vinewrapper.png" alt=""></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-39eacc854f3fd422544f82d390b1f48c">2.14.2 - é“¾è·¯è¿½è¸ª</h1>
    
	<h2 id="ä»€ä¹ˆæ˜¯é“¾è·¯è¿½è¸ª">ä»€ä¹ˆæ˜¯é“¾è·¯è¿½è¸ª</h2>
<p>é“¾è·¯è¿½è¸ªï¼Œå…¨ç§°åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªã€‚åœ¨å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œç³»ç»Ÿç”±å¤§é‡æœåŠ¡ç»„æˆï¼Œæ¯ä¸ªæœåŠ¡å¯èƒ½æ˜¯ç”±ä¸åŒçš„å›¢é˜Ÿå¼€å‘ã€å¯èƒ½ä½¿ç”¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€æ¥å®ç°ã€æœ‰å¯èƒ½å¸ƒåœ¨äº†å‡ åƒå°æœåŠ¡å™¨ï¼Œæ¨ªè·¨å¤šä¸ªä¸åŒçš„æ•°æ®ä¸­å¿ƒâ€¦ä¾‹å¦‚ä¸€æ¬¡è¯·æ±‚å¾€å¾€ä¼šæ¶‰åŠåˆ°å¤šä¸ªæœåŠ¡ï¼Œåœ¨ç³»ç»Ÿå‘ç”Ÿæ•…éšœçš„æ—¶å€™ï¼Œå¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ï¼Œå°±éœ€è¦è¿½è¸ªæœåŠ¡è¯·æ±‚åºåˆ—ã€‚å› æ­¤ï¼Œåˆ†ææ€§èƒ½é—®é¢˜çš„å·¥å…·ä»¥åŠç†è§£ç³»ç»Ÿçš„è¡Œä¸ºå˜å¾—å¾ˆé‡è¦ã€‚é“¾è·¯è¿½è¸ªæ­£æ˜¯ç”¨äºè§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p><strong>Vine</strong> ä¸­é€šè¿‡ wrapper å®ç°é“¾è·¯è¿½è¸ªã€‚</p>
<h2 id="å®ä¾‹">å®ä¾‹</h2>
<p>æˆ‘ä»¬æä¾›ä¸€ä¸ªç®€å•çš„ä»£ç å®ä¾‹ï¼Œæ¥è¯´æ˜é“¾è·¯è¿½è¸ªçš„å·¥ä½œæ–¹å¼:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	pb <span style="color:#f1fa8c">&#34;github.com/vine-io/examples/wrapper/pb&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/client&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/client/grpc&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/server&#34;</span>
	log <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/logger&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/trace&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/trace/memory&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/util/wrapper&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">type</span> hello <span style="color:#8be9fd;font-style:italic">struct</span> {
}

<span style="color:#8be9fd;font-style:italic">func</span> (h hello) <span style="color:#50fa7b">Echo</span>(ctx context.Context, request <span style="color:#ff79c6">*</span>pb.Request, response <span style="color:#ff79c6">*</span>pb.Response) <span style="color:#8be9fd">error</span> {
	ctx, span <span style="color:#ff79c6">:=</span> trace.DefaultTracer.<span style="color:#50fa7b">Start</span>(ctx, <span style="color:#f1fa8c">&#34;echo&#34;</span>)
	<span style="color:#ff79c6">defer</span> trace.DefaultTracer.<span style="color:#50fa7b">Finish</span>(span)
	
	response.Result = request.Name
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	s <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
		vine.<span style="color:#50fa7b">WrapHandler</span>(<span style="color:#50fa7b">HandlerWrapper</span>()),
	)

	s.<span style="color:#50fa7b">Init</span>()

	pb.<span style="color:#50fa7b">RegisterHelloHandler</span>(s.<span style="color:#50fa7b">Server</span>(), <span style="color:#ff79c6">&amp;</span>hello{})

	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		time.<span style="color:#50fa7b">Sleep</span>(time.Second)
        <span style="color:#6272a4">// grpc åŠ è½½ trace wrapper
</span><span style="color:#6272a4"></span>		cli <span style="color:#ff79c6">:=</span> grpc.<span style="color:#50fa7b">NewClient</span>(client.<span style="color:#50fa7b">WrapCall</span>(<span style="color:#50fa7b">CallWrapper</span>()))
		cli = wrapper.<span style="color:#50fa7b">TraceCall</span>(s.<span style="color:#50fa7b">Name</span>(), memory.<span style="color:#50fa7b">NewTracer</span>(), cli)
		cc <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">NewHelloService</span>(s.<span style="color:#50fa7b">Name</span>(), cli)
		cc.<span style="color:#50fa7b">Echo</span>(context.<span style="color:#50fa7b">TODO</span>(), <span style="color:#ff79c6">&amp;</span>pb.Request{<span style="color:#f1fa8c">&#34;Client&#34;</span>})
	}()

	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Run</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">CallWrapper</span>() client.CallWrapper {
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(fn client.CallFunc) client.CallFunc {
		<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, node <span style="color:#ff79c6">*</span>registry.Node, req client.Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}, opts client.CallOptions) <span style="color:#8be9fd">error</span> {
			traceID, parentID, ok <span style="color:#ff79c6">:=</span> trace.<span style="color:#50fa7b">FromContext</span>(ctx)
			<span style="color:#ff79c6">if</span> ok {
				fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;call: tarceID=%s parentID=%s\n&#34;</span>, traceID, parentID)
			}
			<span style="color:#ff79c6">return</span> <span style="color:#50fa7b">fn</span>(ctx, node, req, rsp, opts)
		}
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">HandlerWrapper</span>() server.HandlerWrapper {
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(fn server.HandlerFunc) server.HandlerFunc {
		<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, req server.Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span> {
			traceID, parentID, ok <span style="color:#ff79c6">:=</span> trace.<span style="color:#50fa7b">FromContext</span>(ctx)
			<span style="color:#ff79c6">if</span> ok {
				fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;handle: tarceID=%s parentID=%s\n&#34;</span>, traceID, parentID)
			}
			<span style="color:#ff79c6">return</span> <span style="color:#50fa7b">fn</span>(ctx, req, rsp)
		}
	}
}
</code></pre></div><p>æ–°å»ºé“¾è·¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">ctx = trace.<span style="color:#50fa7b">ToContext</span>(ctx, uuid.<span style="color:#50fa7b">NewString</span>(), uuid.<span style="color:#50fa7b">NewString</span>())
</code></pre></div><p>é“¾è·¯è°ƒç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// æ–°å»ºé“¾è·¯
</span><span style="color:#6272a4"></span>ctx, span <span style="color:#ff79c6">:=</span> trace.<span style="color:#50fa7b">Start</span>(ctx, <span style="color:#f1fa8c">&#34;echo&#34;</span>)
<span style="color:#6272a4">// åœæ­¢ span
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">defer</span> trace.<span style="color:#50fa7b">Finish</span>(span)
</code></pre></div><p>æ•è·é“¾è·¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">traceID, parentID, ok <span style="color:#ff79c6">:=</span> trace.<span style="color:#50fa7b">FromContext</span>(ctx)
<span style="color:#ff79c6">if</span> ok {
	fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;call: tarceID=%s parentID=%s\n&#34;</span>, traceID, parentID)
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-93c9ae063448402518730eb36201d2b1">2.14.3 - æ•°æ®æ ¡éªŒ</h1>
    
	<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>é€šè¿‡ wrapper çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ <code>Client</code> çš„è¾“å‡ºå’Œå¯¹ <code>Server</code> è¾“å…¥çš„æ•°æ®è¿›è¡Œåˆæ³•æ€§æ ¡éªŒã€‚</p>
<h2 id="å®ç°">å®ç°</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	pb <span style="color:#f1fa8c">&#34;github.com/vine-io/examples/wrapper/pb&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/client&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/client/grpc&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/server&#34;</span>
	verrs <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/errors&#34;</span>
	log <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/logger&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/trace/memory&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/util/wrapper&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">type</span> hello <span style="color:#8be9fd;font-style:italic">struct</span>{}

<span style="color:#8be9fd;font-style:italic">func</span> (h hello) <span style="color:#50fa7b">Echo</span>(ctx context.Context, request <span style="color:#ff79c6">*</span>pb.Request, response <span style="color:#ff79c6">*</span>pb.Response) <span style="color:#8be9fd">error</span> {
	response.Result = request.Name
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	s <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
		vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;helloworld&#34;</span>),
		vine.<span style="color:#50fa7b">WrapHandler</span>(<span style="color:#50fa7b">HandlerValidatorWrapper</span>()),
	)

	s.<span style="color:#50fa7b">Init</span>()

	pb.<span style="color:#50fa7b">RegisterHelloHandler</span>(s.<span style="color:#50fa7b">Server</span>(), <span style="color:#ff79c6">&amp;</span>hello{})

	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		time.<span style="color:#50fa7b">Sleep</span>(time.Second)
		cli <span style="color:#ff79c6">:=</span> grpc.<span style="color:#50fa7b">NewClient</span>(client.<span style="color:#50fa7b">WrapCall</span>(<span style="color:#50fa7b">CallValidatorWrapper</span>()))
		cli = wrapper.<span style="color:#50fa7b">TraceCall</span>(s.<span style="color:#50fa7b">Name</span>(), memory.<span style="color:#50fa7b">NewTracer</span>(), cli)
		cc <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">NewHelloService</span>(s.<span style="color:#50fa7b">Name</span>(), cli)
		rsp, err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Echo</span>(context.<span style="color:#50fa7b">TODO</span>(), <span style="color:#ff79c6">&amp;</span>pb.Request{<span style="color:#f1fa8c">&#34;&#34;</span>})
		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
			log.<span style="color:#50fa7b">Fatal</span>(err)
		}
		fmt.<span style="color:#50fa7b">Println</span>(rsp)
	}()

	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Run</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}
}

<span style="color:#8be9fd;font-style:italic">type</span> Validator <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Validate</span>() <span style="color:#8be9fd">error</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">CallValidatorWrapper</span>() client.CallWrapper {
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(fn client.CallFunc) client.CallFunc {
		<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, node <span style="color:#ff79c6">*</span>registry.Node, req client.Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}, opts client.CallOptions) <span style="color:#8be9fd">error</span> {
			<span style="color:#ff79c6">if</span> v, ok <span style="color:#ff79c6">:=</span> req.<span style="color:#50fa7b">Body</span>().(Validator); ok {
				<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> v.<span style="color:#50fa7b">Validate</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
					<span style="color:#ff79c6">return</span> verrs.<span style="color:#50fa7b">BadRequest</span>(req.<span style="color:#50fa7b">Service</span>(), err.<span style="color:#50fa7b">Error</span>())
				}
			}
			<span style="color:#ff79c6">return</span> <span style="color:#50fa7b">fn</span>(ctx, node, req, rsp, opts)
		}
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">HandlerValidatorWrapper</span>() server.HandlerWrapper {
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(fn server.HandlerFunc) server.HandlerFunc {
		<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, req server.Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span> {
			<span style="color:#ff79c6">if</span> v, ok <span style="color:#ff79c6">:=</span> req.<span style="color:#50fa7b">Body</span>().(Validator); ok {
				<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> v.<span style="color:#50fa7b">Validate</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
					<span style="color:#ff79c6">return</span> verrs.<span style="color:#50fa7b">BadRequest</span>(req.<span style="color:#50fa7b">Service</span>(), err.<span style="color:#50fa7b">Error</span>())
				}
			}
			<span style="color:#ff79c6">return</span> <span style="color:#50fa7b">fn</span>(ctx, req, rsp)
		}
	}
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-62cd849eef8495611b5b8892f70d5afa">2.14.4 - å…ƒæ•°æ®</h1>
    
	<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<blockquote>
<p>å…ƒæ•°æ®æ˜¯ç”¨æ¥æè¿°æ•°æ®çš„æ•°æ®ï¼ˆData that describes other dataï¼‰ã€‚</p>
</blockquote>
<p><strong>Vine</strong> ä¸­çš„å…ƒæ•°æ®ç»Ÿä¸€å°è£…åœ¨ <code>context.Context</code> ä¸­ã€‚é€šè¿‡ wrapper çš„ç‰¹æ€§ä½¿æˆ‘ä»¬å¯ä»¥åœ¨æ— å…¥ä¾µçš„æƒ…å†µä¸‹ä¿®æ”¹å…ƒæ•°æ®ä¿¡æ¯ã€‚</p>
<h2 id="metadata">metadata</h2>
<p><code>metadata</code> æ¨¡å—ç”¨äº <strong>Vine</strong> å…ƒæ•°æ®çš„æ“ä½œï¼Œæ”¯æŒçš„æ“ä½œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">import</span> (
    <span style="color:#f1fa8c">&#34;context&#34;</span>
    <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/util/context/metadata&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    <span style="color:#6272a4">// ä» ctx è·å– key
</span><span style="color:#6272a4"></span>    val, ok <span style="color:#ff79c6">:=</span> metadata.<span style="color:#50fa7b">Get</span>(ctx, <span style="color:#f1fa8c">&#34;key&#34;</span>)
    <span style="color:#6272a4">// ä¿®æ”¹ ctx ä¸­çš„ key
</span><span style="color:#6272a4"></span>    metadata.<span style="color:#50fa7b">Set</span>(ctx, <span style="color:#f1fa8c">&#34;key&#34;</span>, <span style="color:#f1fa8c">&#34;value&#34;</span>)
    <span style="color:#6272a4">// åˆ é™¤ ctx ä¸­çš„ key
</span><span style="color:#6272a4"></span>    metadata.<span style="color:#50fa7b">Delete</span>(ctx, <span style="color:#f1fa8c">&#34;key&#34;</span>)
    <span style="color:#6272a4">// è·å– ctx ä¸­çš„å…ƒæ•°æ®
</span><span style="color:#6272a4"></span>    md, _ <span style="color:#ff79c6">:=</span> metadata.<span style="color:#50fa7b">FromContext</span>(ctx)
    <span style="color:#6272a4">// å°è£… md
</span><span style="color:#6272a4"></span>    ctx = metadata.<span style="color:#50fa7b">NewContext</span>(ctx, md)
    <span style="color:#6272a4">// å®Œæ•´æ‹·è´å…ƒæ•°æ®
</span><span style="color:#6272a4"></span>    md = metadata.<span style="color:#50fa7b">Copy</span>(md)
    <span style="color:#6272a4">// åˆå¹¶ ctx ä¸­çš„å…ƒæ•°æ®
</span><span style="color:#6272a4"></span>    ctx = metadata.<span style="color:#50fa7b">MergeContext</span>(ctx, md, <span style="color:#ff79c6">true</span>)
}
</code></pre></div><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<p>åœ¨æœ‰ ctx ä½œä¸ºå…¥å‚çš„åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨ metadataã€‚å¦‚æœä¸å¸Œæœ›ç ´åä¸šåŠ¡ä»£ç ï¼Œæ¨èåœ¨ wrapper ä¸­ä½¿ç”¨:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">CallWrapper</span>() client.CallWrapper {
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(fn client.CallFunc) client.CallFunc {
		<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, node <span style="color:#ff79c6">*</span>registry.Node, req client.Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}, opts client.CallOptions) <span style="color:#8be9fd">error</span> {
			md, _ <span style="color:#ff79c6">:=</span> metadata.<span style="color:#50fa7b">FromContext</span>(ctx)
			<span style="color:#6272a4">// è¿½åŠ  client=wrapper
</span><span style="color:#6272a4"></span>			md.<span style="color:#50fa7b">Set</span>(<span style="color:#f1fa8c">&#34;client&#34;</span>, <span style="color:#f1fa8c">&#34;wrapper&#34;</span>)
			ctx = metadata.<span style="color:#50fa7b">NewContext</span>(ctx, md)
			<span style="color:#ff79c6">return</span> <span style="color:#50fa7b">fn</span>(ctx, node, req, rsp, opts)
		}
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">HandlerWrapper</span>() server.HandlerWrapper {
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(fn server.HandlerFunc) server.HandlerFunc {
		<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, req server.Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span> {
			val, _ <span style="color:#ff79c6">:=</span> metadata.<span style="color:#50fa7b">Get</span>(ctx, <span style="color:#f1fa8c">&#34;client&#34;</span>)
            <span style="color:#6272a4">// è·å– client
</span><span style="color:#6272a4"></span>			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;client: &#34;</span>, val)
			<span style="color:#ff79c6">return</span> <span style="color:#50fa7b">fn</span>(ctx, req, rsp)
		}
	}
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e1183309a928ffcc3eb6cc0dcd66651d">2.14.5 - é™æµå™¨</h1>
    
	<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>ç¼“å­˜ã€é™çº§å’Œé™æµæ˜¯é«˜å¹¶å‘ç³»ç»Ÿæ—¶æœ‰ä¸‰æŠŠåˆ©å™¨ã€‚</p>
<p>é™æµ(é™åˆ¶å¹¶å‘/è¯·æ±‚é‡),å®ƒçš„ç›®çš„æ˜¯é€šè¿‡å¯¹å¹¶å‘è®¿é—®/è¯·æ±‚è¿›è¡Œé™é€Ÿæˆ–è€…ä¸€ä¸ªæ—¶é—´çª—å£å†…çš„è¯·æ±‚è¿›è¡Œé™é€Ÿæ¥ä¿æŠ¤ç³»ç»Ÿï¼Œå¦‚æœè¯·æ±‚è¾¾åˆ°ä¸Šé™å€¼ï¼ŒæœåŠ¡ç«¯å¯ä»¥é‡‡å–æ‹’æ¥æœåŠ¡ã€æ’é˜Ÿæˆ–ç­‰å¾…ã€é™çº§ã€‚</p>
<h2 id="é™æµç®—æ³•">é™æµç®—æ³•</h2>
<p>å¸¸è§çš„é™æµç®—æ³•æœ‰: ä»¤ç‰Œæ¡¶ã€æ¼æ¡¶ã€‚</p>
<h3 id="æ¼æ¡¶">æ¼æ¡¶</h3>
<p>æ¼æ¡¶(Leaky Bucket)ç®—æ³•æ€è·¯å¾ˆç®€å•ï¼Œæ°´(è¯·æ±‚)å…ˆè¿›å…¥åˆ°æ¼æ¡¶é‡Œï¼Œæ¼æ¡¶ä»¥ä¸€å®šçš„é€Ÿåº¦å‡ºæ°´(æ¥å£æœ‰å“åº”é€Ÿç‡)ï¼Œå½“æ°´æµå…¥é€Ÿåº¦è¿‡å¤§ä¼šç›´æ¥æº¢å‡º(è®¿é—®é¢‘ç‡è¶…è¿‡æ¥å£å“åº”é€Ÿç‡)ï¼Œç„¶åå°±æ‹’ç»è¯·æ±‚ï¼Œå¯ä»¥çœ‹å‡ºæ¼æ¡¶ç®—æ³•èƒ½å¼ºè¡Œé™åˆ¶æ•°æ®çš„ä¼ è¾“é€Ÿç‡ã€‚
<img src="2021-09-08-10-57-08.png" alt=""></p>
<h3 id="ä»¤ç‰Œæ¡¶">ä»¤ç‰Œæ¡¶</h3>
<p>ä»¤ç‰Œæ¡¶ç®—æ³•(Token Bucket)å’Œ Leaky Bucket æ•ˆæœä¸€æ ·ä½†æ–¹å‘ç›¸åçš„ç®—æ³•ï¼Œæ›´åŠ å®¹æ˜“ç†è§£ã€‚éšç€æ—¶é—´æµé€ï¼Œç³»ç»Ÿä¼šæŒ‰æ’å®š 1/QPS æ—¶é—´é—´éš”(å¦‚æœQPS=100,åˆ™é—´éš”æ˜¯10ms)å¾€æ¡¶é‡ŒåŠ å…¥ Token (æƒ³è±¡å’Œæ¼æ´æ¼æ°´ç›¸å,æœ‰ä¸ªæ°´é¾™å¤´åœ¨ä¸æ–­çš„åŠ æ°´)ï¼Œå¦‚æœæ¡¶å·²ç»æ»¡äº†å°±ä¸å†åŠ äº†ã€‚æ–°è¯·æ±‚æ¥ä¸´æ—¶ï¼Œä¼šå„è‡ªæ‹¿èµ°ä¸€ä¸ªTokenï¼Œå¦‚æœæ²¡æœ‰Tokenå¯æ‹¿äº†å°±é˜»å¡æˆ–è€…æ‹’ç»æœåŠ¡ã€‚</p>
<p><img src="2021-09-08-10-57-47.png" alt=""></p>
<h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<p><strong>Vine</strong> çš„ wrapper å¯ä»¥å®ç°é™æµå™¨åŠŸèƒ½:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>

	pb <span style="color:#f1fa8c">&#34;github.com/vine-io/examples/wrapper/pb&#34;</span>
	ub <span style="color:#f1fa8c">&#34;github.com/vine-io/plugins/wrapper/ratelimiter/uber&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
	log <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/logger&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">type</span> hello <span style="color:#8be9fd;font-style:italic">struct</span>{}

<span style="color:#8be9fd;font-style:italic">func</span> (h hello) <span style="color:#50fa7b">Echo</span>(ctx context.Context, request <span style="color:#ff79c6">*</span>pb.Request, response <span style="color:#ff79c6">*</span>pb.Response) <span style="color:#8be9fd">error</span> {
	response.Result = request.Name
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	handler <span style="color:#ff79c6">:=</span> ub.<span style="color:#50fa7b">NewHandlerWrapper</span>(<span style="color:#bd93f9">1000</span>)

	s <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
		vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;helloworld&#34;</span>),
		vine.<span style="color:#50fa7b">WrapHandler</span>(handler),
	)

	s.<span style="color:#50fa7b">Init</span>()

	pb.<span style="color:#50fa7b">RegisterHelloHandler</span>(s.<span style="color:#50fa7b">Server</span>(), <span style="color:#ff79c6">&amp;</span>hello{})

	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Run</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c483018e88ad8da9a20f3c7dfcffa915">2.14.6 - æ–­è·¯å™¨</h1>
    
	<h2 id="ä»€ä¹ˆæ˜¯æ–­è·¯å™¨">ä»€ä¹ˆæ˜¯æ–­è·¯å™¨</h2>
<blockquote>
<p>æ–­è·¯å™¨ï¼ˆåˆç§°ç†”æ–­å™¨ï¼ŒCircuit Breakerï¼Œç®€ç§°CBï¼‰ï¼Œå¹¿æ³›ä½¿ç”¨äºå·¥ä¸šç”Ÿäº§å’Œæ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œä¸»è¦åŠŸèƒ½æ˜¯åˆä¸Šå’Œæ–­å¼€å›è·¯ï¼ˆON/OFF POWERï¼‰ã€‚åˆ«å:ç©ºæ°”å¼€å…³ã€ä¿é™©æ£ã€æ— ç†”ä¸å¼€å…³ã€‚æ–­è·¯å™¨ä¼šåœ¨çŸ­è·¯å’Œä¸¥é‡è¶…è½½çš„æƒ…å†µä¸‹åˆ‡æ–­ç”µè·¯ï¼Œä»è€Œæœ‰æ•ˆçš„ä¿æŠ¤å›è·¯ä¸­çš„ç”µå™¨ã€‚&ndash; ç»´åŸºç™¾ç§‘</p>
</blockquote>
<p>é›ªå´©æ•ˆåº”: å¾®æœåŠ¡ä¹‹é—´çš„æ•°æ®äº¤äº’æ˜¯é€šè¿‡è¿œç¨‹è°ƒç”¨æ¥å®Œæˆã€‚æœåŠ¡Aè°ƒç”¨æœåŠ¡Bï¼ŒæœåŠ¡Bè°ƒç”¨æœåŠ¡Cã€‚å¦‚æœæŸä¸€æ—¶é—´è°ƒç”¨é“¾è·¯ä¸Šçš„ä¸€ä¸ªæœåŠ¡ä¸å¯ç”¨ï¼Œä½†æ˜¯å…¶ä»–æœåŠ¡è¿˜åœ¨ä¸æ–­è°ƒç”¨è¿™ä¸ªæœåŠ¡ï¼Œæˆ–è€…ä¸æ–­çš„é‡è¯•ï¼Œå°±ä¼šå¯¼è‡´ç³»ç»Ÿèµ„æºä¸æ–­è¢«å ç”¨ï¼Œå‡ºç°çº§è”æ•…éšœï¼Œä»è€Œé€ æˆè¿™ä¸ªç³»ç»Ÿå¯ä¸ç”¨ã€‚</p>
<p><code>breaker</code> çš„å‡ºç°æ­£æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå½“æŸä¸ªæœåŠ¡ä¸å¯ç”¨æ˜¯ï¼Œè°ƒç”¨ç«¯ä¼šå¼€å¯ç†”æ–­æ£€æµ‹ï¼Œå½“è¯·æ±‚çš„é”™è¯¯è¾¾åˆ°ä¸€å®šé˜ˆå€¼çš„æ—¶å€™ï¼Œå¼€å¯ç†”æ–­å…³é—­ã€‚è¿™æ—¶æ‰€æœ‰è°ƒç”¨è¿™ä¸ªæœåŠ¡çš„è¯·æ±‚ç›´æ¥æŠ¥é”™ï¼Œé¿å…å‡ºç°çº§è”æ•…éšœã€‚åŒæ—¶æ¯ä¸ªä¸€æ®µæ—¶é—´æ£€æµ‹æœåŠ¡è¯·æ±‚çŠ¶æ€ï¼Œå¦‚æœæœåŠ¡è¯·æ±‚æˆåŠŸï¼Œå…³é—­ç†”æ–­ï¼Œé“¾è·¯æ¢å¤ã€‚å®ƒå®é™…æ˜¯ä¸­ç‰¹æ®Šçš„æœåŠ¡é™çº§æ–¹å¼ï¼Œæ˜¯ä¸€ç§è½¯ä»¶é«˜å¹¶å‘è§£å†³æ–¹æ¡ˆã€‚</p>
<p><img src="2021-09-08-10-04-36.png" alt=""></p>
<h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<p><strong>Vine</strong> é€šè¿‡ wrapper ç‰¹æ€§å®ç°ç†”æ–­å™¨åŠŸèƒ½ï¼Œåœ¨ <code>Client Call</code> è¯·æ±‚ä¸­æ·»åŠ ç†”æ–­ wrapperã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;os&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/sony/gobreaker&#34;</span>
	pb <span style="color:#f1fa8c">&#34;github.com/vine-io/examples/wrapper/pb&#34;</span>
	bk <span style="color:#f1fa8c">&#34;github.com/vine-io/plugins/wrapper/breaker/gobreaker&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
	log <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/logger&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">type</span> hello <span style="color:#8be9fd;font-style:italic">struct</span>{}

<span style="color:#8be9fd;font-style:italic">func</span> (h hello) <span style="color:#50fa7b">Echo</span>(ctx context.Context, request <span style="color:#ff79c6">*</span>pb.Request, response <span style="color:#ff79c6">*</span>pb.Response) <span style="color:#8be9fd">error</span> {
	response.Result = request.Name
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	bs <span style="color:#ff79c6">:=</span> gobreaker.Settings{
		Name:          <span style="color:#f1fa8c">&#34;breaker&#34;</span>,
		MaxRequests:   <span style="color:#bd93f9">10</span>,
		Interval:      time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">10</span>,
		Timeout:       time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">15</span>,
		ReadyToTrip: <span style="color:#8be9fd;font-style:italic">func</span>(counts gobreaker.Counts) <span style="color:#8be9fd">bool</span> {
			failureRatio <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">float64</span>(counts.TotalFailures) <span style="color:#ff79c6">/</span> <span style="color:#8be9fd;font-style:italic">float64</span>(counts.Requests)
			<span style="color:#ff79c6">return</span> counts.Requests <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">3</span> <span style="color:#ff79c6">&amp;&amp;</span> failureRatio <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">0.6</span>
		},
		OnStateChange: <span style="color:#8be9fd;font-style:italic">func</span>(name <span style="color:#8be9fd">string</span>, from gobreaker.State, to gobreaker.State) {
			log.<span style="color:#50fa7b">Info</span>(<span style="color:#f1fa8c">&#34;%s %s =&gt; %s&#34;</span>, name, from.<span style="color:#50fa7b">String</span>(), to.<span style="color:#50fa7b">String</span>())
		},
	}
	breaker <span style="color:#ff79c6">:=</span> bk.<span style="color:#50fa7b">NewCustomClientWrapper</span>(bs, bk.BreakService)

	s <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
		vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;helloworld&#34;</span>),
		vine.<span style="color:#50fa7b">WrapClient</span>(breaker),
	)

	s.<span style="color:#50fa7b">Init</span>()

	pb.<span style="color:#50fa7b">RegisterHelloHandler</span>(s.<span style="color:#50fa7b">Server</span>(), <span style="color:#ff79c6">&amp;</span>hello{})

	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		time.<span style="color:#50fa7b">Sleep</span>(time.Second)
		cc <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">NewHelloService</span>(s.<span style="color:#50fa7b">Name</span>(), s.<span style="color:#50fa7b">Client</span>())
		rsp, err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Echo</span>(context.<span style="color:#50fa7b">TODO</span>(), <span style="color:#ff79c6">&amp;</span>pb.Request{<span style="color:#f1fa8c">&#34;&#34;</span>})
		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
			log.<span style="color:#50fa7b">Fatal</span>(err)
		}
		fmt.<span style="color:#50fa7b">Println</span>(rsp)
		os.<span style="color:#50fa7b">Exit</span>(<span style="color:#bd93f9">0</span>)
	}()

	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Run</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c049cbc8dfe9badc6517d70a4af559fb">2.15 - å®šæ—¶ä»»åŠ¡</h1>
    
	<p><strong>Vine</strong> æœåŠ¡å†…éƒ¨æºå¸¦å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨ï¼Œç”¨æˆ·å¯ä»¥æ³¨å†Œ <code>Job</code>ï¼ŒæœåŠ¡å¯åŠ¨æ—¶ï¼Œè°ƒåº¦å™¨åŒæ—¶å¯åŠ¨ã€‚</p>
<h2 id="æ–°å»º">æ–°å»º</h2>
<p>æˆ‘ä»¬æ¥å°è¯•åˆ›å»ºä¸€ä¸ªä»»åŠ¡:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;log&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/gscheduler&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	job <span style="color:#ff79c6">:=</span> gscheduler.<span style="color:#50fa7b">JobBuilder</span>().
		<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;testjob&#34;</span>).          <span style="color:#6272a4">// ä»»åŠ¡åç§°ï¼Œå”¯ä¸€å€¼
</span><span style="color:#6272a4"></span>		<span style="color:#50fa7b">Duration</span>(time.Second).    <span style="color:#6272a4">// ä»»åŠ¡è§¦å‘é—´éš”æ—¶é—´
</span><span style="color:#6272a4"></span>		<span style="color:#50fa7b">Fn</span>(<span style="color:#8be9fd;font-style:italic">func</span>() {               <span style="color:#6272a4">// ä»»åŠ¡ä¸šåŠ¡ä¸»ä½“
</span><span style="color:#6272a4"></span>			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;done!&#34;</span>)
		}).
		<span style="color:#50fa7b">Out</span>()                     <span style="color:#6272a4">// è¿”å› *Job
</span><span style="color:#6272a4"></span>
    <span style="color:#6272a4">// æ·»åŠ å®šæ—¶ä»»åŠ¡
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">AddJob</span>(job); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	s <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>()
	s.<span style="color:#50fa7b">Init</span>()
	s.<span style="color:#50fa7b">Run</span>()
}
</code></pre></div><h2 id="æ„å»ºè¿‡ç¨‹">æ„å»ºè¿‡ç¨‹</h2>
<p>æˆ‘ä»¬æä¾›ä¸€ç»„æ–¹æ³•æ¥ç®€åŒ–å®šæ—¶ä»»åŠ¡çš„åˆ›å»ºè¿‡ç¨‹ã€‚</p>
<p>åˆ›å»ºå®šæ—¶ä»»åŠ¡:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    job <span style="color:#ff79c6">:=</span> gscheduler.<span style="color:#50fa7b">JobBuilder</span>().
		<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;testjob&#34;</span>).
		<span style="color:#50fa7b">Duration</span>(time.Second).
		<span style="color:#50fa7b">Fn</span>(<span style="color:#8be9fd;font-style:italic">func</span>() {
			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;done!&#34;</span>)
		}).
		<span style="color:#50fa7b">Out</span>()
}
</code></pre></div><p>åˆ›å»º crontab å®šæ—¶ä»»åŠ¡:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">import</span> (
    <span style="color:#ff79c6">...</span>
    <span style="color:#f1fa8c">&#34;github.com/vine-io/gscheduler&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/gscheduler/cron&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    <span style="color:#6272a4">// crontab è¡¨è¾¾å¼æ ¼å¼: ç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨
</span><span style="color:#6272a4"></span>    c, err <span style="color:#ff79c6">:=</span> cron.<span style="color:#50fa7b">Parse</span>(<span style="color:#f1fa8c">&#34;*/3 * * * * *&#34;</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;invalid crontab expr: %v&#34;</span>, err)
	}

    <span style="color:#6272a4">// c = cron.Every(time.Second)
</span><span style="color:#6272a4"></span>
	job <span style="color:#ff79c6">:=</span> gscheduler.<span style="color:#50fa7b">JobBuilder</span>().
		<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;testjob&#34;</span>).
		<span style="color:#50fa7b">Spec</span>(c).
		<span style="color:#50fa7b">Fn</span>(<span style="color:#8be9fd;font-style:italic">func</span>() {
			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;done!&#34;</span>)
		}).
		<span style="color:#50fa7b">Out</span>()
}
</code></pre></div><p>åˆ›å»ºä¸€æ¬¡æ€§ä»»åŠ¡:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    job <span style="color:#ff79c6">:=</span> gscheduler.<span style="color:#50fa7b">JobBuilder</span>().
		<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;testjob&#34;</span>).
		<span style="color:#50fa7b">Delay</span>(time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">Add</span>(time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">2</span>)).
		<span style="color:#50fa7b">Fn</span>(<span style="color:#8be9fd;font-style:italic">func</span>() {
			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;done!&#34;</span>)
		}).
		<span style="color:#50fa7b">Out</span>()
}
</code></pre></div><p>é¢å¤–çš„åŠŸèƒ½:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    job <span style="color:#ff79c6">:=</span> gscheduler.<span style="color:#50fa7b">JobBuilder</span>().
		<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;testjob&#34;</span>).
		<span style="color:#50fa7b">Duration</span>(time.Second).
		<span style="color:#50fa7b">Silent</span>().  <span style="color:#6272a4">// ä»»åŠ¡é™é»˜
</span><span style="color:#6272a4"></span>		<span style="color:#50fa7b">Times</span>(<span style="color:#bd93f9">3</span>).  <span style="color:#6272a4">// æŒ‡å®šä»»åŠ¡æ‰§è¡Œæ¬¡æ•°
</span><span style="color:#6272a4"></span>		<span style="color:#50fa7b">Fn</span>(<span style="color:#8be9fd;font-style:italic">func</span>() {
			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;done!&#34;</span>)
		}).
		<span style="color:#50fa7b">Out</span>()
}
</code></pre></div><h2 id="å…¶ä»–">å…¶ä»–</h2>
<p>å†…éƒ¨å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨çš„å…¶ä»–åŠŸèƒ½:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    <span style="color:#6272a4">// æ ¹æ® id è·å–ä»»åŠ¡
</span><span style="color:#6272a4"></span>    j, _ <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">GetJob</span>(job.<span style="color:#50fa7b">ID</span>())
    <span style="color:#6272a4">// æ›´æ–°ä»»åŠ¡
</span><span style="color:#6272a4"></span>	vine.<span style="color:#50fa7b">UpdateJob</span>(j)
    <span style="color:#6272a4">// åˆ é™¤ä»»åŠ¡
</span><span style="color:#6272a4"></span>	vine.<span style="color:#50fa7b">RemoveJob</span>(j)
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d2c6535126cca927d2a9c893abde92a0">3 - ç”¨æˆ·æŒ‡å—</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-22e05ce140284b8cc925e8080f773895">3.1 - Protobuf è§„èŒƒ</h1>
    
	<p>æˆ‘ä»¬æä¾›ä¸€å¥— <code>Protobuf</code> æ–‡ä»¶æ ¼å¼å’Œç¥ç”Ÿæˆä»£ç çš„è§„èŒƒï¼Œå¸®åŠ©ç”¨æˆ·å†™å‡ºæ›´æ ‡å‡†çš„æ¥å£ã€‚</p>
<p><strong>Vine</strong> é¡¹ç›®çš„æ¨å´‡ä»¥ <strong>èµ„æº</strong> ä¸ºæ ¸å¿ƒã€‚æ¥å£çš„è®¾è®¡å’Œä»£ç çš„è§„èŒƒéƒ½æŒ‰ç…§ <strong>èµ„æº</strong> å±•å¼€ã€‚æ¯ä¸ªæ¥å£çš„è®¾è®¡éµå¾ªä»¥ä¸‹çš„è§„åˆ™:</p>
<ol>
<li>æ ¹æ®éœ€æ±‚ç¡®å®šèµ„æº (é¢†åŸŸæ¨¡å‹)ã€‚</li>
<li>æ¯ä¸ªæ¥å£å®é™…ä¸ºèµ„æºçš„æ–¹æ³•æˆ–è€…æ˜¯é’ˆå¯¹èµ„æºçš„æ“ä½œã€‚</li>
<li>æ¯ä¸ª service ä¸ºèµ„æºæ“ä½œçš„é›†åˆã€‚</li>
<li>å‰ç«¯è¯·æ±‚æ—¶æäº¤çš„æ•°æ®å¯ç›´æ¥è½¬åŒ–ä¸ºèµ„æºçš„å†…éƒ¨å±æ€§ã€‚</li>
<li>æä¾›çš„ API æ¥å£æ ¼å¼ç»Ÿä¸€ä¸ºé’ˆå¯¹èµ„æºçš„æ›¹ç»„ã€‚</li>
</ol>
<h2 id="ç›®å½•ç»“æ„">ç›®å½•ç»“æ„</h2>
<p>API æ¥å£ç»Ÿä¸€å­˜æ”¾åœ¨ api ç›®å½•ä¸‹ï¼Œproto æ–‡ä»¶åŒæ—¶è½¬åŒ–ä¸º gRPC å’Œ HTTP ä¸¤ç§æ¥å£ã€‚</p>
<p>é¡¹ç›®ä¸­å®šä¹‰ Protoï¼Œä»¥ api ä¸ºæ ¹ç›®å½•ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">â”œâ”€â”€ service    
â”‚   â””â”€â”€ helloworld
â”‚       â””â”€â”€ v1
â”‚           â”œâ”€â”€ helloworld.pb.go
â”‚           â”œâ”€â”€ helloworld.pb.validator.go
â”‚           â”œâ”€â”€ helloworld.pb.vine.go
â”‚           â””â”€â”€ helloworld.proto
â””â”€â”€ types
    â””â”€â”€ core
        â””â”€â”€ v1
            â”œâ”€â”€ core.pb.dao.go
            â”œâ”€â”€ core.pb.deepcopy.go
            â”œâ”€â”€ core.pb.go
            â”œâ”€â”€ core.pb.validator.go
            â””â”€â”€ core.proto
</code></pre></div><p>api ä¸‹æœ‰ä¸¤ä¸ªå­ç›®å½•ï¼Œåˆ†åˆ«å¯¹åº”</p>
<ul>
<li>types (é¢†åŸŸæ¨¡å‹æˆ–è€…èµ„æº)ï¼Œæ ¼å¼ä¸º <code>group/version/name.proto</code></li>
<li>services (gRPCã€http æ¥å£)ï¼Œæ ¼å¼ä¸º <code>service/version/name.proto</code></li>
</ul>
<h2 id="åŒ…å">åŒ…å</h2>
<p>åŒ…åä¸ºåº”ç”¨çš„æ ‡è¯†ï¼Œç”¨æˆ·ç”Ÿæˆ gRPC è¯·æ±‚è·¯å¾„ï¼Œæˆ–è€… proto æ–‡ä»¶ä¹‹é—´å¼•ç”¨ã€‚</p>
<blockquote>
<p>å»ºè®®åœ¨ $GOPATH/src ç”Ÿæˆä»£ç  proto ä»£ç ã€‚</p>
</blockquote>
<h3 id="go_package">go_package</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#ff79c6">option</span> go_package <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;github.com/lack-io/foo/api/types/&lt;group&gt;/&lt;version&gt;;&lt;group&gt;&lt;version&gt;&#34;</span>;
</code></pre></div><h3 id="java_package">java_package</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#ff79c6">option</span> java_multiple_files <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>;
<span style="color:#ff79c6">option</span> java_package <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;io.vine.services.&lt;group&gt;.&lt;version&gt;&#34;</span>;
</code></pre></div><h2 id="import">import</h2>
<p>service proto ä¾èµ– types protobufï¼Œä»¥ $GOPATH/src ä¸ºæ›´ç›®å½•å¼•å…¥å¯¹åº” protoã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/foo/api/types/core/v1/core.proto&#34;</span>

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Request</span> {
    corev1.Request req <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div><h2 id="repo">repo</h2>
<p>å½“éœ€è¦æ•°æ®æŒä¹…åŒ–æ—¶ï¼Œæœ‰ types proto ç”Ÿæˆå¯¹åº”çš„æ•°æ®åº“äº¤äº’ä»£ç ã€‚è¯¦ç»†çš„è¯´æ˜å¯ä»¥å‚è€ƒ <a href="https://vine-io.github.io/vine/docs/guides/dao/">proto-gen-dao</a>ã€‚</p>
<p>ä»£ç çš„å­˜æ”¾è§„åˆ™ä¸ºï¼Œ<em>è°å®ç°ï¼Œè°å­˜æ”¾</em>ã€‚ç”Ÿæˆçš„ä»£ç å­˜æ”¾åœ¨å¯¹åº”æœåŠ¡æ›´ç›®å½•çš„ <code>infra/repo</code> ä¸‹ï¼Œéœ€è¦åœ¨ proto æ–‡ä»¶çš„å¤´éƒ¨æŒ‡å®šç”Ÿæˆè·¯å¾„:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +dao:output=github.com/vine-io/foo/pkg/helloworld/infra/repo;repo
</span><span style="color:#6272a4"></span>syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;protoc&#34;</span>
</code></pre></div><h2 id="å‘½ä»¤è§„èŒƒ">å‘½ä»¤è§„èŒƒ</h2>
<h3 id="ç›®å½•ç»“æ„-1">ç›®å½•ç»“æ„</h3>
<p>åŒ…åä¸ºå°å†™ï¼Œä¸”åŒä¸ç›®å½•ä¸€è‡´: å¦‚ <code>hellowrold/v1/helloworld.proto</code> çš„åŒ…åä¸º <code>helloworldv1</code>ã€‚</p>
<h3 id="æ–‡ä»¶ç»“æ„">æ–‡ä»¶ç»“æ„</h3>
<p>æ–‡ä»¶åº”è¯¥å‘½åä¸ºï¼šlower_snake_case.proto æ‰€æœ‰Protoåº”æŒ‰ä¸‹åˆ—æ–¹å¼æ’åˆ—:</p>
<ul>
<li>License header (if applicable)</li>
<li>File overview</li>
<li>Syntax</li>
<li>Package</li>
<li>Imports (sorted)</li>
<li>File options</li>
<li>Service</li>
<li>Message</li>
</ul>
<h3 id="service-å’Œ-message">Service å’Œ Message</h3>
<p>ä½¿ç”¨é©¼å³°å‘½åæ³•å‘½å service, method å’Œ messageã€‚Service çš„åç§°æ ¼å¼ä¸º <code>&lt;PackageName&gt;Service</code> ä»¥ <code>Service</code> ä¸ºåç¼€ã€‚</p>
<p>Method çš„æ ¼å¼ä¸º:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">service</span> EchoService {
    <span style="color:#ff79c6">rpc</span> EmptyMethod(Empty) <span style="color:#ff79c6">returns</span> (Empty);
    <span style="color:#ff79c6">rpc</span> Echo(EchoReq) <span style="color:#ff79c6">returns</span> (EchoRsp);
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Empty</span> {}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">EchoReq</span> {}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">EchoRsp</span> {}
</code></pre></div><p>Method çš„è¾“å…¥è¾“å‡º Message æ²¡æœ‰å…¶ä»–å­—æ®µæ—¶ï¼Œä½¿ç”¨ <code>Empty</code>ã€‚Method çš„è¾“å…¥ message ä»¥ <code>Req</code> ç»“å°¾ã€‚è¾“å‡º message ä»¥ <code>Rsp</code> ç»“å°¾ã€‚</p>
<h3 id="å­—æ®µ">å­—æ®µ</h3>
<p>å­—æ®µä½¿ç”¨é©¼å³°å‘½åæ³•(é¦–å­—æ¯å°å†™)ï¼Œ<code>repeated</code> æ•°ç»„ç±»å‹æ˜¯ç»“å°¾åŠ å°å†™:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">User</span> {
    <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
    <span style="color:#ff79c6">repeated</span> <span style="color:#8be9fd">string</span> tags <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}
</code></pre></div><h3 id="æšä¸¾-enums">æšä¸¾ Enums</h3>
<p>ä½¿ç”¨é©¼å³°å‘½åæ³•ï¼ˆé¦–å­—æ¯å¤§å†™ï¼‰å‘½åæšä¸¾ç±»å‹ï¼Œä½¿ç”¨ â€œå¤§å†™ä¸‹åˆ’çº¿å¤§å†™â€ çš„æ–¹å¼å‘½åæšä¸¾å€¼ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">enum</span> Color {
  RED <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
  BLACK <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div><p>æ¯ä¸€ä¸ªæšä¸¾å€¼ä»¥åˆ†å·ç»“å°¾ï¼Œè€Œéé€—å·ã€‚</p>
<h3 id="æ³¨é‡Š-comment">æ³¨é‡Š Comment</h3>
<ul>
<li>Serviceï¼Œæè¿°æ¸…æ¥šæœåŠ¡çš„ä½œç”¨</li>
<li>Methodï¼Œæè¿°æ¸…æ¥šæ¥å£çš„åŠŸèƒ½ç‰¹æ€§</li>
<li>Fieldï¼Œæè¿°æ¸…æ¥šå­—æ®µå‡†ç¡®çš„ä¿¡æ¯</li>
</ul>
<h2 id="å®Œæ•´å®ä¾‹">å®Œæ•´å®ä¾‹</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;proto3&#34;</span>;

<span style="color:#ff79c6">package</span> gpmv1;

<span style="color:#ff79c6">option</span> go_package <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/gpm/api/service/gpm/v1;gpmv1&#34;</span>;
<span style="color:#ff79c6">option</span> java_multiple_files <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>;
<span style="color:#ff79c6">option</span> java_package <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;io.vine.services.gpm.v1&#34;</span>;

<span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/gpm/api/types/gpm/v1/gpm.proto&#34;</span>;

<span style="color:#6272a4">// +gen:openapi
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">service</span> GpmService {
  <span style="color:#6272a4">// +gen:summary=æŸ¥è¯¢å•ä¸ªæœåŠ¡
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:get=/api/v1/Service/{name}
</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> GetService(GetServiceReq) <span style="color:#ff79c6">returns</span> (GetServiceRsp);
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Empty</span> {}

<span style="color:#6272a4">// GetService è¯·æ±‚å‚æ•°
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">GetServiceReq</span> {
  <span style="color:#6272a4">// æœåŠ¡åç§°
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}

<span style="color:#6272a4">// GetService è¿”å›ç»“æœ
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">GetServiceRsp</span> {
  gpmv1.Service <span style="color:#8be9fd;font-style:italic">service</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d821b90f925c23ea34f7869438d8aa2a">3.2 - Vine å·¥å…·</h1>
    <div class="lead">åœ¨ <strong>vine</strong> æ¡†æ¶ä¸‹æˆ‘ä»¬æä¾›ä¸€å¥—å‘½ä»¤è¡Œç®¡ç†å·¥å…·ï¼Œç”¨æ¥ç®¡ç†é¡¹ç›®å’Œå®ç°ä¸ <strong>vine</strong> æœåŠ¡çš„äº¤äº’</div>
	<h2 id="å®‰è£…-vine-å·¥å…·">å®‰è£… vine å·¥å…·</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/vine-io/vine/cmd/vine
</code></pre></div><p>éªŒè¯å®‰è£…ç»“æœ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ vine --help
NAME:
   vine - A vine service runtime
        _
 _   __<span style="color:#ff79c6">(</span>_<span style="color:#ff79c6">)</span>___  ___
| | / / / __ <span style="color:#f1fa8c">\/</span> _ <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>| |/ / / / / /  __/
|___/_/_/ /_/<span style="color:#f1fa8c">\_</span>__/

USAGE:
   vine <span style="color:#ff79c6">[</span>global options<span style="color:#ff79c6">]</span> <span style="color:#8be9fd;font-style:italic">command</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">command</span> options<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>arguments...<span style="color:#ff79c6">]</span>

VERSION:
   ...

COMMANDS:
   api      Run the api gateway
   new      Create vine resource template
   init     Initialize a vine project
   build    Build vine project or resource
   run      Start a vine project
   help, h  Shows a list of commands or <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">for</span> one <span style="color:#8be9fd;font-style:italic">command</span>

GLOBAL OPTIONS:
   --help, -h     show <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
   --version, -v  print the version <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
</code></pre></div><p>vine å‘½ä»¤è¡Œå·¥å…·æ”¯æŒå¤šä¸ªå­å‘½ä»¤ï¼ŒåŒ…å«ä»¥ä¸‹åŠŸèƒ½:</p>
<ul>
<li>å¯åŠ¨ç½‘å…³</li>
<li>é¡¹ç›®ç®¡ç† (åˆ›å»ºï¼Œç¼–è¯‘ï¼Œè¿è¡Œ)</li>
</ul>
<h2 id="vine-é¡¹ç›®ç®¡ç†">vine é¡¹ç›®ç®¡ç†</h2>
<p><code>new</code>, <code>init</code>, <code>build</code>, <code>run</code> å¯èƒ½å¸®åŠ©å¼€å‘äººå‘˜å¾ˆå¥½çš„ç®¡ç† vine å®ç°çš„é¡¹ç›®ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨è¯¥å·¥å…·ä¸€æ­¥æ­¥å®ç°å•æœåŠ¡çš„ç®¡ç†</p>
<h3 id="åˆå§‹åŒ–é¡¹ç›®">åˆå§‹åŒ–é¡¹ç›®</h3>
<p>æ–°å»ºç›®å½• <code>$GOPATH/src/example</code> (å»ºè®®å°†é¡¹ç›®ç›®å½•ä¿å­˜åœ¨ GOPATH ä¸‹ã€‚)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkdir <span style="color:#8be9fd;font-style:italic">$GOAPTH</span>/src/example
$ <span style="color:#8be9fd;font-style:italic">cd</span> <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/example
</code></pre></div><p>åœ¨é¡¹ç›®ç›®å½•ä¸‹æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ vine init 
Creating resource  in <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/example

.
â”œâ”€â”€ vine.toml
â”œâ”€â”€ README.md
â”œâ”€â”€ .gitignore
â””â”€â”€ go.mod
</code></pre></div><p>åˆå§‹åŒ–è¯ç”Ÿæˆä»¥ä¸Šæ–‡ä»¶ï¼Œ<code>vine.toml</code> ä¸­åŒ…å«é¡¹ç›®ç›¸å…³çš„ä¿¡æ¯ï¼ŒåŒ…å«è¯¥æ–‡ä»¶çš„ç›®å½•å°±ä¼šè¢«è¯†åˆ«ä¸º <code>vine</code> é¡¹ç›®ã€‚</p>
<h3 id="æ–°å»ºæœåŠ¡">æ–°å»ºæœåŠ¡</h3>
<p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªæœåŠ¡:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ vine new service 
Creating resource example in <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/example

.
â”œâ”€â”€ cmd
â”‚Â Â  â””â”€â”€ main.go
â”œâ”€â”€ pkg
â”‚Â Â  â”œâ”€â”€ runtime
â”‚Â Â  â”‚Â Â  â””â”€â”€ doc.go
â”‚Â Â  â”œâ”€â”€ plugin.go
â”‚Â Â  â”œâ”€â”€ app.go
â”‚Â Â  â”œâ”€â”€ server
â”‚Â Â  â”‚Â Â  â””â”€â”€ example.go
â”‚Â Â  â”œâ”€â”€ service
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ example.go
â”‚Â Â  â”‚Â Â  â””â”€â”€ wire.go
â”‚Â Â  â””â”€â”€ dao
â”‚Â Â      â””â”€â”€ example.go
â”œâ”€â”€ deploy
â”‚Â Â  â”œâ”€â”€ Dockerfile
â”‚Â Â  â”œâ”€â”€ example.ini
â”‚Â Â  â””â”€â”€ example.service
â”œâ”€â”€ proto
â”‚Â Â  â””â”€â”€ service
â”‚Â Â      â””â”€â”€ example
â”‚Â Â          â””â”€â”€ v1
â”‚Â Â              â””â”€â”€ example.proto
â””â”€â”€ vine.toml


download protoc zip packages <span style="color:#ff79c6">(</span>protoc-<span style="color:#8be9fd;font-style:italic">$VERSION</span>-<span style="color:#8be9fd;font-style:italic">$PLATFORM</span>.zip<span style="color:#ff79c6">)</span> and install:

visit https://github.com/protocolbuffers/protobuf/releases

download protobuf <span style="color:#ff79c6">for</span> vine:

<span style="color:#8be9fd;font-style:italic">cd</span> example

install dependencies:
   go get github.com/google/wire/cmd/wire
	go get github.com/gogo/protobuf
	go get github.com/vine-io/vine/cmd/protoc-gen-gogo
	go get github.com/vine-io/vine/cmd/protoc-gen-vine
	go get github.com/vine-io/vine/cmd/protoc-gen-validator
	go get github.com/vine-io/vine/cmd/protoc-gen-deepcopy
	go get github.com/vine-io/vine/cmd/protoc-gen-dao

<span style="color:#8be9fd;font-style:italic">cd</span> example
	vine build example
</code></pre></div><h3 id="å®‰è£…ä¾èµ–åŒ…">å®‰è£…ä¾èµ–åŒ…</h3>
<p>æ ¹æ®æç¤ºï¼Œå®‰è£…ä¾èµ–</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ go get github.com/google/wire/cmd/wire
$ go get github.com/gogo/protobuf
$ go get github.com/vine-io/vine/cmd/protoc-gen-gogo
$ go get github.com/vine-io/vine/cmd/protoc-gen-vine
$ go get github.com/vine-io/vine/cmd/protoc-gen-validator
$ go get github.com/vine-io/vine/cmd/protoc-gen-deepcopy
$ go get github.com/vine-io/vine/cmd/protoc-gen-dao
</code></pre></div><h3 id="ç¼–è¯‘é¡¹ç›®">ç¼–è¯‘é¡¹ç›®</h3>
<p>ç”Ÿæˆ <code>*.pb.go</code> ä»£ç :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ vine build proto --type<span style="color:#ff79c6">=</span>service  --group<span style="color:#ff79c6">=</span>example example
change directory <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src:
protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src --gogo_out<span style="color:#ff79c6">=</span>:. --vine_out<span style="color:#ff79c6">=</span>:. --validator_out<span style="color:#ff79c6">=</span>:. example/proto/service/example/v1/example.proto
</code></pre></div><p>ç¼–è¯‘æˆäºŒè¿›åˆ¶æ–‡ä»¶:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ go mod vendor
go: finding module <span style="color:#ff79c6">for</span> package github.com/google/wire
go: found github.com/google/wire in github.com/google/wire v0.5.0
$ vine build service example
vine build service example
go build -a -installsuffix cgo -ldflags <span style="color:#f1fa8c">&#34;-s -w&#34;</span> cmd/main.go
speed: 17.907776483s
</code></pre></div><h3 id="è¿è¡ŒæœåŠ¡">è¿è¡ŒæœåŠ¡</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./main
2021-06-05 08:47:29  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>vine/service.go:199 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Starting <span style="color:#ff79c6">[</span>service<span style="color:#ff79c6">]</span> go.vine.service.example
2021-06-05 08:47:29  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>vine/service.go:200 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info service <span style="color:#ff79c6">[</span>version<span style="color:#ff79c6">]</span> latest
2021-06-05 08:47:29  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>grpc/grpc.go:878 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Server <span style="color:#ff79c6">[</span>grpc<span style="color:#ff79c6">]</span> Listening on <span style="color:#ff79c6">[</span>::<span style="color:#ff79c6">]</span>:51530
2021-06-05 08:47:29  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>grpc/grpc.go:719 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Registry <span style="color:#ff79c6">[</span>mdns<span style="color:#ff79c6">]</span> Registering node: go.vine.service.example-81ec2a02-c402-42d7-88c8-3de75a68a49b
2021-06-05 08:47:29  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>mdns/mdns_registry.go:266 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info <span style="color:#ff79c6">[</span>mdns<span style="color:#ff79c6">]</span> registry create new service with ip: 192.168.11.167 <span style="color:#ff79c6">for</span>: 192.168.11.167
</code></pre></div><h2 id="vine-é¡¹ç›®ç»“æ„">vine é¡¹ç›®ç»“æ„</h2>
<p>vine é¡¹ç›®é‡‡ç”¨åˆç†çš„ç»“æ„ï¼Œä½¿ä»£ç ç»“æ„å˜å¾—æ¸…æ™°æ˜“ç†è§£ã€‚é¡¹ç›®åˆ†æˆä¸¤ç§ç±»å‹ï¼Œ<code>cluster</code> åˆ†å¸ƒå¼å’Œ <code>single</code> å•æœåŠ¡ã€‚ä¸¤ç§ç±»å‹çš„ç›®å½•ç»“æ„ä¸Šæœ‰ä¸€äº›åŒºåˆ«</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4"># å•æœåŠ¡é¡¹ç›®</span>
.
â”œâ”€â”€ cmd  <span style="color:#6272a4"># æœåŠ¡å…¥å£ç›®å½•, singleç±»å‹æ—¶ç›®å½•ä¸‹åªæœ‰ main.go æ–‡ä»¶ï¼Œcluster ä¸‹åŒ…å«å¤šä¸ªæœåŠ¡åŒåçš„ç›®å½•ï¼Œå†…éƒ¨æœ‰ main.go æ–‡ä»¶</span>
â”‚Â Â  â””â”€â”€ main.go
â”œâ”€â”€ pkg  <span style="color:#6272a4"># pkg æ¯ä¸ªæœåŠ¡æ ¸å¿ƒä»£ç å­˜æ”¾ä¸‹è¯¥ç›®å½•ä¸‹ï¼Œsingleç±»å‹æ—¶ï¼Œç›®å½•ä¸‹ç›´æ¥å­˜æ”¾æœåŠ¡ä»£ç ï¼Œclusterç±»å‹æ—¶ï¼Œç›®å½•è¿˜æœ‰ä¸€å±‚æœåŠ¡åŒåçš„å­ç›®å½•ã€‚</span>
â”‚Â Â  â”œâ”€â”€ runtime  <span style="color:#6272a4"># å„æœåŠ¡å…¬ç”¨çš„å·¥å…·åŒ…å’Œ client ç­‰</span>
â”‚Â Â  â”‚Â Â  â””â”€â”€ doc.go
â”‚Â Â  â”œâ”€â”€ plugin.go <span style="color:#6272a4"># vine æœåŠ¡çš„æ’ä»¶ä¿¡æ¯</span>
â”‚Â Â  â”œâ”€â”€ app.go    <span style="color:#6272a4"># æœåŠ¡å…¥å£ï¼Œåˆå§‹åŒ–çš„ä¸€äº›ä»£ç </span>
â”‚Â Â  â”œâ”€â”€ server    <span style="color:#6272a4"># æä¾› rpc æœåŠ¡ï¼Œåªè¿›è¡Œä¸€äº›æ•°æ®çš„éªŒè¯ï¼Œå…·ä½“å·¥å…·è°ƒç”¨ service</span>
â”‚Â Â  â”‚Â Â  â””â”€â”€ example.go
â”‚Â Â  â”œâ”€â”€ service   <span style="color:#6272a4"># æœåŠ¡ä¸šåŠ¡é€»è¾‘ä»£ç </span>
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ example.go
â”‚Â Â  â”‚Â Â  â””â”€â”€ wire.go <span style="color:#6272a4"># ä½¿ç”¨ github.com/google/wire å®ç° DI</span>
â”‚Â Â  â””â”€â”€ dao       <span style="color:#6272a4"># æ•°æ®åº“äº¤äº’ä»£ç ï¼Œæœ‰ protoc å·¥å…·è‡ªåŠ¨ç”Ÿæˆ</span>
â”‚Â Â      â””â”€â”€ example.go
â”œâ”€â”€ deploy    <span style="color:#6272a4"># é¡¹ç›®ä»£ç éƒ¨ç½²æ—¶éœ€è¦çš„æ–‡ä»¶ï¼Œsingle å’Œ cluster ç»“æ„ä¸Šä¸åŒ</span>
â”‚Â Â  â”œâ”€â”€ Dockerfile <span style="color:#6272a4"># æœåŠ¡ Dockerfile</span>
â”‚Â Â  â”œâ”€â”€ example.ini <span style="color:#6272a4"># æœåŠ¡çš„å¯åŠ¨å‚æ•°é…ç½®æ–‡ä»¶</span>
â”‚Â Â  â””â”€â”€ example.service <span style="color:#6272a4"># CentOS ä¸Šçš„æœåŠ¡è„šæœ¬</span>
â”œâ”€â”€ proto    <span style="color:#6272a4"># å­˜æ”¾ *.proto æ–‡ä»¶åŠå…¶ç”Ÿæˆçš„ *.go ä»£ç ï¼Œåˆ†æˆ apis å’Œ service ç±»å‹</span>
â”‚Â Â  â””â”€â”€ service <span style="color:#6272a4"># æä¾› gRPC æœåŠ¡ï¼Œå¼•ç”¨ proto/apis ä¸‹çš„ message  </span>
â”‚Â Â      â””â”€â”€ example <span style="color:#6272a4"># å’ŒæœåŠ¡åŒåçš„ç›®å½•</span>
â”‚Â Â          â””â”€â”€ v1  <span style="color:#6272a4"># æœåŠ¡æ¥å£ç‰ˆæœ¬ï¼Œé»˜è®¤ä¸º v1</span>
â”‚Â Â              â””â”€â”€ example.proto
â””â”€â”€ vine.toml <span style="color:#6272a4"># vine é¡¹ç›®çš„æè¿°æ–‡ä»¶ï¼Œæœ‰è¯¥æ–‡ä»¶åˆ™è¢«è®¤å®šä¸º vine é¡¹ç›®ã€‚</span>
</code></pre></div><p><code>vine.toml</code> æ–‡ä»¶å†…å®¹è¯´æ˜</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#ff79c6">[</span>package<span style="color:#ff79c6">]</span>   
<span style="color:#8be9fd;font-style:italic">kind</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;single&#34;</span> <span style="color:#6272a4"># é¡¹ç›®ç±»å‹</span>
<span style="color:#8be9fd;font-style:italic">namespace</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;go.vine&#34;</span> <span style="color:#6272a4"># é¡¹ç›®çš„å‘½ä»¤ç©ºé—´</span>

<span style="color:#ff79c6">[</span>pkg<span style="color:#ff79c6">]</span>  <span style="color:#6272a4"># kind = &#34;single&#34; è¯¥é…ç½®å­˜åœ¨ï¼Œæè¿°æœåŠ¡ä¿¡æ¯ã€‚</span>
<span style="color:#8be9fd;font-style:italic">name</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;example&#34;</span> <span style="color:#6272a4"># æœåŠ¡å‘½ä»¤</span>
<span style="color:#8be9fd;font-style:italic">alias</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;go.vine.service.example&#34;</span> <span style="color:#6272a4"># åˆ«å</span>
<span style="color:#8be9fd;font-style:italic">type</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;service&#34;</span>  <span style="color:#6272a4"># æœåŠ¡ç±»å‹,æä¾› gRPC æ¥å£ï¼Œservice, web, gateway</span>
<span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;latest&#34;</span> <span style="color:#6272a4"># æœåŠ¡ç‰ˆæœ¬</span>
<span style="color:#8be9fd;font-style:italic">main</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;cmd/main.go&#34;</span> <span style="color:#6272a4"># main å‡½æ•°è·¯å¾„</span>
<span style="color:#8be9fd;font-style:italic">dir</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;example&#34;</span> <span style="color:#6272a4"># é¡¹ç›®ç›®å½•è·¯å¾„ï¼Œ$GOPATH/src ä¸‹</span>
<span style="color:#8be9fd;font-style:italic">output</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span> <span style="color:#6272a4"># æœåŠ¡ç¼–è¯‘æ—¶ï¼Œè¾“å…¥è·¯å¾„ go build -o $output main.go</span>
<span style="color:#8be9fd;font-style:italic">flags</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">[</span>   <span style="color:#6272a4"># æœåŠ¡ç¼–è¯‘æ—¶çš„é¢å¤–å‚æ•°ï¼Œæ”¯æŒå¤šä¸ªæ ¼å¼ï¼Œ&#34;KEY=value&#34;, &#34;-key&#34;, &#34;key=${shell command}&#34;  </span>
	<span style="color:#f1fa8c">&#34;-a&#34;</span>, <span style="color:#f1fa8c">&#34;-installsuffix&#34;</span>, <span style="color:#f1fa8c">&#34;cgo&#34;</span>, <span style="color:#f1fa8c">&#34;-ldflags \&#34;-s -w\&#34;&#34;</span>,
<span style="color:#ff79c6">]</span>

<span style="color:#ff79c6">[[</span>mod<span style="color:#ff79c6">]]</span>  <span style="color:#6272a4"># kind = &#34;cluster&#34; è¯¥é…ç½®å­˜åœ¨ï¼Œæè¿°æœåŠ¡ä¿¡æ¯ã€‚æ¯ä¸ª mod è¡¨ç¤ºä¸€ä¸ªæœåŠ¡</span>
<span style="color:#8be9fd;font-style:italic">name</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;apiserver&#34;</span>
<span style="color:#8be9fd;font-style:italic">alias</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;com.howlink.service.apiserver&#34;</span>
<span style="color:#8be9fd;font-style:italic">type</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;service&#34;</span>
<span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;latest&#34;</span>
<span style="color:#8be9fd;font-style:italic">main</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;cmd/apiserver/main.go&#34;</span>
<span style="color:#8be9fd;font-style:italic">dir</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;dr/apiserver&#34;</span>
<span style="color:#8be9fd;font-style:italic">output</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;_output/apiserver&#34;</span>
<span style="color:#8be9fd;font-style:italic">flags</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">[</span>
	<span style="color:#f1fa8c">&#34;GOOS=linux&#34;</span>, <span style="color:#f1fa8c">&#34;GOARCH=amd64&#34;</span>, <span style="color:#f1fa8c">&#34;-a&#34;</span>, <span style="color:#f1fa8c">&#34;-installsuffix&#34;</span>, <span style="color:#f1fa8c">&#34;cgo&#34;</span>, <span style="color:#f1fa8c">&#34;-ldflags \&#34;-s -w\&#34;&#34;</span>,
<span style="color:#ff79c6">]</span>

<span style="color:#ff79c6">[[</span>proto<span style="color:#ff79c6">]]</span> <span style="color:#6272a4"># .proto æ–‡ä»¶æè¿°ä¿¡æ¯</span>
<span style="color:#8be9fd;font-style:italic">name</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;example&#34;</span> <span style="color:#6272a4"># æ–‡ä»¶å</span>
<span style="color:#8be9fd;font-style:italic">pb</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;example/proto/service/example/v1/example.proto&#34;</span> <span style="color:#6272a4"># è·¯å¾„</span>
<span style="color:#8be9fd;font-style:italic">type</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;service&#34;</span> <span style="color:#6272a4"># ç±»å‹ï¼Œservice å’Œ api</span>
<span style="color:#8be9fd;font-style:italic">group</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;example&#34;</span> <span style="color:#6272a4"># ç»„ï¼ŒåŒä¸ª group ä¸‹ä¸åŒæœ‰åŒåçš„ proto æ–‡ä»¶</span>
<span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;v1&#34;</span> <span style="color:#6272a4"># ç‰ˆæœ¬ï¼Œé»˜è®¤ä¸º v1</span>
<span style="color:#8be9fd;font-style:italic">plugins</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#34;gogo&#34;</span>, <span style="color:#f1fa8c">&#34;vine&#34;</span>, <span style="color:#f1fa8c">&#34;validator&#34;</span><span style="color:#ff79c6">]</span> <span style="color:#6272a4"># ç”Ÿæˆ .go ä»£ç æ—¶å¯ç”¨çš„ protoc æ’ä»¶</span>
</code></pre></div><h2 id="vine-å‘½ä»¤è§£æ">vine å‘½ä»¤è§£æ</h2>
<p><code>vine</code> å·¥å…·æ”¯æŒä»¥ä¸‹å­å‘½ä»¤:</p>
<ul>
<li>api      å¯åŠ¨ç½‘å…³æœåŠ¡</li>
<li>new      åˆ›å»ºæœåŠ¡æˆ–è€…protoæ–‡ä»¶</li>
<li>init     åˆå§‹åŒ–é¡¹ç›®ï¼Œå°†ä¸€ä¸ªç›®å½•è½¬åŒ–ä¸ºé¡¹ç›®ç›®å½•</li>
<li>build    ç¼–è¯‘æœåŠ¡ã€ç”Ÿæˆ .go æ–‡ä»¶</li>
<li>run      è¿è¡ŒæœåŠ¡</li>
</ul>
<h3 id="init-å­å‘½ä»¤">init å­å‘½ä»¤</h3>
<p><code>vine init</code> æ”¯æŒä»¥ä¸‹å‚æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ vine init --help    
NAME:
   vine init - Initialize a vine project

USAGE:
   vine init <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">command</span> options<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>arguments...<span style="color:#ff79c6">]</span>

OPTIONS:
   --namespace string  Namespace <span style="color:#ff79c6">for</span> the project e.g com.example <span style="color:#ff79c6">(</span>default: <span style="color:#f1fa8c">&#34;go.vine&#34;</span><span style="color:#ff79c6">)</span> <span style="color:#6272a4"># æŒ‡å®šé¡¹ç›®çš„å‘½ä»¤ç©ºé—´</span>
   --cluster           create cluster package. <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span> <span style="color:#6272a4"># ç¡®è®¤é¡¹ç›®ç±»å‹ï¼Œé»˜è®¤ä¸ºå•æœåŠ¡</span>
   --help, -h          show <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
</code></pre></div><p>vine é¡¹ç›®æ”¯æŒ cluster (å¤šæœåŠ¡åˆ†å¸ƒå¼)ã€single (å•æœåŠ¡ï¼Œé»˜è®¤) ä¸¤ç§ç±»å‹ã€‚</p>
<h3 id="new-å­å‘½ä»¤">new å­å‘½ä»¤</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ NAME:
   vine new - Create vine resource template

USAGE:
   vine new <span style="color:#8be9fd;font-style:italic">command</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">command</span> options<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>arguments...<span style="color:#ff79c6">]</span>

COMMANDS:
   service  Create a service template  <span style="color:#6272a4"># åˆ›å»ºä¸€ä¸ª gRPC æœåŠ¡</span>
   gateway  Create a gateway template  <span style="color:#6272a4"># åˆ›å»ºä¸€ä¸ªç½‘å…³æœåŠ¡</span>
   web      Create a web template      <span style="color:#6272a4"># åˆ›å»ºä¸€ä¸ª web æœåŠ¡</span>
   proto    Create a proto file        <span style="color:#6272a4"># åˆ›å»º proto æ–‡ä»¶</span>
   help, h  Shows a list of commands or <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">for</span> one <span style="color:#8be9fd;font-style:italic">command</span>

OPTIONS:
   --help, -h     show <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
   --version, -v  print the version <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
   
</code></pre></div><h3 id="build-å­å‘½ä»¤">build å­å‘½ä»¤</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ vine build --help
NAME:
   vine build - Build vine project or resource

USAGE:
   vine build <span style="color:#8be9fd;font-style:italic">command</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">command</span> options<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>arguments...<span style="color:#ff79c6">]</span>

COMMANDS:
   proto    Generate protobuf file  <span style="color:#6272a4"># ç”Ÿæˆ proto å¯¹åº”çš„goä»£ç </span>
   service  Build vine project      <span style="color:#6272a4"># ç¼–è¯‘æœåŠ¡</span>
   help, h  Shows a list of commands or <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">for</span> one <span style="color:#8be9fd;font-style:italic">command</span>

OPTIONS:
   --help, -h     show <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
   --version, -v  print the version <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>

</code></pre></div><h3 id="run-å­å‘½ä»¤">run å­å‘½ä»¤</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ vine run --help          
NAME:
   vine run - Start a vine project

USAGE:
   vine run <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">command</span> options<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>arguments...<span style="color:#ff79c6">]</span>

OPTIONS:
   --auto-restart   <span style="color:#6272a4"># æ˜¯å¦åœ¨ç›‘å¬åˆ°æ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨é‡å¯ï¼Œé»˜è®¤ä¸º true</span>
   --watch strings  <span style="color:#6272a4"># ç›‘å¬æŒ‡å®šç›®å½•çš„æ–‡ä»¶å†…å®¹å˜åŒ–</span>
   --help, -h       show <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>

</code></pre></div><p>// TODO</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-826345e38af594c61cf85a8e0dd09f73">3.3 - protoc-gen-vine</h1>
    <div class="lead"><em>OpenAPI</em> é€šè¿‡ <code>protoc-gen-vine</code> é›†æˆ openapi3.0ã€‚</div>
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p><em>Vine</em> å†…éƒ¨é›†æˆ openapi3.0ï¼Œ<code>protoc-gen-vine</code> é€šè¿‡è¯†åˆ« protobuf æ–‡ä»¶çš„æ³¨é‡Šç”Ÿæˆ Openapi3.0 æ–‡æ¡£ã€‚ç±»ä¼¼ <a href="https://vine-io.github.io/vine/docs/tools/validate/">Validator</a>ã€‚</p>
<h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<h3 id="1å…ˆç¼–å†™-helloworldproto-æ–‡ä»¶">1.å…ˆç¼–å†™ helloworld.proto æ–‡ä»¶</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;proto3&#34;</span>;

<span style="color:#ff79c6">package</span> testdata;
<span style="color:#ff79c6">option</span> go_package <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/testdata/proto;testdata&#34;</span>;

<span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/proto/api/api.proto&#34;</span>;

<span style="color:#6272a4">// +gen:openapi
</span><span style="color:#6272a4">// +gen:term_name=vine
</span><span style="color:#6272a4">// +gen:term_email=598223084@qq.com
</span><span style="color:#6272a4">// +gen:contact_name=vine
</span><span style="color:#6272a4">// +gen:contact_email=598223084@qq.com
</span><span style="color:#6272a4">// +gen:license_name=Apache2.0
</span><span style="color:#6272a4">// +gen:license_url=https://www.apache.org/licenses/LICENSE-2.0
</span><span style="color:#6272a4">// +gen:external_doc_desc=123
</span><span style="color:#6272a4">// +gen:external_doc_url=http://www.baidu.com
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">service</span> Helloworld {
  <span style="color:#6272a4">// +gen:get=/api/v1/call
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:body=*
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:summary=callllllllll
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:security=bearer, apiKeys, basic
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:result=[200]
</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Call(HelloWorldRequest) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {};
  <span style="color:#6272a4">// +gen:post=/api/v1/event
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:body=*
</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Mul(api.Event) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {};
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">HelloWorldRequest</span> {
  <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
  <span style="color:#8be9fd">int32</span> age <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}


<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">HelloWorldResponse</span> {
  <span style="color:#8be9fd">int32</span> code <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
  <span style="color:#8be9fd">string</span> reply <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}


</code></pre></div><h3 id="2å®‰è£…-protoc-gen-vine">2.å®‰è£… protoc-gen-vine</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/vine-io/vine/cmd/protoc-gen-vine
</code></pre></div><h3 id="3ç”Ÿæˆ-swagger-æ–‡æ¡£">3.ç”Ÿæˆ swagger æ–‡æ¡£</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/github.com/gogo/googleapis --gogofaster_out<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">plugins</span><span style="color:#ff79c6">=</span>grpc:. --vine_out<span style="color:#ff79c6">=</span>:. proto/helloworld.proto
</code></pre></div><p>æ‰§è¡Œå®Œæˆåç”Ÿæˆä»¥ä¸‹ä»£ç :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#6272a4">// Swagger OpenAPI 3.0 for Helloworld service
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">NewHelloworldOpenAPI</span>() <span style="color:#ff79c6">*</span>registry.OpenAPI {
    <span style="color:#6272a4">// ...
</span><span style="color:#6272a4"></span>}
</code></pre></div><h3 id="4éªŒè¯">4.éªŒè¯</h3>
<p>ç”Ÿæˆçš„ Openapi3.0 æ–‡æ¡£ä¼šè‡ªåŠ¨æ³¨å†Œåˆ° <code>Registry</code> ç»„ä»¶ï¼Œå½“å¯åŠ¨ <code>vine api</code> æ—¶æ·»åŠ  <code>--enable-openapi</code> å‚æ•°å¯ä»¥å¯åŠ¨ OpenAPI3.0 åŠŸèƒ½:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">vine api <span style="color:#ff79c6">--</span>handler=rpc <span style="color:#ff79c6">--</span>enable<span style="color:#ff79c6">-</span>openapi
</code></pre></div><p>å¯åŠ¨ç”¨è®¿é—® url <code>http://127.0.0.1:8080/openapi-ui/</code> æ•ˆæœå¦‚ä¸‹:</p>
<p><img src="2021-01-25-18-58-50.png" alt="swagger-openapi"></p>
<p><em>Vine</em> çš„ OpenAPI æ”¯æŒ swagger é£æ ¼å’Œ redoc é£æ ¼ï¼Œåˆ‡æ¢åˆ° redoc åˆ™ä½¿ç”¨è·¯å¾„ <code>http://127.0.0.1:8080/openapi-ui/?style=redoc</code>ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="2021-01-25-19-04-57.png" alt="redoc-openapi"></p>
<h2 id="è¯­æ³•è§£æ">è¯­æ³•è§£æ</h2>
<p><code>protoc-gen-vine</code> é€šè¿‡è§£æ <code>protobuf</code> ä¸­çš„æ³¨é‡Šæ¥ç”Ÿæˆ OpenAPI3.0 æ–‡æ¡£ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +gen:openapi
</span><span style="color:#6272a4">// +gen:term_name=vine
</span><span style="color:#6272a4">// +gen:term_email=598223084@qq.com
</span><span style="color:#6272a4">// +gen:contact_name=vine
</span><span style="color:#6272a4">// +gen:contact_email=598223084@qq.com
</span><span style="color:#6272a4">// +gen:license_name=Apache2.0
</span><span style="color:#6272a4">// +gen:license_url=https://www.apache.org/licenses/LICENSE-2.0
</span><span style="color:#6272a4">// +gen:external_doc_desc=123
</span><span style="color:#6272a4">// +gen:external_doc_url=http://www.baidu.com
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">service</span> Helloworld {
  <span style="color:#6272a4">// +gen:get=/api/v1/call
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:body=*
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:summary=callllllllll
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:security=bearer, apiKeys, basic
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:result=[200]
</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Call(HelloWorldRequest) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {};
  <span style="color:#6272a4">// +gen:post=/api/v1/event
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:body=*
</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Mul(api.Event) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {};
}
</code></pre></div><blockquote>
<p>æ³¨: <code>protoc-gen-vine</code> å’Œ <code>protoc-gen-validator</code> ä¸­å­˜åœ¨å¤§é‡é‡å¤æ³¨é‡Šï¼Œè¿™æ ·è®¾è®¡çš„åŸå› æ˜¯é€šè¿‡ä¸€å¥—çš„æ³¨é‡Šè§„åˆ™ç›´æ¥ç”Ÿæˆæ›´å¤šçš„ä»£ç ï¼Œè¾ƒå°‘éä¸šåŠ¡ä»£ç çš„ç¼–å†™ã€‚</p>
</blockquote>
<h3 id="è¯­æ³•è§„åˆ™">è¯­æ³•è§„åˆ™</h3>
<p>æœ‰æ•ˆçš„æ³¨é‡Šæœ‰ä»¥ä¸‹çš„è§„åˆ™:</p>
<ul>
<li>æ³¨é‡Šå¿…é¡»ä»¥ <code>+gen</code> ä½œä¸ºå¼€å¤´</li>
<li>æ³¨é‡Šçš„å†…å®¹å¿…é¡»ç´§è´´å¯¹åº”çš„å­—æ®µï¼Œä¸­é—´ä¸èƒ½æœ‰ç©ºè¡Œ</li>
<li>æ”¯æŒå¤šè¡Œæ³¨é‡Šï¼Œä¹Ÿå¯ä»¥å°†å¤šè¡Œåˆå¹¶æˆä¸€è¡Œï¼Œå¹¶ç”¨ <code>;</code> ä½œä¸ºåˆ†éš”ç¬¦</li>
</ul>
<blockquote>
<p>æ³¨ï¼š// é£æ ¼çš„æ³¨é‡Šä¼šè¢«è¯†åˆ«ä¸º openapi3.0 ä¸­çš„ Description ä¿¡æ¯ã€‚</p>
</blockquote>
<h3 id="ç±»å‹æ”¯æŒ">ç±»å‹æ”¯æŒ</h3>
<p><code>service</code> ç±»å‹è§„åˆ™:</p>
<ul>
<li>openapiï¼ˆå¿…å¡«ï¼‰: ç”Ÿæˆ openapi çš„æ ‡è¯†ï¼Œå…·æœ‰æ­¤æ ‡è¯†çš„ Service æ‰ä¼šç”Ÿæˆæ–‡æ¡£</li>
<li>term_url: é¡¹ç›®å›¢é˜Ÿçš„ url</li>
<li>contact_name: é¡¹ç›®ä½œè€…åç§°ï¼Œå’Œ contact_email é…åˆä½¿ç”¨</li>
<li>contact_email: é¡¹ç›®ä½œè€…é‚®ç®±ï¼Œå’Œ contact_name é…åˆä½¿ç”¨</li>
<li>license_name: é¡¹ç›®éµå¾ªçš„è®¸å¯ç±»å‹ï¼Œå’Œ license_url é…åˆä½¿ç”¨</li>
<li>license_url: é¡¹ç›®éµå¾ªçš„è®¸å¯ urlï¼Œå’Œ license_nameé…åˆä½¿ç”¨</li>
<li>external_doc_desc: æ‰©å±•æ–‡æ¡£æè¿°ï¼Œå’Œ external_doc_url é…åˆä½¿ç”¨</li>
<li>external_doc_url: æ‰©å±•æ–‡æ¡£ urlï¼Œå’Œ external_doc_url é…åˆä½¿ç”¨</li>
<li>version: æ–‡æ¡£ç‰ˆæœ¬ï¼Œå¦‚ 1.0.0</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +gen:ignore
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">P</span> {
  <span style="color:#6272a4">// +gen:openapi
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:term_name=vine
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:term_email=598223084@qq.com
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:contact_name=vine
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:contact_email=598223084@qq.com
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:license_name=Apache2.0
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:license_url=https://www.apache.org/licenses/LICENSE-2.0
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:external_doc_desc=123
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:external_doc_url=http://www.example.com
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd;font-style:italic">service</span> HelloWorld {

  }
}
</code></pre></div><p><code>rpc</code> æ”¯æŒçš„è§„åˆ™:</p>
<ul>
<li>get | post | put | patch | deleteï¼ˆå¿…å¡«ï¼‰: ç”Ÿæˆå¯¹åº”çš„ http methodï¼Œåé¢ç´§æ¥è·¯ç”±ä¿¡æ¯ï¼Œå¦‚ // +gen:get=/api/v1/call</li>
<li>body: æŒ‡å®š Request message çš„åç§°ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ <code>*</code></li>
<li>summary: æ¥å£çš„æ‘˜è¦ä¿¡æ¯</li>
<li>security: è·¯ç”±æ”¯æŒçš„ Authorizationã€‚æ”¯æŒ beaer, apiKeys å’Œ basic</li>
<li>result: http response codeã€‚æ”¯æŒ 200ï¼Œ400ï¼Œ401ï¼Œ403ï¼Œ404ï¼Œ405ï¼Œ408ï¼Œ409ï¼Œ500ï¼Œ502ï¼Œ503ï¼Œ504</li>
</ul>
<blockquote>
<p>æ³¨: ä½¿ç”¨ +gen:security æ—¶ï¼Œresult ä¼šç›´æ¥æ·»åŠ  401ï¼Œ403 çš„å†…å®¹</p>
</blockquote>
<p><code>message</code> ä½œä¸ºå†…åµŒå­—æ®µæ—¶æ”¯æŒçš„è§„åˆ™:</p>
<ul>
<li>required: åˆ¤æ–­è¯¥å­—æ®µæ˜¯å¦ä¸º nilã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">service</span> Helloworld {
  <span style="color:#6272a4">// +gen:get=/api/v1/call
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:body=*
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:summary=callllllllll
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:security=bearer, apiKeys, basic
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:result=[200]
</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Call(HelloWorldRequest) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {};
  <span style="color:#6272a4">// +gen:post=/api/v1/{name}/{id}
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:body=*
</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Mul(api.Event) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {};
}
</code></pre></div><p><code>message</code> å­—æ®µé€šç”¨çš„è§„åˆ™ï¼š</p>
<ul>
<li>required: æŒ‡å®šå­—æ®µä¸ºå¿…å¡«</li>
<li>default: æŒ‡å®šå­—æ®µçš„é»˜è®¤å€¼</li>
<li>example: ç»™å®šå­—æ®µçš„å®ä¾‹</li>
<li>in: å­—æ®µåªèƒ½åœ¨å‡ ä¸ªå€¼ä¸­é€‰æ‹©</li>
<li>enum: åŒ in</li>
<li>ro: å­—æ®µä¸ºåªè¯»</li>
<li>wo: å­—æ®µä¸ºåªå†™ï¼Œå’Œ password é…åˆä½¿ç”¨</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">HelloWorldRequest</span> {
  <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:default=&#34;hello&#34;
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:example=&#34;hello&#34;
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:ro
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:rw
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
  <span style="color:#6272a4">// +gen:enum=[1,2,3]
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">int32</span> age <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}
</code></pre></div><p><code>string</code> ç±»å‹æ”¯æŒçš„è§„åˆ™</p>
<ul>
<li>min_len: æŒ‡å®šå­—æ®µçš„æœ€å°é•¿åº¦</li>
<li>max_len: æŒ‡å®šå­—æ®µçš„æœ€å¤§é•¿åº¦</li>
<li>email: é‚®ç®±åœ°å€æ ¼å¼</li>
<li>date: æ—¥æœŸæ ¼å¼<a href="https://tools.ietf.org/html/rfc3339#section-5.6">RFC 3339, section 5.6</a>ï¼Œå¦‚ 2017-07-21</li>
<li>date-time: æ—¥æœŸåŠ æ—¶é—´æ ¼å¼<a href="https://tools.ietf.org/html/rfc3339#section-5.6">RFC 3339, section 5.6</a>ï¼Œå¦‚ 2017-07-21T17:32:28Z</li>
<li>password: å¯†ç æ ¼å¼</li>
<li>byte: å­—èŠ‚æ ¼å¼</li>
<li>binary: äºŒè¿›åˆ¶æ ¼å¼ï¼Œä¸Šä¼ æ–‡ä»¶ä½¿ç”¨</li>
<li>ip: ip åœ°å€æ ¼å¼</li>
<li>ipv4: ipv4 æ ¼å¼</li>
<li>ipv6: ipv6 æ ¼å¼</li>
<li>uuid: uuid v4 æ ¼å¼</li>
<li>uri: uri æ ¼å¼</li>
<li>hostname: ä¸»æœºå</li>
<li>pattern: æ­£åˆ™è¡¨è¾¾å¼</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">S</span> {
    <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:default=&#34;hello&#34;
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:in=[&#34;1&#34;, &#34;2&#34;, &#34;3&#34;]
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:enum=[&#34;a&#34;, &#34;b&#34;, &#34;c&#34;]
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_len=3
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_max=4
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:pattern=`\d+(\w+){3,5}`
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:password
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:email
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:ip
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:ipv4
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:ipv6
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:date
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:date-time
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:bytes
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:binary
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:hostname
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:uuid
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:uri
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">string</span> m <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div><blockquote>
<p>æ³¨: string pattern æœ€å¥½å•ç‹¬ä¸€è¡Œï¼Œä»¥å…å’Œå…¶ä»–è§„åˆ™å†²çª</p>
</blockquote>
<p>æ•°å­—ç±»å‹çš„æ”¯æŒï¼ŒåŒ…å« int32, int64, fixed32, fix64, float, double</p>
<ul>
<li>lt: æŒ‡å®šå­—æ®µå°äºæŒ‡å®šå€¼</li>
<li>lte: æŒ‡å®šå­—æ®µçš„å°äºç­‰äºæŒ‡å®šå€¼</li>
<li>gt: æŒ‡å®šå­—æ®µå¤§äºæŒ‡å®šå€¼</li>
<li>gte: æŒ‡å®šå­—æ®µå¤§äºç­‰äºæŒ‡å®šå€¼</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">S</span> {
    <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">float</span> a <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;

    <span style="color:#6272a4">// +gen:default=3.14
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">double</span> pi <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>

    <span style="color:#6272a4">// +gen:in=[1,2,3]
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:enum=[2,3]
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:not_in=[4,5]
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int32</span> b <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;

    <span style="color:#6272a4">// +gen:ge=3
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +ggen:gte=4
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:lte=9
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:lt=10
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int64</span> c <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0f3139f04142acc9dea586846b8c4063">3.4 - protoc-gen-validator</h1>
    <div class="lead"><em>Validate</em> é€šè¿‡ <code>protoc-gen-validator</code> ç”Ÿæˆ <code>Validate()</code> æ¥å£ï¼Œå‡å°‘éä¸šåŠ¡ä»£ç çš„ç¼–å†™ã€‚</div>
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p>æœåŠ¡è¿è¡Œä¸­ï¼Œç»å¸¸éœ€è¦å’Œå…¶ä»–å®¢æˆ·ç«¯è¿›è¡Œæ•°æ®äº¤äº’ï¼ŒéªŒè¯æ¥è‡ªå®¢æˆ·ç«¯çš„æ•°æ®çš„åˆæ³•æ€§ã€‚ä½†æ˜¯è¿™äº›ä»£ç ç¼–å†™èµ·æ¥æ¯ç‡¥ä¸”æ˜“é”™ï¼Œ<strong>vine</strong> æä¾› <code>protoc-gen-validator</code> å·¥å…·æ¥è‡ªåŠ¨ç”Ÿæˆç»“æ„ä½“ <code>Validate()</code> æ–¹æ³•ï¼Œå‡å°‘ä¸€éƒ¨åˆ†ä»£ç çš„æ‰‹åŠ¨ç¼–å†™ã€‚</p>
<h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<h3 id="1å…ˆç¼–å†™-validatorproto-æ–‡ä»¶">1.å…ˆç¼–å†™ validator.proto æ–‡ä»¶</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Person</span> {
  <span style="color:#6272a4">// +gen:min_len=4
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:max_len=10
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;

  <span style="color:#6272a4">// +gen:required;gt=10;lt=100
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">int32</span> age <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;

  <span style="color:#6272a4">// +gen:required;min_bytes=3;max_bytes=4;
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">bytes</span> any <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;

  <span style="color:#6272a4">// +gen:email
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> email <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;
}
</code></pre></div><h3 id="2å®‰è£…-protoc-gen-validator">2.å®‰è£… protoc-gen-validator</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/vine-io/vine/cmd/protoc-gen-validator
</code></pre></div><h3 id="3ç”Ÿæˆ-validate-æ–¹æ³•">3.ç”Ÿæˆ Validate() æ–¹æ³•</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src --gogo_out<span style="color:#ff79c6">=</span>:.  --validator_out<span style="color:#ff79c6">=</span>:. proto/validator.proto
</code></pre></div><p>æ‰§è¡Œå®Œæˆåç”Ÿæˆä»¥ä¸‹ä»£ç :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">Valdiate</span>() <span style="color:#8be9fd">error</span> {
    <span style="color:#ff79c6">return</span> m.<span style="color:#50fa7b">ValidateE</span>(<span style="color:#f1fa8c">&#34;&#34;</span>)
}

<span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">ValidateE</span>() <span style="color:#8be9fd">error</span> {
	errs <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>([]<span style="color:#8be9fd">error</span>, <span style="color:#bd93f9">0</span>)
	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(m.Name) <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span> {
		<span style="color:#ff79c6">if</span> !(<span style="color:#8be9fd;font-style:italic">len</span>(m.Name) <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">4</span>) {
			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;name&#39; length must less than &#39;4&#39;&#34;</span>))
		}
		<span style="color:#ff79c6">if</span> !(<span style="color:#8be9fd;font-style:italic">len</span>(m.Name) <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">10</span>) {
			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;name&#39; length must great than &#39;10&#39;&#34;</span>))
		}
	}
	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">int64</span>(m.Age) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
		errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;age&#39; is required&#34;</span>))
	} <span style="color:#ff79c6">else</span> {
		<span style="color:#ff79c6">if</span> !(m.Age &lt; <span style="color:#bd93f9">100</span>) {
			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;age&#39; must less than &#39;100&#39;&#34;</span>))
		}
		<span style="color:#ff79c6">if</span> !(m.Age &gt; <span style="color:#bd93f9">10</span>) {
			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;age&#39; must great than &#39;10&#39;&#34;</span>))
		}
	}
	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(m.Any) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
		errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;any&#39; is required&#34;</span>))
	} <span style="color:#ff79c6">else</span> {
		<span style="color:#ff79c6">if</span> !(<span style="color:#8be9fd;font-style:italic">len</span>(m.Any) <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">3</span>) {
			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;any&#39; length must less than &#39;3&#39;&#34;</span>))
		}
		<span style="color:#ff79c6">if</span> !(<span style="color:#8be9fd;font-style:italic">len</span>(m.Any) <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">4</span>) {
			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;any&#39; length must great than &#39;4&#39;&#34;</span>))
		}
	}
	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(m.Email) <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span> {
		<span style="color:#ff79c6">if</span> !is.<span style="color:#50fa7b">Email</span>(m.Email) {
			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;email&#39; is not a valid email&#34;</span>))
		}
	}
	<span style="color:#ff79c6">return</span> is.<span style="color:#50fa7b">MargeErr</span>(errs<span style="color:#ff79c6">...</span>)
}
</code></pre></div><h3 id="4éªŒè¯">4.éªŒè¯</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
 	p <span style="color:#ff79c6">:=</span> pb.Person{}
	p.Age = <span style="color:#bd93f9">1</span>
	p.Email = <span style="color:#f1fa8c">&#34;11&#34;</span>
 	err <span style="color:#ff79c6">:=</span> p.<span style="color:#50fa7b">Validate</span>()
 	log.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;%v\n&#34;</span>, err)
}
<span style="color:#6272a4">// output:  field &#39;age&#39; must great than &#39;10&#39;;field &#39;any&#39; is required;field &#39;email&#39; is not a valid email
</span></code></pre></div><p>å¤šä¸ªé”™è¯¯æ—¶ï¼Œä½¿ç”¨ <code>;</code> éš”å¼€</p>
<h2 id="è¯­æ³•è§£æ">è¯­æ³•è§£æ</h2>
<p><code>protoc-gen-validator</code> é€šè¿‡è§£æ <code>protobuf</code> ä¸­çš„æ³¨é‡Šæ¥ç”Ÿæˆ <code>Validate()</code> è§„åˆ™ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +gen:ignore
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Struct</span> {
    <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">string</span> field1 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
    
    <span style="color:#6272a4">// +gen:required;email
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_len=3
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">string</span> field2 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}
</code></pre></div><h3 id="è¯­æ³•è§„åˆ™">è¯­æ³•è§„åˆ™</h3>
<p>æœ‰æ•ˆçš„æ³¨é‡Šæœ‰ä»¥ä¸‹çš„è§„åˆ™:</p>
<ul>
<li>æ³¨é‡Šå¿…é¡»ä»¥ <code>+gen</code> ä½œä¸ºå¼€å¤´</li>
<li>æ³¨é‡Šçš„å†…å®¹å¿…é¡»ç´§è´´å¯¹åº”çš„å­—æ®µï¼Œä¸­é—´ä¸èƒ½æœ‰ç©ºè¡Œ</li>
<li>æ”¯æŒå¤šè¡Œæ³¨é‡Šï¼Œä¹Ÿå¯ä»¥å°†å¤šè¡Œåˆå¹¶æˆä¸€è¡Œï¼Œå¹¶ç”¨ <code>;</code> ä½œä¸ºåˆ†éš”ç¬¦</li>
</ul>
<h3 id="ç±»å‹æ”¯æŒ">ç±»å‹æ”¯æŒ</h3>
<p><code>message</code> ç±»å‹è§„åˆ™:</p>
<ul>
<li>ignore: å¿½ç•¥è¯¥ message ï¼Œä¸ç”Ÿæˆ <code>Validate()</code> æ–¹æ³•</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +gen:ignore
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">P</span> {

}
</code></pre></div><p><code>message</code> ä½œä¸ºå†…åµŒå­—æ®µæ—¶æ”¯æŒçš„è§„åˆ™:</p>
<ul>
<li>required: åˆ¤æ–­è¯¥å­—æ®µæ˜¯å¦ä¸º nilã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">P</span> {
    <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>    Sub sub <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Sub</span> {

}
</code></pre></div><blockquote>
<p>æ³¨: åœ¨å¼•ç”¨å¤–éƒ¨çš„ message æ—¶ï¼Œè¯·ç¡®è®¤ message å­˜åœ¨ Validate() æ–¹æ³•</p>
</blockquote>
<p><code>string</code> ç±»å‹æ”¯æŒçš„è§„åˆ™</p>
<ul>
<li>required: åˆ¤æ–­æ˜¯å¦ä¸ºç©º</li>
<li>default: å­—æ®µä¸ºç©ºæ—¶æŒ‡å®šçš„é»˜è®¤å€¼ï¼Œ(ä¸å¯ç”¨ required åŒæ—¶ä½¿ç”¨)</li>
<li>in, enum: åˆ¤æ–­å­—æ®µçš„å€¼æ˜¯å¦å­˜åœ¨äºæŒ‡å®šçš„åˆ—è¡¨ä¸­</li>
<li>not_in: åˆ¤æ–­å­—æ®µçš„å€¼æ˜¯å¦åœ¨æŒ‡å®šçš„åˆ—è¡¨ä¹‹å¤–</li>
<li>min_len: æŒ‡å®šå­—æ®µçš„æœ€å°é•¿åº¦</li>
<li>max_len: æŒ‡å®šå­—æ®µçš„æœ€å¤§é•¿åº¦</li>
<li>prefix: åˆ¤æ–­å­—æ®µæ˜¯å¦ä»¥ç»™å®šçš„å€¼ä¸ºå¼€å¤´</li>
<li>suffix: åˆ¤æ–­å­—æ®µæ˜¯å¦ä»¥ç»™å®šçš„å€¼ä¸ºç»“å°¾</li>
<li>contains: åˆ¤æ–­å­—æ®µæ˜¯å¦åŒ…å«ç»™å®šçš„å€¼</li>
<li>pattern: åˆ¤æ–­è¯¥å­—æ®µæ˜¯å¦ä¸ºæœ‰æ•ˆçš„æ­£åˆ™è¡¨è¾¾å¼</li>
<li>number: åˆ¤æ–­è¯¥å­—æ®µæ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—</li>
<li>email: åˆ¤æ–­è¯¥å­—æ®µæ˜¯å¦ä¸ºæœ‰æ•ˆçš„é‚®ç®±åœ°å€</li>
<li>ip: åˆ¤æ–­è¯¥å­—æ®µæ˜¯å¦ä¸ºæœ‰æ•ˆçš„ ip åœ°å€</li>
<li>ipv4: åˆ¤æ–­è¯¥å­—æ®µæ˜¯å¦ä¸ºæœ‰æ•ˆçš„ ipv4</li>
<li>ipv6: åˆ¤æ–­è¯¥å­—æ®µæ˜¯å¦ä¸ºæœ‰æ•ˆçš„ ipv6</li>
<li>crontab: åˆ¤æ–­è¯¥å­—æ®µæ˜¯å¦ä¸ºæœ‰æ•ˆçš„ crontab è¡¨è¾¾å¼</li>
<li>uuid: åˆ¤æ–­è¯¥å­—æ®µæ˜¯å¦ä¸ºæœ‰æ•ˆçš„ uuid v4</li>
<li>uri: åˆ¤æ–­è¯¥å­—æ®µæ˜¯å¦ä¸ºæœ‰æ•ˆçš„ uri</li>
<li>domain: åˆ¤æ–­è¯¥å­—æ®µæ˜¯å¦ä¸ºæœ‰æ•ˆçš„åŸŸå</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">S</span> {
    <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:default=&#34;hello&#34;
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:in=[&#34;1&#34;, &#34;2&#34;, &#34;3&#34;]
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:enum=[&#34;a&#34;, &#34;b&#34;, &#34;c&#34;]
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:not_in=[&#34;d&#34;, &#34;s&#34;]
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_len=3
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_max=4
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:prefix=&#34;http&#34;
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:suffix=&#34;.com&#34;
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:contains=&#34;www&#34;
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:pattern=`\d+(\w+){3,5}`
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:number
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:ip
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:ipv4
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:ipv6
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:crontab
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:uuid
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:uri
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:domain
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">string</span> m <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div><blockquote>
<p>æ³¨: string pattern æœ€å¥½å•ç‹¬ä¸€è¡Œï¼Œä»¥å…å’Œå…¶ä»–è§„åˆ™å†²çª</p>
</blockquote>
<p>æ•°å­—ç±»å‹çš„æ”¯æŒï¼ŒåŒ…å« int32, int64, fixed32, fix64, float, double</p>
<ul>
<li>required: åˆ¤æ–­æ˜¯å¦ä¸º 0</li>
<li>default: å­—æ®µä¸ºç©ºæ—¶æŒ‡å®šçš„é»˜è®¤å€¼ï¼Œ(ä¸å¯ç”¨ required åŒæ—¶ä½¿ç”¨)</li>
<li>in, enum: åˆ¤æ–­å­—æ®µçš„å€¼æ˜¯å¦å­˜åœ¨äºæŒ‡å®šçš„åˆ—è¡¨ä¸­</li>
<li>not_in: åˆ¤æ–­å­—æ®µçš„å€¼æ˜¯å¦åœ¨æŒ‡å®šçš„åˆ—è¡¨ä¹‹å¤–</li>
<li>lt: æŒ‡å®šå­—æ®µå°äºæŒ‡å®šå€¼</li>
<li>lte: æŒ‡å®šå­—æ®µçš„å°äºç­‰äºæŒ‡å®šå€¼</li>
<li>gt: æŒ‡å®šå­—æ®µå¤§äºæŒ‡å®šå€¼</li>
<li>gte: æŒ‡å®šå­—æ®µå¤§äºç­‰äºæŒ‡å®šå€¼</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">S</span> {
    <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">float</span> a <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;

    <span style="color:#6272a4">// +gen:default=3.14
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">double</span> pi <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>

    <span style="color:#6272a4">// +gen:in=[1,2,3]
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:enum=[2,3]
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:not_in=[4,5]
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int32</span> b <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;

    <span style="color:#6272a4">// +gen:ge=3
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +ggen:gte=4
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:lte=9
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:lt=10
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int64</span> c <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;
}
</code></pre></div><p><code>bytes</code> ç±»å‹çš„æ”¯æŒ:</p>
<ul>
<li>required: åˆ¤æ–­å­—æ®µçš„é•¿åº¦æ˜¯å¦ä¸º0</li>
<li>min_bytes: åˆ¤æ–­å­—æ®µçš„æœ€å°å­—èŠ‚æ•°æ˜¯å¦å¤§äºç»™å®šå€¼</li>
<li>max_bytes: åˆ¤æ–­å­—æ®µçš„æœ€å¤§å­—èŠ‚æ•°æ˜¯å¦å°äºç»™å®šå€¼</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">S</span> {
    <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_bytes=10
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_bytes=1024
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">bytes</span> any <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div><p>repeated ç±»å‹çš„æ”¯æŒï¼šrepeated ç±»å‹çš„å­—æ®µåœ¨ golang ä¸­ä¼šè¢«è§£ææˆåˆ‡ç‰‡ã€‚</p>
<ul>
<li>required: åˆ¤æ–­åˆ‡ç‰‡çš„é•¿åº¦æ˜¯å¦ä¸º0</li>
<li>min_len: åˆ¤æ–­åˆ‡ç‰‡çš„æœ€å°é•¿åº¦æ˜¯å¦å¤§äºç»™å®šå€¼</li>
<li>max_len: åˆ¤æ–­åˆ‡ç‰‡çš„æœ€å¤§é•¿åº¦æ˜¯å¦å°äºç»™å®šå€¼</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">S</span> {
    <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_len=3
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:max_len=5
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">repeated</span> <span style="color:#8be9fd">string</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div><h3 id="å†…åµŒ-message">å†…åµŒ message</h3>
<p><code>protoc-gen-validator</code> æ”¯æŒè§£æå†…åµŒ message, ä½¿ç”¨ <code>+gen:inline</code> å¯ä»¥å°†å­ message ä¸­çš„å­—æ®µåµŒå…¥è¯¥ messageã€‚å®ä¾‹å¦‚ä¸‹:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Meta</span> {
  <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
  <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">int64</span> id <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Request</span> {
  <span style="color:#6272a4">// +gen:inline
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>  Meta meta <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
  <span style="color:#8be9fd">string</span> data <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}
</code></pre></div><p>è§£æå‡ºæ¥çš„å†…å®¹å¦‚ä¸‹:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">
func (m *Meta) Validate() error {
	return m.ValidateE(<span style="color:#f1fa8c">&#34;&#34;</span>)
}

func (m *Meta) ValidateE(prefix <span style="color:#8be9fd">string</span>) error {
	errs <span style="color:#ff79c6">:=</span> make([]error, <span style="color:#bd93f9">0</span>)
	if len(m.Name) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
		errs <span style="color:#ff79c6">=</span> append(errs, fmt.Errorf(<span style="color:#f1fa8c">&#34;field &#39;%sname&#39; is required&#34;</span>, prefix))
	}
	if <span style="color:#8be9fd">int64</span>(m.Id) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
		errs <span style="color:#ff79c6">=</span> append(errs, fmt.Errorf(<span style="color:#f1fa8c">&#34;field &#39;%sid&#39; is required&#34;</span>, prefix))
	}
	return is.MargeErr(errs...)
}

func (m *Request) Validate() error {
	return m.ValidateE(<span style="color:#f1fa8c">&#34;&#34;</span>)
}

func (m *Request) ValidateE(prefix <span style="color:#8be9fd">string</span>) error {
	errs <span style="color:#ff79c6">:=</span> make([]error, <span style="color:#bd93f9">0</span>)
	if len(m.Name) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
		errs <span style="color:#ff79c6">=</span> append(errs, fmt.Errorf(<span style="color:#f1fa8c">&#34;field &#39;%sname&#39; is required&#34;</span>, prefix))
	}
	if <span style="color:#8be9fd">int64</span>(m.Id) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
		errs <span style="color:#ff79c6">=</span> append(errs, fmt.Errorf(<span style="color:#f1fa8c">&#34;field &#39;%sid&#39; is required&#34;</span>, prefix))
	}
	return is.MargeErr(errs...)
}

func (m *Response) Validate() error {
	return m.ValidateE(<span style="color:#f1fa8c">&#34;&#34;</span>)
}

func (m *Response) ValidateE(prefix <span style="color:#8be9fd">string</span>) error {
	errs <span style="color:#ff79c6">:=</span> make([]error, <span style="color:#bd93f9">0</span>)
	return is.MargeErr(errs...)
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1cef3190b3d455150f6a09aa20c5c878">3.5 - protoc-gen-deepcopy</h1>
    <div class="lead">ä½¿ç”¨ protoc-gen-deepcopy ç”Ÿæˆèµ„æºçš„ deepcopy æ¥å£ã€‚</div>
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p>protoc-gen-deepcopy å¸®åŠ©ç”¨æˆ·ç”Ÿæˆèµ„æºçš„æ·±æ‹·è´æ¥å£ï¼Œå‡å°‘ç”¨æˆ·ç¼–å†™ä»£ç ã€‚</p>
<h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<h3 id="1å…ˆç¼–å†™-deepcopyproto-æ–‡ä»¶">1.å…ˆç¼–å†™ deepcopy.proto æ–‡ä»¶</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +gen:deepcopy
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Person</span> {
  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
  <span style="color:#8be9fd">bytes</span> any <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;
  <span style="color:#8be9fd">string</span> email <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;
}
</code></pre></div><h3 id="2å®‰è£…-protoc-gen-deepcopy">2.å®‰è£… protoc-gen-deepcopy</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/vine-io/vine/cmd/protoc-gen-deepcopy
</code></pre></div><h3 id="3ç”Ÿæˆ-validate-æ–¹æ³•">3.ç”Ÿæˆ Validate() æ–¹æ³•</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src --gogo_out<span style="color:#ff79c6">=</span>:.  --deepcopy_out<span style="color:#ff79c6">=</span>:. proto/deepcopy.proto
</code></pre></div><p>æ‰§è¡Œå®Œæˆåç”Ÿæˆä»¥ä¸‹ä»£ç :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#6272a4">// DeepCopyInto is an auto-generated deepcopy function, coping the receiver, writing into out. in must be no-nil.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (in <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">DeepCopyInto</span>(out <span style="color:#ff79c6">*</span>Person) {
	<span style="color:#ff79c6">*</span>out = <span style="color:#ff79c6">*</span>in
}

<span style="color:#6272a4">// DeepCopy is an auto-generated deepcopy function, copying the receiver, creating a new Person.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (in <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">DeepCopy</span>() <span style="color:#ff79c6">*</span>Person {
	<span style="color:#ff79c6">if</span> in <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
	}
	out <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">new</span>(Person)
	in.<span style="color:#50fa7b">DeepCopyInto</span>(out)
	<span style="color:#ff79c6">return</span> out
}
</code></pre></div><h3 id="4éªŒè¯">4.éªŒè¯</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	p <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>helloworld.Person{
		Name:  <span style="color:#f1fa8c">&#34;Vine&#34;</span>,
		Any:   []<span style="color:#8be9fd;font-style:italic">byte</span>(<span style="color:#f1fa8c">&#34;Hello&#34;</span>),
		Email: <span style="color:#f1fa8c">&#34;aa@gmail.com&#34;</span>,
	}

	fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;%p %v\n&#34;</span>, p, p)
	pc <span style="color:#ff79c6">:=</span> p.<span style="color:#50fa7b">DeepCopy</span>()
	fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;%p %v\n&#34;</span>, pc, pc)
}
<span style="color:#6272a4">// output:  
</span><span style="color:#6272a4">//  0xc0002ea280 name:&#34;Vine&#34; any:&#34;Hello&#34; email:&#34;aa@gmail.com&#34;
</span><span style="color:#6272a4">//  0xc0002ea2c0 name:&#34;Vine&#34; any:&#34;Hello&#34; email:&#34;aa@gmail.com&#34;
</span></code></pre></div><h2 id="è¯­æ³•è§£æ">è¯­æ³•è§£æ</h2>
<p><code>protoc-gen-deepcopy</code> é€šè¿‡è§£æ <code>protobuf</code> ä¸­çš„æ³¨é‡Šæ¥ç”Ÿæˆ <code>deepcopy</code> æ¥å£ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +gen:deepcopy
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Struct</span> {
    <span style="color:#8be9fd">string</span> field1 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
    <span style="color:#8be9fd">string</span> field2 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}
</code></pre></div><h3 id="è¯­æ³•è§„åˆ™">è¯­æ³•è§„åˆ™</h3>
<p>æœ‰æ•ˆçš„æ³¨é‡Šæœ‰ä»¥ä¸‹çš„è§„åˆ™:</p>
<ul>
<li>æ³¨é‡Šå¿…é¡»ä»¥ <code>+gen</code> ä½œä¸ºå¼€å¤´</li>
<li>æ³¨é‡Šçš„å†…å®¹å¿…é¡»ç´§è´´å¯¹åº”çš„å­—æ®µï¼Œä¸­é—´ä¸èƒ½æœ‰ç©ºè¡Œ</li>
</ul>
<h3 id="ç±»å‹æ”¯æŒ">ç±»å‹æ”¯æŒ</h3>
<p><code>message</code> ç±»å‹è§„åˆ™:</p>
<ul>
<li>deepcopy: ç”Ÿæˆ DeepCopy æ–¹æ³•</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +gen:deepcopy
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">P</span> {
}
</code></pre></div><ul>
<li>runtime=<group>/<version>: å®ç° <code>runtime.Entity</code> æ¥å£</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">// +gen:runtime=a/v1
message Person {
  string name = 1;
  bytes any = 3;
  string email = 4;
}
</code></pre></div><p>ç”Ÿæˆå¦‚ä¸‹ä»£ç :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// DeepCopyInto is an auto-generated deepcopy function, coping the receiver, writing into out. in must be no-nil.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (in <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">DeepCopyInto</span>(out <span style="color:#ff79c6">*</span>Person) {
	<span style="color:#ff79c6">*</span>out = <span style="color:#ff79c6">*</span>in
}

<span style="color:#6272a4">// GVK is an auto-generated gvk function, get the information like group, version and name of Person.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (in <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">GVK</span>() <span style="color:#ff79c6">*</span>runtime.GroupVersionKind {
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>runtime.GroupVersionKind{Group: <span style="color:#f1fa8c">&#34;a&#34;</span>, Version: <span style="color:#f1fa8c">&#34;v1&#34;</span>, Kind: <span style="color:#f1fa8c">&#34;Person&#34;</span>}
}

<span style="color:#6272a4">// DeepCopyFrom is an auto-generated deepcopy function, copying value from Person.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (in <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">DeepCopyFrom</span>(src runtime.Entity) {
	o <span style="color:#ff79c6">:=</span> src.(<span style="color:#ff79c6">*</span>Person)
	o.<span style="color:#50fa7b">DeepCopyInto</span>(in)
}

<span style="color:#6272a4">// DeepCopy is an auto-generated deepcopy function, copying the receiver, creating a new Person.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (in <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">DeepCopy</span>() runtime.Entity {
	<span style="color:#ff79c6">if</span> in <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
	}
	out <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">new</span>(Person)
	in.<span style="color:#50fa7b">DeepCopyInto</span>(out)
	<span style="color:#ff79c6">return</span> out
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-148255df01058e3f71315560bc42a419">3.6 - protoc-gen-dao</h1>
    <div class="lead"><em>Dao</em> é€šè¿‡ <code>protoc-gen-dao</code> ç”Ÿæˆæ•°æ®åº“CURDä»£ç ã€‚</div>
	<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p><code>Dao</code> æ˜¯ <strong>Vine</strong> æ¡†æ¶çš„æ•°æ®åº“äº¤äº’æ¨¡å—ï¼Œè€Œ<code>protoc-gen-dao</code>å·¥å…·åˆ™å¯ä»¥é€šè¿‡è¯†åˆ«<code>*.proto</code>æ¥ç”Ÿæˆå¯¹åº”çš„æ•°æ®åº“äº¤äº’ä»£ç ã€‚å‡å°‘å¤§é‡é‡å¤ä»£ç çš„ç¼–å†™ï¼Œæé«˜ç”¨æˆ·æ•ˆç‡ã€‚</p>
<h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<h3 id="1å…ˆç¼–å†™-userproto-æ–‡ä»¶">1.å…ˆç¼–å†™ user.proto æ–‡ä»¶</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;proto3&#34;</span>;

<span style="color:#ff79c6">package</span> v1;

<span style="color:#6272a4">// +gen:dao
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">User</span> {
  <span style="color:#6272a4">// +gen:pk
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> id <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;

  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;

  <span style="color:#ff79c6">repeated</span> <span style="color:#8be9fd">string</span> following <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;

  map&lt;<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd">string</span>&gt; tags <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;

  Other other <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">5</span>;
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Other</span> {
  <span style="color:#8be9fd">string</span> k <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
  <span style="color:#8be9fd">string</span> v <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}
</code></pre></div><h3 id="2å®‰è£…-protoc-gen-dao">2.å®‰è£… protoc-gen-dao</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/vine-io/vine/cmd/protoc-gen-dao
</code></pre></div><h3 id="3ç”Ÿæˆcurdä»£ç ">3.ç”ŸæˆCURDä»£ç </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src --gogofaster_out<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">plugins</span><span style="color:#ff79c6">=</span>grpc:.  --dao_out<span style="color:#ff79c6">=</span>:. proto/dao.proto
</code></pre></div><p>æ‰§è¡Œå®Œæˆåç”Ÿæˆä»¥ä¸‹æ–‡ä»¶:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">-rw-r--r--  <span style="color:#bd93f9">1</span> lack  staff   7.8K Mar <span style="color:#bd93f9">19</span> 22:26 user.pb.dao.go
-rw-r--r--  <span style="color:#bd93f9">1</span> lack  staff    20K Mar <span style="color:#bd93f9">19</span> 22:26 user.pb.go
-rw-r--r--  <span style="color:#bd93f9">1</span> lack  staff   255B Mar <span style="color:#bd93f9">18</span> 23:00 user.proto
</code></pre></div><p><code>*.pb.dao.go</code> ä¸­ä¿å­˜ç€CURDä»£ç ã€‚</p>
<h3 id="4curd-å®ä¾‹">4.CURD å®ä¾‹</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	dao.DefaultDialect = sqlite.<span style="color:#50fa7b">NewDialect</span>(dao.<span style="color:#50fa7b">DSN</span>(<span style="color:#f1fa8c">&#34;user.db&#34;</span>), dao.<span style="color:#50fa7b">Logger</span>(logger.Default.<span style="color:#50fa7b">LogMode</span>(logger.Info)))
	dao.DefaultDialect.<span style="color:#50fa7b">Init</span>()

    <span style="color:#6272a4">// æ³¨å†Œ Schema, ä¼šåœ¨æ•°æ®åº“ä¸­åˆ›å»ºå¯¹åº”çš„è¡¨
</span><span style="color:#6272a4"></span>	v1.<span style="color:#50fa7b">RegistryUser</span>(<span style="color:#ff79c6">&amp;</span>v1.User{})

	ctx <span style="color:#ff79c6">:=</span> context.<span style="color:#50fa7b">TODO</span>()
	u <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>v1.User{
		Id: <span style="color:#f1fa8c">&#34;1&#34;</span>,
		Name: <span style="color:#f1fa8c">&#34;Lack&#34;</span>,
		Following: []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;JJ&#34;</span>, <span style="color:#f1fa8c">&#34;OO&#34;</span>},
		Tags: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;label&#34;</span>: <span style="color:#f1fa8c">&#34;vv&#34;</span>},
		Other:     <span style="color:#ff79c6">&amp;</span>v1.Other{
			K: <span style="color:#f1fa8c">&#34;k1&#34;</span>,
			V: <span style="color:#f1fa8c">&#34;v1&#34;</span>,
		},
	}

	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Create ==============&gt;&#34;</span>)
	out, err <span style="color:#ff79c6">:=</span> v1.<span style="color:#50fa7b">FromUser</span>(u).<span style="color:#50fa7b">Create</span>(ctx)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}
	fmt.<span style="color:#50fa7b">Println</span>(out)

	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Updates ==============&gt;&#34;</span>)
	out, err = v1.<span style="color:#50fa7b">FromUser</span>(<span style="color:#ff79c6">&amp;</span>v1.User{Id: <span style="color:#f1fa8c">&#34;1&#34;</span>, Tags: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;aa&#34;</span>: <span style="color:#f1fa8c">&#34;vv&#34;</span>}}).<span style="color:#50fa7b">Updates</span>(ctx)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}
	fmt.<span style="color:#50fa7b">Println</span>(out)


	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;FindAll ==============&gt;&#34;</span>)
	outs, err <span style="color:#ff79c6">:=</span> v1.<span style="color:#50fa7b">FromUser</span>(<span style="color:#ff79c6">&amp;</span>v1.User{Tags: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;aa&#34;</span>: <span style="color:#f1fa8c">&#34;vv&#34;</span>}}).<span style="color:#50fa7b">FindAll</span>(ctx)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}
	fmt.<span style="color:#50fa7b">Println</span>(outs)

	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;FindOne ==============&gt;&#34;</span>)
	out, err = v1.<span style="color:#50fa7b">FromUser</span>(<span style="color:#ff79c6">&amp;</span>v1.User{Id: <span style="color:#f1fa8c">&#34;1&#34;</span>}).<span style="color:#50fa7b">FindOne</span>(ctx)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}
	fmt.<span style="color:#50fa7b">Println</span>(outs)

	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;SoftDelete ==============&gt;&#34;</span>)
	err = v1.<span style="color:#50fa7b">FromUser</span>(<span style="color:#ff79c6">&amp;</span>v1.User{Id: <span style="color:#f1fa8c">&#34;1&#34;</span>}).<span style="color:#50fa7b">SoftDelete</span>(ctx)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Delete ==============&gt;&#34;</span>)
	err = v1.<span style="color:#50fa7b">FromUser</span>(<span style="color:#ff79c6">&amp;</span>v1.User{Id: <span style="color:#f1fa8c">&#34;1&#34;</span>}).<span style="color:#50fa7b">Delete</span>(ctx)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#6272a4">//log.Fatal(err)
</span><span style="color:#6272a4"></span>	}
}
</code></pre></div><h2 id="è¯­æ³•è§£æ">è¯­æ³•è§£æ</h2>
<p><code>protoc-gen-dao</code> é€šè¿‡è§£æ <code>protobuf</code> ä¸­çš„æ³¨é‡Šæ¥ç”Ÿæˆä»£ç ã€‚repeated, map, message å­—æ®µä¼šç”Ÿæˆæ–°çš„ç»“æ„ä½“ï¼Œåœ¨æ•°æ®åº“ä¸­å­˜å‚¨æ ¼å¼ä¸º jsonã€‚
æ¯ä¸ªå¸¦<code>+dao:generate</code>æ³¨é‡Šçš„ message ä¼šç”Ÿæˆ *Schema ç»“æ„ä½“ï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„ CURD æ–¹æ³•ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#6272a4">// æ³¨å†Œ User ç›¸åº”çš„æ•°æ®åº“è¡¨
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">RegistryUser</span>(in <span style="color:#ff79c6">*</span>User) <span style="color:#8be9fd">error</span> 
<span style="color:#6272a4">// User =&gt; UserSchema, å¿½ç•¥ç©ºå€¼å­—æ®µ
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">FromUser</span>(in <span style="color:#ff79c6">*</span>User) <span style="color:#ff79c6">*</span>UserSchema 
<span style="color:#6272a4">// UserSchema =&gt; User
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">ToUser</span>() <span style="color:#ff79c6">*</span>User
<span style="color:#6272a4">// User ç»“æ„ä½“åœ¨æ•°æ®åº“ä¸­çš„è¡¨å
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (UserSchema) <span style="color:#50fa7b">TableName</span>() <span style="color:#8be9fd">string</span> 
<span style="color:#6272a4">// ä¸»é”®ä¿¡æ¯ï¼Œè¿”å›ä¸»é”®åç§°ã€å€¼ã€æ˜¯å¦ä¸ºé›¶å€¼
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m UserSchema) <span style="color:#50fa7b">PrimaryKey</span>() (<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd;font-style:italic">interface</span>{}, <span style="color:#8be9fd">bool</span>)
<span style="color:#6272a4">// åˆ†é¡µæŸ¥è¯¢ï¼Œç­‰åŒ FindAll å’Œ Count
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">FindPage</span>(ctx context.Context, page, size <span style="color:#8be9fd">int</span>, exprs <span style="color:#ff79c6">...</span>clause.Expression) ([]<span style="color:#ff79c6">*</span>User, <span style="color:#8be9fd">int64</span>, <span style="color:#8be9fd">error</span>) 
<span style="color:#6272a4">// æŸ¥è¯¢æ‰€æœ‰ç¬¦åˆçš„è®°å½•
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">FindAll</span>(ctx context.Context, exprs <span style="color:#ff79c6">...</span>clause.Expression) ([]<span style="color:#ff79c6">*</span>User, <span style="color:#8be9fd">error</span>) 
<span style="color:#6272a4">// æŸ¥è¯¢ç¬¦åˆçš„è®°å½•æ€»é‡
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">Count</span>(ctx context.Context, exprs <span style="color:#ff79c6">...</span>clause.Expression) (<span style="color:#8be9fd">int64</span>, <span style="color:#8be9fd">error</span>)
<span style="color:#6272a4">// æŸ¥è¯¢é¦–æ¡ç¬¦åˆçš„è®°å½•
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">FindOne</span>(ctx context.Context, exprs <span style="color:#ff79c6">...</span>clause.Expression) (<span style="color:#ff79c6">*</span>User, <span style="color:#8be9fd">error</span>)
<span style="color:#6272a4">// æ’å…¥ä¸€æ¡è®°å½•
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">Create</span>(ctx context.Context) (<span style="color:#ff79c6">*</span>User, <span style="color:#8be9fd">error</span>) 
<span style="color:#6272a4">// æ›´æ–°è®°å½•
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">Updates</span>(ctx context.Context) (<span style="color:#ff79c6">*</span>User, <span style="color:#8be9fd">error</span>)
<span style="color:#6272a4">// è½¯åˆ é™¤
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">Delete</span>(ctx context.Context, soft) <span style="color:#8be9fd">error</span> 
</code></pre></div><h3 id="ç±»å‹è½¬åŒ–">ç±»å‹è½¬åŒ–</h3>
<p>sliceã€mapã€message è‡ªåŠ¨ç”Ÿæˆå®ç° driver.Valuer æ¥å£çš„ç±»å‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#ff79c6">repeated</span> <span style="color:#8be9fd">string</span> following <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;
</code></pre></div><p>ç”Ÿæˆ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8be9fd;font-style:italic">type</span> UserFollowing []<span style="color:#8be9fd">string</span>

<span style="color:#6272a4">// Value return json value, implement driver.Valuer interface
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m UserFollowing) <span style="color:#50fa7b">Value</span>() (driver.Value, <span style="color:#8be9fd">error</span>) {
	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(m) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, <span style="color:#ff79c6">nil</span>
	}
	b, err <span style="color:#ff79c6">:=</span> _go.<span style="color:#50fa7b">Marshal</span>(m)
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">string</span>(b), err
}

<span style="color:#6272a4">// Scan scan value into Jsonb, implements sql.Scanner interface
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserFollowing) <span style="color:#50fa7b">Scan</span>(value <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span> {
	<span style="color:#8be9fd;font-style:italic">var</span> bytes []<span style="color:#8be9fd">byte</span>
	<span style="color:#ff79c6">switch</span> v <span style="color:#ff79c6">:=</span> value.(<span style="color:#8be9fd;font-style:italic">type</span>) {
	<span style="color:#ff79c6">case</span> []<span style="color:#8be9fd">byte</span>:
		bytes = v
	<span style="color:#ff79c6">case</span> <span style="color:#8be9fd">string</span>:
		bytes = []<span style="color:#8be9fd;font-style:italic">byte</span>(v)
	<span style="color:#ff79c6">default</span>:
		<span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(fmt.<span style="color:#50fa7b">Sprint</span>(<span style="color:#f1fa8c">&#34;Failed to unmarshal JSONB value:&#34;</span>, value))
	}

	<span style="color:#ff79c6">return</span> _go.<span style="color:#50fa7b">Unmarshal</span>(bytes, <span style="color:#ff79c6">&amp;</span>m)
}

<span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserFollowing) <span style="color:#50fa7b">DaoDataType</span>() <span style="color:#8be9fd">string</span> {
	<span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;json&#34;</span>
}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">map&lt;<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd">string</span>&gt; tags <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;
</code></pre></div><p>ç”Ÿæˆ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8be9fd;font-style:italic">type</span> UserTags <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>

<span style="color:#6272a4">// Value return json value, implement driver.Valuer interface
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m UserTags) <span style="color:#50fa7b">Value</span>() (driver.Value, <span style="color:#8be9fd">error</span>) {
	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(m) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, <span style="color:#ff79c6">nil</span>
	}
	b, err <span style="color:#ff79c6">:=</span> _go.<span style="color:#50fa7b">Marshal</span>(m)
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">string</span>(b), err
}

<span style="color:#6272a4">// Scan scan value into Jsonb, implements sql.Scanner interface
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserTags) <span style="color:#50fa7b">Scan</span>(value <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span> {
	<span style="color:#8be9fd;font-style:italic">var</span> bytes []<span style="color:#8be9fd">byte</span>
	<span style="color:#ff79c6">switch</span> v <span style="color:#ff79c6">:=</span> value.(<span style="color:#8be9fd;font-style:italic">type</span>) {
	<span style="color:#ff79c6">case</span> []<span style="color:#8be9fd">byte</span>:
		bytes = v
	<span style="color:#ff79c6">case</span> <span style="color:#8be9fd">string</span>:
		bytes = []<span style="color:#8be9fd;font-style:italic">byte</span>(v)
	<span style="color:#ff79c6">default</span>:
		<span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(fmt.<span style="color:#50fa7b">Sprint</span>(<span style="color:#f1fa8c">&#34;Failed to unmarshal JSONB value:&#34;</span>, value))
	}

	<span style="color:#ff79c6">return</span> _go.<span style="color:#50fa7b">Unmarshal</span>(bytes, <span style="color:#ff79c6">&amp;</span>m)
}

<span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserTags) <span style="color:#50fa7b">DaoDataType</span>() <span style="color:#8be9fd">string</span> {
	<span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;json&#34;</span>
}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">Other other <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">5</span>;
</code></pre></div><p>ç”Ÿæˆ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8be9fd;font-style:italic">type</span> UserOther Other

<span style="color:#6272a4">// Value return json value, implement driver.Valuer interface
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserOther) <span style="color:#50fa7b">Value</span>() (driver.Value, <span style="color:#8be9fd">error</span>) {
	<span style="color:#ff79c6">if</span> m <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, <span style="color:#ff79c6">nil</span>
	}
	b, err <span style="color:#ff79c6">:=</span> _go.<span style="color:#50fa7b">Marshal</span>(m)
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">string</span>(b), err
}

<span style="color:#6272a4">// Scan scan value into Jsonb, implements sql.Scanner interface
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserOther) <span style="color:#50fa7b">Scan</span>(value <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span> {
	<span style="color:#8be9fd;font-style:italic">var</span> bytes []<span style="color:#8be9fd">byte</span>
	<span style="color:#ff79c6">switch</span> v <span style="color:#ff79c6">:=</span> value.(<span style="color:#8be9fd;font-style:italic">type</span>) {
	<span style="color:#ff79c6">case</span> []<span style="color:#8be9fd">byte</span>:
		bytes = v
	<span style="color:#ff79c6">case</span> <span style="color:#8be9fd">string</span>:
		bytes = []<span style="color:#8be9fd;font-style:italic">byte</span>(v)
	<span style="color:#ff79c6">default</span>:
		<span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(fmt.<span style="color:#50fa7b">Sprint</span>(<span style="color:#f1fa8c">&#34;Failed to unmarshal JSONB value:&#34;</span>, value))
	}

	<span style="color:#ff79c6">return</span> _go.<span style="color:#50fa7b">Unmarshal</span>(bytes, <span style="color:#ff79c6">&amp;</span>m)
}

<span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserOther) <span style="color:#50fa7b">DaoDataType</span>() <span style="color:#8be9fd">string</span> {
	<span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;json&#34;</span>
}
</code></pre></div><h3 id="json-æ”¯æŒ">JSON æ”¯æŒ</h3>
<p><code>protoc-gen-dao</code> å°† sliceã€map å’Œ message ç±»å‹çš„å­—æ®µè½¬åŒ–ä¸ºJSONæ ¼å¼å¹¶å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼ŒåŒæ—¶ Dao æ”¯æŒé€šè¿‡ JSON æ¥ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ã€‚ä»¥ä¸‹æ˜¯JSONæ ¼å¼æŸ¥è¯¢çš„æ¡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang">    <span style="color:#6272a4">// slice æ ¼å¼ï¼ŒæŸ¥è¯¢sliceåŒ…å«æŒ‡å®šé¡¹çš„è®°å½•
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(m.Following) <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span> {
		<span style="color:#ff79c6">for</span> _, item <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> m.Following {
			exprs = <span style="color:#8be9fd;font-style:italic">append</span>(exprs, dao.DefaultDialect.<span style="color:#50fa7b">JSONBuild</span>(<span style="color:#f1fa8c">&#34;following&#34;</span>).<span style="color:#50fa7b">Tx</span>(tx).<span style="color:#50fa7b">Contains</span>(item))
		}
	}
    <span style="color:#6272a4">// map æ ¼å¼ï¼ŒæŸ¥è¯¢kvç¬¦åˆæ¡ä»¶çš„è®°å½•ï¼Œkey ç±»å‹å¿…é¡»ä¸º string
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> m.Tags <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#ff79c6">for</span> k, v <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> m.Tags {
			exprs = <span style="color:#8be9fd;font-style:italic">append</span>(exprs, dao.DefaultDialect.<span style="color:#50fa7b">JSONBuild</span>(<span style="color:#f1fa8c">&#34;tags&#34;</span>).<span style="color:#50fa7b">Tx</span>(tx).<span style="color:#50fa7b">Equals</span>(v, k))
		}
	}
    <span style="color:#6272a4">// struct æ ¼å¼ï¼Œç²¾ç¡®æŸ¥è¯¢ JSON 
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// æ”¯æŒä¸¤ç§æ–¹å¼:
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">//  * å½“ä¼ å…¥ key çš„å€¼ä¸ºç©ºï¼ŒæŸ¥è¯¢å¯¹åº” JSON key æ˜¯å¦å­˜åœ¨
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">//  * å½“ä¼ å…¥ key ä¸ºç¡®å®šå€¼æ—¶ï¼ŒæŸ¥è¯¢å¯¹åº” JSON key æ˜¯å¦ç­‰äºå¯¹åº”çš„å€¼
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> m.Other <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#ff79c6">for</span> k, v <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> dao.<span style="color:#50fa7b">FieldPatch</span>(m.Other) {
			<span style="color:#ff79c6">if</span> v <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
				exprs = <span style="color:#8be9fd;font-style:italic">append</span>(exprs, dao.DefaultDialect.<span style="color:#50fa7b">JSONBuild</span>(<span style="color:#f1fa8c">&#34;other&#34;</span>).<span style="color:#50fa7b">Tx</span>(tx).<span style="color:#50fa7b">HasKeys</span>(strings.<span style="color:#50fa7b">Split</span>(k, <span style="color:#f1fa8c">&#34;,&#34;</span>)<span style="color:#ff79c6">...</span>))
			} <span style="color:#ff79c6">else</span> {
				exprs = <span style="color:#8be9fd;font-style:italic">append</span>(exprs, dao.DefaultDialect.<span style="color:#50fa7b">JSONBuild</span>(<span style="color:#f1fa8c">&#34;other&#34;</span>).<span style="color:#50fa7b">Tx</span>(tx).<span style="color:#50fa7b">Equals</span>(v, strings.<span style="color:#50fa7b">Split</span>(k, <span style="color:#f1fa8c">&#34;,&#34;</span>)<span style="color:#ff79c6">...</span>))
			}
		}
	}
</code></pre></div><blockquote>
<p>æ³¨: å¦‚æœé»˜è®¤æ•°æ®åº“é€‰æ‹© Sqlite3 æ—¶ï¼Œé»˜è®¤ä¸æ”¯æŒ json_each, json_extract æ–¹æ³•ï¼Œéœ€è¦æ·»åŠ  -tags é€‰é¡¹ã€‚ <code>go build -tags JSON1 main.go</code></p>
</blockquote>
<h3 id="è¯­æ³•è§„åˆ™">è¯­æ³•è§„åˆ™</h3>
<p>æœ‰æ•ˆçš„æ³¨é‡Šæœ‰ä»¥ä¸‹çš„è§„åˆ™:</p>
<ul>
<li>æ³¨é‡Šå¿…é¡»ä»¥ <code>+gen</code> ä½œä¸ºå¼€å¤´</li>
<li>æ³¨é‡Šçš„å†…å®¹å¿…é¡»ç´§è´´å¯¹åº”çš„å­—æ®µï¼Œä¸­é—´ä¸èƒ½æœ‰ç©ºè¡Œ</li>
<li>æ”¯æŒå¤šè¡Œæ³¨é‡Šï¼Œä¹Ÿå¯ä»¥å°†å¤šè¡Œåˆå¹¶æˆä¸€è¡Œï¼Œå¹¶ç”¨ <code>;</code> ä½œä¸ºåˆ†éš”ç¬¦</li>
<li>åªæœ‰å¸¦ <code>+gen:dao</code> æ³¨é‡Šçš„ message æ‰ä¼šç”Ÿæˆ CURD ä»£ç </li>
</ul>
<h3 id="è¯­æ³•æ”¯æŒ">è¯­æ³•æ”¯æŒ</h3>
<h4 id="ä»£ç è¾“å‡ºè·¯å¾„">ä»£ç è¾“å‡ºè·¯å¾„</h4>
<p><code>protoc-gen-dao</code> æ”¯æŒå°†CURDä»£ç è¾“å‡ºåˆ°æŒ‡å®šè·¯å¾„</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +dao:output=github.com/vine-io/vine/testdata/db/dao;dao
</span><span style="color:#6272a4"></span>syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;protoc&#34;</span>
<span style="color:#ff79c6">...</span>
</code></pre></div><p>ä½¿ç”¨ <code>+dao:output=</code>ä¸ºå¼€å¤´ï¼Œå†™åœ¨ protobuf æ–‡ä»¶å¤´éƒ¨ï¼ŒæŒ‡å®šç”Ÿæˆçš„è·¯å¾„(å¯¹åº”$GOPATH)å’Œç”Ÿæˆ package åç§°ã€‚</p>
<h4 id="message-æ”¯æŒ">message æ”¯æŒ</h4>
<p>message æ”¯æŒä»¥ä¸‹æ³¨é‡Š:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +gen:dao  =&gt; åªæœ‰æ ‡è¯†è¯¥æ³¨é‡Šçš„ message æ‰ä¼šç”Ÿæˆ CURD ä»£ç 
</span></code></pre></div><h4 id="field-æ”¯æŒ">field æ”¯æŒ</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +gen:pk   =&gt; æŒ‡å®šå­—æ®µä¸ºä¸»é”®(å¿…é¡»), å¯ä»¥æ˜¯ string å’Œ æ•°å­—, å½“ int ç±»å‹æ—¶è‡ªå¢ 
</span><span style="color:#6272a4">//              å½“å¤šä¸ª PK å­—æ®µå­˜åœ¨æ—¶ï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªã€‚
</span><span style="color:#6272a4">// +gen:inline =&gt; åªèƒ½ç”¨åœ¨ message field ä¸­ï¼Œå°† message çš„å­—æ®µç›´æ¥è§£æä¸ºçˆ¶ message çš„å­—æ®µ
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">...</span>
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-96c4ff43558e2f86011b50d22caa006c">4 - æœåŠ¡éƒ¨ç½²</h1>
    
	<p>è¿™ä¸ªæˆ‘ä»¬ä»‹ç»ä¸¤ç§æœåŠ¡éƒ¨ç½²æ–¹å¼ã€‚</p>
<h2 id="docker">docker</h2>
<p><strong>Vine</strong> ä¸­é»˜è®¤æä¾›äº†ç”¨äºæ„å»ºç¨‹åºçš„ Dockerfile æ–‡ä»¶ã€‚ç”¨äºæ„å»ºæœåŠ¡é•œåƒã€‚</p>
<h3 id="dockerfile">Dockerfile</h3>
<p>ç¼–è¾‘ <code>_output/Dockerfile</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#ff79c6">FROM</span><span style="color:#f1fa8c"> debian:stable-slim</span>
<span style="color:#ff79c6">ADD</span> helloworld /helloworld

<span style="color:#ff79c6">EXPOSE</span><span style="color:#f1fa8c"> 11500</span>

<span style="color:#ff79c6">ENTRYPOINT</span> [ <span style="color:#f1fa8c">&#34;/helloworld&#34;</span>, <span style="color:#f1fa8c">&#34;--server-address=0.0.0.0:11500&#34;</span> ]
</code></pre></div><h3 id="ç¼–è¯‘é¡¹ç›®">ç¼–è¯‘é¡¹ç›®</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine build service --output<span style="color:#ff79c6">=</span>_output/helloworld 
</code></pre></div><h3 id="æ„å»ºé•œåƒ">æ„å»ºé•œåƒ</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8be9fd;font-style:italic">cd</span> _output
docker build -t helloworld .
</code></pre></div><h3 id="å¯åŠ¨æœåŠ¡">å¯åŠ¨æœåŠ¡</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">docker run <span style="color:#ff79c6">--</span>rm <span style="color:#ff79c6">-</span>p <span style="color:#bd93f9">11500</span>:<span style="color:#bd93f9">11500</span> helloworl
</code></pre></div><h2 id="gpm">gpm</h2>
<p><a href="https://github.com/vine-io/gpm">gpm</a> æ˜¯åŸºäº <strong>Vine</strong> å¼€å‘çš„é¡¹ç›®ç®¡ç†æœåŠ¡ã€‚åˆé€‚äºåœ¨æ²¡æœ‰ docker ç¯å¢ƒçš„æœºå™¨ä¸Šç®¡ç† <strong>Vine</strong> æœåŠ¡ã€‚</p>
<h3 id="å¯åŠ¨-gpm">å¯åŠ¨ gpm</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">gpm start <span style="color:#ff79c6">-</span>A &#39;<span style="color:#ff79c6">--</span>server<span style="color:#ff79c6">-</span>address=<span style="color:#bd93f9">0.0.0.0</span>:<span style="color:#bd93f9">7700</span>&#39;
</code></pre></div><h3 id="æœåŠ¡æ‰“åŒ…">æœåŠ¡æ‰“åŒ…</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gpm tar --name helloworld.tar.gz --target main
</code></pre></div><h3 id="å®‰è£…æœåŠ¡">å®‰è£…æœåŠ¡</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gpm --host 192.168.3.111:7700 install --package helloworld.tar.gz --name helloworld --dir /opt/helloworld --bin /opt/helloworld/main --args <span style="color:#f1fa8c">&#39;--server-address=0.0.0.0:11500&#39;</span> --version v1.0.0
</code></pre></div><h3 id="å¯åŠ¨æœåŠ¡-1">å¯åŠ¨æœåŠ¡</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gpm --host 192.168.3.111:7700 start --name helloworld
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="" aria-label="">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="">
      <i class=""></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 The Docsy Authors All Rights Reserved</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank">éšç§æ”¿ç­–</a></small>
	
		<p class="mt-2"><a href="/vine/about/">å…³äº</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>


<script src="https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js" integrity="sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj" crossorigin="anonymous"></script>










<script src="/vine/js/main.min.4311a5d52861bb5e1fd9ee6ffb1f00a3fdc3459ab6bf80c384338786370e230b.js" integrity="sha256-QxGl1Shhu14f2e5v&#43;x8Ao/3DRZq2v4DDhDOHhjcOIws=" crossorigin="anonymous"></script>




  </body>
</html>
