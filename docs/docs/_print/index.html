<!doctype html>
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.87.0" /><link rel="canonical" type="text/html" href="https://vine-io.github.io/vine/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="https://vine-io.github.io/vine/docs/index.xml">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="shortcut icon" href="/vine/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/vine/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/vine/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/vine/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/vine/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/vine/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/vine/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/vine/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/vine/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/vine/favicons/android-192x192.png" sizes="192x192">

<title>欢迎来到 Vine 文档 | Vine</title><meta property="og:title" content="欢迎来到 Vine 文档" />
<meta property="og:description" content="Vine 文档" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://vine-io.github.io/vine/docs/" /><meta property="og:site_name" content="Vine" />

<meta itemprop="name" content="欢迎来到 Vine 文档">
<meta itemprop="description" content="Vine 文档"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="欢迎来到 Vine 文档"/>
<meta name="twitter:description" content="Vine 文档"/>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






<link rel="preload" href="/vine/scss/main.min.bd19fcdf38c012b14ad8d3c8432efd8cf1740a17234311f030bcb495e955a2cf.css" as="style">
<link href="/vine/scss/main.min.bd19fcdf38c012b14ad8d3c8432efd8cf1740a17234311f030bcb495e955a2cf.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>




  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/vine/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">Vine</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a  class="nav-link active" href="/vine/docs/" ><span class="active">文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a  class="nav-link" href="https://github.com/vine-io/vine-example" target="_blank" ><span>实例</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a  class="nav-link" href="https://github.com/vine-io/vine" target="_blank" ><span>GitHub</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
<input type="search" class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label="站内搜索…" autocomplete="off">

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/vine/docs/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">欢迎来到 Vine 文档</h1>






<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-08b1b69f6319108b0455d24614fdd660">1 - 快速开始</h1>
    
	<p>这里提供一个简单的实例，帮助用户快速了解 <strong>Vine</strong> 框架。</p>
<h2 id="定义接口">定义接口</h2>
<h3 id="新建项目">新建项目</h3>
<p>新建目录保存相关代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/greet
</code></pre></div><blockquote>
<p>建议项目保存在 $GOPATH 下</p>
</blockquote>
<h3 id="新建-proto-文件">新建 *.proto 文件</h3>
<p><strong>Vine</strong> 内部使用 <code>gRPC</code> 作为服务端，<code>*.proto</code> 是 google 公司开源的一种数据交换协议，类似 <code>json</code>。关于 <code>protobuf</code> 更详细的语法可以参考<a href="https://developers.google.com/protocol-buffers/docs/gotutorial">protobuf</a>。</p>
<p>这里我们新建 <code>greet.proto</code> 文件，内容如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// mysite/proto/greet.proto
</span><span style="color:#6272a4"></span>syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;proto3&#34;</span>;

<span style="color:#ff79c6">package</span> greet;

<span style="color:#8be9fd;font-style:italic">service</span> Greeter {
  <span style="color:#ff79c6">rpc</span> Echo(EchoReq) <span style="color:#ff79c6">returns</span> (EchoRsp) {}
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">EchoReq</span> {
  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">EchoRsp</span> {
  <span style="color:#8be9fd">string</span> greeting <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div><blockquote>
<p>更多的关于 <strong>Vine</strong> 的语法规则可以参考 <a href="/vine/docs/guides/openapi/">protoc-gen-vine</a></p>
</blockquote>
<h3 id="生成-api-接口">生成 API 接口</h3>
<p>你需要以下的工具来生成 proto 代码</p>
<ul>
<li><a href="https://github.com/protocolbuffers/protobuf">protoc</a></li>
<li><a href="https://github.com/vine-io/vine/tree/master/cmd/protoc-gen-gogo">protoc-gen-gogo</a></li>
<li><a href="https://github.com/vine-io/vine/tree/master/cmd/protoc-gen-vine">protoc-gen-vine</a></li>
</ul>
<p>使用 protoc、protoc-gen-gogo、protoc-gen-vine 来生成 protobuf code</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/gogo/protobuf
go get github.com/vine-io/vine/cmd/protoc-gen-gogo
go get github.com/vine-io/vine/cmd/protoc-gen-vine
</code></pre></div><p>使用命令生成 <code>greet.pb.go</code> 和 <code>greet.vine.go</code> 文件:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8be9fd;font-style:italic">cd</span> <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src
protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src --gogo_out<span style="color:#ff79c6">=</span>:. --vine_out<span style="color:#ff79c6">=</span>:. mysite/proto/greet.proto
</code></pre></div><p>执行成功后会生成新的文件:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mysite
└── proto
    ├── greet.pb.go       <span style="color:#6272a4"># 通过 protoc-gen-gogo 插件生成，包含结构体和 gRPC 的接口</span>
    ├── greet.pb.vine.go  <span style="color:#6272a4"># 通过 protoc-gen-vine 插件生成，包含 Vine 框架接口</span>
    └── greet.proto

</code></pre></div><h2 id="定义服务">定义服务</h2>
<h3 id="实现-vine-服务">实现 Vine 服务</h3>
<p>有了 proto 文件后，接下来就是编写服务端代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">mkdir -p server
touch mysite/server/main.go
</code></pre></div><p>服务端代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>
	<span style="color:#f1fa8c">&#34;log&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
	pb <span style="color:#f1fa8c">&#34;mysite/proto&#34;</span>
)

<span style="color:#6272a4">// greet 需要实现 pb.Greet 的接口
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> greet <span style="color:#8be9fd;font-style:italic">struct</span> {}

<span style="color:#8be9fd;font-style:italic">func</span> (g <span style="color:#ff79c6">*</span>greet) <span style="color:#50fa7b">Echo</span>(ctx context.Context, req <span style="color:#ff79c6">*</span>pb.EchoReq, rsp <span style="color:#ff79c6">*</span>pb.EchoRsp) <span style="color:#8be9fd">error</span> {
	rsp.Greeting = <span style="color:#f1fa8c">&#34;hello: &#34;</span> <span style="color:#ff79c6">+</span> req.Name
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// 构建新的服务
</span><span style="color:#6272a4"></span>	app <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
		vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;greet&#34;</span>),
	)

	<span style="color:#6272a4">// 服务初始化
</span><span style="color:#6272a4"></span>	app.<span style="color:#50fa7b">Init</span>()

	<span style="color:#6272a4">// 注册服务
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">RegisterGreeterHandler</span>(app.<span style="color:#50fa7b">Server</span>(), <span style="color:#ff79c6">&amp;</span>greet{}); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;register greet hander: %v&#34;</span>, err)
	}

	<span style="color:#6272a4">// 服务启动
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> app.<span style="color:#50fa7b">Run</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;start greet server: %v&#34;</span>, err)
	}
}
</code></pre></div><p>这样一个简易的 <strong>Vine</strong> 服务就完成了。</p>
<blockquote>
<p>更多服务端的内容请参考 <a href="/vine/docs/component/server/">内部服务</a></p>
</blockquote>
<h3 id="启动服务">启动服务</h3>
<p>启动服务并绑定端口:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go run server/main.go
2021-08-27 13:24:18  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>vine/service.go:171 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Starting <span style="color:#ff79c6">[</span>service<span style="color:#ff79c6">]</span> greet
2021-08-27 13:24:18  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>vine/service.go:172 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info service <span style="color:#ff79c6">[</span>version<span style="color:#ff79c6">]</span> latest
2021-08-27 13:24:18  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>grpc/grpc.go:920 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Server <span style="color:#ff79c6">[</span>grpc<span style="color:#ff79c6">]</span> Listening on <span style="color:#ff79c6">[</span>::<span style="color:#ff79c6">]</span>:65235
2021-08-27 13:24:18  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>grpc/grpc.go:761 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Registry <span style="color:#ff79c6">[</span>mdns<span style="color:#ff79c6">]</span> Registering node: greet-d4d5e1a8-1bc0-4387-8fb2-1b5eda59055e
2021-08-27 13:24:18  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>mdns/mdns_registry.go:266 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info <span style="color:#ff79c6">[</span>mdns<span style="color:#ff79c6">]</span> registry create new service with ip: 192.168.11.167 <span style="color:#ff79c6">for</span>: 192.168.11.167
</code></pre></div><p>如果用户没有指定 ip 和端口，则默认 ip 为 0.0.0.0，端口随机生成。</p>
<blockquote>
<p>关于 <strong>Vine</strong> 服务的命令行参数可以参考 <a href="/vine/docs/component/cmd/">命令行参数</a></p>
</blockquote>
<h2 id="客户端">客户端</h2>
<p>接下来我们编写客户端的代码来请求服务端:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p client
touch client/main.go
</code></pre></div><p>客户端代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/client/grpc&#34;</span>
	log <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/logger&#34;</span>
	pb <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/testdata/mysite/proto&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// 选择 gRPC 客户端
</span><span style="color:#6272a4"></span>	cc <span style="color:#ff79c6">:=</span> grpc.<span style="color:#50fa7b">NewClient</span>()
	<span style="color:#6272a4">// 指定服务名称
</span><span style="color:#6272a4"></span>	client <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">NewGreeterService</span>(<span style="color:#f1fa8c">&#34;greet&#34;</span>, cc)

	<span style="color:#6272a4">// 请求 Greet.Echo 接口
</span><span style="color:#6272a4"></span>	rsp, err <span style="color:#ff79c6">:=</span> client.<span style="color:#50fa7b">Echo</span>(context.<span style="color:#50fa7b">TODO</span>(), <span style="color:#ff79c6">&amp;</span>pb.EchoReq{Name: <span style="color:#f1fa8c">&#34;lack&#34;</span>})
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	log.<span style="color:#50fa7b">Infof</span>(<span style="color:#f1fa8c">&#34;greet result: %v&#34;</span>, rsp.Greeting)
}
</code></pre></div><p>执行命令输出如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go run client/main.go
2021-08-27 13:24:41  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>client/main.go:20 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info greet result: hello: lack
</code></pre></div><blockquote>
<p>更多关于客户端的内容可以参考 <a href="/vine/docs/component/client/">内部请求</a></p>
</blockquote>
<h2 id="api-接口">API 接口</h2>
<p><strong>Vine</strong> 服务可以同时支持 <code>gRPC</code> 和 <code>Restful</code> 接口。</p>
<h3 id="修改-greetproto-文件">修改 greet.proto 文件</h3>
<p>先修改 greet.proto 文件:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;proto3&#34;</span>;

<span style="color:#ff79c6">package</span> greet;

<span style="color:#6272a4">// +gen:openapi
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">service</span> Greeter {
  <span style="color:#6272a4">// +gen:get=/api/v1/echo
</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Echo(EchoReq) <span style="color:#ff79c6">returns</span> (EchoRsp) {}
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">EchoReq</span> {
  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">EchoRsp</span> {
  <span style="color:#8be9fd">string</span> greeting <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div><p>重新生成 <code>greet.pb.vine.go</code> 文件:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src --vine_out<span style="color:#ff79c6">=</span>:.  github.com/vine-io/vine/testdata/mysite/proto/greet.proto
</code></pre></div><h3 id="安装-vine">安装 <code>vine</code>:</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/vine-io/vine/cmd/vine
</code></pre></div><h3 id="启动网关">启动网关</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine api --handler<span style="color:#ff79c6">=</span>rpc --enable-openapi  
2021-08-27 13:38:54  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>openapi/openapi.go:56 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Starting OpenAPI at /openapi-ui/
2021-08-27 13:38:54  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>api/api.go:179 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Registering API RPC Handler at /
2021-08-27 13:38:54  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>http/http.go:116 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info HTTP API Listening on <span style="color:#ff79c6">[</span>::<span style="color:#ff79c6">]</span>:8080
2021-08-27 13:38:54  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>vine/service.go:171 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Starting <span style="color:#ff79c6">[</span>service<span style="color:#ff79c6">]</span> go.vine.api
2021-08-27 13:38:54  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>vine/service.go:172 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info service <span style="color:#ff79c6">[</span>version<span style="color:#ff79c6">]</span> latest
2021-08-27 13:38:54  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>grpc/grpc.go:920 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Server <span style="color:#ff79c6">[</span>grpc<span style="color:#ff79c6">]</span> Listening on <span style="color:#ff79c6">[</span>::<span style="color:#ff79c6">]</span>:50405
2021-08-27 13:38:54  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>grpc/grpc.go:761 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Registry <span style="color:#ff79c6">[</span>mdns<span style="color:#ff79c6">]</span> Registering node: go.vine.api-b405ca1d-ba24-4470-a18e-b1feeb22c5f6
2021-08-27 13:38:54  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>mdns/mdns_registry.go:266 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info <span style="color:#ff79c6">[</span>mdns<span style="color:#ff79c6">]</span> registry create new service with ip: 192.168.11.167 <span style="color:#ff79c6">for</span>: 192.168.11.167
</code></pre></div><p>使用以下命令验证:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl http://127.0.0.1:8080/api/v1/echo<span style="color:#f1fa8c">\?</span>name<span style="color:#f1fa8c">\=</span>lack
<span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;greeting&#34;</span>:<span style="color:#f1fa8c">&#34;hello: lack&#34;</span><span style="color:#ff79c6">}</span>%
</code></pre></div><p>完成的目录结构如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mysite
├── client
│   └── main.go
├── proto
│   ├── greet.pb.go
│   ├── greet.pb.vine.go
│   └── greet.proto
└── server
    └── main.go
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2ca5b21c2e8606490b4d2c267c683e14">1.1 - 框架简介</h1>
    
	<p><a href="https://opensource.org/licenses/Apache-2.0"><img src="https://img.shields.io/:license-apache-blue.svg" alt="License"></a> <a href="https://pkg.go.dev/github.com/vine-io/vine?tab=doc"><img src="https://img.shields.io/badge/go.dev-reference-007d9c?logo=go&amp;logoColor=white&amp;style=flat-square" alt="Go.Dev reference"></a> <a href="https://travis-ci.org/vine-io/vine"><img src="https://api.travis-ci.org/vine-io/vine.svg?branch=master" alt="Travis CI"></a> <a href="https://goreportcard.com/report/github.com/vine-io/vine"><img src="https://goreportcard.com/badge/vine-io/vine" alt="Go Report Card"></a></p>
<p>Vine (<em>/vaɪn/</em>) 一套简单、高效、可插拔的分布式 RPC 框架。</p>
<blockquote>
<p>Vine (葡萄树 🍇) : 我们希望它能像的它名字一样，多节果子。</p>
</blockquote>
<h2 id="简介">简介</h2>
<p><strong>Vine</strong> 基于 <a href="https://github.com/asim/go-micro">go-micro</a> 框架，因此继承了它的优点。并在此基础上进行裁剪和改进，增加性能和可用性。</p>
<h2 id="架构图">架构图</h2>
<p><img src="vine%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="vine架构图"></p>
<h2 id="功能">功能</h2>
<p><strong>Vine</strong> 抽象化分布式系统的内部细节. 以下是主要功能.</p>
<ul>
<li>
<p><strong>动态配置 (Dynamic Config)</strong> - 从任意地方加载和热加载动态配置。配置接口提供了一种方法，可以从任何源（如环境变量，文件，etcd）加载应用级别配置。同时支持合并源、甚至定义回退。</p>
</li>
<li>
<p><strong>数据存储 (Dao)</strong> - 一个简单的数据存储接口，用于查询，创建，删除数据记录。内置 memory，file，postgresSQL 等</p>
</li>
<li>
<p><strong>缓存接口 (Cache)</strong> - 支持内部数据缓存，保存临时数据。</p>
</li>
<li>
<p><strong>服务发现 (Service discovery)</strong> - 自动服务注册和名称解析。服务发现是微服务开发的核心功能。当服务A与服务B通讯时，需要知道服务B的IP地址等信息。<strong>Vine</strong> 内置(mdns)作为服务发现组件，它是零配置系统。</p>
</li>
<li>
<p><strong>负载均衡 (Load Balancing)</strong> - 基于服务发现的客户端负载均衡。当内部存在多个服务实例的地址时，我们需要一种方式确定路由到哪个节点，默认使用随机指定其中一个地址。同时在请求错误时重试不同的节点。</p>
</li>
<li>
<p><strong>消息编码 (Message Encoding)</strong> - 基于<code>Content-Type</code>的动态消息编码。Codec 为客户端和服务端提供 Go 类型的编码和解码，支持各种不同的类型。默认使用 protobuf 和 json。</p>
</li>
<li>
<p><strong>gRPC 传输 (gRPC transport)</strong> - 基于 gRPC 的请求响应，同时支持双向流。<strong>Vine</strong> 为同步通讯提供一个抽象，使发向服务的请求被自动解析、负载均衡、拨号和流化。</p>
</li>
<li>
<p><strong>异步消息 (Async Messaging)</strong> - 内置订阅发布模型，作为异步通讯和事件驱动架构。事件通知属于微服务开发中的核心模式。默认的消息系统为 HTTP 事件代理。</p>
</li>
<li>
<p><strong>同步 (Synchronization)</strong> - 分布式系统通常以最终一致性的方式构建。内置的 <strong>Sync</strong> 接口实现分布式锁和领导选举。</p>
</li>
<li>
<p><strong>可插拔接口 (Pluggable Interfaces)</strong> - 得益于 Go 语言的抽象特性。 <strong>Vine</strong> 为每个模块提供抽象接口，正因为如此，这些接口都是可插拔的。可以在 <a href="https://github.com/vine-io/plugins">github.com/vine-io/plugins</a> 查询你需要的插件。</p>
</li>
</ul>
<h2 id="许可">许可</h2>
<p>Vine 遵守 MIT License 开源许可.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-83087925151d27e6b8d84f40aff9cdee">1.2 - 新建项目</h1>
    
	<h2 id="依赖">依赖</h2>
<p>新建 <strong>Vine</strong> 项目需要安装依赖环境和工具:</p>
<ul>
<li><a href="https://golang.org/dl/">go</a></li>
<li><a href="https://github.com/protocolbuffers/protobuf">protoc</a></li>
</ul>
<p>建议开启GO111MODULE</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go env -w <span style="color:#8be9fd;font-style:italic">GO111MODULE</span><span style="color:#ff79c6">=</span>on
</code></pre></div><h2 id="安装">安装</h2>
<p>安装 <strong>Vine</strong> 工具</p>
<p>go get 安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get -u github.com/vine-io/vine/cmd/vine@latest
go get -u github.com/vine-io/vine/cmd/protoc-gen-gogo@latest
go get -u github.com/vine-io/vine/cmd/protoc-gen-vine@latest
</code></pre></div><p>go install 安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go install github.com/vine-io/vine/cmd/vine@latest
go install github.com/vine-io/vine/cmd/protoc-gen-gogo@latest
go install github.com/vine-io/vine/cmd/protoc-gen-vine@latest
</code></pre></div><p>源码编译安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git clone https://github.com/vine-io/vine
<span style="color:#8be9fd;font-style:italic">cd</span> vine
make build <span style="color:#ff79c6">&amp;&amp;</span> mv vine <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/bin/vine 
</code></pre></div><h2 id="创建项目">创建项目</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4"># 新建项目根目录</span>
mkdir -p <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/helloworld
<span style="color:#8be9fd;font-style:italic">cd</span> <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/helloworld

<span style="color:#6272a4"># 初始化目录</span>
vine init
<span style="color:#6272a4"># 新建服务</span>
vine new service helloworld
<span style="color:#6272a4"># 生成代码</span>
vine build proto
<span style="color:#6272a4"># 安装依赖</span>
go mod vendor
<span style="color:#6272a4"># 启动服务</span>
vine run helloworld
</code></pre></div><h2 id="启动服务">启动服务</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine run helloworld
</code></pre></div><h2 id="启动网关">启动网关</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine api --handler<span style="color:#ff79c6">=</span>rpc --enable-openapi
</code></pre></div><h2 id="测试">测试</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -X POST http://127.0.0.1:8080/foo/v1/foo/Call -H <span style="color:#f1fa8c">&#34;Content-Type: application/json&#34;</span>  -d <span style="color:#f1fa8c">&#34;{\&#34;name\&#34;:\&#34;World\&#34;}&#34;</span>
<span style="color:#6272a4"># {&#34;msg&#34;:&#34;reply: World&#34;}</span>
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-67790003301156bb2bbfd3d432c5d2f6">1.3 - 项目结构</h1>
    
	<p><strong>Vine</strong> 提供命令行工具创建项目，其中包括了开发过程中需要的工具链和部署内容。符合 DDD 设计规范。</p>
<h2 id="单服务">单服务</h2>
<p>单服务目录结构使用以下命令创建:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir <span style="color:#8be9fd;font-style:italic">$PATH</span>/src/foo
vine init
vine new service foo
</code></pre></div><p>生成目录结构:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">├── Makefile
├── README.md
├── api  // ------ 维护 grpc 接口，和 domain 层中领域模型
│   └── service
│       └── foo
│           └── v1
│               ├── foo.pb.go
│               ├── foo.pb.validator.go
│               ├── foo.pb.vine.go
│               └── foo.proto
├── cmd         // ------ 项目入口
│   └── main.go
├── deploy    // ------- 部署相关工具
│   ├── Dockerfile
│   ├── foo.ini
│   └── foo.service
├── go.mod
├── go.sum
├── pkg  // 服务内部代码
│   ├── app.go  // -------- 构造和组合各层代码，提供给 cmd/main.go
│   ├── biz  // ---------- DDD 的 domain 层，维护业务代码
│   │   └── foo.go
│   ├── infra  // --------- DDD 的 infrastructure 层，底层通用代码
│   │   ├── cache  // -------- 缓存相关
│   │   │   └── cache.go
│   │   └── repo  // ------- 数据库 repository，数据交互
│   │       └── repo.go
│   ├── service   // ---------- DDD 的 interfaces 层，提供对外的 gRPC 接口 
│   │   └── foo.go
│   └── runtime
│       ├── doc.go  // 维护服务版本信息
│       └── inject  // ------ 维护依赖注入代码
│           └── inject.go
└── vine.toml   // -------- vine 项目的描述文件
</code></pre></div><h2 id="多服务">多服务</h2>
<p>当一个项目中有多个微服务时，我们推荐代码在一个目录中维护，使用以下命令创建</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/cluster
<span style="color:#8be9fd;font-style:italic">cd</span> <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/cluster

vine init --cluster
vine new service helloworld
</code></pre></div><p>生成以下目录结构:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">├── Makefile
├── README.md
├── api
│   └── service
│       └── helloworld
│           └── v1
│               └── helloworld.proto
├── cmd
│   └── helloworld
│       └── main.go
├── deploy
│   ├── config
│   │   └── helloworld.ini
│   ├── docker
│   │   └── helloworld
│   │       └── Dockerfile
│   └── systemd
│       └── helloworld.service
├── go.mod
├── pkg   
│   ├── helloworld // -------- 多服务是，pkg 每个目录代码一个服务
│   │   ├── app.go
│   │   ├── biz
│   │   │   └── helloworld.go
│   │   ├── infra
│   │   │   ├── cache
│   │   │   │   └── cache.go
│   │   │   └── repo
│   │   │       └── repo.go
│   │   └── service
│   │       └── helloworld.go
│   └── runtime  // ------ 多个服务间的通用代码
│       ├── doc.go
│       └── inject
│           └── inject.go
└── vine.toml
</code></pre></div><h2 id="vinetoml">vine.toml</h2>
<p><code>vine.toml</code> 是 <strong>Vine</strong> 项目的描述文件，当一个目录底下存在该文件时，会被识别为 <strong>Vine</strong> 项目。</p>
<p><code>vine.toml</code> 存在两种格式，single 和 cluster。</p>
<h3 id="single">single</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#ff79c6">[</span>package<span style="color:#ff79c6">]</span>               <span style="color:#6272a4"># [package] 描述项目的公共信息 </span>
<span style="color:#8be9fd;font-style:italic">kind</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;single&#34;</span>         <span style="color:#6272a4"># 项目类型 single 和 cluster</span>
<span style="color:#8be9fd;font-style:italic">namespace</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;go.vine&#34;</span>   <span style="color:#6272a4"># 统一的命名空间</span>

<span style="color:#ff79c6">[</span>pkg<span style="color:#ff79c6">]</span>      <span style="color:#6272a4"># single 项目详细信息</span>
<span style="color:#8be9fd;font-style:italic">name</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;foo&#34;</span>  <span style="color:#6272a4"># 项目名称</span>
<span style="color:#8be9fd;font-style:italic">alias</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;go.vine.service.foo&#34;</span> <span style="color:#6272a4"># 服务名称</span>
<span style="color:#8be9fd;font-style:italic">type</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;service&#34;</span>    <span style="color:#6272a4"># 服务类型 service, gateway</span>
<span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;latest&#34;</span>  <span style="color:#6272a4"># 服务版本</span>
<span style="color:#8be9fd;font-style:italic">main</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;cmd/main.go&#34;</span> <span style="color:#6272a4"># 服务入口文件</span>
<span style="color:#8be9fd;font-style:italic">dir</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;github.com/lack-io/foo&#34;</span>  <span style="color:#6272a4"># 服务核心代码目录</span>
<span style="color:#8be9fd;font-style:italic">output</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>  <span style="color:#6272a4"># 编译成二进制文件的存放目录</span>
<span style="color:#8be9fd;font-style:italic">flags</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">[</span>
	<span style="color:#f1fa8c">&#34;-a&#34;</span>, <span style="color:#f1fa8c">&#34;-installsuffix&#34;</span>, <span style="color:#f1fa8c">&#34;cgo&#34;</span>, <span style="color:#f1fa8c">&#34;-ldflags \&#34;-s -w\&#34;&#34;</span>,  <span style="color:#6272a4"># 编译参数, 支持shell命令作为值 &#34;name=$(echo hello)&#34;</span>
<span style="color:#ff79c6">]</span>

<span style="color:#ff79c6">[[</span>proto<span style="color:#ff79c6">]]</span>    <span style="color:#6272a4"># *.proto 文件信息</span>
<span style="color:#8be9fd;font-style:italic">name</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;foo&#34;</span> <span style="color:#6272a4"># proto 文件名称</span>
<span style="color:#8be9fd;font-style:italic">pb</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;github.com/lack-io/foo/api/service/foo/v1/foo.proto&#34;</span> <span style="color:#6272a4"># proto 文件路径</span>
<span style="color:#8be9fd;font-style:italic">type</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;service&#34;</span> <span style="color:#6272a4"># proto 类型 service 和 api； service 表示 gRPC 服务，api 表示领域模型</span>
<span style="color:#8be9fd;font-style:italic">group</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;foo&#34;</span> <span style="color:#6272a4"># proto 分组</span>
<span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;v1&#34;</span> <span style="color:#6272a4"># proto 版本</span>
<span style="color:#8be9fd;font-style:italic">plugins</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#34;gogo&#34;</span>, <span style="color:#f1fa8c">&#34;vine&#34;</span>, <span style="color:#f1fa8c">&#34;validator&#34;</span><span style="color:#ff79c6">]</span> <span style="color:#6272a4"># 执行 protoc 命令时携带的插件，可选 gogo、vine、validator、deepcopy、dao</span>
</code></pre></div><h3 id="cluster">cluster</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#ff79c6">[</span>package<span style="color:#ff79c6">]</span>
<span style="color:#8be9fd;font-style:italic">kind</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;cluster&#34;</span>
<span style="color:#8be9fd;font-style:italic">namespace</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;go.vine&#34;</span>

<span style="color:#ff79c6">[[</span>mod<span style="color:#ff79c6">]]</span>  <span style="color:#6272a4"># 每个 mod 表示一个服务</span>
<span style="color:#8be9fd;font-style:italic">name</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;helloworld&#34;</span>
<span style="color:#8be9fd;font-style:italic">alias</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;go.vine.service.helloworld&#34;</span>
<span style="color:#8be9fd;font-style:italic">type</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;service&#34;</span>
<span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;latest&#34;</span>
<span style="color:#8be9fd;font-style:italic">main</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;cmd/helloworld/main.go&#34;</span>
<span style="color:#8be9fd;font-style:italic">dir</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;github.com/lack-io/foo/helloworld&#34;</span>
<span style="color:#8be9fd;font-style:italic">output</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>
<span style="color:#8be9fd;font-style:italic">flags</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">[</span>
	<span style="color:#f1fa8c">&#34;-a&#34;</span>, <span style="color:#f1fa8c">&#34;-installsuffix&#34;</span>, <span style="color:#f1fa8c">&#34;cgo&#34;</span>, <span style="color:#f1fa8c">&#34;-ldflags \&#34;-s -w\&#34;&#34;</span>, 
<span style="color:#ff79c6">]</span>

<span style="color:#ff79c6">[[</span>proto<span style="color:#ff79c6">]]</span>
<span style="color:#8be9fd;font-style:italic">name</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;helloworld&#34;</span>
<span style="color:#8be9fd;font-style:italic">pb</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;github.com/lack-io/foo/api/service/helloworld/v1/helloworld.proto&#34;</span>
<span style="color:#8be9fd;font-style:italic">type</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;service&#34;</span>
<span style="color:#8be9fd;font-style:italic">group</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;helloworld&#34;</span>
<span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;v1&#34;</span>
<span style="color:#8be9fd;font-style:italic">plugins</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#34;gogo&#34;</span>, <span style="color:#f1fa8c">&#34;vine&#34;</span>, <span style="color:#f1fa8c">&#34;validator&#34;</span><span style="color:#ff79c6">]</span>
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-79e475706ae8025baf8c0f923eec34bd">1.4 - 构建工具</h1>
    
	<p>我们提供一套工具帮助开发者快速构建微服务。</p>
<h2 id="安装">安装</h2>
<p>使用 go get 安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get -u github.com/vine-io/vine/cmd/vine@latest
</code></pre></div><p>编译包安装 (推荐)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget https://github.com/vine-io/vine/releases/download/v0.23.0/vine-darwin-amd64-v0.23.0.tar.gz
tar -xvf vine-darwin-amd64-v0.23.0.tar.gz
cp -r darwin-amd64/* <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/bin/
</code></pre></div><p>工具使用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine --version
&gt; v0.23.0-8b25f36c-1630374346
</code></pre></div><h2 id="新建项目">新建项目</h2>
<p>创建目录作为项目根目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/foo
</code></pre></div><p>初始化目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8be9fd;font-style:italic">cd</span> <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/foo
vine init
</code></pre></div><p><code>vine init [--cluster]</code> 会初始化 <strong>Vine</strong> 项目，生成以下文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">.
├── vine.toml  <span style="color:#6272a4"># vine 项目的描述文件，包括项目名称，服务接口和proto等信息。</span>
├── README.md
├── .gitignore
└── go.mod
</code></pre></div><h2 id="新建服务">新建服务</h2>
<p>在初始化的目录新建微服务：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine new service foo
</code></pre></div><blockquote>
<p>vine 项目类型为 single 时，<code>vine new service</code> 指定服务名称是无效的，它的名称等于目录名。</p>
</blockquote>
<p>执行结果，生成以下文档:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">.
├── cmd
│   └── main.go
├── pkg
│   ├── runtime
│   │   ├── doc.go
│   │   └── inject
│   │       └── inject.go
│   ├── app.go
│   ├── interfaces
│   │   └── foo.go
│   ├── app
│   │   └── foo.go
│   ├── biz
│   │   └── foo.go
│   └── infra
│       ├── repo
│       │   └── repo.go
│       └── cache
│           └── cache.go
├── deploy
│   ├── Dockerfile
│   ├── foo.ini
│   └── foo.service
├── api
│   └── service
│       └── foo
│           └── v1
│               └── foo.proto
├── Makefile
└── vine.toml


download protoc zip packages <span style="color:#ff79c6">(</span>protoc-<span style="color:#8be9fd;font-style:italic">$VERSION</span>-<span style="color:#8be9fd;font-style:italic">$PLATFORM</span>.zip<span style="color:#ff79c6">)</span> and install:

visit https://github.com/protocolbuffers/protobuf/releases

download protobuf <span style="color:#ff79c6">for</span> vine:

<span style="color:#8be9fd;font-style:italic">cd</span> github.com/lack-io/foo

install dependencies:
        go get github.com/gogo/protobuf
        go get github.com/vine-io/vine/cmd/protoc-gen-gogo
        go get github.com/vine-io/vine/cmd/protoc-gen-vine
        go get github.com/vine-io/vine/cmd/protoc-gen-validator
        go get github.com/vine-io/vine/cmd/protoc-gen-deepcopy
        go get github.com/vine-io/vine/cmd/protoc-gen-dao

<span style="color:#8be9fd;font-style:italic">cd</span> github.com/lack-io/foo
        vine build foo
</code></pre></div><h2 id="安装依赖">安装依赖</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/gogo/protobuf
go get github.com/vine-io/vine/cmd/protoc-gen-gogo
go get github.com/vine-io/vine/cmd/protoc-gen-vine
go get github.com/vine-io/vine/cmd/protoc-gen-validator
go get github.com/vine-io/vine/cmd/protoc-gen-deepcopy
go get github.com/vine-io/vine/cmd/protoc-gen-dao
</code></pre></div><h2 id="更加-proto-文件生成-go-代码">更加 proto 文件生成 go 代码</h2>
<p>使用命令格式为: <code>vine build proto [command options] [proto_name]</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4"># 生成 vine.toml 中所有 proto 文件对应的代码。</span>
vine new proto
</code></pre></div><p>支持如下参数:</p>
<ul>
<li>&ndash;type string                      指定 proto 文件的类型，支持 api 和 service，默认 api</li>
<li>&ndash;proto-version string, -v string  指定 proto 文件版本，默认 v1</li>
<li>&ndash;group string                     指定 proto 文件分组，默认 core</li>
<li>&ndash;dir string                       执行 protoc 命令是所在的目录，chroot</li>
<li>&ndash;path strings, -I strings         protoc -I 路径</li>
<li>&ndash;plugins strings, -P strings      生成 proto 时装载的插件</li>
</ul>
<h2 id="运行服务">运行服务</h2>
<p>命令格式: <code>vine new [command options] [name]</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine run foo
</code></pre></div><p>支持如下参数:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">- --auto-restart                    监听文件变化时重启服务
- --watch strings                   追加监听的路径
- --watch-interval int64, -I int64  监听事件触发间隔，默认3s
</code></pre></div><h2 id="启动-api-网关">启动 api 网关</h2>
<p>命令格式: <code>vine api [command options]</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine api --handler<span style="color:#ff79c6">=</span>rpc --enable-openapi
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1adf2527acb4bd9f3ca351337ddc8408">1.5 - 可选参数</h1>
    
	<h2 id="概述">概述</h2>
<p>创建新服务时，你可以选择传递其他参数，例如设置名称，版本，Broker，Registry 或者存储，以便与所有其他内部实现一起使用。
选项通常定义如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Options <span style="color:#8be9fd;font-style:italic">struct</span> {
    Name        <span style="color:#8be9fd">string</span>
    Version     <span style="color:#8be9fd">string</span>
    Broker      broker.Broker
    Registry    registry.Registry
}


<span style="color:#8be9fd;font-style:italic">type</span> Option <span style="color:#8be9fd;font-style:italic">func</span>(<span style="color:#ff79c6">*</span>Options)

<span style="color:#6272a4">// set the name
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Name</span>(n <span style="color:#8be9fd">string</span>) Option {
    <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(o <span style="color:#ff79c6">*</span>Options) {
        o.Name = n
    }
}

<span style="color:#6272a4">// set the broker
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Broker</span>(b broker.Broker) Option {
    <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(o <span style="color:#ff79c6">*</span>Options) {
        o.Broker = b
    }
}
</code></pre></div><p>然后这安装如下方式设置这些选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">service <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
    vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;foobar&#34;</span>),
    vine.<span style="color:#50fa7b">Broker</span>(broker),
)
</code></pre></div><h2 id="服务-options">服务 options</h2>
<p>在 <strong>Vine</strong> 中，我们有可以设置多种选项，包括用于身份验证，配置和存储等内容的基础包。你可以使用 <code>service.Options()</code> 来访问这些。</p>
<p>auth、config、registry、cache 等包将默认为我们的零依赖插件。可以通过设置环境变量或者命令行参数来配置它们，在执行 <code>service.Init()</code> 后生效。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4">## as an env vars</span>
<span style="color:#8be9fd;font-style:italic">VINE_CACHE</span><span style="color:#ff79c6">=</span>file go run main.go

<span style="color:#6272a4">## or as a flag</span>
go run main.go --cache<span style="color:#ff79c6">=</span>file
</code></pre></div><h2 id="使用-options">使用 options</h2>
<p>在内部，可以通过选项访问存储：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">service <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
    vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;foobar&#34;</span>),
)

service.<span style="color:#50fa7b">Init</span>()

store <span style="color:#ff79c6">:=</span> service.<span style="color:#50fa7b">Options</span>().Store
</code></pre></div><blockquote>
<p><strong>Vine</strong> 每个内部接口一般都有对应的选项，在插件中，额外的选项通常被保存在 <code>context.Context</code> 中。</p>
</blockquote>
<h2 id="自定义-options">自定义 options</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">custom <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(s <span style="color:#8be9fd">string</span>) vine.Option {
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(o <span style="color:#ff79c6">*</span>vine.Options) {
		o.Context = context.<span style="color:#50fa7b">WithValue</span>(o.Context, s, s)
	}
}
	
vine.<span style="color:#50fa7b">NewService</span>(<span style="color:#50fa7b">custom</span>(<span style="color:#f1fa8c">&#34;value&#34;</span>))
</code></pre></div><h2 id="所有-options">所有 options</h2>
<p>vine 服务初始化是，支持以下 options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">vine.<span style="color:#50fa7b">Name</span>(),            <span style="color:#6272a4">// 微服务名称
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Id</span>(),              <span style="color:#6272a4">// 微服务 uuid
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Version</span>(),         <span style="color:#6272a4">// 微服务版本
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Address</span>(),         <span style="color:#6272a4">// 微服务绑定地址
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Metadata</span>(),        <span style="color:#6272a4">// 微服务 metadata
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Server</span>(),          <span style="color:#6272a4">// 设置内部 Server 模块
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Client</span>(),          <span style="color:#6272a4">// 设置内部 Client 模块
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Selector</span>(),        <span style="color:#6272a4">// 设置 client selector 
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">HandleSignal</span>(),    <span style="color:#6272a4">// 是否处理系统信号
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Context</span>(),         <span style="color:#6272a4">// 设置 Context 
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Broker</span>(),          <span style="color:#6272a4">// 设置内部 broker 模块
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Registry</span>(),        <span style="color:#6272a4">// 设置内部 Registry 模块
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">RegisterTTL</span>(),     <span style="color:#6272a4">// 服务注册有效时间
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">RegisterInterval</span>(), <span style="color:#6272a4">// 服务注册间隔，必须小于 ttl
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Tracer</span>(),          <span style="color:#6272a4">// 设置 Trace 模块
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Dialect</span>(),         <span style="color:#6272a4">// 设置 Dialect 模块
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Cmd</span>(),             <span style="color:#6272a4">// 设置 Cmd 模块
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Action</span>(),          <span style="color:#6272a4">// 设置 Cmd Action 回调函数
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">Flags</span>(),           <span style="color:#6272a4">// 添加 Cmd Flags 
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">WrapHandler</span>(),     <span style="color:#6272a4">// 添加 Server 请求拦截器
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">WrapClient</span>(),      <span style="color:#6272a4">// 添加 Client 请求拦截器
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">WrapCall</span>(),        <span style="color:#6272a4">// 添加 Client Call 请求拦截器
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">WrapSubscriber</span>(),  <span style="color:#6272a4">// 添加 Broker 拦截器
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">BeforeStart</span>(),     <span style="color:#6272a4">// 追加服务 Start 方法前的回调
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">BeforeStop</span>(),      <span style="color:#6272a4">// 追加服务 Stop 方法前的回调
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">AfterStart</span>(),      <span style="color:#6272a4">// 追加服务 Start 方法后的回调
</span><span style="color:#6272a4"></span>vine.<span style="color:#50fa7b">AfterStop</span>(),       <span style="color:#6272a4">// 追加服务 Stop 方法后的回调
</span></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6315071e53a7aa2cbc40cd1587b5d32b">1.6 - 插件中心</h1>
    
	<h2 id="概述">概述</h2>
<p><strong>Vine</strong> 构建在 Go 接口之上。因此这些接口的实现是可插拔的。</p>
<p>默认情况下，<strong>Vine</strong> 只提供核心上每个接口的几个实现，但它完全是可插拔的。而额外的实现保存在 <a href="https://github.com/vine-io/plugins">plugins</a>。</p>
<h2 id="添加插件">添加插件</h2>
<p>如果要集成插件，只需将它们链接到单独的文件中并重新生成。
创建 plugins.go 文件并导入所需的插件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
    <span style="color:#6272a4">// etcd registry
</span><span style="color:#6272a4"></span>    _ <span style="color:#f1fa8c">&#34;github.com/vine-io/plugins/registry/etcd&#34;</span>
    <span style="color:#6272a4">// nats broker
</span><span style="color:#6272a4"></span>    _ <span style="color:#f1fa8c">&#34;github.com/vine-io/plugins/broker/nats&#34;</span>
)
</code></pre></div><p>通过包含插件文件来构建应用程序：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go build -o service main.go plugins.go
</code></pre></div><p>使用插件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">service --registry<span style="color:#ff79c6">=</span>etcd --broker<span style="color:#ff79c6">=</span>nats
</code></pre></div><p>或者使用环境变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8be9fd;font-style:italic">VINE_REGISTRY</span><span style="color:#ff79c6">=</span>etcd <span style="color:#8be9fd;font-style:italic">VINE_BROKER</span><span style="color:#ff79c6">=</span>nats service
</code></pre></div><h2 id="插件选项">插件选项</h2>
<p>或者你可以将插件设置在选项中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
    <span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>

    <span style="color:#6272a4">// etcd registry
</span><span style="color:#6272a4"></span>    <span style="color:#f1fa8c">&#34;github.com/vine-io/plugins/registry/etcd&#34;</span>
    <span style="color:#6272a4">// nats broker
</span><span style="color:#6272a4"></span>    <span style="color:#f1fa8c">&#34;github.com/vine-io/plugins/broker/nats&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    registry <span style="color:#ff79c6">:=</span> etcd.<span style="color:#50fa7b">NewRegistry</span>()
    broker <span style="color:#ff79c6">:=</span> nats.<span style="color:#50fa7b">NewBroker</span>()

    service <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
        vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;greeter&#34;</span>),
        vine.<span style="color:#50fa7b">Registry</span>(registry),
        vine.<span style="color:#50fa7b">Broker</span>(broker),
    )

    service.<span style="color:#50fa7b">Init</span>()

    service.<span style="color:#50fa7b">Run</span>()
}
</code></pre></div><h2 id="编写插件">编写插件</h2>
<p>插件是一个建立在 Go 接口上的概念。每个包都维护一个高级接口抽象。只需实现接口并将其作为服务选项传递给它即可.</p>
<p>服务发现接口称为 <a href="https://pkg.go.dev/github.com/vine-io/vine/core/registry#Registry">Registry</a>. 实现此接口的任何内容都可以用作 <strong>Registry</strong>。这同样适用于其他包.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Registry <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#50fa7b">Register</span>(<span style="color:#ff79c6">*</span>Service, <span style="color:#ff79c6">...</span>RegisterOption) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Deregister</span>(<span style="color:#ff79c6">*</span>Service, <span style="color:#ff79c6">...</span>DeregisterOption) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">GetService</span>(<span style="color:#8be9fd">string</span>, <span style="color:#ff79c6">...</span>GetOption) ([]<span style="color:#ff79c6">*</span>Service, <span style="color:#8be9fd">error</span>)
	<span style="color:#50fa7b">ListServices</span>(<span style="color:#ff79c6">...</span>ListOption) ([]<span style="color:#ff79c6">*</span>Service, <span style="color:#8be9fd">error</span>)
	<span style="color:#50fa7b">Watch</span>(<span style="color:#ff79c6">...</span>WatchOption) (Watcher, <span style="color:#8be9fd">error</span>)
	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><p>查阅 <a href="https://github.com/vine-io/plugins">plugins</a> 可以更好地了解实现细节。</p>
<h2 id="插件列表">插件列表</h2>
<p>Registry 插件:</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/registry/etcd">etcd</a></li>
</ul>
<p>Broker 插件:</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/broker/nats">nats</a></li>
<li><a href="https://github.com/vine-io/plugins/tree/main/broker/redis">redis</a></li>
</ul>
<p>Dao 插件:</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/dao/mysql">mysql</a></li>
<li><a href="https://github.com/vine-io/plugins/tree/main/dao/postgres">postgresql</a></li>
<li><a href="https://github.com/vine-io/plugins/tree/main/dao/sqlite">sqlite</a></li>
</ul>
<p>Cache 插件:</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/cache/redis">redis</a></li>
</ul>
<p>Sync 插件：</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/sync/etcd">etcd</a></li>
<li><a href="https://github.com/vine-io/plugins/tree/main/sync/memory">memory</a></li>
</ul>
<p>Logger 插件:</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/logger/zap">zap</a></li>
</ul>
<p>Config Source 插件：</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/config/source/configmap">configmap</a></li>
<li><a href="https://github.com/vine-io/plugins/tree/main/config/source/etcd">etcd</a></li>
</ul>
<p>Wrapper 类</p>
<p>熔断器:</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/wrapper/breaker/gobreaker">gobreaker</a></li>
<li><a href="https://github.com/vine-io/plugins/tree/main/wrapper/breaker/hystrix">hystrix</a></li>
</ul>
<p>限流器:</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/wrapper/ratelimiter/ratelimiter">ratelimiter</a></li>
<li><a href="https://github.com/vine-io/plugins/tree/main/wrapper/ratelimiter/uber">uber</a></li>
</ul>
<p>链路追踪:</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/wrapper/trace/opentracing">opentracing</a></li>
</ul>
<p>数据校验:</p>
<ul>
<li><a href="https://github.com/vine-io/plugins/tree/main/wrapper/validator">validator</a></li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ceffc22118740feeb3d7861a1db173aa">2 - 框架组件</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-4bf4097c812f2b345e3a8236e52dae1a">2.1 - 服务注册发现</h1>
    
	<h2 id="概述">概述</h2>
<p><code>服务注册发现</code>模块是微服务的核心。服务端需要它来提供注册服务，登录服务自身信息。客户端需要它来根据名称查找服务地址。</p>
<p><strong>Vine</strong> 提供一个通用的 <code>Registry</code> 接口，描述 <code>服务注册发现</code> 模块的行为。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Registry <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span> <span style="color:#6272a4">// ------------------------------- 模块初始化
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options <span style="color:#6272a4">// ----------------------------------- 模块的配置信息
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Register</span>(<span style="color:#ff79c6">*</span>Service, <span style="color:#ff79c6">...</span>RegisterOption) <span style="color:#8be9fd">error</span> <span style="color:#6272a4">// --------- 注册服务
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Deregister</span>(<span style="color:#ff79c6">*</span>Service, <span style="color:#ff79c6">...</span>DeregisterOption) <span style="color:#8be9fd">error</span> <span style="color:#6272a4">// ----- 注销服务
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">GetService</span>(<span style="color:#8be9fd">string</span>, <span style="color:#ff79c6">...</span>GetOption) ([]<span style="color:#ff79c6">*</span>Service, <span style="color:#8be9fd">error</span>) <span style="color:#6272a4">//- 根据名称查找服务
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">ListServices</span>(<span style="color:#ff79c6">...</span>ListOption) ([]<span style="color:#ff79c6">*</span>Service, <span style="color:#8be9fd">error</span>) <span style="color:#6272a4">// ----- 查询所有服务
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Watch</span>(<span style="color:#ff79c6">...</span>WatchOption) (Watcher, <span style="color:#8be9fd">error</span>) <span style="color:#6272a4">// -------------- 监听服务变化
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span> <span style="color:#6272a4">// ------------------------------------- 查询实现 Registry 接口的具体类型
</span><span style="color:#6272a4"></span>}
</code></pre></div><h2 id="使用">使用</h2>
<p>在此我们提供一个完整的代码来介绍 <code>Registry</code> 的具体使用方式:</p>
<h3 id="初始化">初始化</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry/mdns&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// 创建新的 Registry
</span><span style="color:#6272a4"></span>	r <span style="color:#ff79c6">:=</span> mdns.<span style="color:#50fa7b">NewRegistry</span>()
	<span style="color:#6272a4">// 初始化
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> r.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
}
</code></pre></div><h3 id="注册和注销服务">注册和注销服务</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// 创建新的服务
</span><span style="color:#6272a4"></span>	svc <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>registry.Service{
		Name:     <span style="color:#f1fa8c">&#34;go.vine.test&#34;</span>,   <span style="color:#6272a4">// 服务名称，唯一值
</span><span style="color:#6272a4"></span>		Version:  <span style="color:#f1fa8c">&#34;v1.0.0&#34;</span>,         <span style="color:#6272a4">// 服务版本
</span><span style="color:#6272a4"></span>		Metadata: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;Content-Type&#34;</span>: <span style="color:#f1fa8c">&#34;application/json&#34;</span>},  <span style="color:#6272a4">// 元数据
</span><span style="color:#6272a4"></span>		Endpoints: []<span style="color:#ff79c6">*</span>registry.Endpoint{        <span style="color:#6272a4">// 服务接口
</span><span style="color:#6272a4"></span>			{
				Name:     <span style="color:#f1fa8c">&#34;&#34;</span>,
				Request:  <span style="color:#ff79c6">nil</span>,
				Response: <span style="color:#ff79c6">nil</span>,
				Metadata: <span style="color:#ff79c6">nil</span>,
			},
		},
		Nodes: []<span style="color:#ff79c6">*</span>registry.Node{     <span style="color:#6272a4">// 该服务下的节点信息, 节点的 ID 必须是不同的，当一个 `Registry` 中多次注册相同服务时，服务的该字段就会合并
</span><span style="color:#6272a4"></span>			{
				Id:       uuid.<span style="color:#50fa7b">New</span>().<span style="color:#50fa7b">String</span>(),
				Address:  <span style="color:#f1fa8c">&#34;127.0.0.1:11500&#34;</span>,
				<span style="color:#6272a4">//Port:     11500,
</span><span style="color:#6272a4"></span>				Metadata: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;os&#34;</span>: <span style="color:#f1fa8c">&#34;linux&#34;</span>},
			},
		},
		TTL:  <span style="color:#bd93f9">30</span>,  <span style="color:#6272a4">// 服务过期时间，单位秒
</span><span style="color:#6272a4"></span>		Apis: <span style="color:#ff79c6">nil</span>, <span style="color:#6272a4">// swagger 信息
</span><span style="color:#6272a4"></span>	}

	<span style="color:#6272a4">// 注册服务
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> r.<span style="color:#50fa7b">Register</span>(svc); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	<span style="color:#6272a4">// 注销服务
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> r.<span style="color:#50fa7b">Deregister</span>(svc); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
}
</code></pre></div><h3 id="查询服务">查询服务</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// 查询所有服务
</span><span style="color:#6272a4"></span>	list, err <span style="color:#ff79c6">:=</span> r.<span style="color:#50fa7b">ListServices</span>()
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	<span style="color:#ff79c6">for</span> _, item <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> list {
		fmt.<span style="color:#50fa7b">Println</span>(item.Name)
	}

	<span style="color:#6272a4">// 查询单个服务
</span><span style="color:#6272a4"></span>	list, err = r.<span style="color:#50fa7b">GetService</span>(<span style="color:#f1fa8c">&#34;go.vine.test&#34;</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	<span style="color:#ff79c6">for</span> _, item <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> list {
		fmt.<span style="color:#50fa7b">Println</span>(item.Name, <span style="color:#8be9fd;font-style:italic">len</span>(item.Nodes))
	}
}
</code></pre></div><blockquote>
<p>ListService() 方法获取的结果，数据是不完整的，只含有包括服务名称在内的少量信息。</p>
</blockquote>
<h3 id="监听服务">监听服务</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// 启动一个监听器
</span><span style="color:#6272a4"></span>	watcher, err <span style="color:#ff79c6">:=</span> r.<span style="color:#50fa7b">Watch</span>(registry.<span style="color:#50fa7b">WatchService</span>(<span style="color:#f1fa8c">&#34;go.vine.test&#34;</span>))
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	<span style="color:#6272a4">// 停止监听器
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">defer</span> watcher.<span style="color:#50fa7b">Stop</span>()
	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		<span style="color:#ff79c6">for</span> {
			e, err <span style="color:#ff79c6">:=</span> watcher.<span style="color:#50fa7b">Next</span>() <span style="color:#6272a4">// 这里会阻塞，直到返回事假
</span><span style="color:#6272a4"></span>			<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
				<span style="color:#ff79c6">return</span>
			}
			fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;%d: %s, %s\n&#34;</span>,  e.Timestamp, e.Action, e.Service.Name)
		}
	}()
}
</code></pre></div><h3 id="替换服务的-registry">替换服务的 <code>Registry</code></h3>
<p><strong>Vine</strong> 服务默认 <code>Registry</code> 为 <code>mdns</code>。尝试去替换成 <code>memory</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry/memory&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	mr <span style="color:#ff79c6">:=</span> memory.<span style="color:#50fa7b">NewRegistry</span>()
	vine.<span style="color:#50fa7b">NewService</span>(vine.<span style="color:#50fa7b">Registry</span>(mr))
}
</code></pre></div><h2 id="options">options</h2>
<p><code>Registry</code> 接口的几个方法都支持 Options。</p>
<p>创建 <code>NewRegistry(opts...)</code> 和 初始化 <code>Init(opts...)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memory.<span style="color:#50fa7b">NewRegistry</span>(
	<span style="color:#6272a4">// Registry 的 ip 地址
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">Addrs</span>(addrs <span style="color:#ff79c6">...</span><span style="color:#8be9fd">string</span>),
	<span style="color:#6272a4">// 连接超时时间
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">Timeout</span>(t time.Duration),
	<span style="color:#6272a4">// 安全通讯
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">Secure</span>(b <span style="color:#8be9fd">bool</span>),
	<span style="color:#6272a4">// 安全通讯所需证书信息
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">TLSConfig</span>(t <span style="color:#ff79c6">*</span>tls.Config),
)
</code></pre></div><p>注册服务 <code>Register(svc, opts...)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memory.<span style="color:#50fa7b">Register</span>(svc,
	<span style="color:#6272a4">// 服务过期时间
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">RegisterTTL</span>(ttl <span style="color:#8be9fd">int64</span>), 
	<span style="color:#6272a4">// 上下文信息
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">RegisterContext</span>(ctx context.Context),
)
</code></pre></div><p>注销服务 <code>Deregister(svc, opts...)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memory.<span style="color:#50fa7b">Deregister</span>(svc,
	registry.<span style="color:#50fa7b">DeregisterContext</span>(ctx context.Context),
)
</code></pre></div><p>查询所有服务 <code>ListServices(opts...)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memory.<span style="color:#50fa7b">ListServices</span>(svc,
	registry.<span style="color:#50fa7b">ListServicesContext</span>(ctx context.Context),
)
</code></pre></div><p>根据名称获取服务 <code>GetService(name, opts...)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memory.<span style="color:#50fa7b">GetService</span>(svc,
	registry.<span style="color:#50fa7b">GetServiceContext</span>(ctx context.Context),
)
</code></pre></div><p>监听服务 <code>Watch(opts...)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memory.<span style="color:#50fa7b">Watch</span>(svc,
    <span style="color:#6272a4">// 监听单个服务
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">WatchService</span>(name <span style="color:#8be9fd">string</span>),
	registry.<span style="color:#50fa7b">WatchServiceContext</span>(ctx context.Context),
)
</code></pre></div><h2 id="插件">插件</h2>
<p><strong>Vine</strong> 目前自带的 <code>Registry</code> 实现有:</p>
<ul>
<li>memory</li>
<li>mdns</li>
</ul>
<p>第三方的实现请参考 <a href="https://github.com/vine-io/plugins/tree/main/registry">registry</a></p>
<h3 id="etcd">etcd</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/cmd&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/plugins/registry/etcd&#34;</span>
)
	
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	er <span style="color:#ff79c6">:=</span> etcd.<span style="color:#50fa7b">NewRegistry</span>()
	vine.<span style="color:#50fa7b">NewService</span>(vine.<span style="color:#50fa7b">Registry</span>(er))
}
</code></pre></div><h2 id="服务启动">服务启动</h2>
<p><strong>Vine</strong> 服务以插件的方式，注册多种实现，用户可以再服务启动时选择喜欢的类型。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./helloworld --registy<span style="color:#ff79c6">=</span>etcd --registry-address<span style="color:#ff79c6">=</span>127.0.0.1:2379
<span style="color:#6272a4"># 或者使用环境变量</span>
<span style="color:#8be9fd;font-style:italic">VINE_REGISTRY</span><span style="color:#ff79c6">=</span>ETCD <span style="color:#8be9fd;font-style:italic">VINE_REGISTRY_ADDRESS</span><span style="color:#ff79c6">=</span>127.0.0.1:2379 ./helloworld
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f375a1b0338deecef74fa867c6bb7ed5">2.2 - 服务网关</h1>
    
	<h2 id="概述">概述</h2>
<p><strong>API</strong> 是一个可插拔的 API 接口，由 <strong>Registry</strong> 驱动，可帮助构建强大的公共 API 网关.</p>
<p><strong>API</strong> 库提供 api 网关路由功能。微服务体系结构将应用程序逻辑分离到单独的服务中. api 网关提供单个入口点，以将这些服务合并到统一 api 中。 <strong>API</strong> 使用在 <strong>Registry</strong> 元数据中定义的路由来生成路由规则并服务 http 请求.</p>
<h2 id="启动-api-服务">启动 api 服务</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4"># 提供 http 服务和 swagger </span>
vine api --handler<span style="color:#ff79c6">=</span>rpc --enable-openapi
</code></pre></div><h2 id="创建网关">创建网关</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine new gateway api
</code></pre></div><p>启动</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go run cmd/api/main.go --api-address<span style="color:#ff79c6">=</span>127.0.0.1:8080
</code></pre></div><blockquote>
<p>一个服务同时提供 gRPC 和 http 接口可以参考 <a href="https://github.com/vine-io/examples/tree/main/api">api</a></p>
</blockquote>
<h2 id="测试">测试</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -X POST <span style="color:#f1fa8c">&#34;http://127.0.0.1:8080/helloworld/v1/helloworld/Call&#34;</span> -H  <span style="color:#f1fa8c">&#34;accept: application/json&#34;</span> -H  <span style="color:#f1fa8c">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#f1fa8c">&#34;{\&#34;name\&#34;:\&#34;hello\&#34;}&#34;</span>
&gt; <span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;reply: hello&#34;</span><span style="color:#ff79c6">}</span>
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fa10acc15b4e6765d798505e47c766c2">2.3 - 序列化</h1>
    
	<h2 id="概述">概述</h2>
<p>我们抽象出 <code>Codec</code> 和 <code>Marshaler</code> 接口来统一管理数据的序列化和反序列功能。<code>Codec</code> 被 <code>Server</code> 和 <code>Client</code> 使用作为数据解析工具。<code>Marshaler</code> 为用户提供数据转化工具。</p>
<p>目前 <code>Marshaler</code> 接口支持以下格式：</p>
<ul>
<li>yaml</li>
<li>json</li>
<li>bytes</li>
<li>proto</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Codec <span style="color:#8be9fd;font-style:italic">interface</span> {
	Reader
	Writer
	<span style="color:#50fa7b">Close</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}

<span style="color:#8be9fd;font-style:italic">type</span> Reader <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">ReadHeader</span>(<span style="color:#ff79c6">*</span>Message, MessageType) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">ReadBody</span>(<span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
}

<span style="color:#8be9fd;font-style:italic">type</span> Writer <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Write</span>(<span style="color:#ff79c6">*</span>Message, <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
}

<span style="color:#8be9fd;font-style:italic">type</span> Marshaler <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Marshal</span>(<span style="color:#8be9fd;font-style:italic">interface</span>{}) ([]<span style="color:#8be9fd">byte</span>, <span style="color:#8be9fd">error</span>)
	<span style="color:#50fa7b">Unmarshal</span>([]<span style="color:#8be9fd">byte</span>, <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><h2 id="具体实现">具体实现</h2>
<p>只要用户提供了 <code>Marshal</code>, <code>Unmarshal</code> 和 <code>String</code> 方法即可实现 <code>Marshaler</code> 接口，以下提供一个完整的 <code>json</code> 版本代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#8be9fd;font-style:italic">var</span> jsonbMarshaler = <span style="color:#ff79c6">&amp;</span>mjsonpb.Marshaler{}

<span style="color:#6272a4">// create buffer pool with 16 instances each preallocated with 256 bytes
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">var</span> bufferPool = bpool.<span style="color:#50fa7b">NewSizedBufferPool</span>(<span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">256</span>)

<span style="color:#8be9fd;font-style:italic">type</span> Marshaler <span style="color:#8be9fd;font-style:italic">struct</span>{}

<span style="color:#8be9fd;font-style:italic">func</span> (j Marshaler) <span style="color:#50fa7b">Marshal</span>(v <span style="color:#8be9fd;font-style:italic">interface</span>{}) ([]<span style="color:#8be9fd">byte</span>, <span style="color:#8be9fd">error</span>) {
	<span style="color:#ff79c6">if</span> pb, ok <span style="color:#ff79c6">:=</span> v.(proto.Message); ok {
		buf <span style="color:#ff79c6">:=</span> bufferPool.<span style="color:#50fa7b">Get</span>()
		<span style="color:#ff79c6">defer</span> bufferPool.<span style="color:#50fa7b">Put</span>(buf)
		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> jsonbMarshaler.<span style="color:#50fa7b">Marshal</span>(buf, pb); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
			<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
		}
		<span style="color:#ff79c6">return</span> buf.<span style="color:#50fa7b">Bytes</span>(), <span style="color:#ff79c6">nil</span>
	}
	<span style="color:#ff79c6">return</span> json.<span style="color:#50fa7b">Marshal</span>(v)
}

<span style="color:#8be9fd;font-style:italic">func</span> (j Marshaler) <span style="color:#50fa7b">Unmarshal</span>(d []<span style="color:#8be9fd">byte</span>, v <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span> {
	<span style="color:#ff79c6">if</span> pb, ok <span style="color:#ff79c6">:=</span> v.(proto.Message); ok {
		<span style="color:#ff79c6">return</span> mjsonpb.<span style="color:#50fa7b">Unmarshal</span>(bytes.<span style="color:#50fa7b">NewReader</span>(d), pb)
	}
	<span style="color:#ff79c6">return</span> json.<span style="color:#50fa7b">Unmarshal</span>(d, v)
}

<span style="color:#8be9fd;font-style:italic">func</span> (j Marshaler) <span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span> {
	<span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;json&#34;</span>
}
</code></pre></div><h2 id="使用">使用</h2>
<h3 id="注册">注册</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	encoding.<span style="color:#50fa7b">RegisterMarshaler</span>(<span style="color:#f1fa8c">&#34;json&#34;</span>, <span style="color:#ff79c6">&amp;</span>Marshaler{})
}
</code></pre></div><h3 id="获取">获取</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	m, ok <span style="color:#ff79c6">:=</span> encoding.<span style="color:#50fa7b">GetMarshaler</span>(<span style="color:#f1fa8c">&#34;json&#34;</span>)
}
</code></pre></div><h3 id="序列化和反序列化">序列化和反序列化</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/codec/encoding&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">type</span> Person <span style="color:#8be9fd;font-style:italic">struct</span> {
	Name <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;name&#34;`</span>
	Age  <span style="color:#8be9fd">int32</span>  <span style="color:#f1fa8c">`json:&#34;age&#34;`</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	m, _ <span style="color:#ff79c6">:=</span> encoding.<span style="color:#50fa7b">GetMarshaler</span>(<span style="color:#f1fa8c">&#34;json&#34;</span>)
	p <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>Person{
		Name: <span style="color:#f1fa8c">&#34;Vine&#34;</span>,
		Age:  <span style="color:#bd93f9">20</span>,
	}

	data, _ <span style="color:#ff79c6">:=</span> m.<span style="color:#50fa7b">Marshal</span>(p)
	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#8be9fd;font-style:italic">string</span>(data))

	p1 <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">new</span>(Person)
	m.<span style="color:#50fa7b">Unmarshal</span>(data, <span style="color:#ff79c6">&amp;</span>p1)
	fmt.<span style="color:#50fa7b">Println</span>(p1.Name)
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-59586a1fa5b90047cde9c17a0fe343a1">2.4 - 订阅发布</h1>
    
	<h2 id="概述">概述</h2>
<p>微服务是一种事件驱动的体系结构模式，因此 <strong>Vine</strong> 使用消息代理接口构建异步消息的概念。它可为用户无缝地运行 protobuf 类型，并自动编码和解码消息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Broker is an interface used for asynchronous messaging.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Broker <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#50fa7b">Address</span>() <span style="color:#8be9fd">string</span>
	<span style="color:#50fa7b">Connect</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Disconnect</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Publish</span>(topic <span style="color:#8be9fd">string</span>, m <span style="color:#ff79c6">*</span>Message, opts <span style="color:#ff79c6">...</span>PublishOption) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Subscribe</span>(topic <span style="color:#8be9fd">string</span>, h Handler, opts <span style="color:#ff79c6">...</span>SubscribeOption) (Subscriber, <span style="color:#8be9fd">error</span>)
	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><p>默认情况下，vine 实现点对点 http 代理，但可以通过 <a href="https://github.com/vine-io/plugins/tree/main/broker">plugins</a> 替换实现。</p>
<h2 id="发布消息">发布消息</h2>
<p>使用 topic 名称和服务客户端创建一个新的发布者</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">p <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewEvent</span>(<span style="color:#f1fa8c">&#34;events&#34;</span>, service.<span style="color:#50fa7b">Client</span>())
</code></pre></div><p>发布 proto 消息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">p.<span style="color:#50fa7b">Publish</span>(context.<span style="color:#50fa7b">TODO</span>(), <span style="color:#ff79c6">&amp;</span>proto.Event{Name: <span style="color:#f1fa8c">&#34;event&#34;</span>})
</code></pre></div><h2 id="订阅">订阅</h2>
<p>创建消息处理程序。它的签名应该是 <code>func(context.Context, v interface{}) error</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">ProcessEvent</span>(ctx context.Context, event <span style="color:#ff79c6">*</span>proto.Event) <span style="color:#8be9fd">error</span> {
    fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;Got event %+v\n&#34;</span>, event)
    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}
</code></pre></div><p>使用 topic 注册消息处理程序</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">vine.<span style="color:#50fa7b">RegisterSubscriber</span>(<span style="color:#f1fa8c">&#34;events&#34;</span>, ProcessEvent)
</code></pre></div><p>完整实例可以看 <a href="https://github.com/vine-io/examples/tree/main/pubsub">example/pubsub</a></p>
<h2 id="单独使用-broker">单独使用 Broker</h2>
<p><code>Broker</code> 也可以单独使用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/service/broker&#34;</span>
	log <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/service/logger&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	topic <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;go.vine.topic.foo&#34;</span>

	b <span style="color:#ff79c6">:=</span> broker.<span style="color:#50fa7b">NewBroker</span>()

	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> b.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;Broker Init error: %v&#34;</span>, err)
	}
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> b.<span style="color:#50fa7b">Connect</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;Broker Connect error: %v&#34;</span>, err)
	}

	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		<span style="color:#6272a4">// receive message from broker
</span><span style="color:#6272a4"></span>		b.<span style="color:#50fa7b">Subscribe</span>(topic, <span style="color:#8be9fd;font-style:italic">func</span>(p broker.Event) <span style="color:#8be9fd">error</span> {
			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;[sub] received message:&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(p.<span style="color:#50fa7b">Message</span>().Body), <span style="color:#f1fa8c">&#34;header&#34;</span>, p.<span style="color:#50fa7b">Message</span>().Header)
			<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
		})
	}()

	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		<span style="color:#ff79c6">&lt;-</span>time.<span style="color:#50fa7b">After</span>(time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">1</span>)
		<span style="color:#6272a4">// publish message to broker
</span><span style="color:#6272a4"></span>        b.<span style="color:#50fa7b">Publish</span>(topic, <span style="color:#ff79c6">&amp;</span>broker.Message{Header: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;a&#34;</span>: <span style="color:#f1fa8c">&#34;b&#34;</span>}, Body: []<span style="color:#8be9fd;font-style:italic">byte</span>(<span style="color:#f1fa8c">&#34;hello world&#34;</span>)})
	}()

    time.<span style="color:#50fa7b">Sleep</span>(time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">2</span>)
    
    b.<span style="color:#50fa7b">Disconnect</span>()
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d2d36bead0be0a3b9422b2b89dcb6a4f">2.5 - 内部服务</h1>
    
	<h2 id="概述">概述</h2>
<p><code>Server</code> 是微服务的核心模块，它对外提供接口，根据不同的实现，提供相应类型的接口。目前内部支持:</p>
<ul>
<li>grpc</li>
<li>http</li>
</ul>
<p><code>Server</code> 依赖图</p>

<figure>
    <img src=" /vine/docs/component/server/2021-09-03-11-20-03.png " width="30%" height="30%"/> 
</figure>

<p>以下是 <code>Server</code> 模块的内部方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Server is a simple vine server abstraction
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Server <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#6272a4">// 初始化
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// 返回 Options
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#6272a4">// 注册 Handler
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Handle</span>(Handler) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// 创建一个新的 Handler
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">NewHandler</span>(<span style="color:#8be9fd;font-style:italic">interface</span>{}, <span style="color:#ff79c6">...</span>HandlerOption) Handler
	<span style="color:#6272a4">// 创建一个新的 Subscriber
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">NewSubscriber</span>(<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd;font-style:italic">interface</span>{}, <span style="color:#ff79c6">...</span>SubscriberOption) Subscriber
	<span style="color:#6272a4">// 注册 Subscriber
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Subscribe</span>(Subscriber) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// 启动服务
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Start</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// 停止服务
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Stop</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Server 接口类型
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><h2 id="使用方法">使用方法</h2>
<h3 id="启动一个-grpc-服务">启动一个 grpc 服务</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;log&#34;</span>
	<span style="color:#f1fa8c">&#34;os&#34;</span>
	<span style="color:#f1fa8c">&#34;os/signal&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/broker/memory&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry/mdns&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/server&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/server/grpc&#34;</span>
	usignal <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/util/signal&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// 新建 gRPC 服务
</span><span style="color:#6272a4"></span>	s <span style="color:#ff79c6">:=</span> grpc.<span style="color:#50fa7b">NewServer</span>(
		server.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;helloworld&#34;</span>),
		server.<span style="color:#50fa7b">Address</span>(<span style="color:#f1fa8c">&#34;:9000&#34;</span>),
		server.<span style="color:#50fa7b">Broker</span>(memory.<span style="color:#50fa7b">NewBroker</span>()),
		server.<span style="color:#50fa7b">Registry</span>(mdns.<span style="color:#50fa7b">NewRegistry</span>()),
	)
	<span style="color:#6272a4">// 初始化
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;grpc init: %v&#34;</span>, err)
	}
	<span style="color:#6272a4">// 启动服务, (非阻塞)
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Start</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;grpc start: %v&#34;</span>, err)
	}
	<span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>	ch <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> os.Signal, <span style="color:#bd93f9">1</span>)
	signal.<span style="color:#50fa7b">Notify</span>(ch, usignal.<span style="color:#50fa7b">Shutdown</span>()<span style="color:#ff79c6">...</span>)

	<span style="color:#ff79c6">select</span> {
	<span style="color:#6272a4">// wait on kill signal
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">case</span> <span style="color:#ff79c6">&lt;-</span>ch:
	}

    <span style="color:#6272a4">// 停止服务
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Stop</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;grpc stop: %v&#34;</span>, err)
	}
}
</code></pre></div><h3 id="注册-handler">注册 Handler</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">...</span>

<span style="color:#8be9fd;font-style:italic">type</span> HelloImpl <span style="color:#8be9fd;font-style:italic">struct</span> {

}

<span style="color:#8be9fd;font-style:italic">var</span> _ proto.Message = (<span style="color:#ff79c6">*</span>Request)(<span style="color:#ff79c6">nil</span>)
<span style="color:#8be9fd;font-style:italic">type</span> Request <span style="color:#8be9fd;font-style:italic">struct</span> {
	Name <span style="color:#8be9fd">string</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>Request) <span style="color:#50fa7b">Reset</span>() {
	r = <span style="color:#ff79c6">&amp;</span>Request{}
}

<span style="color:#8be9fd;font-style:italic">func</span> (r Request) <span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span> {
	<span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> (r Request) <span style="color:#50fa7b">ProtoMessage</span>() {

}


<span style="color:#8be9fd;font-style:italic">type</span> Response <span style="color:#8be9fd;font-style:italic">struct</span> {
	Name <span style="color:#8be9fd">string</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> (h <span style="color:#ff79c6">*</span>HelloImpl) <span style="color:#50fa7b">Get</span>(ctx context.Context, r <span style="color:#ff79c6">*</span>Request, rsp <span style="color:#ff79c6">*</span>Response) <span style="color:#8be9fd">error</span> {
	rsp.Name = r.Name
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}
<span style="color:#ff79c6">...</span>

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#ff79c6">...</span>
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;grpc init: %v&#34;</span>, err)
	}

	h <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>HelloImpl{}
	opts <span style="color:#ff79c6">:=</span> []server.HandlerOption{
		api.<span style="color:#50fa7b">WithEndpoint</span>(<span style="color:#ff79c6">&amp;</span>api.Endpoint{
			Name:        <span style="color:#f1fa8c">&#34;HelloWorld.Get&#34;</span>,
			Description: <span style="color:#f1fa8c">&#34;HelloWorld.Get&#34;</span>,
			Path:        []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;/api/v1/get&#34;</span>},
			Method:      []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;GET&#34;</span>},
			Body:        <span style="color:#f1fa8c">&#34;*&#34;</span>,
			Handler:     <span style="color:#f1fa8c">&#34;rpc&#34;</span>,
		}),
	}
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Handle</span>(s.<span style="color:#50fa7b">NewHandler</span>(h, opts<span style="color:#ff79c6">...</span>)); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;register handler: %v&#34;</span>, err)
	}
	<span style="color:#ff79c6">...</span>
}
</code></pre></div><h3 id="注册-subscriber">注册 Subscriber</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Alternatively a function can be used
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">subEv</span>(ctx context.Context, event <span style="color:#ff79c6">*</span>Request) <span style="color:#8be9fd">error</span> {
	md, _ <span style="color:#ff79c6">:=</span> metadata.<span style="color:#50fa7b">FromContext</span>(ctx)
	log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;[pubsub.2] Received event %+v with metadata %+v\n&#34;</span>, event, md)
	<span style="color:#6272a4">// do something with event
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#ff79c6">...</span>
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;grpc init: %v&#34;</span>, err)
	}

	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Subscribe</span>(s.<span style="color:#50fa7b">NewSubscriber</span>(<span style="color:#f1fa8c">&#34;get.topic&#34;</span>, subEv, server.<span style="color:#50fa7b">SubscriberQueue</span>(<span style="color:#f1fa8c">&#34;sub&#34;</span>))); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;register subscribe: %v&#34;</span>, err)
	}
	<span style="color:#ff79c6">...</span>
}
</code></pre></div><h2 id="options">options</h2>
<p>使用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	s <span style="color:#ff79c6">:=</span> grpc.<span style="color:#50fa7b">NewServer</span>(server.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;name&#34;</span>))
}
</code></pre></div><p><code>Server</code> 创建和初始化 options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span>  <span style="color:#50fa7b">main</span>() {
	grpc.<span style="color:#50fa7b">NewServer</span>(
		<span style="color:#6272a4">// 设置服务名称
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Name</span>(),
		<span style="color:#6272a4">// 设置公共 IP 地址
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Advertise</span>(),
		<span style="color:#6272a4">// 设置服务绑定地址，如果 Advertise 不为空，优先选择 Advertise
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Address</span>(),
		<span style="color:#6272a4">// 设置服务 id
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Id</span>(),
		<span style="color:#6272a4">// 设置服务 版本
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Version</span>(),
		<span style="color:#6272a4">// 设置服务 context.Context, 保存额外的值
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Context</span>(),
		<span style="color:#6272a4">// 设置服务序列化
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Codec</span>(),
		<span style="color:#6272a4">// 设置服务依赖的 Broker
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Broker</span>(memory.<span style="color:#50fa7b">NewBroker</span>()),
		<span style="color:#6272a4">// 设置服务依赖的 Registry
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Registry</span>(mdns.<span style="color:#50fa7b">NewRegistry</span>()),
		<span style="color:#6272a4">// 添加 Subscriber 处理器的装载器
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">WrapSubscriber</span>(),
		<span style="color:#6272a4">// 添加 Handler 装载器
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">WrapHandler</span>(),
		<span style="color:#6272a4">// 设置服务注册时的 ttl
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">RegisterTTL</span>(),
		<span style="color:#6272a4">// 设置服务注册间隔时间
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">RegisterInterval</span>(),
		<span style="color:#6272a4">// 设置内部 sync.WaitGroup
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Wait</span>(),
		<span style="color:#6272a4">// 设置服务元数据
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Metadata</span>(),
		<span style="color:#6272a4">// 设置服务启动时注册到 Registry 的检测函数
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">RegisterCheck</span>(<span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context) <span style="color:#8be9fd">error</span> {
			<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
		}),
		<span style="color:#6272a4">// 设置服务 Router
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">WithRouter</span>(),
	)
}
</code></pre></div><p>创建 Handler 的 options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	s.<span style="color:#50fa7b">NewHandler</span>(h,
		server.<span style="color:#50fa7b">InternalHandler</span>(), <span style="color:#6272a4">// 内部 handler
</span><span style="color:#6272a4"></span>		api.<span style="color:#50fa7b">WithEndpoint</span>(),   <span style="color:#6272a4">// 添加 api 信息
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">OpenAPIHandler</span>(), <span style="color:#6272a4">// 添加 swagger 信息
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p>创建 Subscriber 的 options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	s.<span style="color:#50fa7b">NewSubscriber</span>(<span style="color:#f1fa8c">&#34;topic&#34;</span>, subEv,
		server.<span style="color:#50fa7b">InternalSubscriber</span>(), <span style="color:#6272a4">// 内部 internal
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">SubscriberQueue</span>(),   <span style="color:#6272a4">// 设置 subscriber 队列
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">SubscriberContext</span>(), <span style="color:#6272a4">// subscriber 内部 context.Context
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><h2 id="grpc-结合-http">gRPC 结合 http</h2>
<p><code>Server</code> 的 gRPC 实现可以同时提供 gRPC 和 http 服务:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	gh <span style="color:#ff79c6">:=</span> grpc.Grpc2Http{
		CertFile: <span style="color:#f1fa8c">&#34;server.pem&#34;</span>,
		KeyFile:  <span style="color:#f1fa8c">&#34;server.key&#34;</span>,
		CaFile:   <span style="color:#f1fa8c">&#34;ca.pem&#34;</span>,
	}
	grpc.<span style="color:#50fa7b">NewServer</span>(grpc.<span style="color:#50fa7b">GrpcToHttp</span>(gh))
}
</code></pre></div><blockquote>
<p>grpc 内置 prometheus metrics 和 golang http prof 接口</p>
</blockquote>
<h2 id="http-实现">http 实现</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	reg <span style="color:#ff79c6">:=</span> memory.<span style="color:#50fa7b">NewRegistry</span>()
	bro <span style="color:#ff79c6">:=</span> membroker.<span style="color:#50fa7b">NewBroker</span>()

	<span style="color:#6272a4">// create server
</span><span style="color:#6272a4"></span>	srv <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">NewServer</span>(server.<span style="color:#50fa7b">Registry</span>(reg), server.<span style="color:#50fa7b">Broker</span>(bro))

	<span style="color:#6272a4">// create server mux
</span><span style="color:#6272a4"></span>	mux <span style="color:#ff79c6">:=</span> http.<span style="color:#50fa7b">NewServeMux</span>()
	mux.<span style="color:#50fa7b">HandleFunc</span>(<span style="color:#f1fa8c">&#34;/&#34;</span>, <span style="color:#8be9fd;font-style:italic">func</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request) {
		w.<span style="color:#50fa7b">Write</span>([]<span style="color:#8be9fd;font-style:italic">byte</span>(<span style="color:#f1fa8c">`hello world`</span>))
	})

	<span style="color:#6272a4">// create handler
</span><span style="color:#6272a4"></span>	hd <span style="color:#ff79c6">:=</span> srv.<span style="color:#50fa7b">NewHandler</span>(mux)

	<span style="color:#6272a4">// register handler
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> srv.<span style="color:#50fa7b">Handle</span>(hd); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		t.<span style="color:#50fa7b">Fatal</span>(err)
	}

	<span style="color:#6272a4">// start server
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> srv.<span style="color:#50fa7b">Start</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		t.<span style="color:#50fa7b">Fatal</span>(err)
	}

	<span style="color:#ff79c6">select</span>{}
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-890777915678ed57c745424af4cba2b8">2.6 - 内部请求</h1>
    
	<h2 id="概述">概述</h2>
<p><code>Client</code> 是微服务的核心模块，提供一个请求其他服务的工具，根据不同的实现，提供相应类型的接口。目前内部支持:</p>
<ul>
<li>grpc</li>
<li>http</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Client <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#50fa7b">NewMessage</span>(topic <span style="color:#8be9fd">string</span>, msg <span style="color:#8be9fd;font-style:italic">interface</span>{}, opts <span style="color:#ff79c6">...</span>MessageOption) Message
	<span style="color:#50fa7b">NewRequest</span>(service, endpoint <span style="color:#8be9fd">string</span>, req <span style="color:#8be9fd;font-style:italic">interface</span>{}, reqOpts <span style="color:#ff79c6">...</span>RequestOption) Request
	<span style="color:#50fa7b">Call</span>(ctx context.Context, req Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}, opts <span style="color:#ff79c6">...</span>CallOption) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Stream</span>(ctx context.Context, req Request, opts <span style="color:#ff79c6">...</span>CallOption) (Stream, <span style="color:#8be9fd">error</span>)
	<span style="color:#50fa7b">Publish</span>(ctx context.Context, msg Message, opts <span style="color:#ff79c6">...</span>PublishOption) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><h2 id="使用方法">使用方法</h2>
<h3 id="启动请求">启动请求</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;log&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/broker/memory&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/client&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/client/grpc&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry/mdns&#34;</span>
	pb <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/testdata/proto&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    <span style="color:#6272a4">// 新建一个新的 gRPC Client
</span><span style="color:#6272a4"></span>	cc <span style="color:#ff79c6">:=</span> grpc.<span style="color:#50fa7b">NewClient</span>(
		client.<span style="color:#50fa7b">Registry</span>(mdns.<span style="color:#50fa7b">NewRegistry</span>()),
		client.<span style="color:#50fa7b">Broker</span>(memory.<span style="color:#50fa7b">NewBroker</span>()),
	)
    <span style="color:#6272a4">// 初始化
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	in <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>pb.Request{
		Id:   <span style="color:#f1fa8c">&#34;1&#34;</span>,
		Name: <span style="color:#f1fa8c">&#34;World&#34;</span>,
		Data: <span style="color:#f1fa8c">&#34;data&#34;</span>,
	}
    <span style="color:#6272a4">// 创建一个新的请求
</span><span style="color:#6272a4"></span>	req <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">NewRequest</span>(
		<span style="color:#f1fa8c">&#34;go.vine.helloworld&#34;</span>,
		<span style="color:#f1fa8c">&#34;HelloWorld.Get&#34;</span>,
		in,
	)
	rsp <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>pb.Response{}
    <span style="color:#6272a4">// 调用请求
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Call</span>(context.<span style="color:#50fa7b">TODO</span>(), req, rsp); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	fmt.<span style="color:#50fa7b">Println</span>(rsp.Reply)
}
</code></pre></div><h3 id="发布消息">发布消息</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    <span style="color:#ff79c6">...</span>
    in <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>pb.Request{
		Id:   <span style="color:#f1fa8c">&#34;1&#34;</span>,
		Name: <span style="color:#f1fa8c">&#34;World&#34;</span>,
		Data: <span style="color:#f1fa8c">&#34;data&#34;</span>,
	}
    <span style="color:#6272a4">// 发布信息
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Publish</span>(context.<span style="color:#50fa7b">TODO</span>(), cc.<span style="color:#50fa7b">NewMessage</span>(<span style="color:#f1fa8c">&#34;go.topic&#34;</span>, in)); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
    <span style="color:#ff79c6">...</span>
}
</code></pre></div><h3 id="新建流">新建流</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    <span style="color:#ff79c6">...</span>
    stream, err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Stream</span>(context.<span style="color:#50fa7b">TODO</span>(), req)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	<span style="color:#ff79c6">defer</span> stream.<span style="color:#50fa7b">Close</span>()

	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		<span style="color:#6272a4">// 发送消息
</span><span style="color:#6272a4"></span>		stream.<span style="color:#50fa7b">Send</span>(in)
	}()
	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		<span style="color:#6272a4">// 接收消息
</span><span style="color:#6272a4"></span>		rsp <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>pb.Request{}
		<span style="color:#6272a4">// 阻塞直到接收到消息
</span><span style="color:#6272a4"></span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> stream.<span style="color:#50fa7b">Recv</span>(rsp); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {

		}
	}()
    <span style="color:#ff79c6">...</span>
}
</code></pre></div><h2 id="options">options</h2>
<p>初始化 options:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    cc <span style="color:#ff79c6">:=</span> grpc.<span style="color:#50fa7b">NewClient</span>(
		client.<span style="color:#50fa7b">Codec</span>(),     <span style="color:#6272a4">// 设置 codec
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">Selector</span>(),  <span style="color:#6272a4">// 设置 selector
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">Registry</span>(mdns.<span style="color:#50fa7b">NewRegistry</span>()), <span style="color:#6272a4">// 设置 registry
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">Broker</span>(memory.<span style="color:#50fa7b">NewBroker</span>()), <span style="color:#6272a4">// 设置 broker
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithRouter</span>(),  <span style="color:#6272a4">// 设置 router
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WrapCall</span>(),    <span style="color:#6272a4">// 设置请求装载器
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">Wrap</span>(),        <span style="color:#6272a4">// 设置装载器
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">DialTimeout</span>(), <span style="color:#6272a4">// 设置连接超时时间
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">ContentType</span>(), <span style="color:#6272a4">// 设置 Content-Type
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">Backoff</span>(),     <span style="color:#6272a4">// 设置重试机制
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">PoolSize</span>(),    <span style="color:#6272a4">// 设置连接池容量
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">PoolTTL</span>(),     <span style="color:#6272a4">// 设置连接池 ttl
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">StreamTimeout</span>(),  <span style="color:#6272a4">// 设置 stream 超时时间
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">Retries</span>(),     <span style="color:#6272a4">// 设置错误重试次数
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">Retry</span>(),   <span style="color:#6272a4">// 设置重试函数
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p><code>NewRequest</code> 的 options:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    req <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">NewRequest</span>(
		<span style="color:#f1fa8c">&#34;go.vine.helloworld&#34;</span>,
		<span style="color:#f1fa8c">&#34;HelloWorld.Get&#34;</span>,
		in,
		client.<span style="color:#50fa7b">WithContentType</span>(<span style="color:#f1fa8c">&#34;application/json&#34;</span>), <span style="color:#6272a4">//  设置请求体的 Content-Type
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">StreamingRequest</span>(), <span style="color:#6272a4">// 流式请求
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p><code>NewMessage</code> 的 options:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    cc.<span style="color:#50fa7b">NewMessage</span>(
		<span style="color:#f1fa8c">&#34;topic&#34;</span>,
		in,
		client.<span style="color:#50fa7b">WithMessageContentType</span>(<span style="color:#f1fa8c">&#34;application/json&#34;</span>), <span style="color:#6272a4">// 设置消息的 Content-Type
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p><code>Call</code> 的 options:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    cc.<span style="color:#50fa7b">Call</span>(context.<span style="color:#50fa7b">TODO</span>(), req, rsp,
		client.<span style="color:#50fa7b">WithAddress</span>(),      <span style="color:#6272a4">// 设置服务端地址，跳过通过 Registry 查询服务端的步骤
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithRequestTimeout</span>(), <span style="color:#6272a4">// 请求超时时间
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithStreamTimeout</span>(), <span style="color:#6272a4">// stream 超时时间
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithDialTimeout</span>(),   <span style="color:#6272a4">// 连接时间
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithBackoff</span>(),   <span style="color:#6272a4">// 重试机制
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithCache</span>(),     <span style="color:#6272a4">// 设置缓存时间
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithCallWrapper</span>(), <span style="color:#6272a4">// 设置请求装载器
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithRetries</span>(),   <span style="color:#6272a4">// 设置重试次数
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithRetry</span>(),  <span style="color:#6272a4">// 设置重试函数
</span><span style="color:#6272a4"></span>		client.<span style="color:#50fa7b">WithSelectOption</span>(), <span style="color:#6272a4">// 设置筛选器
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p><code>Publish</code> 的 Option:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    cc.<span style="color:#50fa7b">Publish</span>(context.<span style="color:#50fa7b">TODO</span>(), cc.<span style="color:#50fa7b">NewMessage</span>(<span style="color:#f1fa8c">&#34;go.topic&#34;</span>, in),
		client.<span style="color:#50fa7b">WithExchange</span>(<span style="color:#f1fa8c">&#34;&#34;</span>), <span style="color:#6272a4">// 设置 exchange
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><h2 id="http-client">http client</h2>
<p>http 实现的 client 可以参考 <a href="https://github.com/vine-io/vine/blob/master/core/client/http/http_test.go">http</a></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-797b02a4bf0dfe71b512bbf7a2dce8be">2.7 - 错误处理</h1>
    
	<h2 id="概述">概述</h2>
<p>我们定义以下错误类型</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Error <span style="color:#8be9fd;font-style:italic">struct</span> {
	Id       <span style="color:#8be9fd">string</span>     <span style="color:#f1fa8c">`json:&#34;id,omitempty&#34;`</span>
	Code     <span style="color:#8be9fd">int32</span>      <span style="color:#f1fa8c">`json:&#34;code,omitempty&#34;`</span>
	Detail   <span style="color:#8be9fd">string</span>     <span style="color:#f1fa8c">`json:&#34;detail,omitempty&#34;`</span>
	Status   <span style="color:#8be9fd">string</span>     <span style="color:#f1fa8c">`json:&#34;status,omitempty&#34;`</span>
    Position <span style="color:#8be9fd">string</span>     <span style="color:#f1fa8c">`json:&#34;position,omitempty&#34;`</span>
    Child    <span style="color:#ff79c6">*</span>Child     <span style="color:#f1fa8c">`json:&#34;child,omitempty&#34;`</span>
    Stacks   []<span style="color:#ff79c6">*</span>Stack   <span style="color:#f1fa8c">`json:&#34;stacks,omitempty&#34;`</span>
}
</code></pre></div><p>在系统中，要求用户从处理程序返回错误或从客户端接收错误的任何位置，都应认为是 <strong>Vine</strong> 错误，或者应该生成错误。默认情况下，我们返回 <code>errors.InternalServerError</code>，如果出现错误错误则返回 <code>errors.Timeout</code>。</p>
<h2 id="使用">使用</h2>
<p>让我们假设程序中发生错误，然后，你应该确定返回哪种错误，并执行以下操作。
假设提供的数据无效：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">badRequest</span>(<span style="color:#f1fa8c">&#34;com.example.srv.service&#34;</span>, <span style="color:#f1fa8c">&#34;invalid field&#34;</span>)
</code></pre></div><p>如果发生内部错误</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">InternalServerError</span>(<span style="color:#f1fa8c">&#34;com.example.srv.service&#34;</span>, <span style="color:#f1fa8c">&#34;failed to read db: %v&#34;</span>, err.<span style="color:#50fa7b">Error</span>())
}
</code></pre></div><p>如果你从客户端收到一些错误，可以按照以下方式处理:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">cc <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">NewGreeterService</span>(<span style="color:#f1fa8c">&#34;go.vine.srv.greeter&#34;</span>, service.<span style="color:#50fa7b">Client</span>())
rsp, err <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">Clinet</span>(ctx, req)
<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
    <span style="color:#6272a4">// parse out the error 
</span><span style="color:#6272a4"></span>    e <span style="color:#ff79c6">:=</span> errors.<span style="color:#50fa7b">Parse</span>(err.<span style="color:#50fa7b">Error</span>())

    <span style="color:#6272a4">// inspect the value
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> e.Code <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">401</span> {
        <span style="color:#6272a4">// unauthorized
</span><span style="color:#6272a4"></span>    }
}
</code></pre></div><h2 id="错误列表">错误列表</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BadGateway</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BadRequest</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Conflict</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Forbidden</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">GatewayTimeout</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">InternalServerError</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">MethodNotAllowed</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">NotFound</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">NotImplemented</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">ServiceUnavailable</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Timeout</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Unauthorized</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
</code></pre></div><h2 id="自定义错误">自定义错误</h2>
<p>除了内置的错误类型之外，<strong>Vine</strong> 支持自定义错误类型</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// 自定义错误，并记录错误位置
</span><span style="color:#6272a4"></span>customErr <span style="color:#ff79c6">:=</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;go.vine.srv.example&#34;</span>, <span style="color:#f1fa8c">&#34;custom error&#34;</span>, <span style="color:#bd93f9">510</span>, <span style="color:#ff79c6">true</span>)
</code></pre></div><h2 id="其他">其他</h2>
<p>判断错误类型是否相同</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">b <span style="color:#ff79c6">:=</span> errors.<span style="color:#50fa7b">Equal</span>(err1, err2)
</code></pre></div><p>链式调用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">e <span style="color:#ff79c6">:=</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;go.vine.srv.example&#34;</span>, <span style="color:#f1fa8c">&#34;name must be set&#34;</span>, <span style="color:#bd93f9">404</span>).
        <span style="color:#50fa7b">WithChild</span>(<span style="color:#bd93f9">111</span>, <span style="color:#f1fa8c">&#34;%v&#34;</span>, <span style="color:#f1fa8c">&#34;child error&#34;</span>). <span style="color:#6272a4">// 添加额外错误
</span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">WithPos</span>(). <span style="color:#6272a4">// 记录错误位置 
</span><span style="color:#6272a4"></span>		<span style="color:#50fa7b">WithStack</span>(<span style="color:#bd93f9">10001</span>, <span style="color:#f1fa8c">&#34;stack context&#34;</span>) <span style="color:#6272a4">// 追加上下文信息 
</span></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a166f9ca5ae0b67e66da460ca61f73a2">2.8 - 配置中心</h1>
    
	<h2 id="概述">概述</h2>
<p>应用程序中的大多数配置都是静态配置或者从多个源加载的复杂逻辑。<strong>Config</strong> 是其变得简单，可插拔和可合并。</p>
<h2 id="特性">特性</h2>
<ul>
<li><strong>动态加载</strong> - 在需要时从多个源加载配置. <strong>Config</strong> 管理在后台监听配置源，并自动合并和更新内存中的配置文件源。</li>
<li><strong>可插拔的源</strong> - 从任意数量的源中进行选择以加载和合并配置。后端源被抽象为内部使用并通过编码器解码的标准格式。源可以是 env vars, flags, etcd, k8s configmap, 等。</li>
<li><strong>可合并配置</strong> - 如果指定多个配置源，无论格式如何，它们都将合并并在单个视图中显示。这极大地简化了基于环境的优先级顺序加载和更改。</li>
<li><strong>改动监听</strong> - 可选择监听配置，以监控特定值的更改。使用 <strong>Config</strong> 的监听程序热加载你的应用。不必临时关机重新加载其他任何内容，只需继续读取配置并监听需要通知的更改。</li>
<li><strong>安全恢复</strong> - 如果配置负载严重或由于未知原因完全擦除，则可以在直接访问任何配置值时指定回退值。这可确保在发生问题时始终读取某些合理的默认值。</li>
</ul>
<h2 id="内部实现">内部实现</h2>
<p>下面介绍 <strong>Config</strong> 的实现，<strong>Config</strong> 有以下部分组成：</p>
<ul>
<li>source: 配置的来源</li>
<li>encoder: 处理编码/解码源配置</li>
<li>reader: 将多个编码源合并为单一格式</li>
<li>loader：管理加载源</li>
</ul>
<h3 id="source">Source</h3>
<p><code>Source</code> 作为配置的读取来源。可以同时使用多个源。
支持以下源:</p>
<p>cli : 从 CLI 标志读取</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    <span style="color:#6272a4">// New Service
</span><span style="color:#6272a4"></span>    service <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
        vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;example&#34;</span>),
        vine.<span style="color:#50fa7b">Flags</span>(
            cli.StringFlag{
                Name: <span style="color:#f1fa8c">&#34;database-address&#34;</span>,
                Value: <span style="color:#f1fa8c">&#34;127.0.0.1&#34;</span>,
                Usage: <span style="color:#f1fa8c">&#34;the db address&#34;</span>,
            },
        ),
    )

    <span style="color:#8be9fd;font-style:italic">var</span> clisrc source.Source

    service.<span style="color:#50fa7b">Init</span>(
        vine.<span style="color:#50fa7b">Action</span>(<span style="color:#8be9fd;font-style:italic">func</span>(c <span style="color:#ff79c6">*</span>cli.Context) {
            clisrc = cli.<span style="color:#50fa7b">NewSource</span>(
                cli.<span style="color:#50fa7b">Context</span>(c),
	    )
            <span style="color:#6272a4">// Alternatively, just setup your config right here
</span><span style="color:#6272a4"></span>        }),
    )
    
    <span style="color:#6272a4">// ... Load and use that source ...
</span><span style="color:#6272a4"></span>    conf <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">NewConfig</span>()
    conf.<span style="color:#50fa7b">Load</span>(clisrc)
}
</code></pre></div><p>env : 从环境变量中读取</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">src <span style="color:#ff79c6">:=</span> env.<span style="color:#50fa7b">NewSource</span>(
	<span style="color:#6272a4">// optionally specify prefix
</span><span style="color:#6272a4"></span>	env.<span style="color:#50fa7b">WithPrefix</span>(<span style="color:#f1fa8c">&#34;VINE&#34;</span>),
)

<span style="color:#6272a4">// Create new config
</span><span style="color:#6272a4"></span>conf <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">NewConfig</span>()

<span style="color:#6272a4">// Load env source
</span><span style="color:#6272a4"></span>conf.<span style="color:#50fa7b">Load</span>(src)
</code></pre></div><p>file : 从文件中读取</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	data <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd;font-style:italic">byte</span>(<span style="color:#f1fa8c">`{&#34;foo&#34;: &#34;bar&#34;}`</span>)
	path <span style="color:#ff79c6">:=</span> filepath.<span style="color:#50fa7b">Join</span>(os.<span style="color:#50fa7b">TempDir</span>(), fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;file.%d&#34;</span>, time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">UnixNano</span>()))
	fh, err <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Create</span>(path)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		t.<span style="color:#50fa7b">Error</span>(err)
	}
	<span style="color:#ff79c6">defer</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		fh.<span style="color:#50fa7b">Close</span>()
		os.<span style="color:#50fa7b">Remove</span>(path)
	}()

	_, err = fh.<span style="color:#50fa7b">Write</span>(data)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		t.<span style="color:#50fa7b">Error</span>(err)
	}

	f <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">NewSource</span>(<span style="color:#50fa7b">WithPath</span>(path))
	c, err <span style="color:#ff79c6">:=</span> f.<span style="color:#50fa7b">Read</span>()
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		t.<span style="color:#50fa7b">Error</span>(err)
	}
}
</code></pre></div><p>flag : 从标志中读取</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">flagSource <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">NewSource</span>(
	<span style="color:#6272a4">// optionally enable reading of unset flags and their default
</span><span style="color:#6272a4"></span>	<span style="color:#6272a4">// values into config, defaults to false
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">IncludeUnset</span>(<span style="color:#ff79c6">true</span>)
)
<span style="color:#6272a4">// Create new config
</span><span style="color:#6272a4"></span>conf <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">NewConfig</span>()

<span style="color:#6272a4">// Load flag source
</span><span style="color:#6272a4"></span>conf.<span style="color:#50fa7b">Load</span>(flagSource)
</code></pre></div><p>memory : 从内存中读取</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memorySource <span style="color:#ff79c6">:=</span> memory.<span style="color:#50fa7b">NewSource</span>(
	memory.<span style="color:#50fa7b">WithJSON</span>(data),
)
<span style="color:#6272a4">// Create new config
</span><span style="color:#6272a4"></span>conf <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">NewConfig</span>()
<span style="color:#6272a4">// Load memory source
</span><span style="color:#6272a4"></span>conf.<span style="color:#50fa7b">Load</span>(memorySource)
</code></pre></div><h3 id="changeset">ChangeSet</h3>
<p><strong>Source</strong> 将 <strong>Config</strong> 作为一个 <strong>ChangeSet</strong> 返回，作为多个源的单一内部抽象。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// ChangeSet represents a set of changes from a source
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> ChangeSet <span style="color:#8be9fd;font-style:italic">struct</span> {
	Data      []<span style="color:#8be9fd">byte</span>
	CheckSum  <span style="color:#8be9fd">string</span>
	Format    <span style="color:#8be9fd">string</span>
	Source    <span style="color:#8be9fd">string</span>
	Timestamp time.Time
}
</code></pre></div><h3 id="encoder">encoder</h3>
<p><code>Encoder</code> 处理编码和解码。后端源可能以许多不停的格式存储。编码器使我们能够处理任何格式。如果未指定编码器，则默认为 json。
支持以下编码格式：</p>
<ul>
<li>json</li>
<li>yaml</li>
<li>toml</li>
<li>xml</li>
<li>hcl</li>
</ul>
<h3 id="reader">reader</h3>
<p><code>Reader</code> 将多个 <strong>ChangeSet</strong> 表示为单个合并和查询的集合</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Reader is an interface for merging changesets
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Reader <span style="color:#8be9fd;font-style:italic">interface</span> {
    <span style="color:#6272a4">// Merge multiple changeset into a single format
</span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">Merge</span>(<span style="color:#ff79c6">...*</span>source.ChangeSet) (<span style="color:#ff79c6">*</span>source.ChangeSet, <span style="color:#8be9fd">error</span>)
    <span style="color:#6272a4">// Return Go assertable values
</span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">Values</span>(<span style="color:#ff79c6">*</span>source.ChangeSet) (Values, <span style="color:#8be9fd">error</span>)
    <span style="color:#6272a4">// Name of the reader e.g json reader
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><p><code>Reader</code> 使用 <code>Encoder</code> 将 <strong>ChangeSet</strong> 解码为 <code>map[string]Values</code>，然后将它们合并到单个 <strong>ChangeSet</strong> 中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Values is returned by the reader
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Values <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Bytes</span>() []<span style="color:#8be9fd">byte</span>
	<span style="color:#50fa7b">Get</span>(path <span style="color:#ff79c6">...</span><span style="color:#8be9fd">string</span>) Value
	<span style="color:#50fa7b">Set</span>(val <span style="color:#8be9fd;font-style:italic">interface</span>{}, path <span style="color:#ff79c6">...</span><span style="color:#8be9fd">string</span>)
	<span style="color:#50fa7b">Del</span>(path <span style="color:#ff79c6">...</span><span style="color:#8be9fd">string</span>)
	<span style="color:#50fa7b">Map</span>() <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}
	<span style="color:#50fa7b">Scan</span>(v <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
}
</code></pre></div><p><code>Value</code> 接口允许强制转换，类型断言，返回默认值</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Value represents a value of any type
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Value <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Bool</span>(def <span style="color:#8be9fd">bool</span>) <span style="color:#8be9fd">bool</span>
	<span style="color:#50fa7b">Int</span>(def <span style="color:#8be9fd">int64</span>) <span style="color:#8be9fd">int64</span>
	<span style="color:#50fa7b">String</span>(def <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">string</span>
	<span style="color:#50fa7b">Float64</span>(def <span style="color:#8be9fd">float64</span>) <span style="color:#8be9fd">float64</span>
	<span style="color:#50fa7b">Duration</span>(def time.Duration) time.Duration
	<span style="color:#50fa7b">StringSlice</span>(def []<span style="color:#8be9fd">string</span>) []<span style="color:#8be9fd">string</span>
	<span style="color:#50fa7b">StringMap</span>(def <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>) <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>
	<span style="color:#50fa7b">Scan</span>(val <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Bytes</span>() []<span style="color:#8be9fd">byte</span>
}
</code></pre></div><h3 id="config">Config</h3>
<p><strong>Config</strong> 管理所有配置，抽象 source，encoder，reader。
它从多个源读取，同步，监听，并将它们合并为单个可查询的源。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Config is an interface abstraction for dynamic configuration
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Config <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#6272a4">// provide the reader.Values interface
</span><span style="color:#6272a4"></span>	reader.Values
	<span style="color:#6272a4">// Init the config
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Init</span>(opts <span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Options in the config
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#6272a4">// Stop the config loader/watcher
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Close</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Load config sources
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Load</span>(source <span style="color:#ff79c6">...</span>source.Source) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Force a source changeset sync
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Sync</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Watch a value for changes
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Watch</span>(path <span style="color:#ff79c6">...</span><span style="color:#8be9fd">string</span>) (Watcher, <span style="color:#8be9fd">error</span>)
}
</code></pre></div><h2 id="使用">使用</h2>
<h3 id="实例配置">实例配置</h3>
<p>只要我们有一个编码器来支持它，配置文件就可以是任务格式的。
json 配置实例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#ff79c6">&#34;hosts&#34;</span>: {
        <span style="color:#ff79c6">&#34;database&#34;</span>: {
            <span style="color:#ff79c6">&#34;address&#34;</span>: <span style="color:#f1fa8c">&#34;10.0.0.1&#34;</span>,
            <span style="color:#ff79c6">&#34;port&#34;</span>: <span style="color:#bd93f9">3306</span>
        },
        <span style="color:#ff79c6">&#34;cache&#34;</span>: {
            <span style="color:#ff79c6">&#34;address&#34;</span>: <span style="color:#f1fa8c">&#34;10.0.0.2&#34;</span>,
            <span style="color:#ff79c6">&#34;port&#34;</span>: <span style="color:#bd93f9">6379</span>
        }
    }
}
</code></pre></div><h3 id="创建-config">创建 Config</h3>
<p>创建一个新 <strong>Config</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/services/config&#34;</span>

conf <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">NewConfig</span>()
</code></pre></div><h3 id="加载文件">加载文件</h3>
<p>从文件加载配置，根据文件扩展名来确定配置格式。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/services/config&#34;</span>

<span style="color:#6272a4">// 加载 json 配置文件
</span><span style="color:#6272a4"></span>config.<span style="color:#50fa7b">LoadFile</span>(<span style="color:#f1fa8c">&#34;/tmp/config.json&#34;</span>)
</code></pre></div><p>如果扩展不存在，可指定 <code>encoder</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/service/config&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/service/config/encoder/toml&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/service/config/source&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/service/config/source/file&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	enc <span style="color:#ff79c6">:=</span> toml.<span style="color:#50fa7b">NewEncoder</span>()
	
	<span style="color:#6272a4">// 通过编码器加载 toml 文件
</span><span style="color:#6272a4"></span>	config.<span style="color:#50fa7b">Load</span>(
		file.<span style="color:#50fa7b">NewSource</span>(
			file.<span style="color:#50fa7b">WithPath</span>(<span style="color:#f1fa8c">&#34;/tmp/config&#34;</span>),
			source.<span style="color:#50fa7b">WithEncoder</span>(enc),
		),
	)
}
</code></pre></div><h3 id="读取配置">读取配置</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">conf <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">Map</span>()

fmt.<span style="color:#50fa7b">Println</span>(conf[<span style="color:#f1fa8c">&#34;hosts&#34;</span>])
</code></pre></div><p>扫描配置到结构体</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Host <span style="color:#8be9fd;font-style:italic">struct</span> {
	Address <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;address&#34;`</span>
	Port <span style="color:#8be9fd">int</span> <span style="color:#f1fa8c">`json:&#34;port&#34;`</span>
}

<span style="color:#8be9fd;font-style:italic">type</span> Config <span style="color:#8be9fd;font-style:italic">struct</span> {
	Hosts <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]Host <span style="color:#f1fa8c">`json:&#34;hosts&#34;`</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	pwd, _ <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Getwd</span>()
	err <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">LoadFile</span>(pwd <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;/config/&#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;config.json&#34;</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	<span style="color:#8be9fd;font-style:italic">var</span> cfg Config
	config.<span style="color:#50fa7b">Scan</span>(<span style="color:#ff79c6">&amp;</span>cfg)

	fmt.<span style="color:#50fa7b">Println</span>(cfg.Hosts[<span style="color:#f1fa8c">&#34;database&#34;</span>].Address)
}
</code></pre></div><h3 id="读取值">读取值</h3>
<p>从配置扫描值到结构体</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Host <span style="color:#8be9fd;font-style:italic">struct</span> {
    Address <span style="color:#8be9fd">string</span>  <span style="color:#f1fa8c">`json:&#34;address&#34;`</span>
    Port    <span style="color:#8be9fd">int</span>     <span style="color:#f1fa8c">`json:&#34;port&#34;`</span>
}

<span style="color:#8be9fd;font-style:italic">var</span> host Host

config.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;hosts&#34;</span>, <span style="color:#f1fa8c">&#34;database&#34;</span>).<span style="color:#50fa7b">Scan</span>(<span style="color:#ff79c6">&amp;</span>host)

<span style="color:#6272a4">// 10.0.0.1 3306
</span><span style="color:#6272a4"></span>fmt.<span style="color:#50fa7b">Println</span>(host.Address, host.Port)
</code></pre></div><p>读取单个值作为 Go 类型</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Get address. Set default to localhost as fallback
</span><span style="color:#6272a4"></span>address <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;hosts&#34;</span>, <span style="color:#f1fa8c">&#34;database&#34;</span>, <span style="color:#f1fa8c">&#34;address&#34;</span>).<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;localhost&#34;</span>)

<span style="color:#6272a4">// Get port. Set default to 3000 as fallback
</span><span style="color:#6272a4"></span>port <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;hosts&#34;</span>, <span style="color:#f1fa8c">&#34;database&#34;</span>, <span style="color:#f1fa8c">&#34;port&#34;</span>).<span style="color:#50fa7b">Int</span>(<span style="color:#bd93f9">3000</span>)
</code></pre></div><h3 id="监听配置">监听配置</h3>
<p>监听配置文件。当文件更改时，更新到新值:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">w, err <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">Watch</span>(<span style="color:#f1fa8c">&#34;hosts&#34;</span>, <span style="color:#f1fa8c">&#34;database&#34;</span>)
<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
    <span style="color:#6272a4">// do something
</span><span style="color:#6272a4"></span>}

<span style="color:#6272a4">// wait for next value
</span><span style="color:#6272a4"></span>v, err <span style="color:#ff79c6">:=</span> w.<span style="color:#50fa7b">Next</span>()
<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
    <span style="color:#6272a4">// do something
</span><span style="color:#6272a4"></span>}

<span style="color:#8be9fd;font-style:italic">var</span> host Host

v.<span style="color:#50fa7b">Scan</span>(<span style="color:#ff79c6">&amp;</span>host)
</code></pre></div><h3 id="多源">多源</h3>
<p>可以加载和合并多个源。合并优先级顺序相反:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">config.<span style="color:#50fa7b">Load</span>(
    <span style="color:#6272a4">// base config from env
</span><span style="color:#6272a4"></span>    env.<span style="color:#50fa7b">NewSource</span>()
    <span style="color:#6272a4">// override env with flags
</span><span style="color:#6272a4"></span>    flag.<span style="color:#50fa7b">NewSource</span>()
    <span style="color:#6272a4">// override flags with file
</span><span style="color:#6272a4"></span>    file.<span style="color:#50fa7b">NewSource</span>(file.<span style="color:#50fa7b">WatchPath</span>(<span style="color:#f1fa8c">&#34;/tmp/config.json&#34;</span>))
)
</code></pre></div><h3 id="设置源编码器">设置源编码器</h3>
<p>源要求编码器对数据进行编码 / 解码并指定更改集格式.</p>
<p>默认的编码器是 json. 要更改编码器可调整对应的类型选项.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">e <span style="color:#ff79c6">:=</span> yaml.<span style="color:#50fa7b">NewEncoder</span>()

s <span style="color:#ff79c6">:=</span> consul.<span style="color:#50fa7b">NewSource</span>(
    source.<span style="color:#50fa7b">WithEncoder</span>(e),
)
</code></pre></div><h3 id="添加读取器编码器">添加读取器编码器</h3>
<p>读取器使用编码器从不同格式的源解码数据.</p>
<p>默认的读取器支持 json, yaml, xml, toml 和 hcl. 它将合并的配置表示为 json.</p>
<p>可以通过指定的选项来添加一个新的编码器.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">e <span style="color:#ff79c6">:=</span> yaml.<span style="color:#50fa7b">NewEncoder</span>()

r <span style="color:#ff79c6">:=</span> json.<span style="color:#50fa7b">NewReader</span>(
    reader.<span style="color:#50fa7b">WithEncoder</span>(e),
)
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-39fecad7477de2ef09d3e2a496ab8478">2.9 - 数据缓存</h1>
    
	<h2 id="概述">概述</h2>
<p><strong>Vine</strong> 提供 <code>Cache</code> 作为分布式缓存接口。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Cache is a data cache interface
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Cache <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#6272a4">// Init initialises the cache. It must perform any required setup on the backing storage implementation and check that it is ready for use, returning any errors.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Options allows you to view the current options.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#6272a4">// Get takes a single key name and optional GetOptions. It returns matching []*Record or an error.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Get</span>(key <span style="color:#8be9fd">string</span>, opts <span style="color:#ff79c6">...</span>GetOption) ([]<span style="color:#ff79c6">*</span>Record, <span style="color:#8be9fd">error</span>)
	<span style="color:#6272a4">// Put writes a record to the cache, and returns an error if the record was not written.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Put</span>(r <span style="color:#ff79c6">*</span>Record, opts <span style="color:#ff79c6">...</span>PutOption) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Del removes the record with the corresponding key from the cache.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Del</span>(key <span style="color:#8be9fd">string</span>, opts <span style="color:#ff79c6">...</span>DelOption) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// List returns any keys that match, or an empty list with no error if none matched.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">List</span>(opts <span style="color:#ff79c6">...</span>ListOption) ([]<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd">error</span>)
	<span style="color:#6272a4">// Close the cache
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Close</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// String returns the name of the implementation.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}

<span style="color:#6272a4">// Record is an item cached or retrieved from a Cache
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Record <span style="color:#8be9fd;font-style:italic">struct</span> {
	<span style="color:#6272a4">// The key to cache the record
</span><span style="color:#6272a4"></span>	Key <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;key&#34;`</span>
	<span style="color:#6272a4">// The value within the record
</span><span style="color:#6272a4"></span>	Value []<span style="color:#8be9fd">byte</span> <span style="color:#f1fa8c">`json:&#34;value&#34;`</span>
	<span style="color:#6272a4">// Any associated metadata for indexing
</span><span style="color:#6272a4"></span>	Metadata <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{} <span style="color:#f1fa8c">`json:&#34;metadata&#34;`</span>
	<span style="color:#6272a4">// Time to expire a record: TODO: change to timestamp
</span><span style="color:#6272a4"></span>	Expiry time.Duration <span style="color:#f1fa8c">`json:&#34;expiry,omitempty&#34;`</span>
}
</code></pre></div><h2 id="使用">使用</h2>
<h3 id="初始化">初始化</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;log&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/cache&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/cache/memory&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	cc <span style="color:#ff79c6">:=</span> memory.<span style="color:#50fa7b">NewCache</span>()
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	<span style="color:#ff79c6">defer</span> cc.<span style="color:#50fa7b">Close</span>()
}
</code></pre></div><h3 id="插入-keyvalue">插入 key/value</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// cache.Record
</span><span style="color:#6272a4"></span>	r <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>cache.Record{
		Key:      <span style="color:#f1fa8c">&#34;a&#34;</span>, <span style="color:#6272a4">// key 唯一值
</span><span style="color:#6272a4"></span>		Value:    []<span style="color:#8be9fd;font-style:italic">byte</span>(<span style="color:#f1fa8c">&#34;hello&#34;</span>), <span style="color:#6272a4">// value
</span><span style="color:#6272a4"></span>		Metadata: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}{}, <span style="color:#6272a4">// 
</span><span style="color:#6272a4"></span>		Expiry:   time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">3</span>, <span style="color:#6272a4">// 过期时间
</span><span style="color:#6272a4"></span>	}
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Put</span>(r); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
}
</code></pre></div><h3 id="获取-keyvalue">获取 key/value</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// 获取所有 keys
</span><span style="color:#6272a4"></span>	keys, err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">List</span>()
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	fmt.<span style="color:#50fa7b">Println</span>(keys)

	<span style="color:#6272a4">// 通过 key 获取 value
</span><span style="color:#6272a4"></span>	rr, err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;a&#34;</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#8be9fd;font-style:italic">string</span>(rr[<span style="color:#bd93f9">0</span>].Value))
}
</code></pre></div><h3 id="删除-key">删除 key</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Del</span>(<span style="color:#f1fa8c">&#34;a&#34;</span>); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
}
</code></pre></div><h2 id="options">options</h2>
<p>初始化 options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	cc <span style="color:#ff79c6">:=</span> memory.<span style="color:#50fa7b">NewCache</span>(
		cache.<span style="color:#50fa7b">Nodes</span>(),    <span style="color:#6272a4">// 指定缓存服务器的节点信息
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">Table</span>(),    <span style="color:#6272a4">// 指定 table
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">Database</span>(), <span style="color:#6272a4">// 指定 database
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">WithClient</span>(), <span style="color:#6272a4">// 指定 Client 接口实现
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">WithContext</span>(), <span style="color:#6272a4">// 指定 context.Context
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p><code>Put</code> options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	cc.<span style="color:#50fa7b">Put</span>(r,
		cache.<span style="color:#50fa7b">PutExpiry</span>(), <span style="color:#6272a4">// 指定 key 过期时间
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">PutTo</span>(),     <span style="color:#6272a4">// 指定 database 和 table
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">PutTTL</span>(),    <span style="color:#6272a4">// 指定 key ttl
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p><code>List</code> options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	keys, err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">List</span>(
		cache.<span style="color:#50fa7b">ListFrom</span>(),  <span style="color:#6272a4">// 指定 database 和 table
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">ListLimit</span>(), <span style="color:#6272a4">// 限制 key 数量
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">ListOffset</span>(), <span style="color:#6272a4">// 查询偏移量
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">ListPrefix</span>(), <span style="color:#6272a4">// 指定 key 前缀
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">ListSuffix</span>(), <span style="color:#6272a4">// 指定 key 后缀
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p><code>Get</code> options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	cc.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;a&#34;</span>,
		cache.<span style="color:#50fa7b">GetFrom</span>(), <span style="color:#6272a4">// 指定 database 和 table
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">GetLimit</span>(), <span style="color:#6272a4">// 限制 key 数量
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">GetOffset</span>(), <span style="color:#6272a4">// 查询偏移量
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">GetPrefix</span>(), <span style="color:#6272a4">// 指定 key 前缀
</span><span style="color:#6272a4"></span>		cache.<span style="color:#50fa7b">GetSuffix</span>(), <span style="color:#6272a4">// 指定 key 后缀
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p><code>Del</code> options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	cc.<span style="color:#50fa7b">Del</span>(<span style="color:#f1fa8c">&#34;a&#34;</span>,
		cache.<span style="color:#50fa7b">DelFrom</span>(), <span style="color:#6272a4">// 指定 database 和 table
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-153e4a0bca2441db25452191e5399846">2.10 - 命令行参数</h1>
    
	<h2 id="概述">概述</h2>
<p><strong>Vine</strong> 结合 <a href="https://github.com/vine-io/cli">cli</a> 提供 <code>Cmd</code> 模块，作为服务的命令工具：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Cmd <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#6272a4">// App The cli app within this cmd
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">App</span>() <span style="color:#ff79c6">*</span>cli.App
	<span style="color:#6272a4">// Init Adds options, parses flags and initialise
</span><span style="color:#6272a4"></span>	<span style="color:#6272a4">// exits on error
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Init</span>(opts <span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Options set within this command
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options
}
</code></pre></div><h2 id="使用">使用</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;log&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/cmd&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	c <span style="color:#ff79c6">:=</span> cmd.<span style="color:#50fa7b">NewCmd</span>()
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> c.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	c.<span style="color:#50fa7b">App</span>().<span style="color:#50fa7b">RunAndExitOnError</span>()
}
</code></pre></div><h2 id="options">options</h2>
<p>罗列 <code>Cmd</code> 的 options:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    c <span style="color:#ff79c6">:=</span> cmd.<span style="color:#50fa7b">NewCmd</span>(
		cmd.<span style="color:#50fa7b">Name</span>(),   <span style="color:#6272a4">// 设置 cli 启动名称
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Server</span>(), <span style="color:#6272a4">// 设置默认 Server 模块
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Client</span>(), <span style="color:#6272a4">// 设置默认 Client 模块
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Selector</span>(), <span style="color:#6272a4">// 设置 Client Selector 模块
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Registry</span>(), <span style="color:#6272a4">// 设置默认 Registry 模块
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Broker</span>(),  <span style="color:#6272a4">// 设置默认 Broker 模块
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Tracer</span>(),  <span style="color:#6272a4">// 设置默认 Tracer 模块
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Dialect</span>(), <span style="color:#6272a4">// 设置默认 Dialect 模块
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Config</span>(),  <span style="color:#6272a4">// 设置默认 Config 模块
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Cache</span>(),   <span style="color:#6272a4">// 设置 Cache 模块
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">CliApp</span>(),  <span style="color:#6272a4">// 设置 *cli.App
</span><span style="color:#6272a4"></span>		cmd.<span style="color:#50fa7b">Description</span>(), <span style="color:#6272a4">// 设置 cli 描述信息
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><h2 id="服务-cmd">服务 cmd</h2>
<p><strong>Vine</strong> 服务启动时初始化 <code>Cmd</code> 模块，每个服务支持以下的命令行参数:</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>默认值</th>
<th>环境换脸</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>&ndash;client string</td>
<td>Client for vine;</td>
<td>rpc</td>
<td>[$VINE_CLIENT]</td>
<td></td>
</tr>
<tr>
<td>&ndash;client-request-timeout string</td>
<td>Sets the client request timeout. e.g 500ms, 5s, 1m.</td>
<td>Default: 5s</td>
<td>[$VINE_CLIENT_REQUEST_TIMEOUT]</td>
<td></td>
</tr>
<tr>
<td>&ndash;client-retries int</td>
<td>Sets the client retries.</td>
<td>Default: 1 (default: 1)</td>
<td>[$VINE_CLIENT_RETIES]</td>
<td></td>
</tr>
<tr>
<td>&ndash;client-pool-size int</td>
<td>Sets the client connection pool size.</td>
<td>Default: 1 (default: 0)</td>
<td>[$VINE_CLIENT_POOL_SIZE]</td>
<td></td>
</tr>
<tr>
<td>&ndash;client-pool-ttl string</td>
<td>Sets the client connection pool ttl. e.g 500ms, 5s, 1m.</td>
<td>Default: 1m</td>
<td>[$VINE_CLIENT_POOL_TTL]</td>
<td></td>
</tr>
<tr>
<td>&ndash;register-ttl int</td>
<td>Register TTL in seconds</td>
<td>(default: 60)</td>
<td>[$VINE_REGISTER_TTL]</td>
<td></td>
</tr>
<tr>
<td>&ndash;register-interval int</td>
<td>Register interval in seconds</td>
<td>(default: 30)</td>
<td>[$VINE_REGISTER_INTERVAL]</td>
<td></td>
</tr>
<tr>
<td>&ndash;server string</td>
<td>Server for vine;</td>
<td>rpc</td>
<td>[$VINE_SERVER]</td>
<td></td>
</tr>
<tr>
<td>&ndash;server-name string</td>
<td>Name of the server. go.vine.svc.example</td>
<td></td>
<td>[$VINE_SERVER_NAME]</td>
<td></td>
</tr>
<tr>
<td>&ndash;server-version string</td>
<td>Version of the server. 1.1.0</td>
<td></td>
<td>[$VINE_SERVER_VERSION]</td>
<td></td>
</tr>
<tr>
<td>&ndash;server-id string</td>
<td>Id of the server. Auto-generated if not specified</td>
<td></td>
<td>[$VINE_SERVER_ID]</td>
<td></td>
</tr>
<tr>
<td>&ndash;server-address string</td>
<td>Bind address for the server. 127.0.0.1:8080</td>
<td></td>
<td>[$VINE_SERVER_ADDRESS]</td>
<td></td>
</tr>
<tr>
<td>&ndash;server-advertise string</td>
<td>Use instead of the server-address when registering with discovery. 127.0.0.1:8080</td>
<td></td>
<td>[$VINE_SERVER_ADVERTISE]</td>
<td></td>
</tr>
<tr>
<td>&ndash;server-metadata strings</td>
<td>A list of key-value pairs defining metadata. version=1.0.0</td>
<td></td>
<td>[$VINE_SERVER_METADATA]</td>
<td></td>
</tr>
<tr>
<td>&ndash;broker string</td>
<td>Broker for pub/sub. http, nats</td>
<td></td>
<td>[$VINE_BROKER]</td>
<td></td>
</tr>
<tr>
<td>&ndash;broker-address string</td>
<td>Comma-separated list of broker addresses</td>
<td></td>
<td>[$VINE_BROKER_ADDRESS]</td>
<td></td>
</tr>
<tr>
<td>&ndash;registry string</td>
<td>Registry for discovery. memory, mdns</td>
<td></td>
<td>[$VINE_REGISTRY]</td>
<td></td>
</tr>
<tr>
<td>&ndash;registry-address string</td>
<td>Comma-separated list of registry addresses</td>
<td></td>
<td>[$VINE_REGISTRY_ADDRESS]</td>
<td></td>
</tr>
<tr>
<td>&ndash;selector string</td>
<td>Selector used to pick nodes for querying</td>
<td></td>
<td>[$VINE_SELECTOR]</td>
<td></td>
</tr>
<tr>
<td>&ndash;dao-dialect string</td>
<td>Database option for the underlying dao</td>
<td></td>
<td>[$VINE_DAO_DIALECT]</td>
<td></td>
</tr>
<tr>
<td>&ndash;dao-dsn string</td>
<td>DSN database driver name for underlying dao</td>
<td></td>
<td>[$VINE_DSN]</td>
<td></td>
</tr>
<tr>
<td>&ndash;config string</td>
<td>The source of the config to be used to get configuration</td>
<td></td>
<td>[$VINE_CONFIG]</td>
<td></td>
</tr>
<tr>
<td>&ndash;cache string</td>
<td>Cache used for key-value storage</td>
<td></td>
<td>[$VINE_CACHE]</td>
<td></td>
</tr>
<tr>
<td>&ndash;cache-address string</td>
<td>Comma-separated list of cache addresses</td>
<td></td>
<td>[$VINE_CACHE_ADDRESS]</td>
<td></td>
</tr>
<tr>
<td>&ndash;tracer string</td>
<td>Tracer for distributed tracing, e.g. memory, jaeger</td>
<td></td>
<td>[$VINE_TRACER]</td>
<td></td>
</tr>
<tr>
<td>&ndash;tracer-address string</td>
<td>Comma-separated list of tracer addresses</td>
<td></td>
<td>[$VINE_TRACER_ADDRESS]</td>
<td></td>
</tr>
</tbody>
</table>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a711fd4172b59f618933a2b52fdc23a0">2.11 - 日志接口</h1>
    
	<h2 id="概述">概述</h2>
<p><code>Logger</code> 是 <strong>Vine</strong> 的日志模块，我们抽象一个一组通用的接口，用户可以根据自己的需要来构建自己的实现:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Logger <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#6272a4">// Init initialises options
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Init</span>(options <span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Options the Logger options
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#6272a4">// Fields set fields to always be logged
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Fields</span>(fields <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}) Logger
	<span style="color:#6272a4">// Log writes a log entry
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Log</span>(level Level, v <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{})
	<span style="color:#6272a4">// Logf writes a formatted log entry
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Logf</span>(level Level, format <span style="color:#8be9fd">string</span>, v <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{})
	<span style="color:#6272a4">// String returns the name of logger
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><h2 id="使用">使用</h2>
<p>这里介绍 <code>Logger</code> 的简单使用方式，我们在内部已经有自带的实现:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    <span style="color:#6272a4">// 新 Logger
</span><span style="color:#6272a4"></span>    l <span style="color:#ff79c6">:=</span> logger.<span style="color:#50fa7b">NewLogger</span>(<span style="color:#50fa7b">WithLevel</span>(TraceLevel))
	h1 <span style="color:#ff79c6">:=</span> logger.<span style="color:#50fa7b">NewHelper</span>(l).<span style="color:#50fa7b">WithFields</span>(<span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}{<span style="color:#f1fa8c">&#34;key1&#34;</span>: <span style="color:#f1fa8c">&#34;val1&#34;</span>})
	h1.<span style="color:#50fa7b">Trace</span>(<span style="color:#f1fa8c">&#34;trace_msg1&#34;</span>)
	h1.<span style="color:#50fa7b">Log</span>(WarnLevel, <span style="color:#f1fa8c">&#34;warn_msg1&#34;</span>)

	h2 <span style="color:#ff79c6">:=</span> logger.<span style="color:#50fa7b">NewHelper</span>(l).<span style="color:#50fa7b">WithFields</span>(<span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}{<span style="color:#f1fa8c">&#34;key2&#34;</span>: <span style="color:#f1fa8c">&#34;val2&#34;</span>})
	h2.<span style="color:#50fa7b">Trace</span>(<span style="color:#f1fa8c">&#34;trace_msg2&#34;</span>)
	h2.<span style="color:#50fa7b">Warn</span>(<span style="color:#f1fa8c">&#34;warn_msg2&#34;</span>)

    <span style="color:#6272a4">// 设置 Fields
</span><span style="color:#6272a4"></span>	l.<span style="color:#50fa7b">Fields</span>(<span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}{<span style="color:#f1fa8c">&#34;key3&#34;</span>: <span style="color:#f1fa8c">&#34;val4&#34;</span>}).<span style="color:#50fa7b">Log</span>(InfoLevel, <span style="color:#f1fa8c">&#34;test_msg&#34;</span>)

    <span style="color:#6272a4">// 使用默认的 logger
</span><span style="color:#6272a4"></span>	logger.<span style="color:#50fa7b">Fields</span>(<span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}{<span style="color:#f1fa8c">&#34;key1&#34;</span>: <span style="color:#f1fa8c">&#34;val1&#34;</span>})
	logger.<span style="color:#50fa7b">Info</span>(<span style="color:#f1fa8c">&#34;info&#34;</span>)
}
</code></pre></div><p>查看输出:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">2021-09-05 16:29:32 <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>logger/logger_test.go:10 <span style="color:#8be9fd;font-style:italic">key1</span><span style="color:#ff79c6">=</span>val1 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>trace trace_msg1
2021-09-05 16:29:32 <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>logger/logger_test.go:11 <span style="color:#8be9fd;font-style:italic">key1</span><span style="color:#ff79c6">=</span>val1 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>warn warn_msg1
2021-09-05 16:29:32 <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>logger/logger_test.go:14 <span style="color:#8be9fd;font-style:italic">key2</span><span style="color:#ff79c6">=</span>val2 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>trace trace_msg2
2021-09-05 16:29:32 <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>logger/logger_test.go:15 <span style="color:#8be9fd;font-style:italic">key2</span><span style="color:#ff79c6">=</span>val2 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>warn warn_msg2
2021-09-05 16:29:32 <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>logger/logger_test.go:17 <span style="color:#8be9fd;font-style:italic">key3</span><span style="color:#ff79c6">=</span>val4 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info test_msg
2021-09-05 16:29:32 <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>logger/logger_test.go:20 <span style="color:#8be9fd;font-style:italic">key1</span><span style="color:#ff79c6">=</span>val1 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info info
</code></pre></div><p>默认的实现支持以下几种级别日志：</p>
<ul>
<li>TRACE: 日志追踪</li>
<li>DEBUG: 调试日志</li>
<li>INFO: 普通提示</li>
<li>WARN: 警告，有错误但不影响正常运行</li>
<li>ERROR: 错误，功能无法正常执行</li>
<li>FATAL: 严重错误，触发会导致程序崩溃</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-06993b840e35b8603c1d1fa4e5390ca5">2.12 - 数据库接口</h1>
    
	<h2 id="概述">概述</h2>
<p>我们整合 <a href="https://gorm.io/">gorm</a>，并抽象出 <code>Dao</code> 作为数据库交互工具：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Dialect DAO database dialect
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Dialect <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#50fa7b">NewTx</span>() <span style="color:#ff79c6">*</span>DB
	<span style="color:#50fa7b">Migrator</span>() Migrator
	<span style="color:#50fa7b">DataTypeOf</span>(<span style="color:#ff79c6">*</span>schema.Field) <span style="color:#8be9fd">string</span>
	<span style="color:#50fa7b">DefaultValueOf</span>(<span style="color:#ff79c6">*</span>schema.Field) clause.Expression
	<span style="color:#50fa7b">BindVarTo</span>(writer clause.Writer, stmt <span style="color:#ff79c6">*</span>Statement, v <span style="color:#8be9fd;font-style:italic">interface</span>{})
	<span style="color:#50fa7b">QuoteTo</span>(clause.Writer, <span style="color:#8be9fd">string</span>)
	<span style="color:#50fa7b">Explain</span>(sql <span style="color:#8be9fd">string</span>, vars <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">string</span>
	<span style="color:#50fa7b">JSONBuild</span>(column <span style="color:#8be9fd">string</span>) JSONQuery
	<span style="color:#50fa7b">JSONDataType</span>() <span style="color:#8be9fd">string</span>
	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><h2 id="使用">使用</h2>
<p><code>Dao</code> 的接口语法和 <a href="https://gorm.io/">gorm</a> 兼容</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;log&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/plugins/dao/mysql&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/dao&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/dao/logger&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">type</span> User <span style="color:#8be9fd;font-style:italic">struct</span> {
	Id   <span style="color:#8be9fd">int32</span>  <span style="color:#f1fa8c">`dao:&#34;column:id;autoIncrement;primaryKey&#34;`</span>
	Name <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`dao:&#34;column:name&#34;`</span>
	Age  <span style="color:#8be9fd">int32</span>  <span style="color:#f1fa8c">`dao:&#34;column:age&#34;`</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	dns <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">`root:123456@tcp(192.168.3.111:3306)/vine?charset=utf8&amp;parseTime=True&amp;loc=Local`</span>
	dialect <span style="color:#ff79c6">:=</span> mysql.<span style="color:#50fa7b">NewDialect</span>(dao.<span style="color:#50fa7b">DSN</span>(dns), dao.<span style="color:#50fa7b">Logger</span>(logger.<span style="color:#50fa7b">New</span>(logger.Options{
		SlowThreshold: <span style="color:#bd93f9">200</span> <span style="color:#ff79c6">*</span> time.Millisecond,
		LogLevel:      logger.Info,
	})))
    <span style="color:#6272a4">// 初始化
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> dialect.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

    <span style="color:#6272a4">// 创建一个新的会话
</span><span style="color:#6272a4"></span>	db <span style="color:#ff79c6">:=</span> dialect.<span style="color:#50fa7b">NewTx</span>()

    <span style="color:#6272a4">// 更新表结构
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> db.<span style="color:#50fa7b">AutoMigrate</span>(<span style="color:#ff79c6">&amp;</span>User{}); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	u <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>User{Name: <span style="color:#f1fa8c">&#34;Mimi&#34;</span>, Age: <span style="color:#bd93f9">11</span>}
    <span style="color:#6272a4">// 插入一条记录
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> db.<span style="color:#50fa7b">Create</span>(u).Error; err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	u1 <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>User{}
    <span style="color:#6272a4">// 查询
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> db.<span style="color:#50fa7b">Find</span>(<span style="color:#ff79c6">&amp;</span>u1, <span style="color:#f1fa8c">&#34;name = ?&#34;</span>, <span style="color:#f1fa8c">&#34;Mimi&#34;</span>).Error; err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	fmt.<span style="color:#50fa7b">Println</span>(u1)

	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> db.<span style="color:#50fa7b">Where</span>(<span style="color:#f1fa8c">&#34;name = ?&#34;</span>, <span style="color:#f1fa8c">&#34;Mimi&#34;</span>).<span style="color:#50fa7b">First</span>(<span style="color:#ff79c6">&amp;</span>u1).Error; err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	fmt.<span style="color:#50fa7b">Println</span>(u1)

	u1.Name = <span style="color:#f1fa8c">&#34;Mimi_update&#34;</span>
    <span style="color:#6272a4">// 更新一条记录
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> db.<span style="color:#50fa7b">Updates</span>(u1).Error; err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

    <span style="color:#6272a4">// 删除一条记录
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> db.<span style="color:#50fa7b">Delete</span>(<span style="color:#ff79c6">&amp;</span>User{}, <span style="color:#f1fa8c">&#34;id = ?&#34;</span>, <span style="color:#bd93f9">1</span>).Error; err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
}
</code></pre></div><p>更多 CURD 的使用方式可以参考<a href="https://gorm.io/docs/create.html">这里</a>。</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1716b93d0e0fcc931d997f5833d2e6f4">2.13 - 锁和选举</h1>
    
	<h2 id="概述">概述</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Sync is an interface for distributed synchronization
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Sync <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#6272a4">// Init Initialise options
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Options Return the options
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#6272a4">// Leader Elect a leader
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Leader</span>(id <span style="color:#8be9fd">string</span>, opts <span style="color:#ff79c6">...</span>LeaderOption) (Leader, <span style="color:#8be9fd">error</span>)
	<span style="color:#6272a4">// ListMembers get all election member
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">ListMembers</span>(opts <span style="color:#ff79c6">...</span>ListMembersOption) ([]<span style="color:#ff79c6">*</span>Member, <span style="color:#8be9fd">error</span>)
	<span style="color:#6272a4">// Lock acquires a lock
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Lock</span>(id <span style="color:#8be9fd">string</span>, opts <span style="color:#ff79c6">...</span>LockOption) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Unlock releases a lock
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Unlock</span>(id <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// String Sync implementation
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><h2 id="使用">使用</h2>
<h3 id="分布式锁">分布式锁</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    s <span style="color:#ff79c6">:=</span> etcd.<span style="color:#50fa7b">NewSync</span>()
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

    <span style="color:#6272a4">// 创建锁
</span><span style="color:#6272a4"></span>	err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Lock</span>(<span style="color:#f1fa8c">&#34;lock1&#34;</span>, sync.<span style="color:#50fa7b">LockTTL</span>(time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">3</span>))
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	ch <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd;font-style:italic">struct</span>{}, <span style="color:#bd93f9">1</span>)
	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Lock</span>(<span style="color:#f1fa8c">&#34;lock1&#34;</span>, sync.<span style="color:#50fa7b">LockTTL</span>(time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">3</span>))
		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
			log.<span style="color:#50fa7b">Fatalln</span>(err)
		}
		fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Locked&#34;</span>)
		ch <span style="color:#ff79c6">&lt;-</span> <span style="color:#8be9fd;font-style:italic">struct</span>{}{}
	}()

    <span style="color:#6272a4">// 释放锁
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err = s.<span style="color:#50fa7b">Unlock</span>(<span style="color:#f1fa8c">&#34;lock1&#34;</span>); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;lock1 released&#34;</span>)

	<span style="color:#ff79c6">&lt;-</span>ch
}
</code></pre></div><h3 id="分布式选举">分布式选举</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    s <span style="color:#ff79c6">:=</span> etcd.<span style="color:#50fa7b">NewSync</span>()
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	id <span style="color:#ff79c6">:=</span> uuid.<span style="color:#50fa7b">NewString</span>()
    <span style="color:#6272a4">// 新 leader
</span><span style="color:#6272a4"></span>	role1, err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Leader</span>(<span style="color:#f1fa8c">&#34;leader&#34;</span>, sync.<span style="color:#50fa7b">LeaderNS</span>(<span style="color:#f1fa8c">&#34;default&#34;</span>), sync.<span style="color:#50fa7b">LeaderId</span>(id), sync.<span style="color:#50fa7b">LeaderTTL</span>(<span style="color:#bd93f9">3</span>))
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

    <span style="color:#6272a4">// 查询所有选举成员
</span><span style="color:#6272a4"></span>    ms, _ <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">ListMembers</span>(sync.<span style="color:#50fa7b">MemberNS</span>(<span style="color:#f1fa8c">&#34;default&#34;</span>))
	<span style="color:#ff79c6">for</span> _, m <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> ms {
		fmt.<span style="color:#50fa7b">Println</span>(m)
	}

    <span style="color:#6272a4">// 成员辞职
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> role1.<span style="color:#50fa7b">Resign</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
}
</code></pre></div><h2 id="options">options</h2>
<p>初始化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	memory.<span style="color:#50fa7b">NewSync</span>(
		sync.<span style="color:#50fa7b">Prefix</span>(<span style="color:#f1fa8c">&#34;/vine/sync&#34;</span>),    <span style="color:#6272a4">// key 前缀
</span><span style="color:#6272a4"></span>		sync.<span style="color:#50fa7b">Nodes</span>(<span style="color:#f1fa8c">&#34;127.0.0.1:2379&#34;</span>), <span style="color:#6272a4">// 服务端地址
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p>上锁和释放锁</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    s.<span style="color:#50fa7b">Lock</span>(<span style="color:#f1fa8c">&#34;lock1&#34;</span>,
		sync.<span style="color:#50fa7b">LockTTL</span>(),   <span style="color:#6272a4">// 锁的 ttl
</span><span style="color:#6272a4"></span>		sync.<span style="color:#50fa7b">LockWait</span>(),  <span style="color:#6272a4">// 超时时间
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p>选举</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    s.<span style="color:#50fa7b">Leader</span>(<span style="color:#f1fa8c">&#34;leader&#34;</span>,
		sync.<span style="color:#50fa7b">LeaderNS</span>(), <span style="color:#6272a4">// namespace
</span><span style="color:#6272a4"></span>		sync.<span style="color:#50fa7b">LeaderTTL</span>(), <span style="color:#6272a4">// 
</span><span style="color:#6272a4"></span>		sync.<span style="color:#50fa7b">LeaderId</span>(), <span style="color:#6272a4">// 成员 id
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><h2 id="实例">实例</h2>
<p>更多的实例代码可参考 <a href="https://github.com/vine-io/examples/tree/main/sync">examples</a></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-af33cab72523ccb0847ef55ee3168c8b">2.14 - 装载器</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-6d71662a7a073686a5f0e2c3e135bd39">2.14.1 - 概述</h1>
    
	<h2 id="简介">简介</h2>
<p><strong>Vine</strong> 装载器等同于&quot;中间件&quot;。</p>
<blockquote>
<p>中间件（英语：Middleware），又译中间件、中介层，是一类提供系统软件和应用软件之间连接、便于软件各部件之间的沟通的软件，应用软件可以借助中间件在不同的技术架构之间共享信息与资源。中间件位于客户机服务器的操作系统之上，管理着计算资源和网络通信。 &ndash; 维基百科</p>
</blockquote>
<h2 id="wrapper">wrapper</h2>
<p><strong>Vine</strong> 中包含输入输出的 wrappr 分别在 <code>Client</code> 和 <code>Server</code> 中使用，定义如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// client
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> CallFunc <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, node <span style="color:#ff79c6">*</span>registry.Node, req Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}, opts CallOptions) <span style="color:#8be9fd">error</span>
<span style="color:#6272a4">// CallWrapper is a low level wrapper for the CallFunc
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> CallWrapper <span style="color:#8be9fd;font-style:italic">func</span>(CallFunc) CallFunc
<span style="color:#6272a4">// Wrapper wraps a client and returns a client
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Wrapper <span style="color:#8be9fd;font-style:italic">func</span>(Client) Client
<span style="color:#6272a4">// StreamWrapper wraps a Stream and returns the equivalent
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> StreamWrapper <span style="color:#8be9fd;font-style:italic">func</span>(Stream) Stream

<span style="color:#6272a4">// server
</span><span style="color:#6272a4">// HandlerFunc represents a single method of a handler. It&#39;s used primarily
</span><span style="color:#6272a4">// for the wrappers. What&#39;s handed to the actual method is the concrete
</span><span style="color:#6272a4">// request and response types.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> HandlerFunc <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, req Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
<span style="color:#6272a4">// SubscriberFunc represents a single method of a subscriber. It&#39;s used primarily
</span><span style="color:#6272a4">// for the wrappers. What&#39;s handed to the actual method is the concrete
</span><span style="color:#6272a4">// publication message.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> SubscriberFunc <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, msg Message) <span style="color:#8be9fd">error</span>
<span style="color:#6272a4">// HandlerWrapper wraps the HandlerFunc and returns the equivalent
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> HandlerWrapper <span style="color:#8be9fd;font-style:italic">func</span>(HandlerFunc) HandlerFunc
<span style="color:#6272a4">// SubscriberWrapper wraps the SubscriberFunc and returns the equivalent
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> SubscriberWrapper <span style="color:#8be9fd;font-style:italic">func</span>(SubscriberFunc) SubscriberFunc
<span style="color:#6272a4">// StreamWrapper wraps a Stream interface and returns the equivalent.
</span><span style="color:#6272a4">// Because streams exist for the lifetime of a method invocation this
</span><span style="color:#6272a4">// is a convenient way to wrap a Stream as its in use for trace, monitoring.
</span><span style="color:#6272a4">// metrics, etc.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> StreamWrapper <span style="color:#8be9fd;font-style:italic">func</span>(Stream) Stream
</code></pre></div><p><strong>Vine</strong> 内部集成五中类型的 wrapper:
client wrapper:</p>
<ul>
<li>CallWrapper: 拦截 client Call 请求</li>
<li>StreamWrapper: 拦截 client Stream 请求</li>
</ul>
<p>server wrapper:</p>
<ul>
<li>HandlerWrapper: 拦截 grpc simple 请求</li>
<li>SubscriberWrapper: 连接 broker 订阅</li>
<li>StreamWrapper:  连接 grpc stream 请求</li>
</ul>
<h2 id="自定义-wrapper">自定义 wrapper</h2>
<p>我们通过实例代码来说明 wrapper 的内部工作原理：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/client&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry&#34;</span>
	log <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/logger&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	vine.<span style="color:#50fa7b">NewService</span>(
        <span style="color:#6272a4">// 加载自定义的 wrapper
</span><span style="color:#6272a4"></span>		vine.<span style="color:#50fa7b">WrapCall</span>(<span style="color:#50fa7b">LoggerWrapper</span>(), <span style="color:#50fa7b">SubWrapper</span>()),
	)
}

<span style="color:#6272a4">// 定义一个 CallWrapper, 拦截 client Call 请求
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">LoggerWrapper</span>() client.CallWrapper {
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(fn client.CallFunc) client.CallFunc {
		<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, node <span style="color:#ff79c6">*</span>registry.Node, req client.Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}, opts client.CallOptions) <span style="color:#8be9fd">error</span> {

			log.<span style="color:#50fa7b">Info</span>(<span style="color:#f1fa8c">&#34;logger wrapper: before call&#34;</span>)
			err <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">fn</span>(ctx, node, req, rsp, opts)
			log.<span style="color:#50fa7b">Info</span>(<span style="color:#f1fa8c">&#34;logger wrapper: after call&#34;</span>)

			<span style="color:#ff79c6">return</span> err
		}
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">SubWrapper</span>() client.CallWrapper {
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(fn client.CallFunc) client.CallFunc {
		<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, node <span style="color:#ff79c6">*</span>registry.Node, req client.Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}, opts client.CallOptions) <span style="color:#8be9fd">error</span> {

			log.<span style="color:#50fa7b">Info</span>(<span style="color:#f1fa8c">&#34;sub wrapper: before call&#34;</span>)
			err <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">fn</span>(ctx, node, req, rsp, opts)
			log.<span style="color:#50fa7b">Info</span>(<span style="color:#f1fa8c">&#34;sub wrapper: after call&#34;</span>)

			<span style="color:#ff79c6">return</span> err
		}
	}
}
</code></pre></div><p>请求输出:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">logger wrapper: before call
sub wrapper: before call
sub wrapper: after call
logger wrapper: after call
</code></pre></div><p>由此可见 wrapper 链路是一个 <code>&quot;洋葱模型&quot;</code>:</p>
<p><img src="vinewrapper.png" alt=""></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-39eacc854f3fd422544f82d390b1f48c">2.14.2 - 链路追踪</h1>
    
	<h2 id="什么是链路追踪">什么是链路追踪</h2>
<p>链路追踪，全称分布式链路追踪。在微服务架构下，系统由大量服务组成，每个服务可能是由不同的团队开发、可能使用不同的编程语言来实现、有可能布在了几千台服务器，横跨多个不同的数据中心…例如一次请求往往会涉及到多个服务，在系统发生故障的时候，快速定位和解决问题，就需要追踪服务请求序列。因此，分析性能问题的工具以及理解系统的行为变得很重要。链路追踪正是用于解决这个问题。</p>
<p><strong>Vine</strong> 中通过 wrapper 实现链路追踪。</p>
<h2 id="实例">实例</h2>
<p>我们提供一个简单的代码实例，来说明链路追踪的工作方式:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	pb <span style="color:#f1fa8c">&#34;github.com/vine-io/examples/wrapper/pb&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/client&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/client/grpc&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/server&#34;</span>
	log <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/logger&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/trace&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/trace/memory&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/util/wrapper&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">type</span> hello <span style="color:#8be9fd;font-style:italic">struct</span> {
}

<span style="color:#8be9fd;font-style:italic">func</span> (h hello) <span style="color:#50fa7b">Echo</span>(ctx context.Context, request <span style="color:#ff79c6">*</span>pb.Request, response <span style="color:#ff79c6">*</span>pb.Response) <span style="color:#8be9fd">error</span> {
	ctx, span <span style="color:#ff79c6">:=</span> trace.DefaultTracer.<span style="color:#50fa7b">Start</span>(ctx, <span style="color:#f1fa8c">&#34;echo&#34;</span>)
	<span style="color:#ff79c6">defer</span> trace.DefaultTracer.<span style="color:#50fa7b">Finish</span>(span)
	
	response.Result = request.Name
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	s <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
		vine.<span style="color:#50fa7b">WrapHandler</span>(<span style="color:#50fa7b">HandlerWrapper</span>()),
	)

	s.<span style="color:#50fa7b">Init</span>()

	pb.<span style="color:#50fa7b">RegisterHelloHandler</span>(s.<span style="color:#50fa7b">Server</span>(), <span style="color:#ff79c6">&amp;</span>hello{})

	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		time.<span style="color:#50fa7b">Sleep</span>(time.Second)
        <span style="color:#6272a4">// grpc 加载 trace wrapper
</span><span style="color:#6272a4"></span>		cli <span style="color:#ff79c6">:=</span> grpc.<span style="color:#50fa7b">NewClient</span>(client.<span style="color:#50fa7b">WrapCall</span>(<span style="color:#50fa7b">CallWrapper</span>()))
		cli = wrapper.<span style="color:#50fa7b">TraceCall</span>(s.<span style="color:#50fa7b">Name</span>(), memory.<span style="color:#50fa7b">NewTracer</span>(), cli)
		cc <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">NewHelloService</span>(s.<span style="color:#50fa7b">Name</span>(), cli)
		cc.<span style="color:#50fa7b">Echo</span>(context.<span style="color:#50fa7b">TODO</span>(), <span style="color:#ff79c6">&amp;</span>pb.Request{<span style="color:#f1fa8c">&#34;Client&#34;</span>})
	}()

	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Run</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">CallWrapper</span>() client.CallWrapper {
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(fn client.CallFunc) client.CallFunc {
		<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, node <span style="color:#ff79c6">*</span>registry.Node, req client.Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}, opts client.CallOptions) <span style="color:#8be9fd">error</span> {
			traceID, parentID, ok <span style="color:#ff79c6">:=</span> trace.<span style="color:#50fa7b">FromContext</span>(ctx)
			<span style="color:#ff79c6">if</span> ok {
				fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;call: tarceID=%s parentID=%s\n&#34;</span>, traceID, parentID)
			}
			<span style="color:#ff79c6">return</span> <span style="color:#50fa7b">fn</span>(ctx, node, req, rsp, opts)
		}
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">HandlerWrapper</span>() server.HandlerWrapper {
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(fn server.HandlerFunc) server.HandlerFunc {
		<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, req server.Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span> {
			traceID, parentID, ok <span style="color:#ff79c6">:=</span> trace.<span style="color:#50fa7b">FromContext</span>(ctx)
			<span style="color:#ff79c6">if</span> ok {
				fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;handle: tarceID=%s parentID=%s\n&#34;</span>, traceID, parentID)
			}
			<span style="color:#ff79c6">return</span> <span style="color:#50fa7b">fn</span>(ctx, req, rsp)
		}
	}
}
</code></pre></div><p>新建链路</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">ctx = trace.<span style="color:#50fa7b">ToContext</span>(ctx, uuid.<span style="color:#50fa7b">NewString</span>(), uuid.<span style="color:#50fa7b">NewString</span>())
</code></pre></div><p>链路调用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// 新建链路
</span><span style="color:#6272a4"></span>ctx, span <span style="color:#ff79c6">:=</span> trace.<span style="color:#50fa7b">Start</span>(ctx, <span style="color:#f1fa8c">&#34;echo&#34;</span>)
<span style="color:#6272a4">// 停止 span
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">defer</span> trace.<span style="color:#50fa7b">Finish</span>(span)
</code></pre></div><p>捕获链路</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">traceID, parentID, ok <span style="color:#ff79c6">:=</span> trace.<span style="color:#50fa7b">FromContext</span>(ctx)
<span style="color:#ff79c6">if</span> ok {
	fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;call: tarceID=%s parentID=%s\n&#34;</span>, traceID, parentID)
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-93c9ae063448402518730eb36201d2b1">2.14.3 - 数据校验</h1>
    
	<h2 id="简介">简介</h2>
<p>通过 wrapper 的特性，我们可以对 <code>Client</code> 的输出和对 <code>Server</code> 输入的数据进行合法性校验。</p>
<h2 id="实现">实现</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	pb <span style="color:#f1fa8c">&#34;github.com/vine-io/examples/wrapper/pb&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/client&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/client/grpc&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/server&#34;</span>
	verrs <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/errors&#34;</span>
	log <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/logger&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/trace/memory&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/util/wrapper&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">type</span> hello <span style="color:#8be9fd;font-style:italic">struct</span>{}

<span style="color:#8be9fd;font-style:italic">func</span> (h hello) <span style="color:#50fa7b">Echo</span>(ctx context.Context, request <span style="color:#ff79c6">*</span>pb.Request, response <span style="color:#ff79c6">*</span>pb.Response) <span style="color:#8be9fd">error</span> {
	response.Result = request.Name
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	s <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
		vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;helloworld&#34;</span>),
		vine.<span style="color:#50fa7b">WrapHandler</span>(<span style="color:#50fa7b">HandlerValidatorWrapper</span>()),
	)

	s.<span style="color:#50fa7b">Init</span>()

	pb.<span style="color:#50fa7b">RegisterHelloHandler</span>(s.<span style="color:#50fa7b">Server</span>(), <span style="color:#ff79c6">&amp;</span>hello{})

	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		time.<span style="color:#50fa7b">Sleep</span>(time.Second)
		cli <span style="color:#ff79c6">:=</span> grpc.<span style="color:#50fa7b">NewClient</span>(client.<span style="color:#50fa7b">WrapCall</span>(<span style="color:#50fa7b">CallValidatorWrapper</span>()))
		cli = wrapper.<span style="color:#50fa7b">TraceCall</span>(s.<span style="color:#50fa7b">Name</span>(), memory.<span style="color:#50fa7b">NewTracer</span>(), cli)
		cc <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">NewHelloService</span>(s.<span style="color:#50fa7b">Name</span>(), cli)
		rsp, err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Echo</span>(context.<span style="color:#50fa7b">TODO</span>(), <span style="color:#ff79c6">&amp;</span>pb.Request{<span style="color:#f1fa8c">&#34;&#34;</span>})
		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
			log.<span style="color:#50fa7b">Fatal</span>(err)
		}
		fmt.<span style="color:#50fa7b">Println</span>(rsp)
	}()

	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Run</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}
}

<span style="color:#8be9fd;font-style:italic">type</span> Validator <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Validate</span>() <span style="color:#8be9fd">error</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">CallValidatorWrapper</span>() client.CallWrapper {
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(fn client.CallFunc) client.CallFunc {
		<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, node <span style="color:#ff79c6">*</span>registry.Node, req client.Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}, opts client.CallOptions) <span style="color:#8be9fd">error</span> {
			<span style="color:#ff79c6">if</span> v, ok <span style="color:#ff79c6">:=</span> req.<span style="color:#50fa7b">Body</span>().(Validator); ok {
				<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> v.<span style="color:#50fa7b">Validate</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
					<span style="color:#ff79c6">return</span> verrs.<span style="color:#50fa7b">BadRequest</span>(req.<span style="color:#50fa7b">Service</span>(), err.<span style="color:#50fa7b">Error</span>())
				}
			}
			<span style="color:#ff79c6">return</span> <span style="color:#50fa7b">fn</span>(ctx, node, req, rsp, opts)
		}
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">HandlerValidatorWrapper</span>() server.HandlerWrapper {
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(fn server.HandlerFunc) server.HandlerFunc {
		<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, req server.Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span> {
			<span style="color:#ff79c6">if</span> v, ok <span style="color:#ff79c6">:=</span> req.<span style="color:#50fa7b">Body</span>().(Validator); ok {
				<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> v.<span style="color:#50fa7b">Validate</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
					<span style="color:#ff79c6">return</span> verrs.<span style="color:#50fa7b">BadRequest</span>(req.<span style="color:#50fa7b">Service</span>(), err.<span style="color:#50fa7b">Error</span>())
				}
			}
			<span style="color:#ff79c6">return</span> <span style="color:#50fa7b">fn</span>(ctx, req, rsp)
		}
	}
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-62cd849eef8495611b5b8892f70d5afa">2.14.4 - 元数据</h1>
    
	<h2 id="简介">简介</h2>
<blockquote>
<p>元数据是用来描述数据的数据（Data that describes other data）。</p>
</blockquote>
<p><strong>Vine</strong> 中的元数据统一封装在 <code>context.Context</code> 中。通过 wrapper 的特性使我们可以在无入侵的情况下修改元数据信息。</p>
<h2 id="metadata">metadata</h2>
<p><code>metadata</code> 模块用于 <strong>Vine</strong> 元数据的操作，支持的操作如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">import</span> (
    <span style="color:#f1fa8c">&#34;context&#34;</span>
    <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/util/context/metadata&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    <span style="color:#6272a4">// 从 ctx 获取 key
</span><span style="color:#6272a4"></span>    val, ok <span style="color:#ff79c6">:=</span> metadata.<span style="color:#50fa7b">Get</span>(ctx, <span style="color:#f1fa8c">&#34;key&#34;</span>)
    <span style="color:#6272a4">// 修改 ctx 中的 key
</span><span style="color:#6272a4"></span>    metadata.<span style="color:#50fa7b">Set</span>(ctx, <span style="color:#f1fa8c">&#34;key&#34;</span>, <span style="color:#f1fa8c">&#34;value&#34;</span>)
    <span style="color:#6272a4">// 删除 ctx 中的 key
</span><span style="color:#6272a4"></span>    metadata.<span style="color:#50fa7b">Delete</span>(ctx, <span style="color:#f1fa8c">&#34;key&#34;</span>)
    <span style="color:#6272a4">// 获取 ctx 中的元数据
</span><span style="color:#6272a4"></span>    md, _ <span style="color:#ff79c6">:=</span> metadata.<span style="color:#50fa7b">FromContext</span>(ctx)
    <span style="color:#6272a4">// 封装 md
</span><span style="color:#6272a4"></span>    ctx = metadata.<span style="color:#50fa7b">NewContext</span>(ctx, md)
    <span style="color:#6272a4">// 完整拷贝元数据
</span><span style="color:#6272a4"></span>    md = metadata.<span style="color:#50fa7b">Copy</span>(md)
    <span style="color:#6272a4">// 合并 ctx 中的元数据
</span><span style="color:#6272a4"></span>    ctx = metadata.<span style="color:#50fa7b">MergeContext</span>(ctx, md, <span style="color:#ff79c6">true</span>)
}
</code></pre></div><h2 id="使用">使用</h2>
<p>在有 ctx 作为入参的地方都可以使用 metadata。如果不希望破坏业务代码，推荐在 wrapper 中使用:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">CallWrapper</span>() client.CallWrapper {
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(fn client.CallFunc) client.CallFunc {
		<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, node <span style="color:#ff79c6">*</span>registry.Node, req client.Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}, opts client.CallOptions) <span style="color:#8be9fd">error</span> {
			md, _ <span style="color:#ff79c6">:=</span> metadata.<span style="color:#50fa7b">FromContext</span>(ctx)
			<span style="color:#6272a4">// 追加 client=wrapper
</span><span style="color:#6272a4"></span>			md.<span style="color:#50fa7b">Set</span>(<span style="color:#f1fa8c">&#34;client&#34;</span>, <span style="color:#f1fa8c">&#34;wrapper&#34;</span>)
			ctx = metadata.<span style="color:#50fa7b">NewContext</span>(ctx, md)
			<span style="color:#ff79c6">return</span> <span style="color:#50fa7b">fn</span>(ctx, node, req, rsp, opts)
		}
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">HandlerWrapper</span>() server.HandlerWrapper {
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(fn server.HandlerFunc) server.HandlerFunc {
		<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context, req server.Request, rsp <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span> {
			val, _ <span style="color:#ff79c6">:=</span> metadata.<span style="color:#50fa7b">Get</span>(ctx, <span style="color:#f1fa8c">&#34;client&#34;</span>)
            <span style="color:#6272a4">// 获取 client
</span><span style="color:#6272a4"></span>			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;client: &#34;</span>, val)
			<span style="color:#ff79c6">return</span> <span style="color:#50fa7b">fn</span>(ctx, req, rsp)
		}
	}
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e1183309a928ffcc3eb6cc0dcd66651d">2.14.5 - 限流器</h1>
    
	<h2 id="简介">简介</h2>
<p>缓存、降级和限流是高并发系统时有三把利器。</p>
<p>限流(限制并发/请求量),它的目的是通过对并发访问/请求进行限速或者一个时间窗口内的请求进行限速来保护系统，如果请求达到上限值，服务端可以采取拒接服务、排队或等待、降级。</p>
<h2 id="限流算法">限流算法</h2>
<p>常见的限流算法有: 令牌桶、漏桶。</p>
<h3 id="漏桶">漏桶</h3>
<p>漏桶(Leaky Bucket)算法思路很简单，水(请求)先进入到漏桶里，漏桶以一定的速度出水(接口有响应速率)，当水流入速度过大会直接溢出(访问频率超过接口响应速率)，然后就拒绝请求，可以看出漏桶算法能强行限制数据的传输速率。
<img src="2021-09-08-10-57-08.png" alt=""></p>
<h3 id="令牌桶">令牌桶</h3>
<p>令牌桶算法(Token Bucket)和 Leaky Bucket 效果一样但方向相反的算法，更加容易理解。随着时间流逝，系统会按恒定 1/QPS 时间间隔(如果QPS=100,则间隔是10ms)往桶里加入 Token (想象和漏洞漏水相反,有个水龙头在不断的加水)，如果桶已经满了就不再加了。新请求来临时，会各自拿走一个Token，如果没有Token可拿了就阻塞或者拒绝服务。</p>
<p><img src="2021-09-08-10-57-47.png" alt=""></p>
<h2 id="使用">使用</h2>
<p><strong>Vine</strong> 的 wrapper 可以实现限流器功能:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>

	pb <span style="color:#f1fa8c">&#34;github.com/vine-io/examples/wrapper/pb&#34;</span>
	ub <span style="color:#f1fa8c">&#34;github.com/vine-io/plugins/wrapper/ratelimiter/uber&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
	log <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/logger&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">type</span> hello <span style="color:#8be9fd;font-style:italic">struct</span>{}

<span style="color:#8be9fd;font-style:italic">func</span> (h hello) <span style="color:#50fa7b">Echo</span>(ctx context.Context, request <span style="color:#ff79c6">*</span>pb.Request, response <span style="color:#ff79c6">*</span>pb.Response) <span style="color:#8be9fd">error</span> {
	response.Result = request.Name
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	handler <span style="color:#ff79c6">:=</span> ub.<span style="color:#50fa7b">NewHandlerWrapper</span>(<span style="color:#bd93f9">1000</span>)

	s <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
		vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;helloworld&#34;</span>),
		vine.<span style="color:#50fa7b">WrapHandler</span>(handler),
	)

	s.<span style="color:#50fa7b">Init</span>()

	pb.<span style="color:#50fa7b">RegisterHelloHandler</span>(s.<span style="color:#50fa7b">Server</span>(), <span style="color:#ff79c6">&amp;</span>hello{})

	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Run</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c483018e88ad8da9a20f3c7dfcffa915">2.14.6 - 断路器</h1>
    
	<h2 id="什么是断路器">什么是断路器</h2>
<blockquote>
<p>断路器（又称熔断器，Circuit Breaker，简称CB），广泛使用于工业生产和日常生活中，主要功能是合上和断开回路（ON/OFF POWER）。别名:空气开关、保险掣、无熔丝开关。断路器会在短路和严重超载的情况下切断电路，从而有效的保护回路中的电器。&ndash; 维基百科</p>
</blockquote>
<p>雪崩效应: 微服务之间的数据交互是通过远程调用来完成。服务A调用服务B，服务B调用服务C。如果某一时间调用链路上的一个服务不可用，但是其他服务还在不断调用这个服务，或者不断的重试，就会导致系统资源不断被占用，出现级联故障，从而造成这个系统可不用。</p>
<p><code>breaker</code> 的出现正是为了解决这个问题，当某个服务不可用是，调用端会开启熔断检测，当请求的错误达到一定阈值的时候，开启熔断关闭。这时所有调用这个服务的请求直接报错，避免出现级联故障。同时每个一段时间检测服务请求状态，如果服务请求成功，关闭熔断，链路恢复。它实际是中特殊的服务降级方式，是一种软件高并发解决方案。</p>
<p><img src="2021-09-08-10-04-36.png" alt=""></p>
<h2 id="使用">使用</h2>
<p><strong>Vine</strong> 通过 wrapper 特性实现熔断器功能，在 <code>Client Call</code> 请求中添加熔断 wrapper。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;os&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/sony/gobreaker&#34;</span>
	pb <span style="color:#f1fa8c">&#34;github.com/vine-io/examples/wrapper/pb&#34;</span>
	bk <span style="color:#f1fa8c">&#34;github.com/vine-io/plugins/wrapper/breaker/gobreaker&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
	log <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/logger&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">type</span> hello <span style="color:#8be9fd;font-style:italic">struct</span>{}

<span style="color:#8be9fd;font-style:italic">func</span> (h hello) <span style="color:#50fa7b">Echo</span>(ctx context.Context, request <span style="color:#ff79c6">*</span>pb.Request, response <span style="color:#ff79c6">*</span>pb.Response) <span style="color:#8be9fd">error</span> {
	response.Result = request.Name
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	bs <span style="color:#ff79c6">:=</span> gobreaker.Settings{
		Name:          <span style="color:#f1fa8c">&#34;breaker&#34;</span>,
		MaxRequests:   <span style="color:#bd93f9">10</span>,
		Interval:      time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">10</span>,
		Timeout:       time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">15</span>,
		ReadyToTrip: <span style="color:#8be9fd;font-style:italic">func</span>(counts gobreaker.Counts) <span style="color:#8be9fd">bool</span> {
			failureRatio <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">float64</span>(counts.TotalFailures) <span style="color:#ff79c6">/</span> <span style="color:#8be9fd;font-style:italic">float64</span>(counts.Requests)
			<span style="color:#ff79c6">return</span> counts.Requests <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">3</span> <span style="color:#ff79c6">&amp;&amp;</span> failureRatio <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">0.6</span>
		},
		OnStateChange: <span style="color:#8be9fd;font-style:italic">func</span>(name <span style="color:#8be9fd">string</span>, from gobreaker.State, to gobreaker.State) {
			log.<span style="color:#50fa7b">Info</span>(<span style="color:#f1fa8c">&#34;%s %s =&gt; %s&#34;</span>, name, from.<span style="color:#50fa7b">String</span>(), to.<span style="color:#50fa7b">String</span>())
		},
	}
	breaker <span style="color:#ff79c6">:=</span> bk.<span style="color:#50fa7b">NewCustomClientWrapper</span>(bs, bk.BreakService)

	s <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
		vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;helloworld&#34;</span>),
		vine.<span style="color:#50fa7b">WrapClient</span>(breaker),
	)

	s.<span style="color:#50fa7b">Init</span>()

	pb.<span style="color:#50fa7b">RegisterHelloHandler</span>(s.<span style="color:#50fa7b">Server</span>(), <span style="color:#ff79c6">&amp;</span>hello{})

	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		time.<span style="color:#50fa7b">Sleep</span>(time.Second)
		cc <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">NewHelloService</span>(s.<span style="color:#50fa7b">Name</span>(), s.<span style="color:#50fa7b">Client</span>())
		rsp, err <span style="color:#ff79c6">:=</span> cc.<span style="color:#50fa7b">Echo</span>(context.<span style="color:#50fa7b">TODO</span>(), <span style="color:#ff79c6">&amp;</span>pb.Request{<span style="color:#f1fa8c">&#34;&#34;</span>})
		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
			log.<span style="color:#50fa7b">Fatal</span>(err)
		}
		fmt.<span style="color:#50fa7b">Println</span>(rsp)
		os.<span style="color:#50fa7b">Exit</span>(<span style="color:#bd93f9">0</span>)
	}()

	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Run</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c049cbc8dfe9badc6517d70a4af559fb">2.15 - 定时任务</h1>
    
	<p><strong>Vine</strong> 服务内部携带定时任务调度器，用户可以注册 <code>Job</code>，服务启动时，调度器同时启动。</p>
<h2 id="新建">新建</h2>
<p>我们来尝试创建一个任务:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;log&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/gscheduler&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	job <span style="color:#ff79c6">:=</span> gscheduler.<span style="color:#50fa7b">JobBuilder</span>().
		<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;testjob&#34;</span>).          <span style="color:#6272a4">// 任务名称，唯一值
</span><span style="color:#6272a4"></span>		<span style="color:#50fa7b">Duration</span>(time.Second).    <span style="color:#6272a4">// 任务触发间隔时间
</span><span style="color:#6272a4"></span>		<span style="color:#50fa7b">Fn</span>(<span style="color:#8be9fd;font-style:italic">func</span>() {               <span style="color:#6272a4">// 任务业务主体
</span><span style="color:#6272a4"></span>			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;done!&#34;</span>)
		}).
		<span style="color:#50fa7b">Out</span>()                     <span style="color:#6272a4">// 返回 *Job
</span><span style="color:#6272a4"></span>
    <span style="color:#6272a4">// 添加定时任务
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">AddJob</span>(job); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	s <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>()
	s.<span style="color:#50fa7b">Init</span>()
	s.<span style="color:#50fa7b">Run</span>()
}
</code></pre></div><h2 id="构建过程">构建过程</h2>
<p>我们提供一组方法来简化定时任务的创建过程。</p>
<p>创建定时任务:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    job <span style="color:#ff79c6">:=</span> gscheduler.<span style="color:#50fa7b">JobBuilder</span>().
		<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;testjob&#34;</span>).
		<span style="color:#50fa7b">Duration</span>(time.Second).
		<span style="color:#50fa7b">Fn</span>(<span style="color:#8be9fd;font-style:italic">func</span>() {
			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;done!&#34;</span>)
		}).
		<span style="color:#50fa7b">Out</span>()
}
</code></pre></div><p>创建 crontab 定时任务:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">import</span> (
    <span style="color:#ff79c6">...</span>
    <span style="color:#f1fa8c">&#34;github.com/vine-io/gscheduler&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/gscheduler/cron&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    <span style="color:#6272a4">// crontab 表达式格式: 秒 分 时 日 月 周
</span><span style="color:#6272a4"></span>    c, err <span style="color:#ff79c6">:=</span> cron.<span style="color:#50fa7b">Parse</span>(<span style="color:#f1fa8c">&#34;*/3 * * * * *&#34;</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;invalid crontab expr: %v&#34;</span>, err)
	}

    <span style="color:#6272a4">// c = cron.Every(time.Second)
</span><span style="color:#6272a4"></span>
	job <span style="color:#ff79c6">:=</span> gscheduler.<span style="color:#50fa7b">JobBuilder</span>().
		<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;testjob&#34;</span>).
		<span style="color:#50fa7b">Spec</span>(c).
		<span style="color:#50fa7b">Fn</span>(<span style="color:#8be9fd;font-style:italic">func</span>() {
			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;done!&#34;</span>)
		}).
		<span style="color:#50fa7b">Out</span>()
}
</code></pre></div><p>创建一次性任务:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    job <span style="color:#ff79c6">:=</span> gscheduler.<span style="color:#50fa7b">JobBuilder</span>().
		<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;testjob&#34;</span>).
		<span style="color:#50fa7b">Delay</span>(time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">Add</span>(time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">2</span>)).
		<span style="color:#50fa7b">Fn</span>(<span style="color:#8be9fd;font-style:italic">func</span>() {
			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;done!&#34;</span>)
		}).
		<span style="color:#50fa7b">Out</span>()
}
</code></pre></div><p>额外的功能:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    job <span style="color:#ff79c6">:=</span> gscheduler.<span style="color:#50fa7b">JobBuilder</span>().
		<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;testjob&#34;</span>).
		<span style="color:#50fa7b">Duration</span>(time.Second).
		<span style="color:#50fa7b">Silent</span>().  <span style="color:#6272a4">// 任务静默
</span><span style="color:#6272a4"></span>		<span style="color:#50fa7b">Times</span>(<span style="color:#bd93f9">3</span>).  <span style="color:#6272a4">// 指定任务执行次数
</span><span style="color:#6272a4"></span>		<span style="color:#50fa7b">Fn</span>(<span style="color:#8be9fd;font-style:italic">func</span>() {
			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;done!&#34;</span>)
		}).
		<span style="color:#50fa7b">Out</span>()
}
</code></pre></div><h2 id="其他">其他</h2>
<p>内部定时任务调度器的其他功能:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    <span style="color:#6272a4">// 根据 id 获取任务
</span><span style="color:#6272a4"></span>    j, _ <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">GetJob</span>(job.<span style="color:#50fa7b">ID</span>())
    <span style="color:#6272a4">// 更新任务
</span><span style="color:#6272a4"></span>	vine.<span style="color:#50fa7b">UpdateJob</span>(j)
    <span style="color:#6272a4">// 删除任务
</span><span style="color:#6272a4"></span>	vine.<span style="color:#50fa7b">RemoveJob</span>(j)
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d2c6535126cca927d2a9c893abde92a0">3 - 用户指南</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-22e05ce140284b8cc925e8080f773895">3.1 - Protobuf 规范</h1>
    
	<p>我们提供一套 <code>Protobuf</code> 文件格式和神生成代码的规范，帮助用户写出更标准的接口。</p>
<p><strong>Vine</strong> 项目的推崇以 <strong>资源</strong> 为核心。接口的设计和代码的规范都按照 <strong>资源</strong> 展开。每个接口的设计遵循以下的规则:</p>
<ol>
<li>根据需求确定资源 (领域模型)。</li>
<li>每个接口实际为资源的方法或者是针对资源的操作。</li>
<li>每个 service 为资源操作的集合。</li>
<li>前端请求时提交的数据可直接转化为资源的内部属性。</li>
<li>提供的 API 接口格式统一为针对资源的曹组。</li>
</ol>
<h2 id="目录结构">目录结构</h2>
<p>API 接口统一存放在 api 目录下，proto 文件同时转化为 gRPC 和 HTTP 两种接口。</p>
<p>项目中定义 Proto，以 api 为根目录。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">├── service    
│   └── helloworld
│       └── v1
│           ├── helloworld.pb.go
│           ├── helloworld.pb.validator.go
│           ├── helloworld.pb.vine.go
│           └── helloworld.proto
└── types
    └── core
        └── v1
            ├── core.pb.dao.go
            ├── core.pb.deepcopy.go
            ├── core.pb.go
            ├── core.pb.validator.go
            └── core.proto
</code></pre></div><p>api 下有两个子目录，分别对应</p>
<ul>
<li>types (领域模型或者资源)，格式为 <code>group/version/name.proto</code></li>
<li>services (gRPC、http 接口)，格式为 <code>service/version/name.proto</code></li>
</ul>
<h2 id="包名">包名</h2>
<p>包名为应用的标识，用户生成 gRPC 请求路径，或者 proto 文件之间引用。</p>
<blockquote>
<p>建议在 $GOPATH/src 生成代码 proto 代码。</p>
</blockquote>
<h3 id="go_package">go_package</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#ff79c6">option</span> go_package <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;github.com/lack-io/foo/api/types/&lt;group&gt;/&lt;version&gt;;&lt;group&gt;&lt;version&gt;&#34;</span>;
</code></pre></div><h3 id="java_package">java_package</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#ff79c6">option</span> java_multiple_files <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>;
<span style="color:#ff79c6">option</span> java_package <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;io.vine.services.&lt;group&gt;.&lt;version&gt;&#34;</span>;
</code></pre></div><h2 id="import">import</h2>
<p>service proto 依赖 types protobuf，以 $GOPATH/src 为更目录引入对应 proto。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/foo/api/types/core/v1/core.proto&#34;</span>

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Request</span> {
    corev1.Request req <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div><h2 id="repo">repo</h2>
<p>当需要数据持久化时，有 types proto 生成对应的数据库交互代码。详细的说明可以参考 <a href="https://vine-io.github.io/vine/docs/guides/dao/">proto-gen-dao</a>。</p>
<p>代码的存放规则为，<em>谁实现，谁存放</em>。生成的代码存放在对应服务更目录的 <code>infra/repo</code> 下，需要在 proto 文件的头部指定生成路径:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +dao:output=github.com/vine-io/foo/pkg/helloworld/infra/repo;repo
</span><span style="color:#6272a4"></span>syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;protoc&#34;</span>
</code></pre></div><h2 id="命令规范">命令规范</h2>
<h3 id="目录结构-1">目录结构</h3>
<p>包名为小写，且同与目录一致: 如 <code>hellowrold/v1/helloworld.proto</code> 的包名为 <code>helloworldv1</code>。</p>
<h3 id="文件结构">文件结构</h3>
<p>文件应该命名为：lower_snake_case.proto 所有Proto应按下列方式排列:</p>
<ul>
<li>License header (if applicable)</li>
<li>File overview</li>
<li>Syntax</li>
<li>Package</li>
<li>Imports (sorted)</li>
<li>File options</li>
<li>Service</li>
<li>Message</li>
</ul>
<h3 id="service-和-message">Service 和 Message</h3>
<p>使用驼峰命名法命名 service, method 和 message。Service 的名称格式为 <code>&lt;PackageName&gt;Service</code> 以 <code>Service</code> 为后缀。</p>
<p>Method 的格式为:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">service</span> EchoService {
    <span style="color:#ff79c6">rpc</span> EmptyMethod(Empty) <span style="color:#ff79c6">returns</span> (Empty);
    <span style="color:#ff79c6">rpc</span> Echo(EchoReq) <span style="color:#ff79c6">returns</span> (EchoRsp);
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Empty</span> {}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">EchoReq</span> {}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">EchoRsp</span> {}
</code></pre></div><p>Method 的输入输出 Message 没有其他字段时，使用 <code>Empty</code>。Method 的输入 message 以 <code>Req</code> 结尾。输出 message 以 <code>Rsp</code> 结尾。</p>
<h3 id="字段">字段</h3>
<p>字段使用驼峰命名法(首字母小写)，<code>repeated</code> 数组类型是结尾加小写:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">User</span> {
    <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
    <span style="color:#ff79c6">repeated</span> <span style="color:#8be9fd">string</span> tags <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}
</code></pre></div><h3 id="枚举-enums">枚举 Enums</h3>
<p>使用驼峰命名法（首字母大写）命名枚举类型，使用 “大写下划线大写” 的方式命名枚举值：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">enum</span> Color {
  RED <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
  BLACK <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div><p>每一个枚举值以分号结尾，而非逗号。</p>
<h3 id="注释-comment">注释 Comment</h3>
<ul>
<li>Service，描述清楚服务的作用</li>
<li>Method，描述清楚接口的功能特性</li>
<li>Field，描述清楚字段准确的信息</li>
</ul>
<h2 id="完整实例">完整实例</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;proto3&#34;</span>;

<span style="color:#ff79c6">package</span> gpmv1;

<span style="color:#ff79c6">option</span> go_package <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/gpm/api/service/gpm/v1;gpmv1&#34;</span>;
<span style="color:#ff79c6">option</span> java_multiple_files <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>;
<span style="color:#ff79c6">option</span> java_package <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;io.vine.services.gpm.v1&#34;</span>;

<span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/gpm/api/types/gpm/v1/gpm.proto&#34;</span>;

<span style="color:#6272a4">// +gen:openapi
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">service</span> GpmService {
  <span style="color:#6272a4">// +gen:summary=查询单个服务
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:get=/api/v1/Service/{name}
</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> GetService(GetServiceReq) <span style="color:#ff79c6">returns</span> (GetServiceRsp);
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Empty</span> {}

<span style="color:#6272a4">// GetService 请求参数
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">GetServiceReq</span> {
  <span style="color:#6272a4">// 服务名称
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}

<span style="color:#6272a4">// GetService 返回结果
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">GetServiceRsp</span> {
  gpmv1.Service <span style="color:#8be9fd;font-style:italic">service</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d821b90f925c23ea34f7869438d8aa2a">3.2 - Vine 工具</h1>
    <div class="lead">在 <strong>vine</strong> 框架下我们提供一套命令行管理工具，用来管理项目和实现与 <strong>vine</strong> 服务的交互</div>
	<h2 id="安装-vine-工具">安装 vine 工具</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/vine-io/vine/cmd/vine
</code></pre></div><p>验证安装结果</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ vine --help
NAME:
   vine - A vine service runtime
        _
 _   __<span style="color:#ff79c6">(</span>_<span style="color:#ff79c6">)</span>___  ___
| | / / / __ <span style="color:#f1fa8c">\/</span> _ <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>| |/ / / / / /  __/
|___/_/_/ /_/<span style="color:#f1fa8c">\_</span>__/

USAGE:
   vine <span style="color:#ff79c6">[</span>global options<span style="color:#ff79c6">]</span> <span style="color:#8be9fd;font-style:italic">command</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">command</span> options<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>arguments...<span style="color:#ff79c6">]</span>

VERSION:
   ...

COMMANDS:
   api      Run the api gateway
   new      Create vine resource template
   init     Initialize a vine project
   build    Build vine project or resource
   run      Start a vine project
   help, h  Shows a list of commands or <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">for</span> one <span style="color:#8be9fd;font-style:italic">command</span>

GLOBAL OPTIONS:
   --help, -h     show <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
   --version, -v  print the version <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
</code></pre></div><p>vine 命令行工具支持多个子命令，包含以下功能:</p>
<ul>
<li>启动网关</li>
<li>项目管理 (创建，编译，运行)</li>
</ul>
<h2 id="vine-项目管理">vine 项目管理</h2>
<p><code>new</code>, <code>init</code>, <code>build</code>, <code>run</code> 可能帮助开发人员很好的管理 vine 实现的项目。接下来我们使用该工具一步步实现单服务的管理</p>
<h3 id="初始化项目">初始化项目</h3>
<p>新建目录 <code>$GOPATH/src/example</code> (建议将项目目录保存在 GOPATH 下。)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkdir <span style="color:#8be9fd;font-style:italic">$GOAPTH</span>/src/example
$ <span style="color:#8be9fd;font-style:italic">cd</span> <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/example
</code></pre></div><p>在项目目录下执行初始化操作:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ vine init 
Creating resource  in <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/example

.
├── vine.toml
├── README.md
├── .gitignore
└── go.mod
</code></pre></div><p>初始化话生成以上文件，<code>vine.toml</code> 中包含项目相关的信息，包含该文件的目录就会被识别为 <code>vine</code> 项目。</p>
<h3 id="新建服务">新建服务</h3>
<p>执行以下命令创建一个服务:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ vine new service 
Creating resource example in <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/example

.
├── cmd
│   └── main.go
├── pkg
│   ├── runtime
│   │   └── doc.go
│   ├── plugin.go
│   ├── app.go
│   ├── server
│   │   └── example.go
│   ├── service
│   │   ├── example.go
│   │   └── wire.go
│   └── dao
│       └── example.go
├── deploy
│   ├── Dockerfile
│   ├── example.ini
│   └── example.service
├── proto
│   └── service
│       └── example
│           └── v1
│               └── example.proto
└── vine.toml


download protoc zip packages <span style="color:#ff79c6">(</span>protoc-<span style="color:#8be9fd;font-style:italic">$VERSION</span>-<span style="color:#8be9fd;font-style:italic">$PLATFORM</span>.zip<span style="color:#ff79c6">)</span> and install:

visit https://github.com/protocolbuffers/protobuf/releases

download protobuf <span style="color:#ff79c6">for</span> vine:

<span style="color:#8be9fd;font-style:italic">cd</span> example

install dependencies:
   go get github.com/google/wire/cmd/wire
	go get github.com/gogo/protobuf
	go get github.com/vine-io/vine/cmd/protoc-gen-gogo
	go get github.com/vine-io/vine/cmd/protoc-gen-vine
	go get github.com/vine-io/vine/cmd/protoc-gen-validator
	go get github.com/vine-io/vine/cmd/protoc-gen-deepcopy
	go get github.com/vine-io/vine/cmd/protoc-gen-dao

<span style="color:#8be9fd;font-style:italic">cd</span> example
	vine build example
</code></pre></div><h3 id="安装依赖包">安装依赖包</h3>
<p>根据提示，安装依赖</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ go get github.com/google/wire/cmd/wire
$ go get github.com/gogo/protobuf
$ go get github.com/vine-io/vine/cmd/protoc-gen-gogo
$ go get github.com/vine-io/vine/cmd/protoc-gen-vine
$ go get github.com/vine-io/vine/cmd/protoc-gen-validator
$ go get github.com/vine-io/vine/cmd/protoc-gen-deepcopy
$ go get github.com/vine-io/vine/cmd/protoc-gen-dao
</code></pre></div><h3 id="编译项目">编译项目</h3>
<p>生成 <code>*.pb.go</code> 代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ vine build proto --type<span style="color:#ff79c6">=</span>service  --group<span style="color:#ff79c6">=</span>example example
change directory <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src:
protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src --gogo_out<span style="color:#ff79c6">=</span>:. --vine_out<span style="color:#ff79c6">=</span>:. --validator_out<span style="color:#ff79c6">=</span>:. example/proto/service/example/v1/example.proto
</code></pre></div><p>编译成二进制文件:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ go mod vendor
go: finding module <span style="color:#ff79c6">for</span> package github.com/google/wire
go: found github.com/google/wire in github.com/google/wire v0.5.0
$ vine build service example
vine build service example
go build -a -installsuffix cgo -ldflags <span style="color:#f1fa8c">&#34;-s -w&#34;</span> cmd/main.go
speed: 17.907776483s
</code></pre></div><h3 id="运行服务">运行服务</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./main
2021-06-05 08:47:29  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>vine/service.go:199 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Starting <span style="color:#ff79c6">[</span>service<span style="color:#ff79c6">]</span> go.vine.service.example
2021-06-05 08:47:29  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>vine/service.go:200 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info service <span style="color:#ff79c6">[</span>version<span style="color:#ff79c6">]</span> latest
2021-06-05 08:47:29  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>grpc/grpc.go:878 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Server <span style="color:#ff79c6">[</span>grpc<span style="color:#ff79c6">]</span> Listening on <span style="color:#ff79c6">[</span>::<span style="color:#ff79c6">]</span>:51530
2021-06-05 08:47:29  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>grpc/grpc.go:719 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info Registry <span style="color:#ff79c6">[</span>mdns<span style="color:#ff79c6">]</span> Registering node: go.vine.service.example-81ec2a02-c402-42d7-88c8-3de75a68a49b
2021-06-05 08:47:29  <span style="color:#8be9fd;font-style:italic">file</span><span style="color:#ff79c6">=</span>mdns/mdns_registry.go:266 <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info <span style="color:#ff79c6">[</span>mdns<span style="color:#ff79c6">]</span> registry create new service with ip: 192.168.11.167 <span style="color:#ff79c6">for</span>: 192.168.11.167
</code></pre></div><h2 id="vine-项目结构">vine 项目结构</h2>
<p>vine 项目采用合理的结构，使代码结构变得清晰易理解。项目分成两种类型，<code>cluster</code> 分布式和 <code>single</code> 单服务。两种类型的目录结构上有一些区别</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4"># 单服务项目</span>
.
├── cmd  <span style="color:#6272a4"># 服务入口目录, single类型时目录下只有 main.go 文件，cluster 下包含多个服务同名的目录，内部有 main.go 文件</span>
│   └── main.go
├── pkg  <span style="color:#6272a4"># pkg 每个服务核心代码存放下该目录下，single类型时，目录下直接存放服务代码，cluster类型时，目录还有一层服务同名的子目录。</span>
│   ├── runtime  <span style="color:#6272a4"># 各服务公用的工具包和 client 等</span>
│   │   └── doc.go
│   ├── plugin.go <span style="color:#6272a4"># vine 服务的插件信息</span>
│   ├── app.go    <span style="color:#6272a4"># 服务入口，初始化的一些代码</span>
│   ├── server    <span style="color:#6272a4"># 提供 rpc 服务，只进行一些数据的验证，具体工具调用 service</span>
│   │   └── example.go
│   ├── service   <span style="color:#6272a4"># 服务业务逻辑代码</span>
│   │   ├── example.go
│   │   └── wire.go <span style="color:#6272a4"># 使用 github.com/google/wire 实现 DI</span>
│   └── dao       <span style="color:#6272a4"># 数据库交互代码，有 protoc 工具自动生成</span>
│       └── example.go
├── deploy    <span style="color:#6272a4"># 项目代码部署时需要的文件，single 和 cluster 结构上不同</span>
│   ├── Dockerfile <span style="color:#6272a4"># 服务 Dockerfile</span>
│   ├── example.ini <span style="color:#6272a4"># 服务的启动参数配置文件</span>
│   └── example.service <span style="color:#6272a4"># CentOS 上的服务脚本</span>
├── proto    <span style="color:#6272a4"># 存放 *.proto 文件及其生成的 *.go 代码，分成 apis 和 service 类型</span>
│   └── service <span style="color:#6272a4"># 提供 gRPC 服务，引用 proto/apis 下的 message  </span>
│       └── example <span style="color:#6272a4"># 和服务同名的目录</span>
│           └── v1  <span style="color:#6272a4"># 服务接口版本，默认为 v1</span>
│               └── example.proto
└── vine.toml <span style="color:#6272a4"># vine 项目的描述文件，有该文件则被认定为 vine 项目。</span>
</code></pre></div><p><code>vine.toml</code> 文件内容说明</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#ff79c6">[</span>package<span style="color:#ff79c6">]</span>   
<span style="color:#8be9fd;font-style:italic">kind</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;single&#34;</span> <span style="color:#6272a4"># 项目类型</span>
<span style="color:#8be9fd;font-style:italic">namespace</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;go.vine&#34;</span> <span style="color:#6272a4"># 项目的命令空间</span>

<span style="color:#ff79c6">[</span>pkg<span style="color:#ff79c6">]</span>  <span style="color:#6272a4"># kind = &#34;single&#34; 该配置存在，描述服务信息。</span>
<span style="color:#8be9fd;font-style:italic">name</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;example&#34;</span> <span style="color:#6272a4"># 服务命令</span>
<span style="color:#8be9fd;font-style:italic">alias</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;go.vine.service.example&#34;</span> <span style="color:#6272a4"># 别名</span>
<span style="color:#8be9fd;font-style:italic">type</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;service&#34;</span>  <span style="color:#6272a4"># 服务类型,提供 gRPC 接口，service, web, gateway</span>
<span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;latest&#34;</span> <span style="color:#6272a4"># 服务版本</span>
<span style="color:#8be9fd;font-style:italic">main</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;cmd/main.go&#34;</span> <span style="color:#6272a4"># main 函数路径</span>
<span style="color:#8be9fd;font-style:italic">dir</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;example&#34;</span> <span style="color:#6272a4"># 项目目录路径，$GOPATH/src 下</span>
<span style="color:#8be9fd;font-style:italic">output</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span> <span style="color:#6272a4"># 服务编译时，输入路径 go build -o $output main.go</span>
<span style="color:#8be9fd;font-style:italic">flags</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">[</span>   <span style="color:#6272a4"># 服务编译时的额外参数，支持多个格式，&#34;KEY=value&#34;, &#34;-key&#34;, &#34;key=${shell command}&#34;  </span>
	<span style="color:#f1fa8c">&#34;-a&#34;</span>, <span style="color:#f1fa8c">&#34;-installsuffix&#34;</span>, <span style="color:#f1fa8c">&#34;cgo&#34;</span>, <span style="color:#f1fa8c">&#34;-ldflags \&#34;-s -w\&#34;&#34;</span>,
<span style="color:#ff79c6">]</span>

<span style="color:#ff79c6">[[</span>mod<span style="color:#ff79c6">]]</span>  <span style="color:#6272a4"># kind = &#34;cluster&#34; 该配置存在，描述服务信息。每个 mod 表示一个服务</span>
<span style="color:#8be9fd;font-style:italic">name</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;apiserver&#34;</span>
<span style="color:#8be9fd;font-style:italic">alias</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;com.howlink.service.apiserver&#34;</span>
<span style="color:#8be9fd;font-style:italic">type</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;service&#34;</span>
<span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;latest&#34;</span>
<span style="color:#8be9fd;font-style:italic">main</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;cmd/apiserver/main.go&#34;</span>
<span style="color:#8be9fd;font-style:italic">dir</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;dr/apiserver&#34;</span>
<span style="color:#8be9fd;font-style:italic">output</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;_output/apiserver&#34;</span>
<span style="color:#8be9fd;font-style:italic">flags</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">[</span>
	<span style="color:#f1fa8c">&#34;GOOS=linux&#34;</span>, <span style="color:#f1fa8c">&#34;GOARCH=amd64&#34;</span>, <span style="color:#f1fa8c">&#34;-a&#34;</span>, <span style="color:#f1fa8c">&#34;-installsuffix&#34;</span>, <span style="color:#f1fa8c">&#34;cgo&#34;</span>, <span style="color:#f1fa8c">&#34;-ldflags \&#34;-s -w\&#34;&#34;</span>,
<span style="color:#ff79c6">]</span>

<span style="color:#ff79c6">[[</span>proto<span style="color:#ff79c6">]]</span> <span style="color:#6272a4"># .proto 文件描述信息</span>
<span style="color:#8be9fd;font-style:italic">name</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;example&#34;</span> <span style="color:#6272a4"># 文件名</span>
<span style="color:#8be9fd;font-style:italic">pb</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;example/proto/service/example/v1/example.proto&#34;</span> <span style="color:#6272a4"># 路径</span>
<span style="color:#8be9fd;font-style:italic">type</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;service&#34;</span> <span style="color:#6272a4"># 类型，service 和 api</span>
<span style="color:#8be9fd;font-style:italic">group</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;example&#34;</span> <span style="color:#6272a4"># 组，同个 group 下不同有同名的 proto 文件</span>
<span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;v1&#34;</span> <span style="color:#6272a4"># 版本，默认为 v1</span>
<span style="color:#8be9fd;font-style:italic">plugins</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#34;gogo&#34;</span>, <span style="color:#f1fa8c">&#34;vine&#34;</span>, <span style="color:#f1fa8c">&#34;validator&#34;</span><span style="color:#ff79c6">]</span> <span style="color:#6272a4"># 生成 .go 代码时启用的 protoc 插件</span>
</code></pre></div><h2 id="vine-命令解析">vine 命令解析</h2>
<p><code>vine</code> 工具支持以下子命令:</p>
<ul>
<li>api      启动网关服务</li>
<li>new      创建服务或者proto文件</li>
<li>init     初始化项目，将一个目录转化为项目目录</li>
<li>build    编译服务、生成 .go 文件</li>
<li>run      运行服务</li>
</ul>
<h3 id="init-子命令">init 子命令</h3>
<p><code>vine init</code> 支持以下参数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ vine init --help    
NAME:
   vine init - Initialize a vine project

USAGE:
   vine init <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">command</span> options<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>arguments...<span style="color:#ff79c6">]</span>

OPTIONS:
   --namespace string  Namespace <span style="color:#ff79c6">for</span> the project e.g com.example <span style="color:#ff79c6">(</span>default: <span style="color:#f1fa8c">&#34;go.vine&#34;</span><span style="color:#ff79c6">)</span> <span style="color:#6272a4"># 指定项目的命令空间</span>
   --cluster           create cluster package. <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span> <span style="color:#6272a4"># 确认项目类型，默认为单服务</span>
   --help, -h          show <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
</code></pre></div><p>vine 项目支持 cluster (多服务分布式)、single (单服务，默认) 两种类型。</p>
<h3 id="new-子命令">new 子命令</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ NAME:
   vine new - Create vine resource template

USAGE:
   vine new <span style="color:#8be9fd;font-style:italic">command</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">command</span> options<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>arguments...<span style="color:#ff79c6">]</span>

COMMANDS:
   service  Create a service template  <span style="color:#6272a4"># 创建一个 gRPC 服务</span>
   gateway  Create a gateway template  <span style="color:#6272a4"># 创建一个网关服务</span>
   web      Create a web template      <span style="color:#6272a4"># 创建一个 web 服务</span>
   proto    Create a proto file        <span style="color:#6272a4"># 创建 proto 文件</span>
   help, h  Shows a list of commands or <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">for</span> one <span style="color:#8be9fd;font-style:italic">command</span>

OPTIONS:
   --help, -h     show <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
   --version, -v  print the version <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
   
</code></pre></div><h3 id="build-子命令">build 子命令</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ vine build --help
NAME:
   vine build - Build vine project or resource

USAGE:
   vine build <span style="color:#8be9fd;font-style:italic">command</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">command</span> options<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>arguments...<span style="color:#ff79c6">]</span>

COMMANDS:
   proto    Generate protobuf file  <span style="color:#6272a4"># 生成 proto 对应的go代码</span>
   service  Build vine project      <span style="color:#6272a4"># 编译服务</span>
   help, h  Shows a list of commands or <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">for</span> one <span style="color:#8be9fd;font-style:italic">command</span>

OPTIONS:
   --help, -h     show <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>
   --version, -v  print the version <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>

</code></pre></div><h3 id="run-子命令">run 子命令</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ vine run --help          
NAME:
   vine run - Start a vine project

USAGE:
   vine run <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">command</span> options<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>arguments...<span style="color:#ff79c6">]</span>

OPTIONS:
   --auto-restart   <span style="color:#6272a4"># 是否在监听到文件变动时自动重启，默认为 true</span>
   --watch strings  <span style="color:#6272a4"># 监听指定目录的文件内容变化</span>
   --help, -h       show <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>default: <span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">)</span>

</code></pre></div><p>// TODO</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-826345e38af594c61cf85a8e0dd09f73">3.3 - protoc-gen-vine</h1>
    <div class="lead"><em>OpenAPI</em> 通过 <code>protoc-gen-vine</code> 集成 openapi3.0。</div>
	<h2 id="概述">概述</h2>
<p><em>Vine</em> 内部集成 openapi3.0，<code>protoc-gen-vine</code> 通过识别 protobuf 文件的注释生成 Openapi3.0 文档。类似 <a href="https://vine-io.github.io/vine/docs/tools/validate/">Validator</a>。</p>
<h2 id="使用">使用</h2>
<h3 id="1先编写-helloworldproto-文件">1.先编写 helloworld.proto 文件</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;proto3&#34;</span>;

<span style="color:#ff79c6">package</span> testdata;
<span style="color:#ff79c6">option</span> go_package <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/testdata/proto;testdata&#34;</span>;

<span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/proto/api/api.proto&#34;</span>;

<span style="color:#6272a4">// +gen:openapi
</span><span style="color:#6272a4">// +gen:term_name=vine
</span><span style="color:#6272a4">// +gen:term_email=598223084@qq.com
</span><span style="color:#6272a4">// +gen:contact_name=vine
</span><span style="color:#6272a4">// +gen:contact_email=598223084@qq.com
</span><span style="color:#6272a4">// +gen:license_name=Apache2.0
</span><span style="color:#6272a4">// +gen:license_url=https://www.apache.org/licenses/LICENSE-2.0
</span><span style="color:#6272a4">// +gen:external_doc_desc=123
</span><span style="color:#6272a4">// +gen:external_doc_url=http://www.baidu.com
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">service</span> Helloworld {
  <span style="color:#6272a4">// +gen:get=/api/v1/call
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:body=*
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:summary=callllllllll
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:security=bearer, apiKeys, basic
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:result=[200]
</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Call(HelloWorldRequest) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {};
  <span style="color:#6272a4">// +gen:post=/api/v1/event
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:body=*
</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Mul(api.Event) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {};
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">HelloWorldRequest</span> {
  <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
  <span style="color:#8be9fd">int32</span> age <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}


<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">HelloWorldResponse</span> {
  <span style="color:#8be9fd">int32</span> code <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
  <span style="color:#8be9fd">string</span> reply <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}


</code></pre></div><h3 id="2安装-protoc-gen-vine">2.安装 protoc-gen-vine</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/vine-io/vine/cmd/protoc-gen-vine
</code></pre></div><h3 id="3生成-swagger-文档">3.生成 swagger 文档</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/github.com/gogo/googleapis --gogofaster_out<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">plugins</span><span style="color:#ff79c6">=</span>grpc:. --vine_out<span style="color:#ff79c6">=</span>:. proto/helloworld.proto
</code></pre></div><p>执行完成后生成以下代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#6272a4">// Swagger OpenAPI 3.0 for Helloworld service
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">NewHelloworldOpenAPI</span>() <span style="color:#ff79c6">*</span>registry.OpenAPI {
    <span style="color:#6272a4">// ...
</span><span style="color:#6272a4"></span>}
</code></pre></div><h3 id="4验证">4.验证</h3>
<p>生成的 Openapi3.0 文档会自动注册到 <code>Registry</code> 组件，当启动 <code>vine api</code> 时添加 <code>--enable-openapi</code> 参数可以启动 OpenAPI3.0 功能:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">vine api <span style="color:#ff79c6">--</span>handler=rpc <span style="color:#ff79c6">--</span>enable<span style="color:#ff79c6">-</span>openapi
</code></pre></div><p>启动用访问 url <code>http://127.0.0.1:8080/openapi-ui/</code> 效果如下:</p>
<p><img src="2021-01-25-18-58-50.png" alt="swagger-openapi"></p>
<p><em>Vine</em> 的 OpenAPI 支持 swagger 风格和 redoc 风格，切换到 redoc 则使用路径 <code>http://127.0.0.1:8080/openapi-ui/?style=redoc</code>，效果如下：</p>
<p><img src="2021-01-25-19-04-57.png" alt="redoc-openapi"></p>
<h2 id="语法解析">语法解析</h2>
<p><code>protoc-gen-vine</code> 通过解析 <code>protobuf</code> 中的注释来生成 OpenAPI3.0 文档。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +gen:openapi
</span><span style="color:#6272a4">// +gen:term_name=vine
</span><span style="color:#6272a4">// +gen:term_email=598223084@qq.com
</span><span style="color:#6272a4">// +gen:contact_name=vine
</span><span style="color:#6272a4">// +gen:contact_email=598223084@qq.com
</span><span style="color:#6272a4">// +gen:license_name=Apache2.0
</span><span style="color:#6272a4">// +gen:license_url=https://www.apache.org/licenses/LICENSE-2.0
</span><span style="color:#6272a4">// +gen:external_doc_desc=123
</span><span style="color:#6272a4">// +gen:external_doc_url=http://www.baidu.com
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">service</span> Helloworld {
  <span style="color:#6272a4">// +gen:get=/api/v1/call
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:body=*
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:summary=callllllllll
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:security=bearer, apiKeys, basic
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:result=[200]
</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Call(HelloWorldRequest) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {};
  <span style="color:#6272a4">// +gen:post=/api/v1/event
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:body=*
</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Mul(api.Event) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {};
}
</code></pre></div><blockquote>
<p>注: <code>protoc-gen-vine</code> 和 <code>protoc-gen-validator</code> 中存在大量重复注释，这样设计的原因是通过一套的注释规则直接生成更多的代码，较少非业务代码的编写。</p>
</blockquote>
<h3 id="语法规则">语法规则</h3>
<p>有效的注释有以下的规则:</p>
<ul>
<li>注释必须以 <code>+gen</code> 作为开头</li>
<li>注释的内容必须紧贴对应的字段，中间不能有空行</li>
<li>支持多行注释，也可以将多行合并成一行，并用 <code>;</code> 作为分隔符</li>
</ul>
<blockquote>
<p>注：// 风格的注释会被识别为 openapi3.0 中的 Description 信息。</p>
</blockquote>
<h3 id="类型支持">类型支持</h3>
<p><code>service</code> 类型规则:</p>
<ul>
<li>openapi（必填）: 生成 openapi 的标识，具有此标识的 Service 才会生成文档</li>
<li>term_url: 项目团队的 url</li>
<li>contact_name: 项目作者名称，和 contact_email 配合使用</li>
<li>contact_email: 项目作者邮箱，和 contact_name 配合使用</li>
<li>license_name: 项目遵循的许可类型，和 license_url 配合使用</li>
<li>license_url: 项目遵循的许可 url，和 license_name配合使用</li>
<li>external_doc_desc: 扩展文档描述，和 external_doc_url 配合使用</li>
<li>external_doc_url: 扩展文档 url，和 external_doc_url 配合使用</li>
<li>version: 文档版本，如 1.0.0</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +gen:ignore
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">P</span> {
  <span style="color:#6272a4">// +gen:openapi
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:term_name=vine
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:term_email=598223084@qq.com
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:contact_name=vine
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:contact_email=598223084@qq.com
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:license_name=Apache2.0
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:license_url=https://www.apache.org/licenses/LICENSE-2.0
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:external_doc_desc=123
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:external_doc_url=http://www.example.com
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd;font-style:italic">service</span> HelloWorld {

  }
}
</code></pre></div><p><code>rpc</code> 支持的规则:</p>
<ul>
<li>get | post | put | patch | delete（必填）: 生成对应的 http method，后面紧接路由信息，如 // +gen:get=/api/v1/call</li>
<li>body: 指定 Request message 的名称，可以直接使用 <code>*</code></li>
<li>summary: 接口的摘要信息</li>
<li>security: 路由支持的 Authorization。支持 beaer, apiKeys 和 basic</li>
<li>result: http response code。支持 200，400，401，403，404，405，408，409，500，502，503，504</li>
</ul>
<blockquote>
<p>注: 使用 +gen:security 时，result 会直接添加 401，403 的内容</p>
</blockquote>
<p><code>message</code> 作为内嵌字段时支持的规则:</p>
<ul>
<li>required: 判断该字段是否为 nil。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">service</span> Helloworld {
  <span style="color:#6272a4">// +gen:get=/api/v1/call
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:body=*
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:summary=callllllllll
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:security=bearer, apiKeys, basic
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:result=[200]
</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Call(HelloWorldRequest) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {};
  <span style="color:#6272a4">// +gen:post=/api/v1/{name}/{id}
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:body=*
</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">rpc</span> Mul(api.Event) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {};
}
</code></pre></div><p><code>message</code> 字段通用的规则：</p>
<ul>
<li>required: 指定字段为必填</li>
<li>default: 指定字段的默认值</li>
<li>example: 给定字段的实例</li>
<li>in: 字段只能在几个值中选择</li>
<li>enum: 同 in</li>
<li>ro: 字段为只读</li>
<li>wo: 字段为只写，和 password 配合使用</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">HelloWorldRequest</span> {
  <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:default=&#34;hello&#34;
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:example=&#34;hello&#34;
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:ro
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:rw
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
  <span style="color:#6272a4">// +gen:enum=[1,2,3]
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">int32</span> age <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}
</code></pre></div><p><code>string</code> 类型支持的规则</p>
<ul>
<li>min_len: 指定字段的最小长度</li>
<li>max_len: 指定字段的最大长度</li>
<li>email: 邮箱地址格式</li>
<li>date: 日期格式<a href="https://tools.ietf.org/html/rfc3339#section-5.6">RFC 3339, section 5.6</a>，如 2017-07-21</li>
<li>date-time: 日期加时间格式<a href="https://tools.ietf.org/html/rfc3339#section-5.6">RFC 3339, section 5.6</a>，如 2017-07-21T17:32:28Z</li>
<li>password: 密码格式</li>
<li>byte: 字节格式</li>
<li>binary: 二进制格式，上传文件使用</li>
<li>ip: ip 地址格式</li>
<li>ipv4: ipv4 格式</li>
<li>ipv6: ipv6 格式</li>
<li>uuid: uuid v4 格式</li>
<li>uri: uri 格式</li>
<li>hostname: 主机名</li>
<li>pattern: 正则表达式</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">S</span> {
    <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:default=&#34;hello&#34;
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:in=[&#34;1&#34;, &#34;2&#34;, &#34;3&#34;]
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:enum=[&#34;a&#34;, &#34;b&#34;, &#34;c&#34;]
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_len=3
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_max=4
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:pattern=`\d+(\w+){3,5}`
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:password
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:email
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:ip
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:ipv4
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:ipv6
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:date
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:date-time
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:bytes
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:binary
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:hostname
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:uuid
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:uri
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">string</span> m <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div><blockquote>
<p>注: string pattern 最好单独一行，以免和其他规则冲突</p>
</blockquote>
<p>数字类型的支持，包含 int32, int64, fixed32, fix64, float, double</p>
<ul>
<li>lt: 指定字段小于指定值</li>
<li>lte: 指定字段的小于等于指定值</li>
<li>gt: 指定字段大于指定值</li>
<li>gte: 指定字段大于等于指定值</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">S</span> {
    <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">float</span> a <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;

    <span style="color:#6272a4">// +gen:default=3.14
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">double</span> pi <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>

    <span style="color:#6272a4">// +gen:in=[1,2,3]
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:enum=[2,3]
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:not_in=[4,5]
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int32</span> b <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;

    <span style="color:#6272a4">// +gen:ge=3
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +ggen:gte=4
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:lte=9
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:lt=10
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int64</span> c <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0f3139f04142acc9dea586846b8c4063">3.4 - protoc-gen-validator</h1>
    <div class="lead"><em>Validate</em> 通过 <code>protoc-gen-validator</code> 生成 <code>Validate()</code> 接口，减少非业务代码的编写。</div>
	<h2 id="概述">概述</h2>
<p>服务运行中，经常需要和其他客户端进行数据交互，验证来自客户端的数据的合法性。但是这些代码编写起来枯燥且易错，<strong>vine</strong> 提供 <code>protoc-gen-validator</code> 工具来自动生成结构体 <code>Validate()</code> 方法，减少一部分代码的手动编写。</p>
<h2 id="使用">使用</h2>
<h3 id="1先编写-validatorproto-文件">1.先编写 validator.proto 文件</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Person</span> {
  <span style="color:#6272a4">// +gen:min_len=4
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:max_len=10
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;

  <span style="color:#6272a4">// +gen:required;gt=10;lt=100
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">int32</span> age <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;

  <span style="color:#6272a4">// +gen:required;min_bytes=3;max_bytes=4;
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">bytes</span> any <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;

  <span style="color:#6272a4">// +gen:email
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> email <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;
}
</code></pre></div><h3 id="2安装-protoc-gen-validator">2.安装 protoc-gen-validator</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/vine-io/vine/cmd/protoc-gen-validator
</code></pre></div><h3 id="3生成-validate-方法">3.生成 Validate() 方法</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src --gogo_out<span style="color:#ff79c6">=</span>:.  --validator_out<span style="color:#ff79c6">=</span>:. proto/validator.proto
</code></pre></div><p>执行完成后生成以下代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">Valdiate</span>() <span style="color:#8be9fd">error</span> {
    <span style="color:#ff79c6">return</span> m.<span style="color:#50fa7b">ValidateE</span>(<span style="color:#f1fa8c">&#34;&#34;</span>)
}

<span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">ValidateE</span>() <span style="color:#8be9fd">error</span> {
	errs <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>([]<span style="color:#8be9fd">error</span>, <span style="color:#bd93f9">0</span>)
	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(m.Name) <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span> {
		<span style="color:#ff79c6">if</span> !(<span style="color:#8be9fd;font-style:italic">len</span>(m.Name) <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">4</span>) {
			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;name&#39; length must less than &#39;4&#39;&#34;</span>))
		}
		<span style="color:#ff79c6">if</span> !(<span style="color:#8be9fd;font-style:italic">len</span>(m.Name) <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">10</span>) {
			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;name&#39; length must great than &#39;10&#39;&#34;</span>))
		}
	}
	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">int64</span>(m.Age) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
		errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;age&#39; is required&#34;</span>))
	} <span style="color:#ff79c6">else</span> {
		<span style="color:#ff79c6">if</span> !(m.Age &lt; <span style="color:#bd93f9">100</span>) {
			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;age&#39; must less than &#39;100&#39;&#34;</span>))
		}
		<span style="color:#ff79c6">if</span> !(m.Age &gt; <span style="color:#bd93f9">10</span>) {
			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;age&#39; must great than &#39;10&#39;&#34;</span>))
		}
	}
	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(m.Any) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
		errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;any&#39; is required&#34;</span>))
	} <span style="color:#ff79c6">else</span> {
		<span style="color:#ff79c6">if</span> !(<span style="color:#8be9fd;font-style:italic">len</span>(m.Any) <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">3</span>) {
			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;any&#39; length must less than &#39;3&#39;&#34;</span>))
		}
		<span style="color:#ff79c6">if</span> !(<span style="color:#8be9fd;font-style:italic">len</span>(m.Any) <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">4</span>) {
			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;any&#39; length must great than &#39;4&#39;&#34;</span>))
		}
	}
	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(m.Email) <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span> {
		<span style="color:#ff79c6">if</span> !is.<span style="color:#50fa7b">Email</span>(m.Email) {
			errs = <span style="color:#8be9fd;font-style:italic">append</span>(errs, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;field &#39;email&#39; is not a valid email&#34;</span>))
		}
	}
	<span style="color:#ff79c6">return</span> is.<span style="color:#50fa7b">MargeErr</span>(errs<span style="color:#ff79c6">...</span>)
}
</code></pre></div><h3 id="4验证">4.验证</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
 	p <span style="color:#ff79c6">:=</span> pb.Person{}
	p.Age = <span style="color:#bd93f9">1</span>
	p.Email = <span style="color:#f1fa8c">&#34;11&#34;</span>
 	err <span style="color:#ff79c6">:=</span> p.<span style="color:#50fa7b">Validate</span>()
 	log.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;%v\n&#34;</span>, err)
}
<span style="color:#6272a4">// output:  field &#39;age&#39; must great than &#39;10&#39;;field &#39;any&#39; is required;field &#39;email&#39; is not a valid email
</span></code></pre></div><p>多个错误时，使用 <code>;</code> 隔开</p>
<h2 id="语法解析">语法解析</h2>
<p><code>protoc-gen-validator</code> 通过解析 <code>protobuf</code> 中的注释来生成 <code>Validate()</code> 规则。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +gen:ignore
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Struct</span> {
    <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">string</span> field1 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
    
    <span style="color:#6272a4">// +gen:required;email
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_len=3
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">string</span> field2 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}
</code></pre></div><h3 id="语法规则">语法规则</h3>
<p>有效的注释有以下的规则:</p>
<ul>
<li>注释必须以 <code>+gen</code> 作为开头</li>
<li>注释的内容必须紧贴对应的字段，中间不能有空行</li>
<li>支持多行注释，也可以将多行合并成一行，并用 <code>;</code> 作为分隔符</li>
</ul>
<h3 id="类型支持">类型支持</h3>
<p><code>message</code> 类型规则:</p>
<ul>
<li>ignore: 忽略该 message ，不生成 <code>Validate()</code> 方法</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +gen:ignore
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">P</span> {

}
</code></pre></div><p><code>message</code> 作为内嵌字段时支持的规则:</p>
<ul>
<li>required: 判断该字段是否为 nil。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">P</span> {
    <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>    Sub sub <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Sub</span> {

}
</code></pre></div><blockquote>
<p>注: 在引用外部的 message 时，请确认 message 存在 Validate() 方法</p>
</blockquote>
<p><code>string</code> 类型支持的规则</p>
<ul>
<li>required: 判断是否为空</li>
<li>default: 字段为空时指定的默认值，(不可用 required 同时使用)</li>
<li>in, enum: 判断字段的值是否存在于指定的列表中</li>
<li>not_in: 判断字段的值是否在指定的列表之外</li>
<li>min_len: 指定字段的最小长度</li>
<li>max_len: 指定字段的最大长度</li>
<li>prefix: 判断字段是否以给定的值为开头</li>
<li>suffix: 判断字段是否以给定的值为结尾</li>
<li>contains: 判断字段是否包含给定的值</li>
<li>pattern: 判断该字段是否为有效的正则表达式</li>
<li>number: 判断该字段是否为有效数字</li>
<li>email: 判断该字段是否为有效的邮箱地址</li>
<li>ip: 判断该字段是否为有效的 ip 地址</li>
<li>ipv4: 判断该字段是否为有效的 ipv4</li>
<li>ipv6: 判断该字段是否为有效的 ipv6</li>
<li>crontab: 判断该字段是否为有效的 crontab 表达式</li>
<li>uuid: 判断该字段是否为有效的 uuid v4</li>
<li>uri: 判断该字段是否为有效的 uri</li>
<li>domain: 判断该字段是否为有效的域名</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">S</span> {
    <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:default=&#34;hello&#34;
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:in=[&#34;1&#34;, &#34;2&#34;, &#34;3&#34;]
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:enum=[&#34;a&#34;, &#34;b&#34;, &#34;c&#34;]
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:not_in=[&#34;d&#34;, &#34;s&#34;]
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_len=3
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_max=4
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:prefix=&#34;http&#34;
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:suffix=&#34;.com&#34;
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:contains=&#34;www&#34;
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:pattern=`\d+(\w+){3,5}`
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:number
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:ip
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:ipv4
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:ipv6
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:crontab
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:uuid
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:uri
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:domain
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">string</span> m <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div><blockquote>
<p>注: string pattern 最好单独一行，以免和其他规则冲突</p>
</blockquote>
<p>数字类型的支持，包含 int32, int64, fixed32, fix64, float, double</p>
<ul>
<li>required: 判断是否为 0</li>
<li>default: 字段为空时指定的默认值，(不可用 required 同时使用)</li>
<li>in, enum: 判断字段的值是否存在于指定的列表中</li>
<li>not_in: 判断字段的值是否在指定的列表之外</li>
<li>lt: 指定字段小于指定值</li>
<li>lte: 指定字段的小于等于指定值</li>
<li>gt: 指定字段大于指定值</li>
<li>gte: 指定字段大于等于指定值</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">S</span> {
    <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">float</span> a <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;

    <span style="color:#6272a4">// +gen:default=3.14
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">double</span> pi <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>

    <span style="color:#6272a4">// +gen:in=[1,2,3]
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:enum=[2,3]
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:not_in=[4,5]
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int32</span> b <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;

    <span style="color:#6272a4">// +gen:ge=3
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +ggen:gte=4
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:lte=9
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:lt=10
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int64</span> c <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;
}
</code></pre></div><p><code>bytes</code> 类型的支持:</p>
<ul>
<li>required: 判断字段的长度是否为0</li>
<li>min_bytes: 判断字段的最小字节数是否大于给定值</li>
<li>max_bytes: 判断字段的最大字节数是否小于给定值</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">S</span> {
    <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_bytes=10
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_bytes=1024
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">bytes</span> any <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div><p>repeated 类型的支持：repeated 类型的字段在 golang 中会被解析成切片。</p>
<ul>
<li>required: 判断切片的长度是否为0</li>
<li>min_len: 判断切片的最小长度是否大于给定值</li>
<li>max_len: 判断切片的最大长度是否小于给定值</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">S</span> {
    <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:min_len=3
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// +gen:max_len=5
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">repeated</span> <span style="color:#8be9fd">string</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div><h3 id="内嵌-message">内嵌 message</h3>
<p><code>protoc-gen-validator</code> 支持解析内嵌 message, 使用 <code>+gen:inline</code> 可以将子 message 中的字段嵌入该 message。实例如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Meta</span> {
  <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
  <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">int64</span> id <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Request</span> {
  <span style="color:#6272a4">// +gen:inline
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// +gen:required
</span><span style="color:#6272a4"></span>  Meta meta <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
  <span style="color:#8be9fd">string</span> data <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}
</code></pre></div><p>解析出来的内容如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">
func (m *Meta) Validate() error {
	return m.ValidateE(<span style="color:#f1fa8c">&#34;&#34;</span>)
}

func (m *Meta) ValidateE(prefix <span style="color:#8be9fd">string</span>) error {
	errs <span style="color:#ff79c6">:=</span> make([]error, <span style="color:#bd93f9">0</span>)
	if len(m.Name) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
		errs <span style="color:#ff79c6">=</span> append(errs, fmt.Errorf(<span style="color:#f1fa8c">&#34;field &#39;%sname&#39; is required&#34;</span>, prefix))
	}
	if <span style="color:#8be9fd">int64</span>(m.Id) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
		errs <span style="color:#ff79c6">=</span> append(errs, fmt.Errorf(<span style="color:#f1fa8c">&#34;field &#39;%sid&#39; is required&#34;</span>, prefix))
	}
	return is.MargeErr(errs...)
}

func (m *Request) Validate() error {
	return m.ValidateE(<span style="color:#f1fa8c">&#34;&#34;</span>)
}

func (m *Request) ValidateE(prefix <span style="color:#8be9fd">string</span>) error {
	errs <span style="color:#ff79c6">:=</span> make([]error, <span style="color:#bd93f9">0</span>)
	if len(m.Name) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
		errs <span style="color:#ff79c6">=</span> append(errs, fmt.Errorf(<span style="color:#f1fa8c">&#34;field &#39;%sname&#39; is required&#34;</span>, prefix))
	}
	if <span style="color:#8be9fd">int64</span>(m.Id) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
		errs <span style="color:#ff79c6">=</span> append(errs, fmt.Errorf(<span style="color:#f1fa8c">&#34;field &#39;%sid&#39; is required&#34;</span>, prefix))
	}
	return is.MargeErr(errs...)
}

func (m *Response) Validate() error {
	return m.ValidateE(<span style="color:#f1fa8c">&#34;&#34;</span>)
}

func (m *Response) ValidateE(prefix <span style="color:#8be9fd">string</span>) error {
	errs <span style="color:#ff79c6">:=</span> make([]error, <span style="color:#bd93f9">0</span>)
	return is.MargeErr(errs...)
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1cef3190b3d455150f6a09aa20c5c878">3.5 - protoc-gen-deepcopy</h1>
    <div class="lead">使用 protoc-gen-deepcopy 生成资源的 deepcopy 接口。</div>
	<h2 id="概述">概述</h2>
<p>protoc-gen-deepcopy 帮助用户生成资源的深拷贝接口，减少用户编写代码。</p>
<h2 id="使用">使用</h2>
<h3 id="1先编写-deepcopyproto-文件">1.先编写 deepcopy.proto 文件</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +gen:deepcopy
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Person</span> {
  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
  <span style="color:#8be9fd">bytes</span> any <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;
  <span style="color:#8be9fd">string</span> email <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;
}
</code></pre></div><h3 id="2安装-protoc-gen-deepcopy">2.安装 protoc-gen-deepcopy</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/vine-io/vine/cmd/protoc-gen-deepcopy
</code></pre></div><h3 id="3生成-validate-方法">3.生成 Validate() 方法</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src --gogo_out<span style="color:#ff79c6">=</span>:.  --deepcopy_out<span style="color:#ff79c6">=</span>:. proto/deepcopy.proto
</code></pre></div><p>执行完成后生成以下代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#6272a4">// DeepCopyInto is an auto-generated deepcopy function, coping the receiver, writing into out. in must be no-nil.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (in <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">DeepCopyInto</span>(out <span style="color:#ff79c6">*</span>Person) {
	<span style="color:#ff79c6">*</span>out = <span style="color:#ff79c6">*</span>in
}

<span style="color:#6272a4">// DeepCopy is an auto-generated deepcopy function, copying the receiver, creating a new Person.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (in <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">DeepCopy</span>() <span style="color:#ff79c6">*</span>Person {
	<span style="color:#ff79c6">if</span> in <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
	}
	out <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">new</span>(Person)
	in.<span style="color:#50fa7b">DeepCopyInto</span>(out)
	<span style="color:#ff79c6">return</span> out
}
</code></pre></div><h3 id="4验证">4.验证</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	p <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>helloworld.Person{
		Name:  <span style="color:#f1fa8c">&#34;Vine&#34;</span>,
		Any:   []<span style="color:#8be9fd;font-style:italic">byte</span>(<span style="color:#f1fa8c">&#34;Hello&#34;</span>),
		Email: <span style="color:#f1fa8c">&#34;aa@gmail.com&#34;</span>,
	}

	fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;%p %v\n&#34;</span>, p, p)
	pc <span style="color:#ff79c6">:=</span> p.<span style="color:#50fa7b">DeepCopy</span>()
	fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;%p %v\n&#34;</span>, pc, pc)
}
<span style="color:#6272a4">// output:  
</span><span style="color:#6272a4">//  0xc0002ea280 name:&#34;Vine&#34; any:&#34;Hello&#34; email:&#34;aa@gmail.com&#34;
</span><span style="color:#6272a4">//  0xc0002ea2c0 name:&#34;Vine&#34; any:&#34;Hello&#34; email:&#34;aa@gmail.com&#34;
</span></code></pre></div><h2 id="语法解析">语法解析</h2>
<p><code>protoc-gen-deepcopy</code> 通过解析 <code>protobuf</code> 中的注释来生成 <code>deepcopy</code> 接口。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +gen:deepcopy
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Struct</span> {
    <span style="color:#8be9fd">string</span> field1 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
    <span style="color:#8be9fd">string</span> field2 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}
</code></pre></div><h3 id="语法规则">语法规则</h3>
<p>有效的注释有以下的规则:</p>
<ul>
<li>注释必须以 <code>+gen</code> 作为开头</li>
<li>注释的内容必须紧贴对应的字段，中间不能有空行</li>
</ul>
<h3 id="类型支持">类型支持</h3>
<p><code>message</code> 类型规则:</p>
<ul>
<li>deepcopy: 生成 DeepCopy 方法</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +gen:deepcopy
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">P</span> {
}
</code></pre></div><ul>
<li>runtime=<group>/<version>: 实现 <code>runtime.Entity</code> 接口</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">// +gen:runtime=a/v1
message Person {
  string name = 1;
  bytes any = 3;
  string email = 4;
}
</code></pre></div><p>生成如下代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// DeepCopyInto is an auto-generated deepcopy function, coping the receiver, writing into out. in must be no-nil.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (in <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">DeepCopyInto</span>(out <span style="color:#ff79c6">*</span>Person) {
	<span style="color:#ff79c6">*</span>out = <span style="color:#ff79c6">*</span>in
}

<span style="color:#6272a4">// GVK is an auto-generated gvk function, get the information like group, version and name of Person.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (in <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">GVK</span>() <span style="color:#ff79c6">*</span>runtime.GroupVersionKind {
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>runtime.GroupVersionKind{Group: <span style="color:#f1fa8c">&#34;a&#34;</span>, Version: <span style="color:#f1fa8c">&#34;v1&#34;</span>, Kind: <span style="color:#f1fa8c">&#34;Person&#34;</span>}
}

<span style="color:#6272a4">// DeepCopyFrom is an auto-generated deepcopy function, copying value from Person.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (in <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">DeepCopyFrom</span>(src runtime.Entity) {
	o <span style="color:#ff79c6">:=</span> src.(<span style="color:#ff79c6">*</span>Person)
	o.<span style="color:#50fa7b">DeepCopyInto</span>(in)
}

<span style="color:#6272a4">// DeepCopy is an auto-generated deepcopy function, copying the receiver, creating a new Person.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (in <span style="color:#ff79c6">*</span>Person) <span style="color:#50fa7b">DeepCopy</span>() runtime.Entity {
	<span style="color:#ff79c6">if</span> in <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
	}
	out <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">new</span>(Person)
	in.<span style="color:#50fa7b">DeepCopyInto</span>(out)
	<span style="color:#ff79c6">return</span> out
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-148255df01058e3f71315560bc42a419">3.6 - protoc-gen-dao</h1>
    <div class="lead"><em>Dao</em> 通过 <code>protoc-gen-dao</code> 生成数据库CURD代码。</div>
	<h2 id="概述">概述</h2>
<p><code>Dao</code> 是 <strong>Vine</strong> 框架的数据库交互模块，而<code>protoc-gen-dao</code>工具则可以通过识别<code>*.proto</code>来生成对应的数据库交互代码。减少大量重复代码的编写，提高用户效率。</p>
<h2 id="使用">使用</h2>
<h3 id="1先编写-userproto-文件">1.先编写 user.proto 文件</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;proto3&#34;</span>;

<span style="color:#ff79c6">package</span> v1;

<span style="color:#6272a4">// +gen:dao
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">User</span> {
  <span style="color:#6272a4">// +gen:pk
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">string</span> id <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;

  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;

  <span style="color:#ff79c6">repeated</span> <span style="color:#8be9fd">string</span> following <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;

  map&lt;<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd">string</span>&gt; tags <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;

  Other other <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">5</span>;
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Other</span> {
  <span style="color:#8be9fd">string</span> k <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
  <span style="color:#8be9fd">string</span> v <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}
</code></pre></div><h3 id="2安装-protoc-gen-dao">2.安装 protoc-gen-dao</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/vine-io/vine/cmd/protoc-gen-dao
</code></pre></div><h3 id="3生成curd代码">3.生成CURD代码</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src --gogofaster_out<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">plugins</span><span style="color:#ff79c6">=</span>grpc:.  --dao_out<span style="color:#ff79c6">=</span>:. proto/dao.proto
</code></pre></div><p>执行完成后生成以下文件:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">-rw-r--r--  <span style="color:#bd93f9">1</span> lack  staff   7.8K Mar <span style="color:#bd93f9">19</span> 22:26 user.pb.dao.go
-rw-r--r--  <span style="color:#bd93f9">1</span> lack  staff    20K Mar <span style="color:#bd93f9">19</span> 22:26 user.pb.go
-rw-r--r--  <span style="color:#bd93f9">1</span> lack  staff   255B Mar <span style="color:#bd93f9">18</span> 23:00 user.proto
</code></pre></div><p><code>*.pb.dao.go</code> 中保存着CURD代码。</p>
<h3 id="4curd-实例">4.CURD 实例</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	dao.DefaultDialect = sqlite.<span style="color:#50fa7b">NewDialect</span>(dao.<span style="color:#50fa7b">DSN</span>(<span style="color:#f1fa8c">&#34;user.db&#34;</span>), dao.<span style="color:#50fa7b">Logger</span>(logger.Default.<span style="color:#50fa7b">LogMode</span>(logger.Info)))
	dao.DefaultDialect.<span style="color:#50fa7b">Init</span>()

    <span style="color:#6272a4">// 注册 Schema, 会在数据库中创建对应的表
</span><span style="color:#6272a4"></span>	v1.<span style="color:#50fa7b">RegistryUser</span>(<span style="color:#ff79c6">&amp;</span>v1.User{})

	ctx <span style="color:#ff79c6">:=</span> context.<span style="color:#50fa7b">TODO</span>()
	u <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>v1.User{
		Id: <span style="color:#f1fa8c">&#34;1&#34;</span>,
		Name: <span style="color:#f1fa8c">&#34;Lack&#34;</span>,
		Following: []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;JJ&#34;</span>, <span style="color:#f1fa8c">&#34;OO&#34;</span>},
		Tags: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;label&#34;</span>: <span style="color:#f1fa8c">&#34;vv&#34;</span>},
		Other:     <span style="color:#ff79c6">&amp;</span>v1.Other{
			K: <span style="color:#f1fa8c">&#34;k1&#34;</span>,
			V: <span style="color:#f1fa8c">&#34;v1&#34;</span>,
		},
	}

	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Create ==============&gt;&#34;</span>)
	out, err <span style="color:#ff79c6">:=</span> v1.<span style="color:#50fa7b">FromUser</span>(u).<span style="color:#50fa7b">Create</span>(ctx)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}
	fmt.<span style="color:#50fa7b">Println</span>(out)

	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Updates ==============&gt;&#34;</span>)
	out, err = v1.<span style="color:#50fa7b">FromUser</span>(<span style="color:#ff79c6">&amp;</span>v1.User{Id: <span style="color:#f1fa8c">&#34;1&#34;</span>, Tags: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;aa&#34;</span>: <span style="color:#f1fa8c">&#34;vv&#34;</span>}}).<span style="color:#50fa7b">Updates</span>(ctx)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}
	fmt.<span style="color:#50fa7b">Println</span>(out)


	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;FindAll ==============&gt;&#34;</span>)
	outs, err <span style="color:#ff79c6">:=</span> v1.<span style="color:#50fa7b">FromUser</span>(<span style="color:#ff79c6">&amp;</span>v1.User{Tags: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;aa&#34;</span>: <span style="color:#f1fa8c">&#34;vv&#34;</span>}}).<span style="color:#50fa7b">FindAll</span>(ctx)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}
	fmt.<span style="color:#50fa7b">Println</span>(outs)

	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;FindOne ==============&gt;&#34;</span>)
	out, err = v1.<span style="color:#50fa7b">FromUser</span>(<span style="color:#ff79c6">&amp;</span>v1.User{Id: <span style="color:#f1fa8c">&#34;1&#34;</span>}).<span style="color:#50fa7b">FindOne</span>(ctx)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}
	fmt.<span style="color:#50fa7b">Println</span>(outs)

	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;SoftDelete ==============&gt;&#34;</span>)
	err = v1.<span style="color:#50fa7b">FromUser</span>(<span style="color:#ff79c6">&amp;</span>v1.User{Id: <span style="color:#f1fa8c">&#34;1&#34;</span>}).<span style="color:#50fa7b">SoftDelete</span>(ctx)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Delete ==============&gt;&#34;</span>)
	err = v1.<span style="color:#50fa7b">FromUser</span>(<span style="color:#ff79c6">&amp;</span>v1.User{Id: <span style="color:#f1fa8c">&#34;1&#34;</span>}).<span style="color:#50fa7b">Delete</span>(ctx)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#6272a4">//log.Fatal(err)
</span><span style="color:#6272a4"></span>	}
}
</code></pre></div><h2 id="语法解析">语法解析</h2>
<p><code>protoc-gen-dao</code> 通过解析 <code>protobuf</code> 中的注释来生成代码。repeated, map, message 字段会生成新的结构体，在数据库中存储格式为 json。
每个带<code>+dao:generate</code>注释的 message 会生成 *Schema 结构体，并生成对应的 CURD 方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#6272a4">// 注册 User 相应的数据库表
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">RegistryUser</span>(in <span style="color:#ff79c6">*</span>User) <span style="color:#8be9fd">error</span> 
<span style="color:#6272a4">// User =&gt; UserSchema, 忽略空值字段
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">FromUser</span>(in <span style="color:#ff79c6">*</span>User) <span style="color:#ff79c6">*</span>UserSchema 
<span style="color:#6272a4">// UserSchema =&gt; User
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">ToUser</span>() <span style="color:#ff79c6">*</span>User
<span style="color:#6272a4">// User 结构体在数据库中的表名
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (UserSchema) <span style="color:#50fa7b">TableName</span>() <span style="color:#8be9fd">string</span> 
<span style="color:#6272a4">// 主键信息，返回主键名称、值、是否为零值
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m UserSchema) <span style="color:#50fa7b">PrimaryKey</span>() (<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd;font-style:italic">interface</span>{}, <span style="color:#8be9fd">bool</span>)
<span style="color:#6272a4">// 分页查询，等同 FindAll 和 Count
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">FindPage</span>(ctx context.Context, page, size <span style="color:#8be9fd">int</span>, exprs <span style="color:#ff79c6">...</span>clause.Expression) ([]<span style="color:#ff79c6">*</span>User, <span style="color:#8be9fd">int64</span>, <span style="color:#8be9fd">error</span>) 
<span style="color:#6272a4">// 查询所有符合的记录
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">FindAll</span>(ctx context.Context, exprs <span style="color:#ff79c6">...</span>clause.Expression) ([]<span style="color:#ff79c6">*</span>User, <span style="color:#8be9fd">error</span>) 
<span style="color:#6272a4">// 查询符合的记录总量
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">Count</span>(ctx context.Context, exprs <span style="color:#ff79c6">...</span>clause.Expression) (<span style="color:#8be9fd">int64</span>, <span style="color:#8be9fd">error</span>)
<span style="color:#6272a4">// 查询首条符合的记录
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">FindOne</span>(ctx context.Context, exprs <span style="color:#ff79c6">...</span>clause.Expression) (<span style="color:#ff79c6">*</span>User, <span style="color:#8be9fd">error</span>)
<span style="color:#6272a4">// 插入一条记录
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">Create</span>(ctx context.Context) (<span style="color:#ff79c6">*</span>User, <span style="color:#8be9fd">error</span>) 
<span style="color:#6272a4">// 更新记录
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">Updates</span>(ctx context.Context) (<span style="color:#ff79c6">*</span>User, <span style="color:#8be9fd">error</span>)
<span style="color:#6272a4">// 软删除
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserSchema) <span style="color:#50fa7b">Delete</span>(ctx context.Context, soft) <span style="color:#8be9fd">error</span> 
</code></pre></div><h3 id="类型转化">类型转化</h3>
<p>slice、map、message 自动生成实现 driver.Valuer 接口的类型</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#ff79c6">repeated</span> <span style="color:#8be9fd">string</span> following <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;
</code></pre></div><p>生成</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8be9fd;font-style:italic">type</span> UserFollowing []<span style="color:#8be9fd">string</span>

<span style="color:#6272a4">// Value return json value, implement driver.Valuer interface
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m UserFollowing) <span style="color:#50fa7b">Value</span>() (driver.Value, <span style="color:#8be9fd">error</span>) {
	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(m) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, <span style="color:#ff79c6">nil</span>
	}
	b, err <span style="color:#ff79c6">:=</span> _go.<span style="color:#50fa7b">Marshal</span>(m)
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">string</span>(b), err
}

<span style="color:#6272a4">// Scan scan value into Jsonb, implements sql.Scanner interface
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserFollowing) <span style="color:#50fa7b">Scan</span>(value <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span> {
	<span style="color:#8be9fd;font-style:italic">var</span> bytes []<span style="color:#8be9fd">byte</span>
	<span style="color:#ff79c6">switch</span> v <span style="color:#ff79c6">:=</span> value.(<span style="color:#8be9fd;font-style:italic">type</span>) {
	<span style="color:#ff79c6">case</span> []<span style="color:#8be9fd">byte</span>:
		bytes = v
	<span style="color:#ff79c6">case</span> <span style="color:#8be9fd">string</span>:
		bytes = []<span style="color:#8be9fd;font-style:italic">byte</span>(v)
	<span style="color:#ff79c6">default</span>:
		<span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(fmt.<span style="color:#50fa7b">Sprint</span>(<span style="color:#f1fa8c">&#34;Failed to unmarshal JSONB value:&#34;</span>, value))
	}

	<span style="color:#ff79c6">return</span> _go.<span style="color:#50fa7b">Unmarshal</span>(bytes, <span style="color:#ff79c6">&amp;</span>m)
}

<span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserFollowing) <span style="color:#50fa7b">DaoDataType</span>() <span style="color:#8be9fd">string</span> {
	<span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;json&#34;</span>
}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">map&lt;<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd">string</span>&gt; tags <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;
</code></pre></div><p>生成</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8be9fd;font-style:italic">type</span> UserTags <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>

<span style="color:#6272a4">// Value return json value, implement driver.Valuer interface
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m UserTags) <span style="color:#50fa7b">Value</span>() (driver.Value, <span style="color:#8be9fd">error</span>) {
	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(m) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, <span style="color:#ff79c6">nil</span>
	}
	b, err <span style="color:#ff79c6">:=</span> _go.<span style="color:#50fa7b">Marshal</span>(m)
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">string</span>(b), err
}

<span style="color:#6272a4">// Scan scan value into Jsonb, implements sql.Scanner interface
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserTags) <span style="color:#50fa7b">Scan</span>(value <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span> {
	<span style="color:#8be9fd;font-style:italic">var</span> bytes []<span style="color:#8be9fd">byte</span>
	<span style="color:#ff79c6">switch</span> v <span style="color:#ff79c6">:=</span> value.(<span style="color:#8be9fd;font-style:italic">type</span>) {
	<span style="color:#ff79c6">case</span> []<span style="color:#8be9fd">byte</span>:
		bytes = v
	<span style="color:#ff79c6">case</span> <span style="color:#8be9fd">string</span>:
		bytes = []<span style="color:#8be9fd;font-style:italic">byte</span>(v)
	<span style="color:#ff79c6">default</span>:
		<span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(fmt.<span style="color:#50fa7b">Sprint</span>(<span style="color:#f1fa8c">&#34;Failed to unmarshal JSONB value:&#34;</span>, value))
	}

	<span style="color:#ff79c6">return</span> _go.<span style="color:#50fa7b">Unmarshal</span>(bytes, <span style="color:#ff79c6">&amp;</span>m)
}

<span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserTags) <span style="color:#50fa7b">DaoDataType</span>() <span style="color:#8be9fd">string</span> {
	<span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;json&#34;</span>
}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">Other other <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">5</span>;
</code></pre></div><p>生成</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8be9fd;font-style:italic">type</span> UserOther Other

<span style="color:#6272a4">// Value return json value, implement driver.Valuer interface
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserOther) <span style="color:#50fa7b">Value</span>() (driver.Value, <span style="color:#8be9fd">error</span>) {
	<span style="color:#ff79c6">if</span> m <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, <span style="color:#ff79c6">nil</span>
	}
	b, err <span style="color:#ff79c6">:=</span> _go.<span style="color:#50fa7b">Marshal</span>(m)
	<span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">string</span>(b), err
}

<span style="color:#6272a4">// Scan scan value into Jsonb, implements sql.Scanner interface
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserOther) <span style="color:#50fa7b">Scan</span>(value <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span> {
	<span style="color:#8be9fd;font-style:italic">var</span> bytes []<span style="color:#8be9fd">byte</span>
	<span style="color:#ff79c6">switch</span> v <span style="color:#ff79c6">:=</span> value.(<span style="color:#8be9fd;font-style:italic">type</span>) {
	<span style="color:#ff79c6">case</span> []<span style="color:#8be9fd">byte</span>:
		bytes = v
	<span style="color:#ff79c6">case</span> <span style="color:#8be9fd">string</span>:
		bytes = []<span style="color:#8be9fd;font-style:italic">byte</span>(v)
	<span style="color:#ff79c6">default</span>:
		<span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(fmt.<span style="color:#50fa7b">Sprint</span>(<span style="color:#f1fa8c">&#34;Failed to unmarshal JSONB value:&#34;</span>, value))
	}

	<span style="color:#ff79c6">return</span> _go.<span style="color:#50fa7b">Unmarshal</span>(bytes, <span style="color:#ff79c6">&amp;</span>m)
}

<span style="color:#8be9fd;font-style:italic">func</span> (m <span style="color:#ff79c6">*</span>UserOther) <span style="color:#50fa7b">DaoDataType</span>() <span style="color:#8be9fd">string</span> {
	<span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;json&#34;</span>
}
</code></pre></div><h3 id="json-支持">JSON 支持</h3>
<p><code>protoc-gen-dao</code> 将 slice、map 和 message 类型的字段转化为JSON格式并存储到数据库中，同时 Dao 支持通过 JSON 来作为查询条件。以下是JSON格式查询的条件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang">    <span style="color:#6272a4">// slice 格式，查询slice包含指定项的记录
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(m.Following) <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span> {
		<span style="color:#ff79c6">for</span> _, item <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> m.Following {
			exprs = <span style="color:#8be9fd;font-style:italic">append</span>(exprs, dao.DefaultDialect.<span style="color:#50fa7b">JSONBuild</span>(<span style="color:#f1fa8c">&#34;following&#34;</span>).<span style="color:#50fa7b">Tx</span>(tx).<span style="color:#50fa7b">Contains</span>(item))
		}
	}
    <span style="color:#6272a4">// map 格式，查询kv符合条件的记录，key 类型必须为 string
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> m.Tags <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#ff79c6">for</span> k, v <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> m.Tags {
			exprs = <span style="color:#8be9fd;font-style:italic">append</span>(exprs, dao.DefaultDialect.<span style="color:#50fa7b">JSONBuild</span>(<span style="color:#f1fa8c">&#34;tags&#34;</span>).<span style="color:#50fa7b">Tx</span>(tx).<span style="color:#50fa7b">Equals</span>(v, k))
		}
	}
    <span style="color:#6272a4">// struct 格式，精确查询 JSON 
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// 支持两种方式:
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">//  * 当传入 key 的值为空，查询对应 JSON key 是否存在
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">//  * 当传入 key 为确定值时，查询对应 JSON key 是否等于对应的值
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> m.Other <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#ff79c6">for</span> k, v <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> dao.<span style="color:#50fa7b">FieldPatch</span>(m.Other) {
			<span style="color:#ff79c6">if</span> v <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
				exprs = <span style="color:#8be9fd;font-style:italic">append</span>(exprs, dao.DefaultDialect.<span style="color:#50fa7b">JSONBuild</span>(<span style="color:#f1fa8c">&#34;other&#34;</span>).<span style="color:#50fa7b">Tx</span>(tx).<span style="color:#50fa7b">HasKeys</span>(strings.<span style="color:#50fa7b">Split</span>(k, <span style="color:#f1fa8c">&#34;,&#34;</span>)<span style="color:#ff79c6">...</span>))
			} <span style="color:#ff79c6">else</span> {
				exprs = <span style="color:#8be9fd;font-style:italic">append</span>(exprs, dao.DefaultDialect.<span style="color:#50fa7b">JSONBuild</span>(<span style="color:#f1fa8c">&#34;other&#34;</span>).<span style="color:#50fa7b">Tx</span>(tx).<span style="color:#50fa7b">Equals</span>(v, strings.<span style="color:#50fa7b">Split</span>(k, <span style="color:#f1fa8c">&#34;,&#34;</span>)<span style="color:#ff79c6">...</span>))
			}
		}
	}
</code></pre></div><blockquote>
<p>注: 如果默认数据库选择 Sqlite3 时，默认不支持 json_each, json_extract 方法，需要添加 -tags 选项。 <code>go build -tags JSON1 main.go</code></p>
</blockquote>
<h3 id="语法规则">语法规则</h3>
<p>有效的注释有以下的规则:</p>
<ul>
<li>注释必须以 <code>+gen</code> 作为开头</li>
<li>注释的内容必须紧贴对应的字段，中间不能有空行</li>
<li>支持多行注释，也可以将多行合并成一行，并用 <code>;</code> 作为分隔符</li>
<li>只有带 <code>+gen:dao</code> 注释的 message 才会生成 CURD 代码</li>
</ul>
<h3 id="语法支持">语法支持</h3>
<h4 id="代码输出路径">代码输出路径</h4>
<p><code>protoc-gen-dao</code> 支持将CURD代码输出到指定路径</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +dao:output=github.com/vine-io/vine/testdata/db/dao;dao
</span><span style="color:#6272a4"></span>syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;protoc&#34;</span>
<span style="color:#ff79c6">...</span>
</code></pre></div><p>使用 <code>+dao:output=</code>为开头，写在 protobuf 文件头部，指定生成的路径(对应$GOPATH)和生成 package 名称。</p>
<h4 id="message-支持">message 支持</h4>
<p>message 支持以下注释:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +gen:dao  =&gt; 只有标识该注释的 message 才会生成 CURD 代码
</span></code></pre></div><h4 id="field-支持">field 支持</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#6272a4">// +gen:pk   =&gt; 指定字段为主键(必须), 可以是 string 和 数字, 当 int 类型时自增 
</span><span style="color:#6272a4">//              当多个 PK 字段存在时，默认选择第一个。
</span><span style="color:#6272a4">// +gen:inline =&gt; 只能用在 message field 中，将 message 的字段直接解析为父 message 的字段
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">...</span>
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-96c4ff43558e2f86011b50d22caa006c">4 - 服务部署</h1>
    
	<p>这个我们介绍两种服务部署方式。</p>
<h2 id="docker">docker</h2>
<p><strong>Vine</strong> 中默认提供了用于构建程序的 Dockerfile 文件。用于构建服务镜像。</p>
<h3 id="dockerfile">Dockerfile</h3>
<p>编辑 <code>_output/Dockerfile</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#ff79c6">FROM</span><span style="color:#f1fa8c"> debian:stable-slim</span>
<span style="color:#ff79c6">ADD</span> helloworld /helloworld

<span style="color:#ff79c6">EXPOSE</span><span style="color:#f1fa8c"> 11500</span>

<span style="color:#ff79c6">ENTRYPOINT</span> [ <span style="color:#f1fa8c">&#34;/helloworld&#34;</span>, <span style="color:#f1fa8c">&#34;--server-address=0.0.0.0:11500&#34;</span> ]
</code></pre></div><h3 id="编译项目">编译项目</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine build service --output<span style="color:#ff79c6">=</span>_output/helloworld 
</code></pre></div><h3 id="构建镜像">构建镜像</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8be9fd;font-style:italic">cd</span> _output
docker build -t helloworld .
</code></pre></div><h3 id="启动服务">启动服务</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">docker run <span style="color:#ff79c6">--</span>rm <span style="color:#ff79c6">-</span>p <span style="color:#bd93f9">11500</span>:<span style="color:#bd93f9">11500</span> helloworl
</code></pre></div><h2 id="gpm">gpm</h2>
<p><a href="https://github.com/vine-io/gpm">gpm</a> 是基于 <strong>Vine</strong> 开发的项目管理服务。合适于在没有 docker 环境的机器上管理 <strong>Vine</strong> 服务。</p>
<h3 id="启动-gpm">启动 gpm</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">gpm start <span style="color:#ff79c6">-</span>A &#39;<span style="color:#ff79c6">--</span>server<span style="color:#ff79c6">-</span>address=<span style="color:#bd93f9">0.0.0.0</span>:<span style="color:#bd93f9">7700</span>&#39;
</code></pre></div><h3 id="服务打包">服务打包</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gpm tar --name helloworld.tar.gz --target main
</code></pre></div><h3 id="安装服务">安装服务</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gpm --host 192.168.3.111:7700 install --package helloworld.tar.gz --name helloworld --dir /opt/helloworld --bin /opt/helloworld/main --args <span style="color:#f1fa8c">&#39;--server-address=0.0.0.0:11500&#39;</span> --version v1.0.0
</code></pre></div><h3 id="启动服务-1">启动服务</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gpm --host 192.168.3.111:7700 start --name helloworld
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="" aria-label="">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="">
      <i class=""></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 The Docsy Authors All Rights Reserved</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank">隐私政策</a></small>
	
		<p class="mt-2"><a href="/vine/about/">关于</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>


<script src="https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js" integrity="sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj" crossorigin="anonymous"></script>










<script src="/vine/js/main.min.4311a5d52861bb5e1fd9ee6ffb1f00a3fdc3459ab6bf80c384338786370e230b.js" integrity="sha256-QxGl1Shhu14f2e5v&#43;x8Ao/3DRZq2v4DDhDOHhjcOIws=" crossorigin="anonymous"></script>




  </body>
</html>
