<!doctype html>
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.87.0" /><link rel="canonical" type="text/html" href="https://vine-io.github.io/vine/docs/component/">
<link rel="alternate" type="application/rss&#43;xml" href="https://vine-io.github.io/vine/docs/component/index.xml">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="shortcut icon" href="/vine/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/vine/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/vine/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/vine/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/vine/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/vine/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/vine/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/vine/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/vine/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/vine/favicons/android-192x192.png" sizes="192x192">

<title>框架组件 | Vine</title><meta property="og:title" content="框架组件" />
<meta property="og:description" content="我们将深入了解 Vine 框架内部各个组件以及使用方法。
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://vine-io.github.io/vine/docs/component/" /><meta property="og:site_name" content="Vine" />

<meta itemprop="name" content="框架组件">
<meta itemprop="description" content="我们将深入了解 Vine 框架内部各个组件以及使用方法。
"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="框架组件"/>
<meta name="twitter:description" content="我们将深入了解 Vine 框架内部各个组件以及使用方法。
"/>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






<link rel="preload" href="/vine/scss/main.min.bd19fcdf38c012b14ad8d3c8432efd8cf1740a17234311f030bcb495e955a2cf.css" as="style">
<link href="/vine/scss/main.min.bd19fcdf38c012b14ad8d3c8432efd8cf1740a17234311f030bcb495e955a2cf.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>




  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/vine/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">Vine</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a  class="nav-link active" href="/vine/docs/" ><span class="active">文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a  class="nav-link" href="https://github.com/vine-io/vine-example" target="_blank" ><span>实例</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a  class="nav-link" href="https://github.com/vine-io/vine" target="_blank" ><span>GitHub</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
<input type="search" class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label="站内搜索…" autocomplete="off">

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/vine/docs/component/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">框架组件</h1>
<div class="lead">我们将深入了解 Vine 框架内部各个组件以及使用方法。</div>





<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-4bf4097c812f2b345e3a8236e52dae1a">1 - 服务注册发现</h1>
    
	<h2 id="概述">概述</h2>
<p><code>服务注册发现</code>模块是微服务的核心。服务端需要它来提供注册服务，登录服务自身信息。客户端需要它来根据名称查找服务地址。</p>
<p><strong>Vine</strong> 提供一个通用的 <code>Registry</code> 接口，描述 <code>服务注册发现</code> 模块的行为。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Registry <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span> <span style="color:#6272a4">// ------------------------------- 模块初始化
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options <span style="color:#6272a4">// ----------------------------------- 模块的配置信息
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Register</span>(<span style="color:#ff79c6">*</span>Service, <span style="color:#ff79c6">...</span>RegisterOption) <span style="color:#8be9fd">error</span> <span style="color:#6272a4">// --------- 注册服务
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Deregister</span>(<span style="color:#ff79c6">*</span>Service, <span style="color:#ff79c6">...</span>DeregisterOption) <span style="color:#8be9fd">error</span> <span style="color:#6272a4">// ----- 注销服务
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">GetService</span>(<span style="color:#8be9fd">string</span>, <span style="color:#ff79c6">...</span>GetOption) ([]<span style="color:#ff79c6">*</span>Service, <span style="color:#8be9fd">error</span>) <span style="color:#6272a4">//- 根据名称查找服务
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">ListServices</span>(<span style="color:#ff79c6">...</span>ListOption) ([]<span style="color:#ff79c6">*</span>Service, <span style="color:#8be9fd">error</span>) <span style="color:#6272a4">// ----- 查询所有服务
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Watch</span>(<span style="color:#ff79c6">...</span>WatchOption) (Watcher, <span style="color:#8be9fd">error</span>) <span style="color:#6272a4">// -------------- 监听服务变化
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span> <span style="color:#6272a4">// ------------------------------------- 查询实现 Registry 接口的具体类型
</span><span style="color:#6272a4"></span>}
</code></pre></div><h2 id="使用">使用</h2>
<p>在此我们提供一个完整的代码来介绍 <code>Registry</code> 的具体使用方式:</p>
<h3 id="初始化">初始化</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry/mdns&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// 创建新的 Registry
</span><span style="color:#6272a4"></span>	r <span style="color:#ff79c6">:=</span> mdns.<span style="color:#50fa7b">NewRegistry</span>()
	<span style="color:#6272a4">// 初始化
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> r.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
}
</code></pre></div><h3 id="注册和注销服务">注册和注销服务</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// 创建新的服务
</span><span style="color:#6272a4"></span>	svc <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>registry.Service{
		Name:     <span style="color:#f1fa8c">&#34;go.vine.test&#34;</span>,   <span style="color:#6272a4">// 服务名称，唯一值
</span><span style="color:#6272a4"></span>		Version:  <span style="color:#f1fa8c">&#34;v1.0.0&#34;</span>,         <span style="color:#6272a4">// 服务版本
</span><span style="color:#6272a4"></span>		Metadata: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;Content-Type&#34;</span>: <span style="color:#f1fa8c">&#34;application/json&#34;</span>},  <span style="color:#6272a4">// 元数据
</span><span style="color:#6272a4"></span>		Endpoints: []<span style="color:#ff79c6">*</span>registry.Endpoint{        <span style="color:#6272a4">// 服务接口
</span><span style="color:#6272a4"></span>			{
				Name:     <span style="color:#f1fa8c">&#34;&#34;</span>,
				Request:  <span style="color:#ff79c6">nil</span>,
				Response: <span style="color:#ff79c6">nil</span>,
				Metadata: <span style="color:#ff79c6">nil</span>,
			},
		},
		Nodes: []<span style="color:#ff79c6">*</span>registry.Node{     <span style="color:#6272a4">// 该服务下的节点信息, 节点的 ID 必须是不同的，当一个 `Registry` 中多次注册相同服务时，服务的该字段就会合并
</span><span style="color:#6272a4"></span>			{
				Id:       uuid.<span style="color:#50fa7b">New</span>().<span style="color:#50fa7b">String</span>(),
				Address:  <span style="color:#f1fa8c">&#34;127.0.0.1:11500&#34;</span>,
				<span style="color:#6272a4">//Port:     11500,
</span><span style="color:#6272a4"></span>				Metadata: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;os&#34;</span>: <span style="color:#f1fa8c">&#34;linux&#34;</span>},
			},
		},
		TTL:  <span style="color:#bd93f9">30</span>,  <span style="color:#6272a4">// 服务过期时间，单位秒
</span><span style="color:#6272a4"></span>		Apis: <span style="color:#ff79c6">nil</span>, <span style="color:#6272a4">// swagger 信息
</span><span style="color:#6272a4"></span>	}

	<span style="color:#6272a4">// 注册服务
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> r.<span style="color:#50fa7b">Register</span>(svc); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	<span style="color:#6272a4">// 注销服务
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> r.<span style="color:#50fa7b">Deregister</span>(svc); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
}
</code></pre></div><h3 id="查询服务">查询服务</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// 查询所有服务
</span><span style="color:#6272a4"></span>	list, err <span style="color:#ff79c6">:=</span> r.<span style="color:#50fa7b">ListServices</span>()
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	<span style="color:#ff79c6">for</span> _, item <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> list {
		fmt.<span style="color:#50fa7b">Println</span>(item.Name)
	}

	<span style="color:#6272a4">// 查询单个服务
</span><span style="color:#6272a4"></span>	list, err = r.<span style="color:#50fa7b">GetService</span>(<span style="color:#f1fa8c">&#34;go.vine.test&#34;</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	<span style="color:#ff79c6">for</span> _, item <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> list {
		fmt.<span style="color:#50fa7b">Println</span>(item.Name, <span style="color:#8be9fd;font-style:italic">len</span>(item.Nodes))
	}
}
</code></pre></div><blockquote>
<p>ListService() 方法获取的结果，数据是不完整的，只含有包括服务名称在内的少量信息。</p>
</blockquote>
<h3 id="监听服务">监听服务</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// 启动一个监听器
</span><span style="color:#6272a4"></span>	watcher, err <span style="color:#ff79c6">:=</span> r.<span style="color:#50fa7b">Watch</span>(registry.<span style="color:#50fa7b">WatchService</span>(<span style="color:#f1fa8c">&#34;go.vine.test&#34;</span>))
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}
	<span style="color:#6272a4">// 停止监听器
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">defer</span> watcher.<span style="color:#50fa7b">Stop</span>()
	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		<span style="color:#ff79c6">for</span> {
			e, err <span style="color:#ff79c6">:=</span> watcher.<span style="color:#50fa7b">Next</span>() <span style="color:#6272a4">// 这里会阻塞，直到返回事假
</span><span style="color:#6272a4"></span>			<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
				<span style="color:#ff79c6">return</span>
			}
			fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;%d: %s, %s\n&#34;</span>,  e.Timestamp, e.Action, e.Service.Name)
		}
	}()
}
</code></pre></div><h3 id="替换服务的-registry">替换服务的 <code>Registry</code></h3>
<p><strong>Vine</strong> 服务默认 <code>Registry</code> 为 <code>mdns</code>。尝试去替换成 <code>memory</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry/memory&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	mr <span style="color:#ff79c6">:=</span> memory.<span style="color:#50fa7b">NewRegistry</span>()
	vine.<span style="color:#50fa7b">NewService</span>(vine.<span style="color:#50fa7b">Registry</span>(mr))
}
</code></pre></div><h2 id="options">options</h2>
<p><code>Registry</code> 接口的几个方法都支持 Options。</p>
<p>创建 <code>NewRegistry(opts...)</code> 和 初始化 <code>Init(opts...)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memory.<span style="color:#50fa7b">NewRegistry</span>(
	<span style="color:#6272a4">// Registry 的 ip 地址
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">Addrs</span>(addrs <span style="color:#ff79c6">...</span><span style="color:#8be9fd">string</span>),
	<span style="color:#6272a4">// 连接超时时间
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">Timeout</span>(t time.Duration),
	<span style="color:#6272a4">// 安全通讯
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">Secure</span>(b <span style="color:#8be9fd">bool</span>),
	<span style="color:#6272a4">// 安全通讯所需证书信息
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">TLSConfig</span>(t <span style="color:#ff79c6">*</span>tls.Config),
)
</code></pre></div><p>注册服务 <code>Register(svc, opts...)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memory.<span style="color:#50fa7b">Register</span>(svc,
	<span style="color:#6272a4">// 服务过期时间
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">RegisterTTL</span>(ttl <span style="color:#8be9fd">int64</span>), 
	<span style="color:#6272a4">// 上下文信息
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">RegisterContext</span>(ctx context.Context),
)
</code></pre></div><p>注销服务 <code>Deregister(svc, opts...)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memory.<span style="color:#50fa7b">Deregister</span>(svc,
	registry.<span style="color:#50fa7b">DeregisterContext</span>(ctx context.Context),
)
</code></pre></div><p>查询所有服务 <code>ListServices(opts...)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memory.<span style="color:#50fa7b">ListServices</span>(svc,
	registry.<span style="color:#50fa7b">ListServicesContext</span>(ctx context.Context),
)
</code></pre></div><p>根据名称获取服务 <code>GetService(name, opts...)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memory.<span style="color:#50fa7b">GetService</span>(svc,
	registry.<span style="color:#50fa7b">GetServiceContext</span>(ctx context.Context),
)
</code></pre></div><p>监听服务 <code>Watch(opts...)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">memory.<span style="color:#50fa7b">Watch</span>(svc,
    <span style="color:#6272a4">// 监听单个服务
</span><span style="color:#6272a4"></span>	registry.<span style="color:#50fa7b">WatchService</span>(name <span style="color:#8be9fd">string</span>),
	registry.<span style="color:#50fa7b">WatchServiceContext</span>(ctx context.Context),
)
</code></pre></div><h2 id="插件">插件</h2>
<p><strong>Vine</strong> 目前自带的 <code>Registry</code> 实现有:</p>
<ul>
<li>memory</li>
<li>mdns</li>
</ul>
<p>第三方的实现请参考 <a href="https://github.com/vine-io/plugins/tree/main/registry">registry</a></p>
<h3 id="etcd">etcd</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/lib/cmd&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/plugins/registry/etcd&#34;</span>
)
	
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	er <span style="color:#ff79c6">:=</span> etcd.<span style="color:#50fa7b">NewRegistry</span>()
	vine.<span style="color:#50fa7b">NewService</span>(vine.<span style="color:#50fa7b">Registry</span>(er))
}
</code></pre></div><h2 id="服务启动">服务启动</h2>
<p><strong>Vine</strong> 服务以插件的方式，注册多种实现，用户可以再服务启动时选择喜欢的类型。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./helloworld --registy<span style="color:#ff79c6">=</span>etcd --registry-address<span style="color:#ff79c6">=</span>127.0.0.1:2379
<span style="color:#6272a4"># 或者使用环境变量</span>
<span style="color:#8be9fd;font-style:italic">VINE_REGISTRY</span><span style="color:#ff79c6">=</span>ETCD <span style="color:#8be9fd;font-style:italic">VINE_REGISTRY_ADDRESS</span><span style="color:#ff79c6">=</span>127.0.0.1:2379 ./helloworld
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f375a1b0338deecef74fa867c6bb7ed5">2 - 服务网关</h1>
    
	<h2 id="概述">概述</h2>
<p><strong>API</strong> 是一个可插拔的 API 接口，由 <strong>Registry</strong> 驱动，可帮助构建强大的公共 API 网关.</p>
<p><strong>API</strong> 库提供 api 网关路由功能。微服务体系结构将应用程序逻辑分离到单独的服务中. api 网关提供单个入口点，以将这些服务合并到统一 api 中。 <strong>API</strong> 使用在 <strong>Registry</strong> 元数据中定义的路由来生成路由规则并服务 http 请求.</p>
<h2 id="启动-api-服务">启动 api 服务</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4"># 提供 http 服务和 swagger </span>
vine api --handler<span style="color:#ff79c6">=</span>rpc --enable-openapi
</code></pre></div><h2 id="创建网关">创建网关</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine new gateway api
</code></pre></div><p>启动</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go run cmd/api/main.go --api-address<span style="color:#ff79c6">=</span>127.0.0.1:8080
</code></pre></div><blockquote>
<p>一个服务同时提供 gRPC 和 http 接口可以参考 <a href="https://github.com/vine-io/examples/tree/main/api">api</a></p>
</blockquote>
<h2 id="测试">测试</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -X POST <span style="color:#f1fa8c">&#34;http://127.0.0.1:8080/helloworld/v1/helloworld/Call&#34;</span> -H  <span style="color:#f1fa8c">&#34;accept: application/json&#34;</span> -H  <span style="color:#f1fa8c">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#f1fa8c">&#34;{\&#34;name\&#34;:\&#34;hello\&#34;}&#34;</span>
&gt; <span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;reply: hello&#34;</span><span style="color:#ff79c6">}</span>
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fa10acc15b4e6765d798505e47c766c2">3 - 序列化</h1>
    
	<h2 id="概述">概述</h2>
<p>我们抽象出 <code>Codec</code> 和 <code>Marshaler</code> 接口来统一管理数据的序列化和反序列功能。<code>Codec</code> 被 <code>Server</code> 和 <code>Client</code> 使用作为数据解析工具。<code>Marshaler</code> 为用户提供数据转化工具。</p>
<p>目前 <code>Marshaler</code> 接口支持以下格式：</p>
<ul>
<li>yaml</li>
<li>json</li>
<li>bytes</li>
<li>proto</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Codec <span style="color:#8be9fd;font-style:italic">interface</span> {
	Reader
	Writer
	<span style="color:#50fa7b">Close</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}

<span style="color:#8be9fd;font-style:italic">type</span> Reader <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">ReadHeader</span>(<span style="color:#ff79c6">*</span>Message, MessageType) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">ReadBody</span>(<span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
}

<span style="color:#8be9fd;font-style:italic">type</span> Writer <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Write</span>(<span style="color:#ff79c6">*</span>Message, <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
}

<span style="color:#8be9fd;font-style:italic">type</span> Marshaler <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Marshal</span>(<span style="color:#8be9fd;font-style:italic">interface</span>{}) ([]<span style="color:#8be9fd">byte</span>, <span style="color:#8be9fd">error</span>)
	<span style="color:#50fa7b">Unmarshal</span>([]<span style="color:#8be9fd">byte</span>, <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><h2 id="具体实现">具体实现</h2>
<p>只要用户提供了 <code>Marshal</code>, <code>Unmarshal</code> 和 <code>String</code> 方法即可实现 <code>Marshaler</code> 接口，以下提供一个完整的 <code>json</code> 版本代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#8be9fd;font-style:italic">var</span> jsonbMarshaler = <span style="color:#ff79c6">&amp;</span>mjsonpb.Marshaler{}

<span style="color:#6272a4">// create buffer pool with 16 instances each preallocated with 256 bytes
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">var</span> bufferPool = bpool.<span style="color:#50fa7b">NewSizedBufferPool</span>(<span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">256</span>)

<span style="color:#8be9fd;font-style:italic">type</span> Marshaler <span style="color:#8be9fd;font-style:italic">struct</span>{}

<span style="color:#8be9fd;font-style:italic">func</span> (j Marshaler) <span style="color:#50fa7b">Marshal</span>(v <span style="color:#8be9fd;font-style:italic">interface</span>{}) ([]<span style="color:#8be9fd">byte</span>, <span style="color:#8be9fd">error</span>) {
	<span style="color:#ff79c6">if</span> pb, ok <span style="color:#ff79c6">:=</span> v.(proto.Message); ok {
		buf <span style="color:#ff79c6">:=</span> bufferPool.<span style="color:#50fa7b">Get</span>()
		<span style="color:#ff79c6">defer</span> bufferPool.<span style="color:#50fa7b">Put</span>(buf)
		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> jsonbMarshaler.<span style="color:#50fa7b">Marshal</span>(buf, pb); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
			<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
		}
		<span style="color:#ff79c6">return</span> buf.<span style="color:#50fa7b">Bytes</span>(), <span style="color:#ff79c6">nil</span>
	}
	<span style="color:#ff79c6">return</span> json.<span style="color:#50fa7b">Marshal</span>(v)
}

<span style="color:#8be9fd;font-style:italic">func</span> (j Marshaler) <span style="color:#50fa7b">Unmarshal</span>(d []<span style="color:#8be9fd">byte</span>, v <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span> {
	<span style="color:#ff79c6">if</span> pb, ok <span style="color:#ff79c6">:=</span> v.(proto.Message); ok {
		<span style="color:#ff79c6">return</span> mjsonpb.<span style="color:#50fa7b">Unmarshal</span>(bytes.<span style="color:#50fa7b">NewReader</span>(d), pb)
	}
	<span style="color:#ff79c6">return</span> json.<span style="color:#50fa7b">Unmarshal</span>(d, v)
}

<span style="color:#8be9fd;font-style:italic">func</span> (j Marshaler) <span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span> {
	<span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;json&#34;</span>
}
</code></pre></div><h2 id="使用">使用</h2>
<h3 id="注册">注册</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	encoding.<span style="color:#50fa7b">RegisterMarshaler</span>(<span style="color:#f1fa8c">&#34;json&#34;</span>, <span style="color:#ff79c6">&amp;</span>Marshaler{})
}
</code></pre></div><h3 id="获取">获取</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	m, ok <span style="color:#ff79c6">:=</span> encoding.<span style="color:#50fa7b">GetMarshaler</span>(<span style="color:#f1fa8c">&#34;json&#34;</span>)
}
</code></pre></div><h3 id="序列化和反序列化">序列化和反序列化</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/codec/encoding&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">type</span> Person <span style="color:#8be9fd;font-style:italic">struct</span> {
	Name <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;name&#34;`</span>
	Age  <span style="color:#8be9fd">int32</span>  <span style="color:#f1fa8c">`json:&#34;age&#34;`</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	m, _ <span style="color:#ff79c6">:=</span> encoding.<span style="color:#50fa7b">GetMarshaler</span>(<span style="color:#f1fa8c">&#34;json&#34;</span>)
	p <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>Person{
		Name: <span style="color:#f1fa8c">&#34;Vine&#34;</span>,
		Age:  <span style="color:#bd93f9">20</span>,
	}

	data, _ <span style="color:#ff79c6">:=</span> m.<span style="color:#50fa7b">Marshal</span>(p)
	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#8be9fd;font-style:italic">string</span>(data))

	p1 <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">new</span>(Person)
	m.<span style="color:#50fa7b">Unmarshal</span>(data, <span style="color:#ff79c6">&amp;</span>p1)
	fmt.<span style="color:#50fa7b">Println</span>(p1.Name)
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-59586a1fa5b90047cde9c17a0fe343a1">4 - 订阅发布</h1>
    
	<h2 id="概述">概述</h2>
<p>微服务是一种事件驱动的体系结构模式，因此 <strong>Vine</strong> 使用消息代理接口构建异步消息的概念。它可为用户无缝地运行 protobuf 类型，并自动编码和解码消息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Broker is an interface used for asynchronous messaging.
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Broker <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#50fa7b">Address</span>() <span style="color:#8be9fd">string</span>
	<span style="color:#50fa7b">Connect</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Disconnect</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Publish</span>(topic <span style="color:#8be9fd">string</span>, m <span style="color:#ff79c6">*</span>Message, opts <span style="color:#ff79c6">...</span>PublishOption) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Subscribe</span>(topic <span style="color:#8be9fd">string</span>, h Handler, opts <span style="color:#ff79c6">...</span>SubscribeOption) (Subscriber, <span style="color:#8be9fd">error</span>)
	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><p>默认情况下，vine 实现点对点 http 代理，但可以通过 <a href="https://github.com/vine-io/plugins/tree/main/broker">plugins</a> 替换实现。</p>
<h2 id="发布消息">发布消息</h2>
<p>使用 topic 名称和服务客户端创建一个新的发布者</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">p <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewEvent</span>(<span style="color:#f1fa8c">&#34;events&#34;</span>, service.<span style="color:#50fa7b">Client</span>())
</code></pre></div><p>发布 proto 消息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">p.<span style="color:#50fa7b">Publish</span>(context.<span style="color:#50fa7b">TODO</span>(), <span style="color:#ff79c6">&amp;</span>proto.Event{Name: <span style="color:#f1fa8c">&#34;event&#34;</span>})
</code></pre></div><h2 id="订阅">订阅</h2>
<p>创建消息处理程序。它的签名应该是 <code>func(context.Context, v interface{}) error</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">ProcessEvent</span>(ctx context.Context, event <span style="color:#ff79c6">*</span>proto.Event) <span style="color:#8be9fd">error</span> {
    fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;Got event %+v\n&#34;</span>, event)
    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}
</code></pre></div><p>使用 topic 注册消息处理程序</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">vine.<span style="color:#50fa7b">RegisterSubscriber</span>(<span style="color:#f1fa8c">&#34;events&#34;</span>, ProcessEvent)
</code></pre></div><p>完整实例可以看 <a href="https://github.com/vine-io/examples/tree/main/pubsub">example/pubsub</a></p>
<h2 id="单独使用-broker">单独使用 Broker</h2>
<p><code>Broker</code> 也可以单独使用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/service/broker&#34;</span>
	log <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/service/logger&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	topic <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;go.vine.topic.foo&#34;</span>

	b <span style="color:#ff79c6">:=</span> broker.<span style="color:#50fa7b">NewBroker</span>()

	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> b.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;Broker Init error: %v&#34;</span>, err)
	}
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> b.<span style="color:#50fa7b">Connect</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;Broker Connect error: %v&#34;</span>, err)
	}

	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		<span style="color:#6272a4">// receive message from broker
</span><span style="color:#6272a4"></span>		b.<span style="color:#50fa7b">Subscribe</span>(topic, <span style="color:#8be9fd;font-style:italic">func</span>(p broker.Event) <span style="color:#8be9fd">error</span> {
			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;[sub] received message:&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(p.<span style="color:#50fa7b">Message</span>().Body), <span style="color:#f1fa8c">&#34;header&#34;</span>, p.<span style="color:#50fa7b">Message</span>().Header)
			<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
		})
	}()

	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		<span style="color:#ff79c6">&lt;-</span>time.<span style="color:#50fa7b">After</span>(time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">1</span>)
		<span style="color:#6272a4">// publish message to broker
</span><span style="color:#6272a4"></span>        b.<span style="color:#50fa7b">Publish</span>(topic, <span style="color:#ff79c6">&amp;</span>broker.Message{Header: <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;a&#34;</span>: <span style="color:#f1fa8c">&#34;b&#34;</span>}, Body: []<span style="color:#8be9fd;font-style:italic">byte</span>(<span style="color:#f1fa8c">&#34;hello world&#34;</span>)})
	}()

    time.<span style="color:#50fa7b">Sleep</span>(time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">2</span>)
    
    b.<span style="color:#50fa7b">Disconnect</span>()
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d2d36bead0be0a3b9422b2b89dcb6a4f">5 - 内部服务</h1>
    
	<h2 id="概述">概述</h2>
<p><code>Server</code> 是微服务服务和核心模块，它对外提供接口，根据不同的实现，提供相应类型的接口。目前内部支持:</p>
<ul>
<li>grpc</li>
<li>http</li>
</ul>
<p><code>Server</code> 依赖图</p>

<figure>
    <img src=" /vine/docs/component/server/2021-09-03-11-20-03.png " width="30%" height="30%"/> 
</figure>

<p>以下是 <code>Server</code> 模块的内部方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Server is a simple vine server abstraction
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Server <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#6272a4">// 初始化
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// 返回 Options
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#6272a4">// 注册 Handler
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Handle</span>(Handler) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// 创建一个新的 Handler
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">NewHandler</span>(<span style="color:#8be9fd;font-style:italic">interface</span>{}, <span style="color:#ff79c6">...</span>HandlerOption) Handler
	<span style="color:#6272a4">// 创建一个新的 Subscriber
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">NewSubscriber</span>(<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd;font-style:italic">interface</span>{}, <span style="color:#ff79c6">...</span>SubscriberOption) Subscriber
	<span style="color:#6272a4">// 注册 Subscriber
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Subscribe</span>(Subscriber) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// 启动服务
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Start</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// 停止服务
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Stop</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Server 接口类型
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><h2 id="使用方法">使用方法</h2>
<h3 id="启动一个-grpc-服务">启动一个 grpc 服务</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;log&#34;</span>
	<span style="color:#f1fa8c">&#34;os&#34;</span>
	<span style="color:#f1fa8c">&#34;os/signal&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/broker/memory&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/registry/mdns&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/server&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/core/server/grpc&#34;</span>
	usignal <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/util/signal&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// 新建 gRPC 服务
</span><span style="color:#6272a4"></span>	s <span style="color:#ff79c6">:=</span> grpc.<span style="color:#50fa7b">NewServer</span>(
		server.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;helloworld&#34;</span>),
		server.<span style="color:#50fa7b">Address</span>(<span style="color:#f1fa8c">&#34;:9000&#34;</span>),
		server.<span style="color:#50fa7b">Broker</span>(memory.<span style="color:#50fa7b">NewBroker</span>()),
		server.<span style="color:#50fa7b">Registry</span>(mdns.<span style="color:#50fa7b">NewRegistry</span>()),
	)
	<span style="color:#6272a4">// 初始化
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;grpc init: %v&#34;</span>, err)
	}
	<span style="color:#6272a4">// 启动服务, (非阻塞)
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Start</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;grpc start: %v&#34;</span>, err)
	}
	<span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>	ch <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> os.Signal, <span style="color:#bd93f9">1</span>)
	signal.<span style="color:#50fa7b">Notify</span>(ch, usignal.<span style="color:#50fa7b">Shutdown</span>()<span style="color:#ff79c6">...</span>)

	<span style="color:#ff79c6">select</span> {
	<span style="color:#6272a4">// wait on kill signal
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">case</span> <span style="color:#ff79c6">&lt;-</span>ch:
	}

    <span style="color:#6272a4">// 停止服务
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Stop</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;grpc stop: %v&#34;</span>, err)
	}
}
</code></pre></div><h3 id="注册-handler">注册 Handler</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">...</span>

<span style="color:#8be9fd;font-style:italic">type</span> HelloImpl <span style="color:#8be9fd;font-style:italic">struct</span> {

}

<span style="color:#8be9fd;font-style:italic">var</span> _ proto.Message = (<span style="color:#ff79c6">*</span>Request)(<span style="color:#ff79c6">nil</span>)
<span style="color:#8be9fd;font-style:italic">type</span> Request <span style="color:#8be9fd;font-style:italic">struct</span> {
	Name <span style="color:#8be9fd">string</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>Request) <span style="color:#50fa7b">Reset</span>() {
	r = <span style="color:#ff79c6">&amp;</span>Request{}
}

<span style="color:#8be9fd;font-style:italic">func</span> (r Request) <span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span> {
	<span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> (r Request) <span style="color:#50fa7b">ProtoMessage</span>() {

}


<span style="color:#8be9fd;font-style:italic">type</span> Response <span style="color:#8be9fd;font-style:italic">struct</span> {
	Name <span style="color:#8be9fd">string</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> (h <span style="color:#ff79c6">*</span>HelloImpl) <span style="color:#50fa7b">Get</span>(ctx context.Context, r <span style="color:#ff79c6">*</span>Request, rsp <span style="color:#ff79c6">*</span>Response) <span style="color:#8be9fd">error</span> {
	rsp.Name = r.Name
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}
<span style="color:#ff79c6">...</span>

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#ff79c6">...</span>
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;grpc init: %v&#34;</span>, err)
	}

	h <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>HelloImpl{}
	opts <span style="color:#ff79c6">:=</span> []server.HandlerOption{
		api.<span style="color:#50fa7b">WithEndpoint</span>(<span style="color:#ff79c6">&amp;</span>api.Endpoint{
			Name:        <span style="color:#f1fa8c">&#34;HelloWorld.Get&#34;</span>,
			Description: <span style="color:#f1fa8c">&#34;HelloWorld.Get&#34;</span>,
			Path:        []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;/api/v1/get&#34;</span>},
			Method:      []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;GET&#34;</span>},
			Body:        <span style="color:#f1fa8c">&#34;*&#34;</span>,
			Handler:     <span style="color:#f1fa8c">&#34;rpc&#34;</span>,
		}),
	}
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Handle</span>(s.<span style="color:#50fa7b">NewHandler</span>(h, opts<span style="color:#ff79c6">...</span>)); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;register handler: %v&#34;</span>, err)
	}
	<span style="color:#ff79c6">...</span>
}
</code></pre></div><h3 id="注册-subscriber">注册 Subscriber</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Alternatively a function can be used
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">subEv</span>(ctx context.Context, event <span style="color:#ff79c6">*</span>Request) <span style="color:#8be9fd">error</span> {
	md, _ <span style="color:#ff79c6">:=</span> metadata.<span style="color:#50fa7b">FromContext</span>(ctx)
	log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;[pubsub.2] Received event %+v with metadata %+v\n&#34;</span>, event, md)
	<span style="color:#6272a4">// do something with event
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#ff79c6">...</span>
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Init</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;grpc init: %v&#34;</span>, err)
	}

	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> s.<span style="color:#50fa7b">Subscribe</span>(s.<span style="color:#50fa7b">NewSubscriber</span>(<span style="color:#f1fa8c">&#34;get.topic&#34;</span>, subEv, server.<span style="color:#50fa7b">SubscriberQueue</span>(<span style="color:#f1fa8c">&#34;sub&#34;</span>))); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;register subscribe: %v&#34;</span>, err)
	}
	<span style="color:#ff79c6">...</span>
}
</code></pre></div><h2 id="options">options</h2>
<p>使用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	s <span style="color:#ff79c6">:=</span> grpc.<span style="color:#50fa7b">NewServer</span>(server.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;name&#34;</span>))
}
</code></pre></div><p><code>Server</code> 创建和初始化 options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span>  <span style="color:#50fa7b">main</span>() {
	grpc.<span style="color:#50fa7b">NewServer</span>(
		<span style="color:#6272a4">// 设置服务名称
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Name</span>(),
		<span style="color:#6272a4">// 设置公共 IP 地址
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Advertise</span>(),
		<span style="color:#6272a4">// 设置服务绑定地址，如果 Advertise 不为空，优先选择 Advertise
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Address</span>(),
		<span style="color:#6272a4">// 设置服务 id
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Id</span>(),
		<span style="color:#6272a4">// 设置服务 版本
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Version</span>(),
		<span style="color:#6272a4">// 设置服务 context.Context, 保存额外的值
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Context</span>(),
		<span style="color:#6272a4">// 设置服务序列化
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Codec</span>(),
		<span style="color:#6272a4">// 设置服务依赖的 Broker
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Broker</span>(memory.<span style="color:#50fa7b">NewBroker</span>()),
		<span style="color:#6272a4">// 设置服务依赖的 Registry
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Registry</span>(mdns.<span style="color:#50fa7b">NewRegistry</span>()),
		<span style="color:#6272a4">// 添加 Subscriber 处理器的装载器
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">WrapSubscriber</span>(),
		<span style="color:#6272a4">// 添加 Handler 装载器
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">WrapHandler</span>(),
		<span style="color:#6272a4">// 设置服务注册时的 ttl
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">RegisterTTL</span>(),
		<span style="color:#6272a4">// 设置服务注册间隔时间
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">RegisterInterval</span>(),
		<span style="color:#6272a4">// 设置内部 sync.WaitGroup
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Wait</span>(),
		<span style="color:#6272a4">// 设置服务元数据
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">Metadata</span>(),
		<span style="color:#6272a4">// 设置服务启动时注册到 Registry 的检测函数
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">RegisterCheck</span>(<span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context) <span style="color:#8be9fd">error</span> {
			<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
		}),
		<span style="color:#6272a4">// 设置服务 Router
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">WithRouter</span>(),
	)
}
</code></pre></div><p>创建 Handler 的 options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	s.<span style="color:#50fa7b">NewHandler</span>(h,
		server.<span style="color:#50fa7b">InternalHandler</span>(), <span style="color:#6272a4">// 内部 handler
</span><span style="color:#6272a4"></span>		api.<span style="color:#50fa7b">WithEndpoint</span>(),   <span style="color:#6272a4">// 添加 api 信息
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">OpenAPIHandler</span>(), <span style="color:#6272a4">// 添加 swagger 信息
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><p>创建 Subscriber 的 options</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	s.<span style="color:#50fa7b">NewSubscriber</span>(<span style="color:#f1fa8c">&#34;topic&#34;</span>, subEv,
		server.<span style="color:#50fa7b">InternalSubscriber</span>(), <span style="color:#6272a4">// 内部 internal
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">SubscriberQueue</span>(),   <span style="color:#6272a4">// 设置 subscriber 队列
</span><span style="color:#6272a4"></span>		server.<span style="color:#50fa7b">SubscriberContext</span>(), <span style="color:#6272a4">// subscriber 内部 context.Context
</span><span style="color:#6272a4"></span>	)
}
</code></pre></div><h2 id="grpc-结合-http">gRPC 结合 http</h2>
<p><code>Server</code> 的 gRPC 实现可以同时提供 gRPC 和 http 服务:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	gh <span style="color:#ff79c6">:=</span> grpc.Grpc2Http{
		CertFile: <span style="color:#f1fa8c">&#34;server.pem&#34;</span>,
		KeyFile:  <span style="color:#f1fa8c">&#34;server.key&#34;</span>,
		CaFile:   <span style="color:#f1fa8c">&#34;ca.pem&#34;</span>,
	}
	grpc.<span style="color:#50fa7b">NewServer</span>(grpc.<span style="color:#50fa7b">GrpcToHttp</span>(gh))
}
</code></pre></div><blockquote>
<p>grpc 内置 prometheus metrics 和 golang http prof 接口</p>
</blockquote>
<h2 id="http-实现">http 实现</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	reg <span style="color:#ff79c6">:=</span> memory.<span style="color:#50fa7b">NewRegistry</span>()
	bro <span style="color:#ff79c6">:=</span> membroker.<span style="color:#50fa7b">NewBroker</span>()

	<span style="color:#6272a4">// create server
</span><span style="color:#6272a4"></span>	srv <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">NewServer</span>(server.<span style="color:#50fa7b">Registry</span>(reg), server.<span style="color:#50fa7b">Broker</span>(bro))

	<span style="color:#6272a4">// create server mux
</span><span style="color:#6272a4"></span>	mux <span style="color:#ff79c6">:=</span> http.<span style="color:#50fa7b">NewServeMux</span>()
	mux.<span style="color:#50fa7b">HandleFunc</span>(<span style="color:#f1fa8c">&#34;/&#34;</span>, <span style="color:#8be9fd;font-style:italic">func</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request) {
		w.<span style="color:#50fa7b">Write</span>([]<span style="color:#8be9fd;font-style:italic">byte</span>(<span style="color:#f1fa8c">`hello world`</span>))
	})

	<span style="color:#6272a4">// create handler
</span><span style="color:#6272a4"></span>	hd <span style="color:#ff79c6">:=</span> srv.<span style="color:#50fa7b">NewHandler</span>(mux)

	<span style="color:#6272a4">// register handler
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> srv.<span style="color:#50fa7b">Handle</span>(hd); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		t.<span style="color:#50fa7b">Fatal</span>(err)
	}

	<span style="color:#6272a4">// start server
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> srv.<span style="color:#50fa7b">Start</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		t.<span style="color:#50fa7b">Fatal</span>(err)
	}

	<span style="color:#ff79c6">select</span>{}
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-890777915678ed57c745424af4cba2b8">6 - 内部请求</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-797b02a4bf0dfe71b512bbf7a2dce8be">7 - 错误处理</h1>
    
	<h2 id="概述">概述</h2>
<p>我们定义以下错误类型</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Error <span style="color:#8be9fd;font-style:italic">struct</span> {
	Id       <span style="color:#8be9fd">string</span>     <span style="color:#f1fa8c">`json:&#34;id,omitempty&#34;`</span>
	Code     <span style="color:#8be9fd">int32</span>      <span style="color:#f1fa8c">`json:&#34;code,omitempty&#34;`</span>
	Detail   <span style="color:#8be9fd">string</span>     <span style="color:#f1fa8c">`json:&#34;detail,omitempty&#34;`</span>
	Status   <span style="color:#8be9fd">string</span>     <span style="color:#f1fa8c">`json:&#34;status,omitempty&#34;`</span>
    Position <span style="color:#8be9fd">string</span>     <span style="color:#f1fa8c">`json:&#34;position,omitempty&#34;`</span>
    Child    <span style="color:#ff79c6">*</span>Child     <span style="color:#f1fa8c">`json:&#34;child,omitempty&#34;`</span>
    Stacks   []<span style="color:#ff79c6">*</span>Stack   <span style="color:#f1fa8c">`json:&#34;stacks,omitempty&#34;`</span>
}
</code></pre></div><p>在系统中，要求用户从处理程序返回错误或从客户端接收错误的任何位置，都应认为是 <strong>Vine</strong> 错误，或者应该生成错误。默认情况下，我们返回 <code>errors.InternalServerError</code>，如果出现错误错误则返回 <code>errors.Timeout</code>。</p>
<h2 id="使用">使用</h2>
<p>让我们假设程序中发生错误，然后，你应该确定返回哪种错误，并执行以下操作。
假设提供的数据无效：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">badRequest</span>(<span style="color:#f1fa8c">&#34;com.example.srv.service&#34;</span>, <span style="color:#f1fa8c">&#34;invalid field&#34;</span>)
</code></pre></div><p>如果发生内部错误</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">InternalServerError</span>(<span style="color:#f1fa8c">&#34;com.example.srv.service&#34;</span>, <span style="color:#f1fa8c">&#34;failed to read db: %v&#34;</span>, err.<span style="color:#50fa7b">Error</span>())
}
</code></pre></div><p>如果你从客户端收到一些错误，可以按照以下方式处理:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">cc <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">NewGreeterService</span>(<span style="color:#f1fa8c">&#34;go.vine.srv.greeter&#34;</span>, service.<span style="color:#50fa7b">Client</span>())
rsp, err <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">Clinet</span>(ctx, req)
<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
    <span style="color:#6272a4">// parse out the error 
</span><span style="color:#6272a4"></span>    e <span style="color:#ff79c6">:=</span> errors.<span style="color:#50fa7b">Parse</span>(err.<span style="color:#50fa7b">Error</span>())

    <span style="color:#6272a4">// inspect the value
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> e.Code <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">401</span> {
        <span style="color:#6272a4">// unauthorized
</span><span style="color:#6272a4"></span>    }
}
</code></pre></div><h2 id="错误列表">错误列表</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BadGateway</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BadRequest</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Conflict</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Forbidden</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">GatewayTimeout</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">InternalServerError</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">MethodNotAllowed</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">NotFound</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">NotImplemented</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">ServiceUnavailable</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Timeout</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Unauthorized</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>errors.Error
</code></pre></div><h2 id="自定义错误">自定义错误</h2>
<p>除了内置的错误类型之外，<strong>Vine</strong> 支持自定义错误类型</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// 自定义错误，并记录错误位置
</span><span style="color:#6272a4"></span>customErr <span style="color:#ff79c6">:=</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;go.vine.srv.example&#34;</span>, <span style="color:#f1fa8c">&#34;custom error&#34;</span>, <span style="color:#bd93f9">510</span>, <span style="color:#ff79c6">true</span>)
</code></pre></div><h2 id="其他">其他</h2>
<p>判断错误类型是否相同</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">b <span style="color:#ff79c6">:=</span> errors.<span style="color:#50fa7b">Equal</span>(err1, err2)
</code></pre></div><p>链式调用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">e <span style="color:#ff79c6">:=</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;go.vine.srv.example&#34;</span>, <span style="color:#f1fa8c">&#34;name must be set&#34;</span>, <span style="color:#bd93f9">404</span>).
        <span style="color:#50fa7b">WithChild</span>(<span style="color:#bd93f9">111</span>, <span style="color:#f1fa8c">&#34;%v&#34;</span>, <span style="color:#f1fa8c">&#34;child error&#34;</span>). <span style="color:#6272a4">// 添加额外错误
</span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">WithPos</span>(). <span style="color:#6272a4">// 记录错误位置 
</span><span style="color:#6272a4"></span>		<span style="color:#50fa7b">WithStack</span>(<span style="color:#bd93f9">10001</span>, <span style="color:#f1fa8c">&#34;stack context&#34;</span>) <span style="color:#6272a4">// 追加上下文信息 
</span></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a166f9ca5ae0b67e66da460ca61f73a2">8 - 配置中心</h1>
    
	<h2 id="概述">概述</h2>
<p>应用程序中的大多数配置都是静态配置或者从多个源加载的复杂逻辑。<strong>Config</strong> 是其变得简单，可插拔和可合并。</p>
<h2 id="特性">特性</h2>
<ul>
<li><strong>动态加载</strong> - 在需要时从多个源加载配置. <strong>Config</strong> 管理在后台监听配置源，并自动合并和更新内存中的配置文件源。</li>
<li><strong>可插拔的源</strong> - 从任意数量的源中进行选择以加载和合并配置。后端源被抽象为内部使用并通过编码器解码的标准格式。源可以是 env vars, flags, etcd, k8s configmap, 等。</li>
<li><strong>可合并配置</strong> - 如果指定多个配置源，无论格式如何，它们都将合并并在单个视图中显示。这极大地简化了基于环境的优先级顺序加载和更改。</li>
<li><strong>改动监听</strong> - 可选择监听配置，以监控特定值的更改。使用 <strong>Config</strong> 的监听程序热加载你的应用。不必临时关机重新加载其他任何内容，只需继续读取配置并监听需要通知的更改。</li>
<li><strong>安全恢复</strong> - 如果配置负载严重或由于未知原因完全擦除，则可以在直接访问任何配置值时指定回退值。这可确保在发生问题时始终读取某些合理的默认值。</li>
</ul>
<h2 id="内部实现">内部实现</h2>
<p>下面介绍 <strong>Config</strong> 的实现，<strong>Config</strong> 有以下部分组成：</p>
<ul>
<li>source: 配置的来源</li>
<li>encoder: 处理编码/解码源配置</li>
<li>reader: 将多个编码源合并为单一格式</li>
<li>loader：管理加载源</li>
</ul>
<h3 id="source">Source</h3>
<p><code>Source</code> 作为配置的读取来源。可以同时使用多个源。
支持以下源:</p>
<ul>
<li>cli : 从 CLI 标志读取</li>
<li>env : 从环境变量中读取</li>
<li>file : 从文件中读取</li>
<li>flag : 从标志中读取</li>
<li>memory : 从内存中读取</li>
</ul>
<h3 id="changeset">ChangeSet</h3>
<p><strong>Source</strong> 将 <strong>Config</strong> 作为一个 <strong>ChangeSet</strong> 返回，作为多个源的单一内部抽象。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// ChangeSet represents a set of changes from a source
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> ChangeSet <span style="color:#8be9fd;font-style:italic">struct</span> {
	Data      []<span style="color:#8be9fd">byte</span>
	CheckSum  <span style="color:#8be9fd">string</span>
	Format    <span style="color:#8be9fd">string</span>
	Source    <span style="color:#8be9fd">string</span>
	Timestamp time.Time
}
</code></pre></div><h3 id="encoder">encoder</h3>
<p><code>Encoder</code> 处理编码和解码。后端源可能以许多不停的格式存储。编码器使我们能够处理任何格式。如果未指定编码器，则默认为 json。
支持以下编码格式：</p>
<ul>
<li>json</li>
<li>yaml</li>
<li>toml</li>
<li>xml</li>
<li>hcl</li>
</ul>
<h3 id="reader">reader</h3>
<p><code>Reader</code> 将多个 <strong>ChangeSet</strong> 表示为单个合并和查询的集合</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Reader is an interface for merging changesets
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Reader <span style="color:#8be9fd;font-style:italic">interface</span> {
    <span style="color:#6272a4">// Merge multiple changeset into a single format
</span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">Merge</span>(<span style="color:#ff79c6">...*</span>source.ChangeSet) (<span style="color:#ff79c6">*</span>source.ChangeSet, <span style="color:#8be9fd">error</span>)
    <span style="color:#6272a4">// Return Go assertable values
</span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">Values</span>(<span style="color:#ff79c6">*</span>source.ChangeSet) (Values, <span style="color:#8be9fd">error</span>)
    <span style="color:#6272a4">// Name of the reader e.g json reader
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><p><code>Reader</code> 使用 <code>Encoder</code> 将 <strong>ChangeSet</strong> 解码为 <code>map[string]Values</code>，然后将它们合并到单个 <strong>ChangeSet</strong> 中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Values is returned by the reader
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Values <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Bytes</span>() []<span style="color:#8be9fd">byte</span>
	<span style="color:#50fa7b">Get</span>(path <span style="color:#ff79c6">...</span><span style="color:#8be9fd">string</span>) Value
	<span style="color:#50fa7b">Set</span>(val <span style="color:#8be9fd;font-style:italic">interface</span>{}, path <span style="color:#ff79c6">...</span><span style="color:#8be9fd">string</span>)
	<span style="color:#50fa7b">Del</span>(path <span style="color:#ff79c6">...</span><span style="color:#8be9fd">string</span>)
	<span style="color:#50fa7b">Map</span>() <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}
	<span style="color:#50fa7b">Scan</span>(v <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
}
</code></pre></div><p><code>Value</code> 接口允许强制转换，类型断言，返回默认值</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Value represents a value of any type
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Value <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Bool</span>(def <span style="color:#8be9fd">bool</span>) <span style="color:#8be9fd">bool</span>
	<span style="color:#50fa7b">Int</span>(def <span style="color:#8be9fd">int64</span>) <span style="color:#8be9fd">int64</span>
	<span style="color:#50fa7b">String</span>(def <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">string</span>
	<span style="color:#50fa7b">Float64</span>(def <span style="color:#8be9fd">float64</span>) <span style="color:#8be9fd">float64</span>
	<span style="color:#50fa7b">Duration</span>(def time.Duration) time.Duration
	<span style="color:#50fa7b">StringSlice</span>(def []<span style="color:#8be9fd">string</span>) []<span style="color:#8be9fd">string</span>
	<span style="color:#50fa7b">StringMap</span>(def <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>) <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>
	<span style="color:#50fa7b">Scan</span>(val <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Bytes</span>() []<span style="color:#8be9fd">byte</span>
}
</code></pre></div><h3 id="config">Config</h3>
<p><strong>Config</strong> 管理所有配置，抽象 source，encoder，reader。
它从多个源读取，同步，监听，并将它们合并为单个可查询的源。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Config is an interface abstraction for dynamic configuration
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Config <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#6272a4">// provide the reader.Values interface
</span><span style="color:#6272a4"></span>	reader.Values
	<span style="color:#6272a4">// Init the config
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Init</span>(opts <span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Options in the config
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#6272a4">// Stop the config loader/watcher
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Close</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Load config sources
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Load</span>(source <span style="color:#ff79c6">...</span>source.Source) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Force a source changeset sync
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Sync</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Watch a value for changes
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Watch</span>(path <span style="color:#ff79c6">...</span><span style="color:#8be9fd">string</span>) (Watcher, <span style="color:#8be9fd">error</span>)
}
</code></pre></div><h2 id="使用">使用</h2>
<h3 id="实例配置">实例配置</h3>
<p>只要我们有一个编码器来支持它，配置文件就可以是任务格式的。
json 配置实例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#ff79c6">&#34;hosts&#34;</span>: {
        <span style="color:#ff79c6">&#34;database&#34;</span>: {
            <span style="color:#ff79c6">&#34;address&#34;</span>: <span style="color:#f1fa8c">&#34;10.0.0.1&#34;</span>,
            <span style="color:#ff79c6">&#34;port&#34;</span>: <span style="color:#bd93f9">3306</span>
        },
        <span style="color:#ff79c6">&#34;cache&#34;</span>: {
            <span style="color:#ff79c6">&#34;address&#34;</span>: <span style="color:#f1fa8c">&#34;10.0.0.2&#34;</span>,
            <span style="color:#ff79c6">&#34;port&#34;</span>: <span style="color:#bd93f9">6379</span>
        }
    }
}
</code></pre></div><h3 id="创建-config">创建 Config</h3>
<p>创建一个新 <strong>Config</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/services/config&#34;</span>

conf <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">NewConfig</span>()
</code></pre></div><h3 id="加载文件">加载文件</h3>
<p>从文件加载配置，根据文件扩展名来确定配置格式。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;github.com/vine-io/vine/services/config&#34;</span>

<span style="color:#6272a4">// 加载 json 配置文件
</span><span style="color:#6272a4"></span>config.<span style="color:#50fa7b">LoadFile</span>(<span style="color:#f1fa8c">&#34;/tmp/config.json&#34;</span>)
</code></pre></div><p>如果扩展不存在，可指定 <code>encoder</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/service/config&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/service/config/encoder/toml&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/service/config/source&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine/service/config/source/file&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	enc <span style="color:#ff79c6">:=</span> toml.<span style="color:#50fa7b">NewEncoder</span>()
	
	<span style="color:#6272a4">// 通过编码器加载 toml 文件
</span><span style="color:#6272a4"></span>	config.<span style="color:#50fa7b">Load</span>(
		file.<span style="color:#50fa7b">NewSource</span>(
			file.<span style="color:#50fa7b">WithPath</span>(<span style="color:#f1fa8c">&#34;/tmp/config&#34;</span>),
			source.<span style="color:#50fa7b">WithEncoder</span>(enc),
		),
	)
}
</code></pre></div><h3 id="读取配置">读取配置</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">conf <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">Map</span>()

fmt.<span style="color:#50fa7b">Println</span>(conf[<span style="color:#f1fa8c">&#34;hosts&#34;</span>])
</code></pre></div><p>扫描配置到结构体</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Host <span style="color:#8be9fd;font-style:italic">struct</span> {
	Address <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;address&#34;`</span>
	Port <span style="color:#8be9fd">int</span> <span style="color:#f1fa8c">`json:&#34;port&#34;`</span>
}

<span style="color:#8be9fd;font-style:italic">type</span> Config <span style="color:#8be9fd;font-style:italic">struct</span> {
	Hosts <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]Host <span style="color:#f1fa8c">`json:&#34;hosts&#34;`</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	pwd, _ <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Getwd</span>()
	err <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">LoadFile</span>(pwd <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;/config/&#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;config.json&#34;</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	<span style="color:#8be9fd;font-style:italic">var</span> cfg Config
	config.<span style="color:#50fa7b">Scan</span>(<span style="color:#ff79c6">&amp;</span>cfg)

	fmt.<span style="color:#50fa7b">Println</span>(cfg.Hosts[<span style="color:#f1fa8c">&#34;database&#34;</span>].Address)
}
</code></pre></div><h3 id="读取值">读取值</h3>
<p>从配置扫描值到结构体</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Host <span style="color:#8be9fd;font-style:italic">struct</span> {
    Address <span style="color:#8be9fd">string</span>  <span style="color:#f1fa8c">`json:&#34;address&#34;`</span>
    Port    <span style="color:#8be9fd">int</span>     <span style="color:#f1fa8c">`json:&#34;port&#34;`</span>
}

<span style="color:#8be9fd;font-style:italic">var</span> host Host

config.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;hosts&#34;</span>, <span style="color:#f1fa8c">&#34;database&#34;</span>).<span style="color:#50fa7b">Scan</span>(<span style="color:#ff79c6">&amp;</span>host)

<span style="color:#6272a4">// 10.0.0.1 3306
</span><span style="color:#6272a4"></span>fmt.<span style="color:#50fa7b">Println</span>(host.Address, host.Port)
</code></pre></div><p>读取单个值作为 Go 类型</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Get address. Set default to localhost as fallback
</span><span style="color:#6272a4"></span>address <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;hosts&#34;</span>, <span style="color:#f1fa8c">&#34;database&#34;</span>, <span style="color:#f1fa8c">&#34;address&#34;</span>).<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;localhost&#34;</span>)

<span style="color:#6272a4">// Get port. Set default to 3000 as fallback
</span><span style="color:#6272a4"></span>port <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;hosts&#34;</span>, <span style="color:#f1fa8c">&#34;database&#34;</span>, <span style="color:#f1fa8c">&#34;port&#34;</span>).<span style="color:#50fa7b">Int</span>(<span style="color:#bd93f9">3000</span>)
</code></pre></div><h3 id="监听配置">监听配置</h3>
<p>监听配置文件。当文件更改时，更新到新值:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">w, err <span style="color:#ff79c6">:=</span> config.<span style="color:#50fa7b">Watch</span>(<span style="color:#f1fa8c">&#34;hosts&#34;</span>, <span style="color:#f1fa8c">&#34;database&#34;</span>)
<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
    <span style="color:#6272a4">// do something
</span><span style="color:#6272a4"></span>}

<span style="color:#6272a4">// wait for next value
</span><span style="color:#6272a4"></span>v, err <span style="color:#ff79c6">:=</span> w.<span style="color:#50fa7b">Next</span>()
<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
    <span style="color:#6272a4">// do something
</span><span style="color:#6272a4"></span>}

<span style="color:#8be9fd;font-style:italic">var</span> host Host

v.<span style="color:#50fa7b">Scan</span>(<span style="color:#ff79c6">&amp;</span>host)
</code></pre></div><h3 id="多源">多源</h3>
<p>可以加载和合并多个源。合并优先级顺序相反:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">config.<span style="color:#50fa7b">Load</span>(
    <span style="color:#6272a4">// base config from env
</span><span style="color:#6272a4"></span>    env.<span style="color:#50fa7b">NewSource</span>()
    <span style="color:#6272a4">// override env with flags
</span><span style="color:#6272a4"></span>    flag.<span style="color:#50fa7b">NewSource</span>()
    <span style="color:#6272a4">// override flags with file
</span><span style="color:#6272a4"></span>    file.<span style="color:#50fa7b">NewSource</span>(file.<span style="color:#50fa7b">WatchPath</span>(<span style="color:#f1fa8c">&#34;/tmp/config.json&#34;</span>))
)
</code></pre></div><h3 id="设置源编码器">设置源编码器</h3>
<p>源要求编码器对数据进行编码 / 解码并指定更改集格式.</p>
<p>默认的编码器是 json. 要更改编码器可调整对应的类型选项.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">e <span style="color:#ff79c6">:=</span> yaml.<span style="color:#50fa7b">NewEncoder</span>()

s <span style="color:#ff79c6">:=</span> consul.<span style="color:#50fa7b">NewSource</span>(
    source.<span style="color:#50fa7b">WithEncoder</span>(e),
)
</code></pre></div><h3 id="添加读取器编码器">添加读取器编码器</h3>
<p>读取器使用编码器从不同格式的源解码数据.</p>
<p>默认的读取器支持 json, yaml, xml, toml 和 hcl. 它将合并的配置表示为 json.</p>
<p>可以通过指定的选项来添加一个新的编码器.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">e <span style="color:#ff79c6">:=</span> yaml.<span style="color:#50fa7b">NewEncoder</span>()

r <span style="color:#ff79c6">:=</span> json.<span style="color:#50fa7b">NewReader</span>(
    reader.<span style="color:#50fa7b">WithEncoder</span>(e),
)
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-39fecad7477de2ef09d3e2a496ab8478">9 - 数据缓存</h1>
    
	<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Cache is a data cache interface
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Cache <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#6272a4">// Init initialises the cache. It must perform any required setup on the backing storage implementation and check that it is ready for use, returning any errors.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Options allows you to view the current options.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#6272a4">// Get takes a single key name and optional GetOptions. It returns matching []*Record or an error.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Get</span>(key <span style="color:#8be9fd">string</span>, opts <span style="color:#ff79c6">...</span>GetOption) ([]<span style="color:#ff79c6">*</span>Record, <span style="color:#8be9fd">error</span>)
	<span style="color:#6272a4">// Put writes a record to the cache, and returns an error if the record was not written.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Put</span>(r <span style="color:#ff79c6">*</span>Record, opts <span style="color:#ff79c6">...</span>PutOption) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// Del removes the record with the corresponding key from the cache.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Del</span>(key <span style="color:#8be9fd">string</span>, opts <span style="color:#ff79c6">...</span>DelOption) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// List returns any keys that match, or an empty list with no error if none matched.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">List</span>(opts <span style="color:#ff79c6">...</span>ListOption) ([]<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd">error</span>)
	<span style="color:#6272a4">// Close the cache
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Close</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// String returns the name of the implementation.
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}

<span style="color:#6272a4">// Record is an item cached or retrieved from a Cache
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Record <span style="color:#8be9fd;font-style:italic">struct</span> {
	<span style="color:#6272a4">// The key to cache the record
</span><span style="color:#6272a4"></span>	Key <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;key&#34;`</span>
	<span style="color:#6272a4">// The value within the record
</span><span style="color:#6272a4"></span>	Value []<span style="color:#8be9fd">byte</span> <span style="color:#f1fa8c">`json:&#34;value&#34;`</span>
	<span style="color:#6272a4">// Any associated metadata for indexing
</span><span style="color:#6272a4"></span>	Metadata <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{} <span style="color:#f1fa8c">`json:&#34;metadata&#34;`</span>
	<span style="color:#6272a4">// Time to expire a record: TODO: change to timestamp
</span><span style="color:#6272a4"></span>	Expiry time.Duration <span style="color:#f1fa8c">`json:&#34;expiry,omitempty&#34;`</span>
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-153e4a0bca2441db25452191e5399846">10 - 命令行参数</h1>
    
	<p>// TODO</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a711fd4172b59f618933a2b52fdc23a0">11 - 日志接口</h1>
    
	<p>// TODO</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-06993b840e35b8603c1d1fa4e5390ca5">12 - 数据库接口</h1>
    
	<p>// TODO</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1716b93d0e0fcc931d997f5833d2e6f4">13 - 锁和选举</h1>
    
	<p>// TODO</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-af33cab72523ccb0847ef55ee3168c8b">14 - 装载器</h1>
    
	<p>// TODO</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-6d71662a7a073686a5f0e2c3e135bd39">14.1 - 概述</h1>
    
	<p>// TODO</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-39eacc854f3fd422544f82d390b1f48c">14.2 - 链路追踪</h1>
    
	<p>// TODO</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-93c9ae063448402518730eb36201d2b1">14.3 - 数据校验</h1>
    
	<p>// TODO</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-62cd849eef8495611b5b8892f70d5afa">14.4 - 元数据</h1>
    
	<p>// TODO</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c483018e88ad8da9a20f3c7dfcffa915">14.5 - 请求熔断</h1>
    
	<p>// TODO</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e1183309a928ffcc3eb6cc0dcd66651d">14.6 - 请求限流</h1>
    
	<p>// TODO</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c049cbc8dfe9badc6517d70a4af559fb">15 - 定时任务</h1>
    
	<p><strong>Vine</strong> 服务内部携带定时任务调度器，用户可以注册 <code>Job</code>，服务启动时，调度器同时启动。</p>
<h2 id="新建">新建</h2>
<p>我们来尝试创建一个任务:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;log&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/vine-io/gscheduler&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/vine&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	job <span style="color:#ff79c6">:=</span> gscheduler.<span style="color:#50fa7b">JobBuilder</span>().
		<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;testjob&#34;</span>).          <span style="color:#6272a4">// 任务名称，唯一值
</span><span style="color:#6272a4"></span>		<span style="color:#50fa7b">Duration</span>(time.Second).    <span style="color:#6272a4">// 任务触发间隔时间
</span><span style="color:#6272a4"></span>		<span style="color:#50fa7b">Fn</span>(<span style="color:#8be9fd;font-style:italic">func</span>() {               <span style="color:#6272a4">// 任务业务主体
</span><span style="color:#6272a4"></span>			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;done!&#34;</span>)
		}).
		<span style="color:#50fa7b">Out</span>()                     <span style="color:#6272a4">// 返回 *Job
</span><span style="color:#6272a4"></span>
    <span style="color:#6272a4">// 添加定时任务
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">AddJob</span>(job); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalln</span>(err)
	}

	s <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>()
	s.<span style="color:#50fa7b">Init</span>()
	s.<span style="color:#50fa7b">Run</span>()
}
</code></pre></div><h2 id="构建过程">构建过程</h2>
<p>我们提供一组方法来简化定时任务的创建过程。</p>
<p>创建定时任务:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    job <span style="color:#ff79c6">:=</span> gscheduler.<span style="color:#50fa7b">JobBuilder</span>().
		<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;testjob&#34;</span>).
		<span style="color:#50fa7b">Duration</span>(time.Second).
		<span style="color:#50fa7b">Fn</span>(<span style="color:#8be9fd;font-style:italic">func</span>() {
			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;done!&#34;</span>)
		}).
		<span style="color:#50fa7b">Out</span>()
}
</code></pre></div><p>创建 crontab 定时任务:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">import</span> (
    <span style="color:#ff79c6">...</span>
    <span style="color:#f1fa8c">&#34;github.com/vine-io/gscheduler&#34;</span>
	<span style="color:#f1fa8c">&#34;github.com/vine-io/gscheduler/cron&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    <span style="color:#6272a4">// crontab 表达式格式: 秒 分 时 日 月 周
</span><span style="color:#6272a4"></span>    c, err <span style="color:#ff79c6">:=</span> cron.<span style="color:#50fa7b">Parse</span>(<span style="color:#f1fa8c">&#34;*/3 * * * * *&#34;</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;invalid crontab expr: %v&#34;</span>, err)
	}

    <span style="color:#6272a4">// c = cron.Every(time.Second)
</span><span style="color:#6272a4"></span>
	job <span style="color:#ff79c6">:=</span> gscheduler.<span style="color:#50fa7b">JobBuilder</span>().
		<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;testjob&#34;</span>).
		<span style="color:#50fa7b">Spec</span>(c).
		<span style="color:#50fa7b">Fn</span>(<span style="color:#8be9fd;font-style:italic">func</span>() {
			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;done!&#34;</span>)
		}).
		<span style="color:#50fa7b">Out</span>()
}
</code></pre></div><p>创建一次性任务:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    job <span style="color:#ff79c6">:=</span> gscheduler.<span style="color:#50fa7b">JobBuilder</span>().
		<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;testjob&#34;</span>).
		<span style="color:#50fa7b">Delay</span>(time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">Add</span>(time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">2</span>)).
		<span style="color:#50fa7b">Fn</span>(<span style="color:#8be9fd;font-style:italic">func</span>() {
			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;done!&#34;</span>)
		}).
		<span style="color:#50fa7b">Out</span>()
}
</code></pre></div><p>额外的功能:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    job <span style="color:#ff79c6">:=</span> gscheduler.<span style="color:#50fa7b">JobBuilder</span>().
		<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;testjob&#34;</span>).
		<span style="color:#50fa7b">Duration</span>(time.Second).
		<span style="color:#50fa7b">Silent</span>().  <span style="color:#6272a4">// 任务静默
</span><span style="color:#6272a4"></span>		<span style="color:#50fa7b">Times</span>(<span style="color:#bd93f9">3</span>).  <span style="color:#6272a4">// 指定任务执行次数
</span><span style="color:#6272a4"></span>		<span style="color:#50fa7b">Fn</span>(<span style="color:#8be9fd;font-style:italic">func</span>() {
			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;done!&#34;</span>)
		}).
		<span style="color:#50fa7b">Out</span>()
}
</code></pre></div><h2 id="其他">其他</h2>
<p>内部定时任务调度器的其他功能:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    <span style="color:#6272a4">// 根据 id 获取任务
</span><span style="color:#6272a4"></span>    j, _ <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">GetJob</span>(job.<span style="color:#50fa7b">ID</span>())
    <span style="color:#6272a4">// 更新任务
</span><span style="color:#6272a4"></span>	vine.<span style="color:#50fa7b">UpdateJob</span>(j)
    <span style="color:#6272a4">// 删除任务
</span><span style="color:#6272a4"></span>	vine.<span style="color:#50fa7b">RemoveJob</span>(j)
}
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="" aria-label="">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="">
      <i class=""></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 The Docsy Authors All Rights Reserved</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank">隐私政策</a></small>
	
		<p class="mt-2"><a href="/vine/about/">关于</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>


<script src="https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js" integrity="sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj" crossorigin="anonymous"></script>










<script src="/vine/js/main.min.4311a5d52861bb5e1fd9ee6ffb1f00a3fdc3459ab6bf80c384338786370e230b.js" integrity="sha256-QxGl1Shhu14f2e5v&#43;x8Ao/3DRZq2v4DDhDOHhjcOIws=" crossorigin="anonymous"></script>




  </body>
</html>
